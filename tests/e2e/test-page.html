<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HTTP Client Test Page</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .response,
      .error {
        margin: 10px 0;
        padding: 10px;
        border-radius: 3px;
        white-space: pre-wrap;
      }
      .response {
        background: #d4edda;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
      }
      .loading {
        color: #007bff;
      }
    </style>
  </head>
  <body>
    <h1>HTTP Client Test Page</h1>

    <div class="section">
      <h2>Basic Requests</h2>
      <button data-testid="send-get-request">Send GET Request</button>
      <button data-testid="send-post-request">Send POST Request</button>
      <button data-testid="send-error-request">Send Error Request</button>
      <div data-testid="response" class="response" style="display: none"></div>
      <div data-testid="error" class="error" style="display: none"></div>
      <div data-testid="loading" class="loading" style="display: none">Loading...</div>
    </div>

    <div class="section">
      <h2>Vue Integration Test</h2>
      <div id="vue-app">
        <button @click="sendRequest" data-testid="vue-send-request">Vue Send Request</button>
        <div v-if="loading" data-testid="vue-loading" class="loading">Loading...</div>
        <div v-if="data" data-testid="vue-response" class="response">{{ JSON.stringify(data, null, 2) }}</div>
        <div v-if="error" data-testid="vue-error" class="error">{{ error.message }}</div>
      </div>
    </div>

    <!-- 引入 Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
      // 模拟 HTTP 客户端
      class MockHttpClient {
        async request(config) {
          await new Promise((resolve) => setTimeout(resolve, 500)) // 模拟延迟

          if (config.url.includes('error')) {
            throw new Error('Mock error response')
          }

          return {
            data: {
              success: true,
              method: config.method,
              url: config.url,
              timestamp: new Date().toISOString(),
            },
            status: 200,
            statusText: 'OK',
            headers: {},
            config,
          }
        }

        async get(url, config = {}) {
          return this.request({ ...config, method: 'GET', url })
        }

        async post(url, data, config = {}) {
          return this.request({ ...config, method: 'POST', url, data })
        }
      }

      const httpClient = new MockHttpClient()

      // 基础请求测试
      document.addEventListener('DOMContentLoaded', () => {
        const responseEl = document.querySelector('[data-testid="response"]')
        const errorEl = document.querySelector('[data-testid="error"]')
        const loadingEl = document.querySelector('[data-testid="loading"]')

        function showLoading() {
          loadingEl.style.display = 'block'
          responseEl.style.display = 'none'
          errorEl.style.display = 'none'
        }

        function showResponse(data) {
          loadingEl.style.display = 'none'
          responseEl.style.display = 'block'
          responseEl.textContent = JSON.stringify(data, null, 2)
        }

        function showError(error) {
          loadingEl.style.display = 'none'
          errorEl.style.display = 'block'
          errorEl.textContent = error.message
        }

        document.querySelector('[data-testid="send-get-request"]').addEventListener('click', async () => {
          try {
            showLoading()
            const response = await httpClient.get('https://jsonplaceholder.typicode.com/posts/1')
            showResponse(response.data)
          } catch (error) {
            showError(error)
          }
        })

        document.querySelector('[data-testid="send-post-request"]').addEventListener('click', async () => {
          try {
            showLoading()
            const response = await httpClient.post('https://jsonplaceholder.typicode.com/posts', {
              title: 'Test Post',
              body: 'This is a test post',
              userId: 1,
            })
            showResponse(response.data)
          } catch (error) {
            showError(error)
          }
        })

        document.querySelector('[data-testid="send-error-request"]').addEventListener('click', async () => {
          try {
            showLoading()
            await httpClient.get('/api/error')
          } catch (error) {
            showError(error)
          }
        })
      })

      // Vue 应用
      const { createApp, ref } = Vue

      createApp({
        setup() {
          const data = ref(null)
          const loading = ref(false)
          const error = ref(null)

          const sendRequest = async () => {
            try {
              loading.value = true
              error.value = null
              data.value = null

              const response = await httpClient.get('https://jsonplaceholder.typicode.com/users/1')
              data.value = response.data
            } catch (err) {
              error.value = err
            } finally {
              loading.value = false
            }
          }

          return {
            data,
            loading,
            error,
            sendRequest,
          }
        },
      }).mount('#vue-app')
    </script>
  </body>
</html>

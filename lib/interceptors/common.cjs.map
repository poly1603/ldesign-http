{"version":3,"file":"common.cjs","sources":["../../src/interceptors/common.ts"],"sourcesContent":["import type {\r\n  ErrorInterceptor,\r\n  HttpError,\r\n  RequestInterceptor,\r\n  ResponseInterceptor,\r\n} from '../types'\r\n\r\n/**\r\n * 请求日志拦截器\r\n */\r\nexport const requestLoggerInterceptor: RequestInterceptor = (config) => {\r\n  // eslint-disable-next-line no-console\r\n  console.log(`[HTTP Request] ${config.method} ${config.url}`, {\r\n    headers: config.headers,\r\n    data: config.data,\r\n    params: config.params,\r\n  })\r\n  return config\r\n}\r\n\r\n/**\r\n * 响应日志拦截器\r\n */\r\nexport const responseLoggerInterceptor: ResponseInterceptor = (response) => {\r\n  // eslint-disable-next-line no-console\r\n  console.log(`[HTTP Response] ${response.config.method} ${response.config.url}`, {\r\n    status: response.status,\r\n    data: response.data\r\n  })\r\n  return response\r\n}\r\n\r\n/**\r\n * 错误日志拦截器\r\n */\r\nexport const errorLoggerInterceptor: ErrorInterceptor = (error) => {\r\n  console.error(`[HTTP Error] ${error.config?.url}`, {\r\n    message: error.message,\r\n    code: error.code,\r\n    status: error.response?.status,\r\n    response: error.response?.data,\r\n  })\r\n  return error\r\n}\r\n\r\n/**\r\n * 认证拦截器工厂\r\n */\r\nexport function createAuthInterceptor(\r\n  getToken: () => string | null,\r\n): RequestInterceptor {\r\n  return (config) => {\r\n    const token = getToken()\r\n    if (token) {\r\n      config.headers = {\r\n        ...config.headers,\r\n        Authorization: `Bearer ${token}`,\r\n      }\r\n    }\r\n    return config\r\n  }\r\n}\r\n\r\n/**\r\n * 基础 URL 拦截器工厂\r\n */\r\nexport function createBaseURLInterceptor(baseURL: string): RequestInterceptor {\r\n  return (config) => {\r\n    if (!config.baseURL && !config.url?.startsWith('http')) {\r\n      config.baseURL = baseURL\r\n    }\r\n    return config\r\n  }\r\n}\r\n\r\n/**\r\n * 请求 ID 拦截器\r\n */\r\nexport const requestIdInterceptor: RequestInterceptor = (config) => {\r\n  const requestId = Math.random().toString(36).substring(2, 15)\r\n  config.headers = {\r\n    ...config.headers,\r\n    'X-Request-ID': requestId,\r\n  }\r\n  return config\r\n}\r\n\r\n/**\r\n * 时间戳拦截器\r\n */\r\nexport const timestampInterceptor: RequestInterceptor = (config) => {\r\n  const timestamp = Date.now()\r\n\r\n  // 为 GET 请求添加时间戳参数防止缓存\r\n  if (config.method === 'GET') {\r\n    config.params = {\r\n      ...config.params,\r\n      _t: timestamp,\r\n    }\r\n  }\r\n\r\n  // 添加时间戳头部\r\n  config.headers = {\r\n    ...config.headers,\r\n    'X-Timestamp': timestamp.toString(),\r\n  }\r\n\r\n  return config\r\n}\r\n\r\n/**\r\n * 内容类型拦截器\r\n */\r\nexport const contentTypeInterceptor: RequestInterceptor = (config) => {\r\n  if (\r\n    config.data\r\n    && !config.headers?.['Content-Type']\r\n    && !config.headers?.['content-type']\r\n  ) {\r\n    if (typeof config.data === 'object' && !(config.data instanceof FormData)) {\r\n      config.headers = {\r\n        ...config.headers,\r\n        'Content-Type': 'application/json',\r\n      }\r\n    }\r\n  }\r\n  return config\r\n}\r\n\r\n/**\r\n * 响应时间拦截器\r\n */\r\nexport function createResponseTimeInterceptor(): {\r\n  request: RequestInterceptor\r\n  response: ResponseInterceptor\r\n} {\r\n  const startTimes = new Map<string, number>()\r\n\r\n  return {\r\n    request: (config) => {\r\n      const requestId\r\n        = config.headers?.['X-Request-ID'] || Math.random().toString(36)\r\n      startTimes.set(requestId, Date.now())\r\n      config.headers = {\r\n        ...config.headers,\r\n        'X-Request-ID': requestId,\r\n      }\r\n      return config\r\n    },\r\n    response: (response) => {\r\n      const requestId = response.config.headers?.['X-Request-ID']\r\n      if (requestId && startTimes.has(requestId)) {\r\n        const startTime = startTimes.get(requestId)!\r\n        const duration = Date.now() - startTime\r\n        // eslint-disable-next-line no-console\r\n        console.log(`[Response Time] ${response.config.url}: ${duration}ms`)\r\n        startTimes.delete(requestId)\r\n      }\r\n      return response\r\n    },\r\n  }\r\n}\r\n\r\n/**\r\n * 状态码处理拦截器\r\n */\r\nexport const statusCodeInterceptor: ResponseInterceptor = (response) => {\r\n  // 可以在这里处理特定的状态码\r\n  if (response.status >= 400) {\r\n    throw new Error(`HTTP Error: ${response.status} ${response.statusText}`)\r\n  }\r\n  return response\r\n}\r\n\r\n/**\r\n * 数据转换拦截器工厂\r\n */\r\nexport function createDataTransformInterceptor<T, R>(\r\n  transform: (data: T) => R,\r\n): ResponseInterceptor<R> {\r\n  return (response) => {\r\n    return {\r\n      ...response,\r\n      data: transform(response.data as unknown as T),\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 重试拦截器工厂\r\n */\r\nexport function createRetryInterceptor(\r\n  maxRetries: number = 3,\r\n  retryDelay: number = 1000,\r\n  retryCondition?: (error: HttpError) => boolean,\r\n): ErrorInterceptor {\r\n  return async (error) => {\r\n    const config = error.config\r\n    if (!config) {\r\n      return error\r\n    }\r\n\r\n    // 检查是否应该重试\r\n    const shouldRetry = retryCondition\r\n      ? retryCondition(error)\r\n      : error.isNetworkError || error.isTimeoutError\r\n\r\n    if (!shouldRetry) {\r\n      return error\r\n    }\r\n\r\n    // 获取当前重试次数\r\n    const retryCount = (config as any).__retryCount || 0\r\n\r\n    if (retryCount >= maxRetries) {\r\n      return error\r\n    }\r\n\r\n    // 增加重试次数\r\n    ;(config as any).__retryCount = retryCount + 1\r\n\r\n    // 延迟重试\r\n    await new Promise(resolve =>\r\n      setTimeout(resolve, retryDelay * 2 ** retryCount),\r\n    )\r\n\r\n    // 这里需要重新发送请求，但由于拦截器的限制，我们只能返回错误\r\n    // 实际的重试逻辑应该在 HttpClient 中实现\r\n    return error\r\n  }\r\n}\r\n\r\n// 简化的拦截器函数，用于测试\r\nexport function authInterceptor(options: any = {}) {\r\n  const {\r\n    tokenKey = 'accessToken',\r\n    headerName = 'Authorization',\r\n    tokenPrefix = 'Bearer',\r\n  } = options\r\n\r\n  return {\r\n    request: (config: any) => {\r\n      const token = localStorage.getItem(tokenKey)\r\n      if (token) {\r\n        config.headers = config.headers || {}\r\n        config.headers[headerName] = `${tokenPrefix} ${token}`\r\n      }\r\n      return config\r\n    },\r\n    responseError: (error: any) => {\r\n      if (error.response?.status === 401) {\r\n        localStorage.removeItem(tokenKey)\r\n      }\r\n      return error\r\n    },\r\n  }\r\n}\r\n\r\nexport function loggingInterceptor(options: any = {}) {\r\n  const { level = 'info', logger = console } = options\r\n\r\n  return {\r\n    request: (config: any) => {\r\n      if (level === 'info' || level === 'debug') {\r\n        logger.log('Request:', {\r\n          method: config.method,\r\n          url: config.url,\r\n          headers: config.headers,\r\n          data: config.data,\r\n        })\r\n      }\r\n      return config\r\n    },\r\n    response: (response: any) => {\r\n      if (level === 'info' || level === 'debug') {\r\n        logger.log('Response:', {\r\n          status: response.status,\r\n          data: response.data,\r\n          headers: response.headers,\r\n        })\r\n      }\r\n      return response\r\n    },\r\n    responseError: (error: any) => {\r\n      logger.error('Error:', {\r\n        message: error.message,\r\n        config: error.config,\r\n        response: error.response,\r\n      })\r\n      return error\r\n    },\r\n  }\r\n}\r\n\r\nexport function errorHandlingInterceptor(options: any = {}) {\r\n  const { customHandler } = options\r\n\r\n  return {\r\n    responseError: (error: any) => {\r\n      if (customHandler) {\r\n        return customHandler(error)\r\n      }\r\n\r\n      // 默认错误处理\r\n      if (error.isNetworkError) {\r\n        error.userMessage = '网络连接失败，请检查网络设置'\r\n      }\r\n      else if (error.isTimeoutError) {\r\n        error.userMessage = '请求超时，请重试'\r\n      }\r\n      else if (error.response?.status >= 500) {\r\n        error.userMessage = '服务器内部错误'\r\n      }\r\n      else if (error.response?.status >= 400) {\r\n        error.userMessage = `请求失败 (${error.response.status})`\r\n      }\r\n\r\n      return error\r\n    },\r\n  }\r\n}\r\n\r\nexport function timeoutInterceptor(options: any = {}) {\r\n  const { timeout = 5000 } = options\r\n\r\n  return {\r\n    request: (config: any) => {\r\n      if (!config.timeout) {\r\n        config.timeout = timeout\r\n      }\r\n      return config\r\n    },\r\n    responseError: (error: any) => {\r\n      if (error.code === 'ECONNABORTED' || error.message?.includes('timeout')) {\r\n        error.isTimeoutError = true\r\n        error.message = 'Request timeout'\r\n      }\r\n      return error\r\n    },\r\n  }\r\n}\r\n\r\nexport function retryInterceptor(options: any = {}) {\r\n  const { maxAttempts = 3, delay = 1000 } = options\r\n\r\n  return {\r\n    request: (config: any) => {\r\n      if (!config.retry) {\r\n        config.retry = { maxAttempts, delay }\r\n      }\r\n      return config\r\n    },\r\n  }\r\n}\r\n\r\nexport function cacheInterceptor(options: any = {}) {\r\n  const { enabled = true, ttl = 300000, methods = ['GET'] } = options\r\n\r\n  return {\r\n    request: (config: any) => {\r\n      // 不覆盖现有的缓存配置\r\n      if (!config.cache) {\r\n        const method = config.method?.toUpperCase() || 'GET'\r\n        const shouldCache = enabled && methods.includes(method)\r\n        config.cache = { enabled: shouldCache, ttl }\r\n      }\r\n      return config\r\n    },\r\n  }\r\n}\r\n"],"names":["options","tokenKey","headerName","tokenPrefix","request","config","token","localStorage","getItem","headers","responseError","error","response","status","removeItem","enabled","ttl","methods","cache","method","toUpperCase","shouldCache","includes","data","FormData","getToken","Authorization","baseURL","url","startsWith","transform","startTimes","Map","requestId","Math","random","toString","set","Date","now","has","startTime","get","delete","maxRetries","retryDelay","retryCondition","isNetworkError","isTimeoutError","retryCount","__retryCount","Promise","resolve","setTimeout","customHandler","userMessage","level","logger","console","log","message","substring","maxAttempts","delay","retry","Error","statusText","timeout","code","timestamp","params","_t"],"mappings":"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"}
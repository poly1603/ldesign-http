"use strict";var e=require("node:process");class t{constructor(e={}){this.usageHistory=[],this.stats={current:{used:0,total:0,percentage:0,timestamp:Date.now()},peak:{used:0,total:0,percentage:0,timestamp:Date.now()},average:0,warningCount:0,dangerCount:0,cleanupCount:0},this.config={enabled:e.enabled??!0,interval:e.interval??1e4,warningThreshold:e.warningThreshold??100,dangerThreshold:e.dangerThreshold??200,autoCleanup:e.autoCleanup??!0,onCleanup:e.onCleanup,onWarning:e.onWarning,onDanger:e.onDanger},this.config?.enabled&&this.start()}start(){this.monitorTimer||(this.monitorTimer=setInterval(()=>{this.check()},this.config?.interval),this.check())}stop(){this.monitorTimer&&(clearInterval(this.monitorTimer),this.monitorTimer=void 0)}check(){const e=this.getMemoryUsage();this.stats.current=e,e.used>this.stats.peak.used&&(this.stats.peak=e),this.usageHistory.push(e),this.usageHistory.length>100&&this.usageHistory.shift(),this.stats.average=this.usageHistory.reduce((e,t)=>e+t.used,0)/this.usageHistory.length,e.used>=this.config?.dangerThreshold?(this.stats.dangerCount++,this.config?.onDanger?.(e),this.config?.autoCleanup&&this.cleanup()):e.used>=this.config?.warningThreshold&&(this.stats.warningCount++,this.config?.onWarning?.(e))}getMemoryUsage(){let t=0,s=0;if(typeof performance<"u"&&performance.memory){const e=performance.memory;t=e.usedJSHeapSize/1024/1024,s=e.totalJSHeapSize/1024/1024}else if(typeof e<"u"&&e.memoryUsage){const a=e.memoryUsage();t=a.heapUsed/1024/1024,s=a.heapTotal/1024/1024}return{used:t,total:s,percentage:s>0?t/s*100:0,timestamp:Date.now()}}cleanup(){if(this.stats.cleanupCount++,this.config?.onCleanup?.(),typeof globalThis<"u"&&globalThis.gc)try{globalThis.gc()}catch{}}getStats(){return{...this.stats}}getHistory(){return[...this.usageHistory]}resetStats(){this.stats={current:this.stats.current,peak:{used:0,total:0,percentage:0,timestamp:Date.now()},average:0,warningCount:0,dangerCount:0,cleanupCount:0},this.usageHistory=[]}destroy(){this.stop(),this.usageHistory=[]}}function s(e){return new t(e)}const a=s({enabled:!1});class n{constructor(){this.cleanupHandlers=[]}register(e){return this.cleanupHandlers.push(e),()=>{const t=this.cleanupHandlers.indexOf(e);t>-1&&this.cleanupHandlers.splice(t,1)}}cleanup(){this.cleanupHandlers.forEach(e=>{try{e()}catch(e){}})}clear(){this.cleanupHandlers=[]}}const r=new n;exports.MemoryCleaner=n,exports.MemoryMonitor=t,exports.createMemoryMonitor=s,exports.globalMemoryCleaner=r,exports.globalMemoryMonitor=a;
//# sourceMappingURL=memory.cjs.map

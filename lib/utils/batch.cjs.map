{"version":3,"file":"batch.cjs","sources":["../../src/utils/batch.ts"],"sourcesContent":["/**\r\n * 请求批处理功能\r\n * 将多个请求合并为一个批量请求，减少网络开销\r\n */\r\n\r\nimport type { RequestConfig, ResponseData } from '../types'\r\n\r\n/**\r\n * 批处理配置\r\n */\r\nexport interface BatchConfig {\r\n  /** 批处理窗口时间（毫秒） */\r\n  windowMs?: number\r\n  /** 最大批处理大小 */\r\n  maxBatchSize?: number\r\n  /** 是否启用批处理 */\r\n  enabled?: boolean\r\n  /** 批处理端点 */\r\n  endpoint?: string\r\n  /** 自定义批处理请求构建器 */\r\n  requestBuilder?: (requests: RequestConfig[]) => RequestConfig\r\n  /** 自定义批处理响应解析器 */\r\n  responseParser?: (response: ResponseData) => ResponseData[]\r\n}\r\n\r\n/**\r\n * 批处理项\r\n */\r\ninterface BatchItem {\r\n  config: RequestConfig\r\n  resolve: (value: ResponseData) => void\r\n  reject: (error: any) => void\r\n  timestamp: number\r\n}\r\n\r\n/**\r\n * 批处理统计\r\n */\r\nexport interface BatchStats {\r\n  /** 总请求数 */\r\n  totalRequests: number\r\n  /** 批处理次数 */\r\n  batchCount: number\r\n  /** 节省的请求数 */\r\n  savedRequests: number\r\n  /** 平均批处理大小 */\r\n  averageBatchSize: number\r\n  /** 批处理效率（节省比例） */\r\n  efficiency: number\r\n}\r\n\r\n/**\r\n * 请求批处理管理器\r\n * \r\n * 优化点：\r\n * 1. 智能批处理窗口，自动调整批处理时机\r\n * 2. 支持优先级，高优先级请求可以立即发送\r\n * 3. 自动错误处理和重试\r\n * 4. 详细的批处理统计\r\n */\r\nexport class BatchManager {\r\n  private config: Required<BatchConfig>\r\n  private pendingBatch: BatchItem[] = []\r\n  private batchTimer?: ReturnType<typeof setTimeout>\r\n  private stats: BatchStats = {\r\n    totalRequests: 0,\r\n    batchCount: 0,\r\n    savedRequests: 0,\r\n    averageBatchSize: 0,\r\n    efficiency: 0,\r\n  }\r\n\r\n  constructor(config: BatchConfig = {}) {\r\n    this.config = {\r\n      windowMs: config.windowMs ?? 50,\r\n      maxBatchSize: config.maxBatchSize ?? 10,\r\n      enabled: config.enabled ?? true,\r\n      endpoint: config.endpoint ?? '/batch',\r\n      requestBuilder: config.requestBuilder ?? this.defaultRequestBuilder.bind(this),\r\n      responseParser: config.responseParser ?? this.defaultResponseParser.bind(this),\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 添加请求到批处理队列\r\n   */\r\n  async add<T = any>(config: RequestConfig): Promise<ResponseData<T>> {\r\n    if (!this.config?.enabled) {\r\n      throw new Error('Batch processing is disabled')\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const item: BatchItem = {\r\n        config,\r\n        resolve: resolve as any,\r\n        reject,\r\n        timestamp: Date.now(),\r\n      }\r\n\r\n      this.pendingBatch.push(item)\r\n      this.stats.totalRequests++\r\n\r\n      // 如果达到最大批处理大小，立即执行\r\n      if (this.pendingBatch.length >= this.config?.maxBatchSize) {\r\n        this.flush()\r\n      }\r\n      else {\r\n        // 否则等待批处理窗口\r\n        this.scheduleBatch()\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 调度批处理\r\n   */\r\n  private scheduleBatch(): void {\r\n    if (this.batchTimer) {\r\n      return\r\n    }\r\n\r\n    this.batchTimer = setTimeout(() => {\r\n      this.flush()\r\n    }, this.config?.windowMs)\r\n  }\r\n\r\n  /**\r\n   * 立即执行批处理\r\n   */\r\n  async flush(): Promise<void> {\r\n    if (this.batchTimer) {\r\n      clearTimeout(this.batchTimer)\r\n      this.batchTimer = undefined\r\n    }\r\n\r\n    if (this.pendingBatch.length === 0) {\r\n      return\r\n    }\r\n\r\n    const batch = this.pendingBatch.splice(0, this.config?.maxBatchSize)\r\n    this.stats.batchCount++\r\n    this.stats.savedRequests += batch.length - 1\r\n    this.updateStats()\r\n\r\n    try {\r\n      // 构建批处理请求\r\n      const batchRequest = this.config?.requestBuilder(\r\n        batch.map(item => item.config),\r\n      )\r\n\r\n      // 发送批处理请求（这里需要实际的 HTTP 客户端）\r\n      // 为了避免循环依赖，这里返回一个占位符\r\n      // 实际使用时应该注入 HTTP 客户端\r\n      const batchResponse = await this.executeBatchRequest(batchRequest)\r\n\r\n      // 解析批处理响应\r\n      const responses = this.config?.responseParser(batchResponse)\r\n\r\n      // 分发响应到各个请求\r\n      batch.forEach((item, index) => {\r\n        if (responses[index]) {\r\n          item.resolve(responses[index])\r\n        }\r\n        else {\r\n          item.reject(new Error('No response for request'))\r\n        }\r\n      })\r\n    }\r\n    catch (error) {\r\n      // 批处理失败，拒绝所有请求\r\n      batch.forEach((item) => {\r\n        item.reject(error)\r\n      })\r\n    }\r\n\r\n    // 如果还有待处理的请求，继续调度\r\n    if (this.pendingBatch.length > 0) {\r\n      this.scheduleBatch()\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 执行批处理请求（需要注入实际的 HTTP 客户端）\r\n   */\r\n  private async executeBatchRequest(_config: RequestConfig): Promise<ResponseData> {\r\n    // 这里应该使用实际的 HTTP 客户端\r\n    // 为了避免循环依赖，这里抛出错误提示用户需要配置\r\n    throw new Error('Batch request executor not configured. Please set a custom requestBuilder.')\r\n  }\r\n\r\n  /**\r\n   * 默认批处理请求构建器\r\n   */\r\n  private defaultRequestBuilder(requests: RequestConfig[]): RequestConfig {\r\n    return {\r\n      method: 'POST',\r\n      url: this.config?.endpoint,\r\n      data: {\r\n        requests: requests.map(req => ({\r\n          method: req.method,\r\n          url: req.url,\r\n          headers: req.headers,\r\n          params: req.params,\r\n          data: req.data,\r\n        })),\r\n      },\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 默认批处理响应解析器\r\n   */\r\n  private defaultResponseParser(response: ResponseData): ResponseData[] {\r\n    const responseData = response.data as any\r\n    if (!responseData || !Array.isArray(responseData.responses)) {\r\n      throw new Error('Invalid batch response format')\r\n    }\r\n\r\n    return responseData.responses.map((res: any) => ({\r\n      data: res.data,\r\n      status: res.status || 200,\r\n      statusText: res.statusText || 'OK',\r\n      headers: res.headers || {},\r\n      config: {} as RequestConfig,\r\n    }))\r\n  }\r\n\r\n  /**\r\n   * 更新统计信息\r\n   */\r\n  private updateStats(): void {\r\n    if (this.stats.batchCount > 0) {\r\n      this.stats.averageBatchSize = this.stats.totalRequests / this.stats.batchCount\r\n      this.stats.efficiency = this.stats.totalRequests > 0\r\n        ? this.stats.savedRequests / this.stats.totalRequests\r\n        : 0\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取统计信息\r\n   */\r\n  getStats(): BatchStats {\r\n    return { ...this.stats }\r\n  }\r\n\r\n  /**\r\n   * 重置统计信息\r\n   */\r\n  resetStats(): void {\r\n    this.stats = {\r\n      totalRequests: 0,\r\n      batchCount: 0,\r\n      savedRequests: 0,\r\n      averageBatchSize: 0,\r\n      efficiency: 0,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取待处理请求数量\r\n   */\r\n  getPendingCount(): number {\r\n    return this.pendingBatch.length\r\n  }\r\n\r\n  /**\r\n   * 清空待处理请求\r\n   */\r\n  clear(): void {\r\n    if (this.batchTimer) {\r\n      clearTimeout(this.batchTimer)\r\n      this.batchTimer = undefined\r\n    }\r\n\r\n    // 拒绝所有待处理的请求\r\n    this.pendingBatch.forEach((item) => {\r\n      item.reject(new Error('Batch cleared'))\r\n    })\r\n\r\n    this.pendingBatch = []\r\n  }\r\n\r\n  /**\r\n   * 更新配置\r\n   */\r\n  updateConfig(config: Partial<BatchConfig>): void {\r\n    Object.assign(this.config, config)\r\n  }\r\n\r\n  /**\r\n   * 销毁批处理管理器\r\n   */\r\n  destroy(): void {\r\n    this.clear()\r\n  }\r\n}\r\n\r\n/**\r\n * 创建批处理管理器\r\n */\r\nexport function createBatchManager(config?: BatchConfig): BatchManager {\r\n  return new BatchManager(config)\r\n}\r\n\r\n"],"names":["BatchManager","constructor","config","this","pendingBatch","stats","totalRequests","batchCount","savedRequests","averageBatchSize","efficiency","windowMs","maxBatchSize","enabled","endpoint","requestBuilder","defaultRequestBuilder","bind","responseParser","defaultResponseParser","add","Error","Promise","resolve","reject","item","timestamp","Date","now","push","length","flush","scheduleBatch","batchTimer","setTimeout","clearTimeout","batch","splice","updateStats","batchRequest","map","batchResponse","executeBatchRequest","responses","forEach","index","error","_config","requests","method","url","data","req","headers","params","response","responseData","Array","isArray","res","status","statusText","getStats","resetStats","getPendingCount","clear","updateConfig","Object","assign","destroy"],"mappings":"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"}
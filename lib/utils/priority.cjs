"use strict";var t;exports.Priority=void 0,(t=exports.Priority||(exports.Priority={}))[t.CRITICAL=0]="CRITICAL",t[t.HIGH=1]="HIGH",t[t.NORMAL=2]="NORMAL",t[t.LOW=3]="LOW",t[t.IDLE=4]="IDLE";class e{constructor(t={}){this.queue=new Map,this.active=new Set,this.stats={totalQueued:0,totalProcessed:0,totalFailed:0,waitTimes:[],processTimes:[]},this.processing=!1,this.lastBoostCheck=0,this.cachedQueueSize=0,this.queueSizeDirty=!0,this.config={maxConcurrent:6,maxQueueSize:100,queueTimeout:3e4,priorityBoost:!0,boostInterval:5e3,...t};for(const t of Object.values(exports.Priority))"number"==typeof t&&this.queue.set(t,[]);this.config?.priorityBoost&&this.startPriorityBoost()}async enqueue(t,e,s=exports.Priority.NORMAL){return new Promise((i,r)=>{if(this.getTotalQueueSize()>=this.config?.maxQueueSize)return void r(new Error("Queue is full"));const o={id:this.generateId(),priority:s,config:t,executor:e,resolve:i,reject:r,timestamp:Date.now(),abortController:new AbortController},n=this.queue.get(s);n&&(n.push(o),this.stats.totalQueued++,this.queueSizeDirty=!0),this.config?.queueTimeout>0&&setTimeout(()=>{this.removeItem(o)&&(o.reject(new Error("Request timeout in queue")),this.stats.totalFailed++)},this.config?.queueTimeout),this.processQueue()})}async processQueue(){if(!this.processing){for(this.processing=!0;this.active.size<this.config?.maxConcurrent;){const t=this.getNextItem();if(!t)break;this.active.add(t.id),this.executeItem(t)}this.processing=!1}}async executeItem(t){const e=Date.now()-t.timestamp;this.stats.waitTimes.push(e);const s=Date.now();try{const e=await t.executor();t.resolve(e),this.stats.totalProcessed++;const i=Date.now()-s;this.stats.processTimes.push(i)}catch(e){t.reject(e),this.stats.totalFailed++}finally{this.active.delete(t.id),this.processQueue()}}getNextItem(){for(const t of[exports.Priority.CRITICAL,exports.Priority.HIGH,exports.Priority.NORMAL,exports.Priority.LOW,exports.Priority.IDLE]){const e=this.queue.get(t);if(e&&e.length>0)return e.shift()}}removeItem(t){const e=this.queue.get(t.priority);if(!e)return!1;const s=e.findIndex(e=>e.id===t.id);return-1!==s&&(e.splice(s,1),!0)}startPriorityBoost(){this.boostTimer=setInterval(()=>{if(0===this.getTotalQueueSize())return;const t=Date.now();t-this.lastBoostCheck<this.config?.boostInterval/2||(this.lastBoostCheck=t,this.performPriorityBoost(t))},2e3)}performPriorityBoost(t){const e=[];for(const[s,i]of this.queue.entries()){if(s===exports.Priority.CRITICAL||0===i.length)continue;const r=this.config?.boostInterval;for(let o=0;o<i.length;o++){const n=i[o];if(t-n.timestamp>r){const t=Math.max(exports.Priority.CRITICAL,s-1);e.push({item:n,from:s,to:t})}}}for(const t of e){const e=this.queue.get(t.from);if(e){const s=e.indexOf(t.item);-1!==s&&(e.splice(s,1),this.queueSizeDirty=!0)}t.item.priority=t.to;const s=this.queue.get(t.to);s&&s.push(t.item)}}cancel(t){for(const[,e]of this.queue.entries()){const s=e.findIndex(e=>e.id===t);if(-1!==s){const t=e[s];return e.splice(s,1),t.reject(new Error("Request cancelled")),t.abortController?.abort(),!0}}return this.active.has(t),!1}cancelAll(t="All requests cancelled"){for(const[,e]of this.queue.entries()){for(const s of e)s.reject(new Error(t)),s.abortController?.abort();e.length=0}}getStats(){const t={};for(const[e,s]of this.queue.entries())t[e]=s.length;const e=this.stats.waitTimes.length>0?this.stats.waitTimes.reduce((t,e)=>t+e,0)/this.stats.waitTimes.length:0,s=this.stats.processTimes.length>0?this.stats.processTimes.reduce((t,e)=>t+e,0)/this.stats.processTimes.length:0;return{totalQueued:this.stats.totalQueued,totalProcessed:this.stats.totalProcessed,totalFailed:this.stats.totalFailed,currentActive:this.active.size,queuedByPriority:t,averageWaitTime:e,averageProcessTime:s}}getTotalQueueSize(){if(!this.queueSizeDirty)return this.cachedQueueSize;let t=0;for(const[,e]of this.queue.entries())t+=e.length;return this.cachedQueueSize=t,this.queueSizeDirty=!1,t}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}destroy(){this.boostTimer&&clearInterval(this.boostTimer),this.cancelAll("Queue destroyed"),this.queue.clear(),this.active.clear()}}exports.PriorityQueue=e,exports.createPriorityQueue=function(t){return new e(t)},exports.determinePriority=function(t){if(void 0!==t.priority)return t.priority;const e=t.url||"";return e.includes("/auth")||e.includes("/login")||e.includes("/token")?exports.Priority.CRITICAL:e.includes("/api")?exports.Priority.HIGH:e.match(/\.(jpg|jpeg|png|gif|css|js)$/i)?exports.Priority.LOW:e.includes("/analytics")||e.includes("/log")?exports.Priority.IDLE:exports.Priority.NORMAL};
//# sourceMappingURL=priority.cjs.map

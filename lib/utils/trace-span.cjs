"use strict";var t,s=require("./index.cjs");exports.SpanType=void 0,(t=exports.SpanType||(exports.SpanType={})).HTTP="http",t.DATABASE="database",t.CACHE="cache",t.CUSTOM="custom",t.MIDDLEWARE="middleware",t.SERVICE="service",t.MESSAGE="message",exports.SpanStatus=void 0,function(t){t.PENDING="pending",t.SUCCESS="success",t.ERROR="error",t.CANCELLED="cancelled",t.TIMEOUT="timeout",t.WARNING="warning"}(exports.SpanStatus||(exports.SpanStatus={}));class e{constructor(t,s,e=exports.SpanType.CUSTOM){this.span={spanId:this.generateSpanId(),traceId:t,name:s,type:e,startTime:Date.now(),status:exports.SpanStatus.PENDING,tags:[],logs:[],events:[],childSpanIds:[]}}setParent(t){return this.span.parentSpanId=t,this}setType(t){return this.span.type=t,this}addTag(t,s){return this.span.tags.push({key:t,value:s}),this}addTags(t){return Object.entries(t).forEach(([t,s])=>{this.addTag(t,s)}),this}setAttribute(t,s){return this.span.attributes||(this.span.attributes={}),this.span.attributes[t]=s,this}setAttributes(t){return this.span.attributes||(this.span.attributes={}),Object.assign(this.span.attributes,t),this}build(){return{...this.span}}generateSpanId(){return`span-${s.generateId()}`}}class a{constructor(t){this.span=t}addTag(t,s){return this.span.tags.push({key:t,value:s}),this}addLog(t,s,e="info"){return this.span.logs.push({timestamp:Date.now(),level:e,message:t,data:s}),this}addEvent(t,s){return this.span.events||(this.span.events=[]),this.span.events.push({name:t,timestamp:Date.now(),attributes:s}),this}setError(t){return this.span.status=exports.SpanStatus.ERROR,"string"==typeof t?this.span.error={message:t}:t instanceof Error?this.span.error={message:t.message,stack:t.stack,type:t.name}:this.span.error=t,this}setStatus(t){return this.span.status=t,this}finish(t){const s=Date.now();this.span.endTime=s,this.span.duration=s-this.span.startTime,void 0!==t?this.span.status=t:this.span.status===exports.SpanStatus.PENDING&&(this.span.status=exports.SpanStatus.SUCCESS)}getSpan(){return this.span}addChildSpanId(t){return this.span.childSpanIds||(this.span.childSpanIds=[]),this.span.childSpanIds.push(t),this}getDuration(){return void 0!==this.span.duration?this.span.duration:this.span.endTime?this.span.endTime-this.span.startTime:Date.now()-this.span.startTime}isFinished(){return void 0!==this.span.endTime}hasError(){return this.span.status===exports.SpanStatus.ERROR||void 0!==this.span.error}}class n{constructor(){this.spans=new Map,this.spansByTrace=new Map,this.childToParent=new Map}add(t){this.spans.set(t.spanId,t),this.spansByTrace.has(t.traceId)||this.spansByTrace.set(t.traceId,new Set),this.spansByTrace.get(t.traceId).add(t.spanId),t.parentSpanId&&this.childToParent.set(t.spanId,t.parentSpanId)}get(t){return this.spans.get(t)}getByTraceId(t){const s=this.spansByTrace.get(t);return s?Array.from(s).map(t=>this.spans.get(t)).filter(t=>void 0!==t):[]}getRootSpans(t){return this.getByTraceId(t).filter(t=>!t.parentSpanId)}getChildSpans(t){const s=[];return this.spans.forEach(e=>{e.parentSpanId===t&&s.push(e)}),s}getSpanPath(t){const s=[];let e=t;for(;e;){const t=this.spans.get(e);if(!t)break;s.unshift(t),e=t.parentSpanId}return s}remove(t){const s=this.spans.get(t);return!!s&&(this.spans.delete(t),this.spansByTrace.get(s.traceId)?.delete(t),this.childToParent.delete(t),!0)}removeByTraceId(t){const s=this.spansByTrace.get(t);if(!s)return 0;let e=0;return s.forEach(t=>{this.remove(t)&&e++}),this.spansByTrace.delete(t),e}clear(){this.spans.clear(),this.spansByTrace.clear(),this.childToParent.clear()}size(){return this.spans.size}traceCount(){return this.spansByTrace.size}buildSpanTree(t){const s=this.getByTraceId(t);return s.filter(t=>!t.parentSpanId).map(t=>this.buildTreeNode(t,s))}buildTreeNode(t,s){const e=s.filter(s=>s.parentSpanId===t.spanId).map(t=>this.buildTreeNode(t,s));return{span:t,children:e}}}exports.SpanBuilder=e,exports.SpanCollection=n,exports.SpanOperator=a,exports.createSpanBuilder=function(t,s,a=exports.SpanType.CUSTOM){return new e(t,s,a)},exports.createSpanCollection=function(){return new n},exports.createSpanOperator=function(t){return new a(t)};
//# sourceMappingURL=trace-span.cjs.map

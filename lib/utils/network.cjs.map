{"version":3,"file":"network.cjs","sources":["../../src/utils/network.ts"],"sourcesContent":["/**\r\n * 网络状态感知\r\n *\r\n * 监听网络状态变化，自动处理离线/在线场景\r\n */\r\n\r\n/**\r\n * 网络状态\r\n */\r\nexport enum NetworkStatus {\r\n /** 在线 */\r\n ONLINE = 'online',\r\n /** 离线 */\r\n OFFLINE = 'offline',\r\n /** 未知 */\r\n UNKNOWN = 'unknown',\r\n}\r\n\r\n/**\r\n * 连接类型\r\n */\r\nexport enum ConnectionType {\r\n /** WiFi */\r\n WIFI = 'wifi',\r\n /** 4G */\r\n CELLULAR_4G = '4g',\r\n /** 3G */\r\n CELLULAR_3G = '3g',\r\n /** 2G */\r\n CELLULAR_2G = '2g',\r\n /** 未知 */\r\n UNKNOWN = 'unknown',\r\n}\r\n\r\n/**\r\n * 网络状态信息\r\n */\r\nexport interface NetworkInfo {\r\n /** 是否在线 */\r\n online: boolean\r\n /** 连接类型 */\r\n connectionType: ConnectionType\r\n /** 是否按流量计费 */\r\n metered: boolean\r\n /** 下行速度(Mbps) */\r\n downlink?: number\r\n /** 往返时间(ms) */\r\n rtt?: number\r\n /** 有效类型 */\r\n effectiveType?: string\r\n}\r\n\r\n/**\r\n * 网络状态监听器配置\r\n */\r\nexport interface NetworkMonitorConfig {\r\n /** 是否启用 */\r\n enabled?: boolean\r\n /** 离线时是否暂停请求 */\r\n pauseOnOffline?: boolean\r\n /** 在线时是否自动重试失败的请求 */\r\n retryOnOnline?: boolean\r\n /** 状态变化回调 */\r\n onStatusChange?: (status: NetworkStatus, info: NetworkInfo) => void\r\n /** 离线回调 */\r\n onOffline?: () => void\r\n /** 在线回调 */\r\n onOnline?: () => void\r\n}\r\n\r\n/**\r\n * 网络状态监听器\r\n *\r\n * @example\r\n * ```typescript\r\n * const monitor = new NetworkMonitor({\r\n *  enabled: true,\r\n *  onStatusChange: (status, info) => {\r\n *   \r\n *  },\r\n *  onOffline: () => {\r\n *   \r\n *  },\r\n *  onOnline: () => {\r\n *   \r\n *  },\r\n * })\r\n *\r\n * monitor.start()\r\n *\r\n * // 获取当前状态\r\n * const info = monitor.getNetworkInfo()\r\n * \r\n * ```\r\n */\r\nexport class NetworkMonitor {\r\n public config: Required<Omit<NetworkMonitorConfig, 'onStatusChange' | 'onOffline' | 'onOnline'>> & Pick<NetworkMonitorConfig, 'onStatusChange' | 'onOffline' | 'onOnline'>\r\n private currentStatus: NetworkStatus = NetworkStatus.UNKNOWN\r\n private listeners: Array<() => void> = []\r\n private isMonitoring: boolean = false\r\n\r\n constructor(config: NetworkMonitorConfig = {}) {\r\n  this.config = {\r\n   enabled: config.enabled ?? true,\r\n   pauseOnOffline: config.pauseOnOffline ?? true,\r\n   retryOnOnline: config.retryOnOnline ?? true,\r\n   onStatusChange: config.onStatusChange,\r\n   onOffline: config.onOffline,\r\n   onOnline: config.onOnline,\r\n  }\r\n\r\n  // 初始化当前状态\r\n  this.updateStatus()\r\n }\r\n\r\n /**\r\n  * 开始监听\r\n  */\r\n start(): void {\r\n  if (!this.config?.enabled || this.isMonitoring) {\r\n   return\r\n  }\r\n\r\n  if (typeof window === 'undefined') {\r\n   return\r\n  }\r\n\r\n  this.isMonitoring = true\r\n\r\n  // 监听online事件\r\n  const handleOnline = () => {\r\n   this.handleStatusChange(NetworkStatus.ONLINE)\r\n   this.config?.onOnline?.()\r\n  }\r\n\r\n  // 监听offline事件\r\n  const handleOffline = () => {\r\n   this.handleStatusChange(NetworkStatus.OFFLINE)\r\n   this.config?.onOffline?.()\r\n  }\r\n\r\n  window.addEventListener('online', handleOnline)\r\n  window.addEventListener('offline', handleOffline)\r\n\r\n  // 保存监听器以便清理\r\n  this.listeners.push(\r\n   () => window.removeEventListener('online', handleOnline),\r\n   () => window.removeEventListener('offline', handleOffline),\r\n  )\r\n\r\n  // 如果支持Network Information API,也监听连接变化\r\n  if ('connection' in navigator || 'mozConnection' in navigator || 'webkitConnection' in navigator) {\r\n   const connection = (navigator as any).connection || (navigator as any).mozConnection || (navigator as any).webkitConnection\r\n\r\n   const handleConnectionChange = () => {\r\n    this.updateStatus()\r\n   }\r\n\r\n   connection.addEventListener('change', handleConnectionChange)\r\n   this.listeners.push(() => connection.removeEventListener('change', handleConnectionChange))\r\n  }\r\n }\r\n\r\n /**\r\n  * 停止监听\r\n  */\r\n stop(): void {\r\n  if (!this.isMonitoring) {\r\n   return\r\n  }\r\n\r\n  this.isMonitoring = false\r\n\r\n  // 清理所有监听器\r\n  this.listeners.forEach(cleanup => cleanup())\r\n  this.listeners = []\r\n }\r\n\r\n /**\r\n  * 获取当前网络状态\r\n  */\r\n getStatus(): NetworkStatus {\r\n  return this.currentStatus\r\n }\r\n\r\n /**\r\n  * 是否在线\r\n  */\r\n isOnline(): boolean {\r\n  return this.currentStatus === NetworkStatus.ONLINE\r\n }\r\n\r\n /**\r\n  * 是否离线\r\n  */\r\n isOffline(): boolean {\r\n  return this.currentStatus === NetworkStatus.OFFLINE\r\n }\r\n\r\n /**\r\n  * 获取网络信息\r\n  */\r\n getNetworkInfo(): NetworkInfo {\r\n  const info: NetworkInfo = {\r\n   online: this.isOnline(),\r\n   connectionType: ConnectionType.UNKNOWN,\r\n   metered: false,\r\n  }\r\n\r\n  if (typeof navigator === 'undefined') {\r\n   return info\r\n  }\r\n\r\n  // 获取连接信息\r\n  const connection = (navigator as any).connection || (navigator as any).mozConnection || (navigator as any).webkitConnection\r\n\r\n  if (connection) {\r\n   // 连接类型\r\n   if (connection.effectiveType) {\r\n    info.effectiveType = connection.effectiveType\r\n    info.connectionType = this.parseConnectionType(connection.effectiveType)\r\n   }\r\n\r\n   // 是否按流量计费\r\n   if (typeof connection.saveData === 'boolean') {\r\n    info.metered = connection.saveData\r\n   }\r\n\r\n   // 下行速度\r\n   if (typeof connection.downlink === 'number') {\r\n    info.downlink = connection.downlink\r\n   }\r\n\r\n   // 往返时间\r\n   if (typeof connection.rtt === 'number') {\r\n    info.rtt = connection.rtt\r\n   }\r\n  }\r\n\r\n  return info\r\n }\r\n\r\n /**\r\n  * 处理状态变化\r\n  */\r\n private handleStatusChange(newStatus: NetworkStatus): void {\r\n  if (this.currentStatus === newStatus) {\r\n   return\r\n  }\r\n\r\n  this.currentStatus = newStatus\r\n  const info = this.getNetworkInfo()\r\n\r\n  // 触发回调\r\n  this.config?.onStatusChange?.(newStatus, info)\r\n }\r\n\r\n /**\r\n  * 更新状态\r\n  */\r\n private updateStatus(): void {\r\n  if (typeof navigator !== 'undefined' && 'onLine' in navigator) {\r\n   this.currentStatus = navigator.onLine ? NetworkStatus.ONLINE : NetworkStatus.OFFLINE\r\n  }\r\n  else {\r\n   this.currentStatus = NetworkStatus.UNKNOWN\r\n  }\r\n }\r\n\r\n /**\r\n  * 解析连接类型\r\n  */\r\n private parseConnectionType(effectiveType: string): ConnectionType {\r\n  switch (effectiveType.toLowerCase()) {\r\n   case '4g':\r\n    return ConnectionType.CELLULAR_4G\r\n   case '3g':\r\n    return ConnectionType.CELLULAR_3G\r\n   case '2g':\r\n    return ConnectionType.CELLULAR_2G\r\n   case 'wifi':\r\n    return ConnectionType.WIFI\r\n   default:\r\n    return ConnectionType.UNKNOWN\r\n  }\r\n }\r\n\r\n /**\r\n  * 判断当前网络是否适合大文件传输\r\n  */\r\n isSuitableForLargeTransfer(): boolean {\r\n  const info = this.getNetworkInfo()\r\n\r\n  // 离线不适合\r\n  if (!info.online) {\r\n   return false\r\n  }\r\n\r\n  // 按流量计费不适合\r\n  if (info.metered) {\r\n   return false\r\n  }\r\n\r\n  // 2G/3G网络不适合\r\n  if (\r\n   info.connectionType === ConnectionType.CELLULAR_2G\r\n   || info.connectionType === ConnectionType.CELLULAR_3G\r\n  ) {\r\n   return false\r\n  }\r\n\r\n  // 下行速度太慢不适合 (< 1 Mbps)\r\n  if (info.downlink && info.downlink < 1) {\r\n   return false\r\n  }\r\n\r\n  return true\r\n }\r\n\r\n /**\r\n  * 销毁监听器\r\n  */\r\n destroy(): void {\r\n  this.stop()\r\n }\r\n}\r\n\r\n/**\r\n * 创建网络状态监听器\r\n */\r\nexport function createNetworkMonitor(config?: NetworkMonitorConfig): NetworkMonitor {\r\n return new NetworkMonitor(config)\r\n}\r\n\r\n/**\r\n * 全局网络状态监听器\r\n */\r\nexport const globalNetworkMonitor = new NetworkMonitor()\r\n\r\n// 自动启动全局监听器\r\nif (typeof window !== 'undefined') {\r\n globalNetworkMonitor.start()\r\n}\r\n\r\n/**\r\n * 网络状态拦截器\r\n *\r\n * 在离线时阻止请求，在线时自动重试\r\n */\r\nexport function createNetworkInterceptor(config?: NetworkMonitorConfig) {\r\n const monitor = new NetworkMonitor(config)\r\n monitor.start()\r\n\r\n const pendingRequests: Array<{ config: any, resolve: any, reject: any }> = []\r\n\r\n // 在线时处理待处理的请求\r\n monitor.start()\r\n\r\n return {\r\n  request: {\r\n   onFulfilled: async (requestConfig: any) => {\r\n    // 检查网络状态\r\n    if (monitor.isOffline()) {\r\n     // 如果配置了离线暂停，将请求加入队列\r\n     if (monitor.config.pauseOnOffline) {\r\n      return new Promise((resolve, reject) => {\r\n       pendingRequests.push({\r\n        config: requestConfig,\r\n        resolve,\r\n        reject,\r\n       })\r\n\r\n       // 监听网络恢复\r\n       const checkOnline = () => {\r\n        if (monitor.isOnline()) {\r\n         // 网络恢复，处理待处理的请求\r\n         const pending = pendingRequests.shift()\r\n         if (pending) {\r\n          resolve(pending.config)\r\n         }\r\n        }\r\n       }\r\n\r\n       const timer = setInterval(checkOnline, 1000)\r\n\r\n       // 5分钟超时\r\n       setTimeout(() => {\r\n        clearInterval(timer)\r\n        const index = pendingRequests.findIndex(p => p.config === requestConfig)\r\n        if (index !== -1) {\r\n         pendingRequests.splice(index, 1)\r\n         reject(new Error('Network timeout: request cancelled after 5 minutes'))\r\n        }\r\n       }, 5 * 60 * 1000)\r\n      })\r\n     }\r\n\r\n     // 否则直接抛出错误\r\n     throw new Error('Network is offline')\r\n    }\r\n\r\n    return requestConfig\r\n   },\r\n  },\r\n\r\n  destroy: () => {\r\n   monitor.destroy()\r\n  },\r\n }\r\n}\r\n\r\n/**\r\n * 便捷函数: 等待网络恢复\r\n */\r\nexport function waitForOnline(timeout = 60000): Promise<void> {\r\n return new Promise((resolve, reject) => {\r\n  if (globalNetworkMonitor.isOnline()) {\r\n   resolve()\r\n   return\r\n  }\r\n\r\n  const timer = setTimeout(() => {\r\n   reject(new Error('Timeout waiting for network'))\r\n  }, timeout)\r\n\r\n  const checkOnline = () => {\r\n   if (globalNetworkMonitor.isOnline()) {\r\n    clearTimeout(timer)\r\n    resolve()\r\n   }\r\n  }\r\n\r\n  const interval = setInterval(checkOnline, 1000)\r\n\r\n  setTimeout(() => clearInterval(interval), timeout)\r\n })\r\n}\r\n"],"names":["NetworkStatus","ONLINE","OFFLINE","UNKNOWN","ConnectionType","WIFI","CELLULAR_4G","CELLULAR_3G","CELLULAR_2G","NetworkMonitor","constructor","config","this","currentStatus","listeners","isMonitoring","enabled","pauseOnOffline","retryOnOnline","onStatusChange","onOffline","onOnline","updateStatus","start","window","handleOnline","handleStatusChange","handleOffline","addEventListener","push","removeEventListener","navigator","connection","mozConnection","webkitConnection","handleConnectionChange","stop","forEach","cleanup","getStatus","isOnline","isOffline","getNetworkInfo","info","online","connectionType","metered","effectiveType","parseConnectionType","saveData","downlink","rtt","newStatus","onLine","toLowerCase","isSuitableForLargeTransfer","destroy","globalNetworkMonitor","monitor","pendingRequests","request","onFulfilled","async","Promise","resolve","reject","requestConfig","timer","setInterval","pending","shift","setTimeout","clearInterval","index","findIndex","p","splice","Error","timeout","interval","clearTimeout"],"mappings":"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"}
{"version":3,"file":"memory.cjs","sources":["../../src/utils/memory.ts"],"sourcesContent":["/**\n * 内存监控和管理功能\n * 监控内存使用情况，防止内存泄漏\n */\nimport process from 'node:process'\n\n/**\n * 内存监控配置\n */\nexport interface MemoryMonitorConfig {\n  /** 是否启用监控 */\n  enabled?: boolean\n  /** 监控间隔（毫秒） */\n  interval?: number\n  /** 内存警告阈值（MB） */\n  warningThreshold?: number\n  /** 内存危险阈值（MB） */\n  dangerThreshold?: number\n  /** 自动清理 */\n  autoCleanup?: boolean\n  /** 清理回调 */\n  onCleanup?: () => void\n  /** 警告回调 */\n  onWarning?: (usage: MemoryUsage) => void\n  /** 危险回调 */\n  onDanger?: (usage: MemoryUsage) => void\n}\n\n/**\n * 内存使用情况\n */\nexport interface MemoryUsage {\n  /** 已使用内存（MB） */\n  used: number\n  /** 总内存（MB） */\n  total: number\n  /** 使用率 */\n  percentage: number\n  /** 时间戳 */\n  timestamp: number\n}\n\n/**\n * 内存统计\n */\nexport interface MemoryStats {\n  /** 当前内存使用 */\n  current: MemoryUsage\n  /** 峰值内存使用 */\n  peak: MemoryUsage\n  /** 平均内存使用 */\n  average: number\n  /** 警告次数 */\n  warningCount: number\n  /** 危险次数 */\n  dangerCount: number\n  /** 清理次数 */\n  cleanupCount: number\n}\n\n/**\n * 内存监控管理器\n * \n * 功能：\n * 1. 实时监控内存使用\n * 2. 内存使用预警\n * 3. 自动清理机制\n * 4. 内存使用统计\n */\nexport class MemoryMonitor {\n  private config: Required<Omit<MemoryMonitorConfig, 'onCleanup' | 'onWarning' | 'onDanger'>> & Pick<MemoryMonitorConfig, 'onCleanup' | 'onWarning' | 'onDanger'>\n  private monitorTimer?: ReturnType<typeof setInterval>\n  private usageHistory: MemoryUsage[] = []\n  private stats: MemoryStats = {\n    current: { used: 0, total: 0, percentage: 0, timestamp: Date.now() },\n    peak: { used: 0, total: 0, percentage: 0, timestamp: Date.now() },\n    average: 0,\n    warningCount: 0,\n    dangerCount: 0,\n    cleanupCount: 0,\n  }\n\n  constructor(config: MemoryMonitorConfig = {}) {\n    this.config = {\n      enabled: config.enabled ?? true,\n      interval: config.interval ?? 10000, // 10秒\n      warningThreshold: config.warningThreshold ?? 100, // 100MB\n      dangerThreshold: config.dangerThreshold ?? 200, // 200MB\n      autoCleanup: config.autoCleanup ?? true,\n      onCleanup: config.onCleanup,\n      onWarning: config.onWarning,\n      onDanger: config.onDanger,\n    }\n\n    if (this.config?.enabled) {\n      this.start()\n    }\n  }\n\n  /**\n   * 启动监控\n   */\n  start(): void {\n    if (this.monitorTimer) {\n      return\n    }\n\n    this.monitorTimer = setInterval(() => {\n      this.check()\n    }, this.config?.interval)\n\n    // 立即执行一次检查\n    this.check()\n  }\n\n  /**\n   * 停止监控\n   */\n  stop(): void {\n    if (this.monitorTimer) {\n      clearInterval(this.monitorTimer)\n      this.monitorTimer = undefined\n    }\n  }\n\n  /**\n   * 检查内存使用\n   */\n  private check(): void {\n    const usage = this.getMemoryUsage()\n    \n    // 更新当前使用情况\n    this.stats.current = usage\n\n    // 更新峰值\n    if (usage.used > this.stats.peak.used) {\n      this.stats.peak = usage\n    }\n\n    // 记录历史\n    this.usageHistory.push(usage)\n    if (this.usageHistory.length > 100) {\n      this.usageHistory.shift()\n    }\n\n    // 计算平均值\n    this.stats.average = this.usageHistory.reduce((sum, u) => sum + u.used, 0) / this.usageHistory.length\n\n    // 检查阈值\n    if (usage.used >= this.config?.dangerThreshold) {\n      this.stats.dangerCount++\n      this.config?.onDanger?.(usage)\n      \n      if (this.config?.autoCleanup) {\n        this.cleanup()\n      }\n    }\n    else if (usage.used >= this.config?.warningThreshold) {\n      this.stats.warningCount++\n      this.config?.onWarning?.(usage)\n    }\n  }\n\n  /**\n   * 获取内存使用情况\n   */\n  private getMemoryUsage(): MemoryUsage {\n    let used = 0\n    let total = 0\n\n    // 浏览器环境\n    if (typeof performance !== 'undefined' && (performance as any).memory) {\n      const memory = (performance as any).memory\n      used = memory.usedJSHeapSize / 1024 / 1024 // 转换为 MB\n      total = memory.totalJSHeapSize / 1024 / 1024\n    }\n    // Node.js 环境\n    else if (typeof process !== 'undefined' && process.memoryUsage) {\n      const memory = process.memoryUsage()\n      used = memory.heapUsed / 1024 / 1024\n      total = memory.heapTotal / 1024 / 1024\n    }\n\n    return {\n      used,\n      total,\n      percentage: total > 0 ? (used / total) * 100 : 0,\n      timestamp: Date.now(),\n    }\n  }\n\n  /**\n   * 执行清理\n   */\n  private cleanup(): void {\n    this.stats.cleanupCount++\n    this.config?.onCleanup?.()\n\n    // 触发垃圾回收（如果可用）\n    if (typeof globalThis !== 'undefined' && (globalThis as any).gc) {\n      try {\n        (globalThis as any).gc()\n      }\n      catch {\n        // 忽略错误\n      }\n    }\n  }\n\n  /**\n   * 获取统计信息\n   */\n  getStats(): MemoryStats {\n    return { ...this.stats }\n  }\n\n  /**\n   * 获取使用历史\n   */\n  getHistory(): MemoryUsage[] {\n    return [...this.usageHistory]\n  }\n\n  /**\n   * 重置统计\n   */\n  resetStats(): void {\n    this.stats = {\n      current: this.stats.current,\n      peak: { used: 0, total: 0, percentage: 0, timestamp: Date.now() },\n      average: 0,\n      warningCount: 0,\n      dangerCount: 0,\n      cleanupCount: 0,\n    }\n    this.usageHistory = []\n  }\n\n  /**\n   * 销毁监控器\n   */\n  destroy(): void {\n    this.stop()\n    this.usageHistory = []\n  }\n}\n\n/**\n * 创建内存监控器\n */\nexport function createMemoryMonitor(config?: MemoryMonitorConfig): MemoryMonitor {\n  return new MemoryMonitor(config)\n}\n\n/**\n * 全局内存监控器实例\n */\nexport const globalMemoryMonitor = createMemoryMonitor({\n  enabled: false, // 默认禁用，需要手动启用\n})\n\n/**\n * 内存清理工具\n */\nexport class MemoryCleaner {\n  private cleanupHandlers: Array<() => void> = []\n\n  /**\n   * 注册清理处理器\n   */\n  register(handler: () => void): () => void {\n    this.cleanupHandlers.push(handler)\n    \n    // 返回取消注册函数\n    return () => {\n      const index = this.cleanupHandlers.indexOf(handler)\n      if (index > -1) {\n        this.cleanupHandlers.splice(index, 1)\n      }\n    }\n  }\n\n  /**\n   * 执行所有清理处理器\n   */\n  cleanup(): void {\n    this.cleanupHandlers.forEach((handler) => {\n      try {\n        handler()\n      }\n      catch (error) {\n        console.error('Cleanup handler error:', error)\n      }\n    })\n  }\n\n  /**\n   * 清空所有处理器\n   */\n  clear(): void {\n    this.cleanupHandlers = []\n  }\n}\n\n/**\n * 全局内存清理器实例\n */\nexport const globalMemoryCleaner = new MemoryCleaner()\n\n"],"names":["MemoryMonitor","constructor","config","this","usageHistory","stats","current","used","total","percentage","timestamp","Date","now","peak","average","warningCount","dangerCount","cleanupCount","enabled","interval","warningThreshold","dangerThreshold","autoCleanup","onCleanup","onWarning","onDanger","start","monitorTimer","setInterval","check","stop","clearInterval","usage","getMemoryUsage","push","length","shift","reduce","sum","u","cleanup","performance","memory","usedJSHeapSize","totalJSHeapSize","process","memoryUsage","heapUsed","heapTotal","globalThis","gc","getStats","getHistory","resetStats","destroy","createMemoryMonitor","globalMemoryMonitor","MemoryCleaner","cleanupHandlers","register","handler","index","indexOf","splice","forEach","error","clear","globalMemoryCleaner"],"mappings":"iDAqEaA,EAaX,WAAAC,CAAYC,EAA8B,IAVlCC,KAAAC,aAA8B,GAC9BD,KAAAE,MAAqB,CAC3BC,QAAS,CAAEC,KAAM,EAAGC,MAAO,EAAGC,WAAY,EAAGC,UAAWC,KAAKC,OAC7DC,KAAM,CAAEN,KAAM,EAAGC,MAAO,EAAGC,WAAY,EAAGC,UAAWC,KAAKC,OAC1DE,QAAS,EACTC,aAAc,EACdC,YAAa,EACbC,aAAc,GAIdd,KAAKD,OAAS,CACZgB,QAAShB,EAAOgB,UAAW,EAC3BC,SAAUjB,EAAOiB,UAAY,IAC7BC,iBAAkBlB,EAAOkB,kBAAoB,IAC7CC,gBAAiBnB,EAAOmB,iBAAmB,IAC3CC,YAAapB,EAAOoB,cAAe,EACnCC,UAAWrB,EAAOqB,UAClBC,UAAWtB,EAAOsB,UAClBC,SAAUvB,EAAOuB,UAGftB,KAAKD,QAAQgB,SACff,KAAKuB,OAET,CAKA,KAAAA,GACMvB,KAAKwB,eAITxB,KAAKwB,aAAeC,YAAY,KAC9BzB,KAAK0B,SACJ1B,KAAKD,QAAQiB,UAGhBhB,KAAK0B,QACP,CAKA,IAAAC,GACM3B,KAAKwB,eACPI,cAAc5B,KAAKwB,cACnBxB,KAAKwB,kBAAe,EAExB,CAKQ,KAAAE,GACN,MAAMG,EAAQ7B,KAAK8B,iBAGnB9B,KAAKE,MAAMC,QAAU0B,EAGjBA,EAAMzB,KAAOJ,KAAKE,MAAMQ,KAAKN,OAC/BJ,KAAKE,MAAMQ,KAAOmB,GAIpB7B,KAAKC,aAAa8B,KAAKF,GACnB7B,KAAKC,aAAa+B,OAAS,KAC7BhC,KAAKC,aAAagC,QAIpBjC,KAAKE,MAAMS,QAAUX,KAAKC,aAAaiC,OAAO,CAACC,EAAKC,IAAMD,EAAMC,EAAEhC,KAAM,GAAKJ,KAAKC,aAAa+B,OAG3FH,EAAMzB,MAAQJ,KAAKD,QAAQmB,iBAC7BlB,KAAKE,MAAMW,cACXb,KAAKD,QAAQuB,WAAWO,GAEpB7B,KAAKD,QAAQoB,aACfnB,KAAKqC,WAGAR,EAAMzB,MAAQJ,KAAKD,QAAQkB,mBAClCjB,KAAKE,MAAMU,eACXZ,KAAKD,QAAQsB,YAAYQ,GAE7B,CAKQ,cAAAC,GACN,IAAI1B,EAAO,EACPC,EAAQ,EAGZ,UAAWiC,YAAgB,KAAgBA,YAAoBC,OAAQ,CACrE,MAAMA,EAAUD,YAAoBC,OACpCnC,EAAOmC,EAAOC,eAAiB,KAAO,KACtCnC,EAAQkC,EAAOE,gBAAkB,KAAO,IAC1C,MAAA,UAEgBC,EAAY,KAAeA,EAAQC,YAAa,CAC9D,MAAMJ,EAASG,EAAQC,cACvBvC,EAAOmC,EAAOK,SAAW,KAAO,KAChCvC,EAAQkC,EAAOM,UAAY,KAAO,IACpC,CAEA,MAAO,CACLzC,KAAAA,EACAC,MAAAA,EACAC,WAAYD,EAAQ,EAAKD,EAAOC,EAAS,IAAM,EAC/CE,UAAWC,KAAKC,MAEpB,CAKQ,OAAA4B,GAKN,GAJArC,KAAKE,MAAMY,eACXd,KAAKD,QAAQqB,qBAGF0B,WAAe,KAAgBA,WAAmBC,GAC3D,IACGD,WAAmBC,IACtB,CAAA,MAGA,CAEJ,CAKA,QAAAC,GACE,MAAO,IAAKhD,KAAKE,MACnB,CAKA,UAAA+C,GACE,MAAO,IAAIjD,KAAKC,aAClB,CAKA,UAAAiD,GACElD,KAAKE,MAAQ,CACXC,QAASH,KAAKE,MAAMC,QACpBO,KAAM,CAAEN,KAAM,EAAGC,MAAO,EAAGC,WAAY,EAAGC,UAAWC,KAAKC,OAC1DE,QAAS,EACTC,aAAc,EACdC,YAAa,EACbC,aAAc,GAEhBd,KAAKC,aAAe,EACtB,CAKA,OAAAkD,GACEnD,KAAK2B,OACL3B,KAAKC,aAAe,EACtB,EAMI,SAAUmD,EAAoBrD,GAClC,OAAO,IAAIF,EAAcE,EAC3B,OAKasD,EAAsBD,EAAoB,CACrDrC,SAAS,UAMEuC,EAAb,WAAAxD,GACUE,KAAAuD,gBAAqC,EAqC/C,CAhCE,QAAAC,CAASC,GACP,OAAAzD,KAAKuD,gBAAgBxB,KAAK0B,GAGnB,KACL,MAAMC,EAAQ1D,KAAKuD,gBAAgBI,QAAQF,GACvCC,GAAQ,GACV1D,KAAKuD,gBAAgBK,OAAOF,EAAO,GAGzC,CAKA,OAAArB,GACErC,KAAKuD,gBAAgBM,QAASJ,IAC5B,IACEA,GACF,CAAA,MACOK,GAEP,GAEJ,CAKA,KAAAC,GACE/D,KAAKuD,gBAAkB,EACzB,EAMK,MAAMS,EAAsB,IAAIV"}
{"version":3,"file":"error-analyzer.cjs","sources":["../../src/utils/error-analyzer.ts"],"sourcesContent":["/**\r\n * 错误分析器模块\r\n * \r\n * 提供错误模式分析和建议生成功能\r\n */\r\n\r\nimport type { HttpError } from '../types'\r\n\r\n/**\r\n * 错误模式类型\r\n */\r\nexport type ErrorPatternType = \r\n  | 'network_errors'\r\n  | 'timeout_errors'\r\n  | 'auth_errors'\r\n  | 'server_errors'\r\n  | 'client_errors'\r\n  | 'rate_limit_errors'\r\n  | 'permission_errors'\r\n\r\n/**\r\n * 错误模式分析结果\r\n */\r\nexport interface ErrorPattern {\r\n  type: string\r\n  count: number\r\n  percentage: number\r\n  description: string\r\n}\r\n\r\n/**\r\n * 错误分析结果\r\n */\r\nexport interface ErrorAnalysisResult {\r\n  patterns: ErrorPattern[]\r\n  recommendations: string[]\r\n  summary: {\r\n    totalErrors: number\r\n    uniqueEndpoints: number\r\n    timeRange: { start: number; end: number }\r\n    mostFrequentError?: { type: string; count: number }\r\n  }\r\n}\r\n\r\n/**\r\n * 错误分析器\r\n */\r\nexport class ErrorAnalyzer {\r\n  private static readonly patternDescriptions: Record<string, string> = {\r\n    network_errors: '网络连接问题，可能是网络不稳定或服务器不可达',\r\n    timeout_errors: '请求超时，可能是网络延迟高或服务器响应慢',\r\n    auth_errors: '认证失败，可能是令牌过期或权限不足',\r\n    server_errors: '服务器内部错误，可能是服务器故障或过载',\r\n    client_errors: '客户端请求错误，可能是参数错误或请求格式不正确',\r\n    rate_limit_errors: '请求频率超限，需要降低请求频率',\r\n    permission_errors: '权限不足，需要检查用户权限配置',\r\n  }\r\n\r\n  /**\r\n   * 分析错误模式\r\n   */\r\n  static analyzeErrorPatterns(errors: HttpError[]): ErrorAnalysisResult {\r\n    if (errors.length === 0) {\r\n      return {\r\n        patterns: [],\r\n        recommendations: [],\r\n        summary: {\r\n          totalErrors: 0,\r\n          uniqueEndpoints: 0,\r\n          timeRange: { start: Date.now(), end: Date.now() },\r\n        },\r\n      }\r\n    }\r\n\r\n    const patterns: Record<string, number> = {}\r\n    const endpoints = new Set<string>()\r\n    let minTime = Number.MAX_SAFE_INTEGER\r\n    let maxTime = 0\r\n    const total = errors.length\r\n\r\n    // 分析错误模式\r\n    errors.forEach((error) => {\r\n      // 记录端点\r\n      if (error.config?.url) {\r\n        endpoints.add(error.config.url)\r\n      }\r\n\r\n      // 记录时间范围\r\n      const timestamp = (error as any).timestamp || Date.now()\r\n      minTime = Math.min(minTime, timestamp)\r\n      maxTime = Math.max(maxTime, timestamp)\r\n\r\n      // 分类错误\r\n      if (error.isNetworkError) {\r\n        patterns.network_errors = (patterns.network_errors || 0) + 1\r\n      }\r\n\r\n      if (error.isTimeoutError) {\r\n        patterns.timeout_errors = (patterns.timeout_errors || 0) + 1\r\n      }\r\n\r\n      const status = error.response?.status\r\n      if (status) {\r\n        if (status === 401) {\r\n          patterns.auth_errors = (patterns.auth_errors || 0) + 1\r\n        }\r\n        else if (status === 403) {\r\n          patterns.permission_errors = (patterns.permission_errors || 0) + 1\r\n        }\r\n        else if (status === 429) {\r\n          patterns.rate_limit_errors = (patterns.rate_limit_errors || 0) + 1\r\n        }\r\n        else if (status >= 500) {\r\n          patterns.server_errors = (patterns.server_errors || 0) + 1\r\n        }\r\n        else if (status >= 400 && status < 500) {\r\n          patterns.client_errors = (patterns.client_errors || 0) + 1\r\n        }\r\n      }\r\n    })\r\n\r\n    // 转换为分析结果\r\n    const analysisPatterns = Object.entries(patterns).map(([type, count]) => ({\r\n      type,\r\n      count,\r\n      percentage: Math.round((count / total) * 100),\r\n      description: this.getPatternDescription(type),\r\n    }))\r\n\r\n    // 按出现次数排序\r\n    analysisPatterns.sort((a, b) => b.count - a.count)\r\n\r\n    // 找出最频繁的错误\r\n    const mostFrequentError = analysisPatterns[0]\r\n      ? { type: analysisPatterns[0].type, count: analysisPatterns[0].count }\r\n      : undefined\r\n\r\n    // 生成建议\r\n    const recommendations = this.generateRecommendations(patterns, total)\r\n\r\n    return {\r\n      patterns: analysisPatterns,\r\n      recommendations,\r\n      summary: {\r\n        totalErrors: total,\r\n        uniqueEndpoints: endpoints.size,\r\n        timeRange: { start: minTime, end: maxTime },\r\n        mostFrequentError,\r\n      },\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取模式描述\r\n   */\r\n  private static getPatternDescription(type: string): string {\r\n    return this.patternDescriptions[type] || '未知错误模式'\r\n  }\r\n\r\n  /**\r\n   * 生成建议\r\n   */\r\n  private static generateRecommendations(\r\n    patterns: Record<string, number>,\r\n    total: number,\r\n  ): string[] {\r\n    const recommendations: string[] = []\r\n\r\n    // 网络错误建议\r\n    if (patterns.network_errors > total * 0.3) {\r\n      recommendations.push(\r\n        '检测到大量网络错误，建议：\\n' +\r\n        '1. 检查网络连接稳定性\\n' +\r\n        '2. 验证服务器地址是否正确\\n' +\r\n        '3. 考虑实现离线模式或缓存策略'\r\n      )\r\n    }\r\n\r\n    // 超时错误建议\r\n    if (patterns.timeout_errors > total * 0.2) {\r\n      recommendations.push(\r\n        '检测到频繁超时，建议：\\n' +\r\n        '1. 增加请求超时时间\\n' +\r\n        '2. 优化服务器响应性能\\n' +\r\n        '3. 实现请求重试机制'\r\n      )\r\n    }\r\n\r\n    // 认证错误建议\r\n    if (patterns.auth_errors > total * 0.2) {\r\n      recommendations.push(\r\n        '检测到认证问题，建议：\\n' +\r\n        '1. 实现令牌自动刷新机制\\n' +\r\n        '2. 检查令牌有效期设置\\n' +\r\n        '3. 优化登录流程'\r\n      )\r\n    }\r\n\r\n    // 服务器错误建议\r\n    if (patterns.server_errors > total * 0.3) {\r\n      recommendations.push(\r\n        '检测到服务器问题，建议：\\n' +\r\n        '1. 检查服务器日志\\n' +\r\n        '2. 监控服务器资源使用\\n' +\r\n        '3. 实现服务降级策略'\r\n      )\r\n    }\r\n\r\n    // 限流错误建议\r\n    if (patterns.rate_limit_errors > 5) {\r\n      recommendations.push(\r\n        '检测到请求限流，建议：\\n' +\r\n        '1. 实现请求队列和节流\\n' +\r\n        '2. 使用批量API减少请求数\\n' +\r\n        '3. 优化客户端缓存策略'\r\n      )\r\n    }\r\n\r\n    // 权限错误建议\r\n    if (patterns.permission_errors > total * 0.1) {\r\n      recommendations.push(\r\n        '检测到权限问题，建议：\\n' +\r\n        '1. 检查用户权限配置\\n' +\r\n        '2. 验证API访问权限\\n' +\r\n        '3. 优化权限错误提示'\r\n      )\r\n    }\r\n\r\n    // 客户端错误建议\r\n    if (patterns.client_errors > total * 0.4) {\r\n      recommendations.push(\r\n        '检测到大量客户端错误，建议：\\n' +\r\n        '1. 检查请求参数验证\\n' +\r\n        '2. 优化表单验证逻辑\\n' +\r\n        '3. 改进错误提示信息'\r\n      )\r\n    }\r\n\r\n    // 如果没有特定建议，提供通用建议\r\n    if (recommendations.length === 0) {\r\n      recommendations.push(\r\n        '建议实施以下通用优化：\\n' +\r\n        '1. 启用请求重试机制\\n' +\r\n        '2. 实现错误监控和告警\\n' +\r\n        '3. 优化错误处理和用户提示'\r\n      )\r\n    }\r\n\r\n    return recommendations\r\n  }\r\n\r\n  /**\r\n   * 生成错误报告\r\n   */\r\n  static generateErrorReport(errors: HttpError[]): string {\r\n    const analysis = this.analyzeErrorPatterns(errors)\r\n    \r\n    let report = '# 错误分析报告\\n\\n'\r\n    \r\n    // 摘要\r\n    report += '## 摘要\\n'\r\n    report += `- 总错误数: ${analysis.summary.totalErrors}\\n`\r\n    report += `- 影响端点数: ${analysis.summary.uniqueEndpoints}\\n`\r\n    \r\n    if (analysis.summary.timeRange) {\r\n      const duration = analysis.summary.timeRange.end - analysis.summary.timeRange.start\r\n      const hours = Math.floor(duration / (1000 * 60 * 60))\r\n      report += `- 时间跨度: ${hours}小时\\n`\r\n    }\r\n    \r\n    if (analysis.summary.mostFrequentError) {\r\n      report += `- 最频繁错误: ${analysis.summary.mostFrequentError.type} (${analysis.summary.mostFrequentError.count}次)\\n`\r\n    }\r\n    \r\n    report += '\\n'\r\n    \r\n    // 错误模式\r\n    if (analysis.patterns.length > 0) {\r\n      report += '## 错误模式\\n'\r\n      analysis.patterns.forEach(pattern => {\r\n        report += `- **${pattern.type}** (${pattern.count}次, ${pattern.percentage}%): ${pattern.description}\\n`\r\n      })\r\n      report += '\\n'\r\n    }\r\n    \r\n    // 建议\r\n    if (analysis.recommendations.length > 0) {\r\n      report += '## 优化建议\\n'\r\n      analysis.recommendations.forEach((rec, index) => {\r\n        report += `### ${index + 1}. ${rec}\\n`\r\n      })\r\n    }\r\n    \r\n    return report\r\n  }\r\n\r\n  /**\r\n   * 预测错误趋势\r\n   */\r\n  static predictErrorTrend(errors: HttpError[]): {\r\n    trend: 'increasing' | 'decreasing' | 'stable'\r\n    rate: number\r\n  } {\r\n    if (errors.length < 2) {\r\n      return { trend: 'stable', rate: 0 }\r\n    }\r\n\r\n    // 将错误按时间排序\r\nconst sortedErrors = [...errors].sort((a, b) => \r\n      (((a as any).timestamp) || 0) - (((b as any).timestamp) || 0)\r\n    )\r\n\r\n    // 计算前半部分和后半部分的错误率\r\n    const midPoint = Math.floor(sortedErrors.length / 2)\r\n    const firstHalf = sortedErrors.slice(0, midPoint)\r\n    const secondHalf = sortedErrors.slice(midPoint)\r\n\r\n    const firstHalfRate = firstHalf.length / (midPoint || 1)\r\n    const secondHalfRate = secondHalf.length / (sortedErrors.length - midPoint)\r\n\r\n    const rateChange = secondHalfRate - firstHalfRate\r\n\r\n    if (rateChange > 0.2) {\r\n      return { trend: 'increasing', rate: rateChange }\r\n    }\r\n    else if (rateChange < -0.2) {\r\n      return { trend: 'decreasing', rate: Math.abs(rateChange) }\r\n    }\r\n    else {\r\n      return { trend: 'stable', rate: 0 }\r\n    }\r\n  }\r\n}"],"names":["ErrorAnalyzer","analyzeErrorPatterns","errors","length","patterns","recommendations","summary","totalErrors","uniqueEndpoints","timeRange","start","Date","now","end","endpoints","Set","minTime","Number","MAX_SAFE_INTEGER","maxTime","total","forEach","error","config","url","add","timestamp","Math","min","max","isNetworkError","network_errors","isTimeoutError","timeout_errors","status","response","auth_errors","permission_errors","rate_limit_errors","server_errors","client_errors","analysisPatterns","Object","entries","map","type","count","percentage","round","description","this","getPatternDescription","sort","a","b","mostFrequentError","generateRecommendations","size","patternDescriptions","push","generateErrorReport","analysis","report","duration","hours","floor","pattern","rec","index","predictErrorTrend","trend","rate","sortedErrors","midPoint","firstHalf","slice","secondHalf","firstHalfRate","rateChange","abs"],"mappings":"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"}
"use strict";class t{constructor(t={}){this.connections=new Map,this.stats={totalRequests:0,connectionReuse:0,connectionErrors:0},this.waitingQueues=new Map,this.config={maxConnections:10,maxIdleConnections:5,maxConnectionAge:3e5,idleTimeout:6e4,connectionTimeout:3e4,keepAlive:!0,keepAliveTimeout:6e4,pipelining:!1,maxPipelineLength:10,...t},this.startCleanup()}async getConnection(t){const e=this.getConnectionKey(t),n=this.connections.get(e);if(n){const t=n.length;for(let e=0;e<t;e++){const t=n[e];if("idle"===t.state&&this.isConnectionValid(t))return this.markConnectionActive(t),this.stats.connectionReuse++,t}}const o=n||[];let s=0;const i=o.length;for(let t=0;t<i;t++)"active"===o[t].state&&s++;if(s>=this.config?.maxConnections)return this.waitForConnection(e,t);const c=await this.createConnection(t);return o.push(c),this.connections.set(e,o),c}releaseConnection(t){const e=`${t.protocol}//${t.host}:${t.port}`,n=this.connections.get(e);if(!n)return;const o=n.find(e=>e.id===t.id);o&&(o.state="idle",o.lastUsedAt=Date.now(),o.useCount++,this.trimIdleConnections(e)),this.notifyWaiters(e)}async createConnection(t){const e=new URL(t.url||""),n={id:this.generateId(),host:e.hostname,port:Number.parseInt(e.port)||("https:"===e.protocol?443:80),protocol:e.protocol,createdAt:Date.now(),lastUsedAt:Date.now(),useCount:1,state:"active"};return this.stats.totalRequests++,this.config?.connectionTimeout>0&&setTimeout(()=>{"active"===n.state&&this.closeConnection(n)},this.config?.connectionTimeout),n}async waitForConnection(t,e){return new Promise((e,n)=>{const o={resolve:e,reject:n,timestamp:Date.now()},s=this.waitingQueues.get(t)||[];s.push(o),this.waitingQueues.set(t,s);const i=setTimeout(()=>{const t=s.indexOf(o);-1!==t&&s.splice(t,1),n(new Error("Connection pool timeout"))},this.config?.connectionTimeout);o.timeout=i})}markConnectionActive(t){t.state="active",t.lastUsedAt=Date.now()}isConnectionValid(t){const e=Date.now();return!(e-t.createdAt>this.config?.maxConnectionAge||"idle"===t.state&&e-t.lastUsedAt>this.config?.idleTimeout)&&"closed"!==t.state}closeConnection(t){t.state="closed";const e=`${t.protocol}//${t.host}:${t.port}`,n=this.connections.get(e);if(n){const e=n.findIndex(e=>e.id===t.id);-1!==e&&n.splice(e,1)}}trimIdleConnections(t){const e=this.connections.get(t);if(!e)return;const n=e.filter(t=>"idle"===t.state);if(n.length>this.config?.maxIdleConnections){n.sort((t,e)=>t.lastUsedAt-e.lastUsedAt);const t=n.slice(0,n.length-this.config?.maxIdleConnections);for(const e of t)this.closeConnection(e)}}notifyWaiters(t){const e=this.waitingQueues.get(t);if(!e||0===e.length)return;const n=(this.connections.get(t)||[]).find(t=>"idle"===t.state&&this.isConnectionValid(t));if(n){const o=e.shift();if(o){const s=o.timeout;s&&clearTimeout(s),this.markConnectionActive(n),o.resolve(n),e.length>0&&this.notifyWaiters(t)}}}getConnectionKey(t){const e=new URL(t.url||"");return`${e.protocol}//${e.hostname}:${e.port||("https:"===e.protocol?443:80)}`}startCleanup(){this.cleanupTimer=setInterval(()=>{for(const[t,e]of this.connections.entries()){const n=e.filter(t=>!!this.isConnectionValid(t)||(this.closeConnection(t),!1));0===n.length?this.connections.delete(t):this.connections.set(t,n)}},1e4)}getStats(){let t=0,e=0,n=0;for(const o of this.connections.values())t+=o.length,e+=o.filter(t=>"active"===t.state).length,n+=o.filter(t=>"idle"===t.state).length;const o=t>0?this.stats.totalRequests/t:0;return{totalConnections:t,activeConnections:e,idleConnections:n,totalRequests:this.stats.totalRequests,connectionReuse:this.stats.connectionReuse,averageRequestsPerConnection:o,connectionErrors:this.stats.connectionErrors}}getConnectionDetails(){return new Map(this.connections)}closeAll(){for(const t of this.connections.values())for(const e of t)this.closeConnection(e);this.connections.clear()}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}destroy(){this.cleanupTimer&&clearInterval(this.cleanupTimer),this.closeAll()}}function e(e){return new t(e)}const n=e();exports.RequestPool=t,exports.createRequestPool=e,exports.defaultPool=n;
//# sourceMappingURL=pool.cjs.map

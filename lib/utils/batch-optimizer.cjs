"use strict";class t{constructor(t={}){this.groups=new Map,this.stats={totalBatches:0,totalRequests:0,mergedRequests:0,averageBatchSize:0,totalSavedRequests:0,compressionRatio:1},this.successRate=1,this.latencyHistory=[],this.signatureCache=new Map,this.MAX_CACHE_SIZE=1e3,this.config={enabled:t.enabled??!0,maxBatchSize:t.maxBatchSize??10,batchWindow:t.batchWindow??50,mergeDuplicates:t.mergeDuplicates??!0,smartGrouping:t.smartGrouping??!0,dynamicBatching:t.dynamicBatching??!0},this.currentBatchSize=this.config.maxBatchSize}async addRequest(t,e){return this.config.enabled?new Promise((s,i)=>{const a={id:this.generateId(),config:t,resolve:s,reject:i,timestamp:Date.now()},r=this.getGroupKey(t);let c=this.groups.get(r);if(c||(c=this.createGroup(t),this.groups.set(r,c)),this.config.mergeDuplicates){const e=this.findDuplicate(c,t);if(e)return this.shareDuplicateResult(e,a),this.stats.mergedRequests++,void this.stats.totalSavedRequests++}c.requests.push(a),this.stats.totalRequests++,this.shouldExecuteNow(c)?this.executeBatch(c,e):this.scheduleExecution(c,e)}):e(t)}createGroup(t){const e=new URL(t.url||"");return{endpoint:`${e.protocol}//${e.host}${e.pathname}`,method:t.method||"GET",requests:[]}}getGroupKey(t){if(!this.config.smartGrouping)return"default";const e=new URL(t.url||""),s=`${e.protocol}//${e.host}${e.pathname}`;return`${t.method||"GET"}:${s}`}findDuplicate(t,e){const s=this.getRequestSignature(e);for(const e of t.requests)if(this.getRequestSignature(e.config)===s)return e;return null}getRequestSignature(t){const e=`${t.method}:${t.url}:${JSON.stringify(t.params)}:${JSON.stringify(t.data)}`;let s=this.signatureCache.get(e);if(!s){if(s=this.computeSignature(t),this.signatureCache.size>=this.MAX_CACHE_SIZE){const t=this.signatureCache.keys().next().value;t&&this.signatureCache.delete(t)}this.signatureCache.set(e,s)}return s}computeSignature(t){return[t.method||"GET",t.url||"",JSON.stringify(t.params||{}),JSON.stringify(t.data||{}),JSON.stringify(t.headers||{})].join("|")}shareDuplicateResult(t,e){new Promise((e,s)=>{const i=t.resolve,a=t.reject;t.resolve=t=>{i(t),e(t)},t.reject=t=>{a(t),s(t)}}).then(e.resolve,e.reject)}shouldExecuteNow(t){if(t.requests.length>=this.currentBatchSize)return!0;if(t.requests.length>0){const e=t.requests[0];if(Date.now()-e.timestamp>2*this.config.batchWindow)return!0}return!1}scheduleExecution(t,e){t.timer||(t.timer=setTimeout(()=>{this.executeBatch(t,e)},this.config.batchWindow))}async executeBatch(t,e){t.timer&&(clearTimeout(t.timer),t.timer=void 0);const s=t.requests.splice(0);if(0===s.length)return;this.stats.totalBatches++;const i=Date.now(),a=s.map(async t=>{try{const s=await e(t.config);return t.resolve(s),{success:!0}}catch(e){return t.reject(e),{success:!1}}}),r=await Promise.all(a),c=Date.now()-i;this.updateMetrics(s.length,c,r),this.config.dynamicBatching&&this.adjustBatchSize();const h=this.getGroupKey(s[0].config);0===t.requests.length&&this.groups.delete(h)}updateMetrics(t,e,s){this.latencyHistory.push(e/t),this.latencyHistory.length>100&&this.latencyHistory.shift();const i=s.filter(t=>t.success).length/s.length;this.successRate=.9*this.successRate+.1*i;const a=this.stats.totalBatches;this.stats.averageBatchSize=(this.stats.averageBatchSize*(a-1)+t)/a,this.stats.compressionRatio=this.stats.totalRequests/(this.stats.totalRequests-this.stats.totalSavedRequests)}adjustBatchSize(){if(this.successRate<.8?this.currentBatchSize=Math.max(1,Math.floor(.8*this.currentBatchSize)):this.successRate>.95&&(this.currentBatchSize=Math.min(this.config.maxBatchSize,Math.floor(1.2*this.currentBatchSize))),this.latencyHistory.length>10){const t=this.latencyHistory.reduce((t,e)=>t+e,0)/this.latencyHistory.length;this.latencyHistory.slice(-10).reduce((t,e)=>t+e,0)/10>1.5*t&&(this.currentBatchSize=Math.max(1,Math.floor(.9*this.currentBatchSize)))}}getStats(){return{...this.stats}}resetStats(){this.stats={totalBatches:0,totalRequests:0,mergedRequests:0,averageBatchSize:0,totalSavedRequests:0,compressionRatio:1},this.latencyHistory=[],this.successRate=1}getCurrentBatchSize(){return this.currentBatchSize}destroy(){for(const t of this.groups.values())t.timer&&clearTimeout(t.timer);for(const t of this.groups.values())for(const e of t.requests)e.reject(new Error("BatchOptimizer destroyed"));this.groups.clear(),this.signatureCache.clear()}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}}exports.BatchOptimizer=t,exports.createBatchOptimizer=function(e){return new t(e)};
//# sourceMappingURL=batch-optimizer.cjs.map

"use strict";class t{constructor(){this.metadata=new Map,this.strategies=new Map,this.builtInStrategies={timeout:{name:"timeout",shouldCancel:t=>Date.now()-t.createdAt>6e4,getReason:t=>`Request timeout: ${Date.now()-t.createdAt}ms`},duplicate:{name:"duplicate",shouldCancel:(t,e)=>{let a=!1;return this.metadata.forEach((e,s)=>{e!==t&&e.config?.url===t.config?.url&&e.createdAt>t.createdAt&&(a=!0)}),a},getReason:()=>"Cancelled due to duplicate request"}},Object.values(this.builtInStrategies).forEach(t=>{this.addStrategy(t)})}register(t,e,a){const s={createdAt:Date.now(),tags:new Set(a?.tags||[]),config:a?.config,controller:e,token:a?.token};this.metadata.set(t,s),a?.token&&a.token.promise.then(()=>{this.cancel(t)}).catch(()=>{})}cancel(t,e="Request cancelled"){const a=this.metadata.get(t);return!!a&&(a.controller.abort(e),a.token&&!a.token.isCancelled&&a.token.cancel(e),this.metadata.delete(t),!0)}cancelBatch(t,e){let a=0;return t.forEach(t=>{this.cancel(t,e)&&a++}),a}cancelByTags(t,e){const a=new Set;return t.forEach(t=>{this.getRequestIdsByTag(t).forEach(t=>a.add(t))}),this.cancelBatch(Array.from(a),e)}cancelByStrategy(t,e){const a=this.strategies.get(t);if(!a)return 0;const s=[];this.metadata.forEach((t,e)=>{a.shouldCancel(t,e)&&s.push(e)});const r=e||(a.getReason?s.map(t=>a.getReason(this.metadata.get(t)))[0]:`Cancelled by strategy: ${t}`);return this.cancelBatch(s,r)}cancelTimeout(t,e){const a=Date.now(),s=[];return this.metadata.forEach((e,r)=>{a-e.createdAt>t&&s.push(r)}),this.cancelBatch(s,e||`Timeout exceeded: ${t}ms`)}cancelWhere(t,e){const a=[];return this.metadata.forEach((e,s)=>{t(e,s)&&a.push(s)}),this.cancelBatch(a,e)}cancelAll(t="All requests cancelled"){const e=this.metadata.size;return this.metadata.forEach((e,a)=>{this.cancel(a,t)}),e}cleanup(t){this.metadata.delete(t)}autoCleanup(t=3e5){const e=Date.now(),a=[];return this.metadata.forEach((s,r)=>{e-s.createdAt>t&&a.push(r)}),a.forEach(t=>{this.metadata.delete(t)}),a.length}addStrategy(t){this.strategies.set(t.name,t)}removeStrategy(t){return this.strategies.delete(t)}getStrategy(t){return this.strategies.get(t)}getStrategyNames(){return Array.from(this.strategies.keys())}applyStrategies(){let t=0;return this.strategies.forEach((e,a)=>{t+=this.cancelByStrategy(a)}),t}getRequestIdsByTag(t){const e=[];return this.metadata.forEach((a,s)=>{a.tags.has(t)&&e.push(s)}),e}getRequestCountByTag(){const t=new Map;return this.metadata.forEach(e=>{e.tags.forEach(e=>{t.set(e,(t.get(e)||0)+1)})}),t}getActiveRequests(){const t=Date.now(),e=[];return this.metadata.forEach((a,s)=>{e.push({id:s,tags:Array.from(a.tags),age:t-a.createdAt,url:a.config?.url})}),e}getStats(){const t=Date.now();let e=0,a=0;const s=this.getRequestCountByTag();return this.metadata.forEach(s=>{const r=t-s.createdAt;e+=r,a=Math.max(a,r)}),{active:this.metadata.size,byTag:Object.fromEntries(s),averageAge:this.metadata.size>0?e/this.metadata.size:0,oldestAge:a,strategies:this.getStrategyNames()}}addTags(t,...e){const a=this.metadata.get(t);return!!a&&(e.forEach(t=>a.tags.add(t)),!0)}removeTags(t,...e){const a=this.metadata.get(t);return!!a&&(e.forEach(t=>a.tags.delete(t)),!0)}getTags(t){const e=this.metadata.get(t);return e?Array.from(e.tags):[]}has(t){return this.metadata.has(t)}getMetadata(t){return this.metadata.get(t)}getActiveRequestCount(){return this.metadata.size}static createMergedSignal(t){const e=t.filter(t=>void 0!==t);if(0===e.length)return(new AbortController).signal;if(1===e.length)return e[0];const a=new AbortController,s=()=>{a.abort()};return e.forEach(t=>{t.aborted?a.abort():t.addEventListener("abort",s,{once:!0})}),a.signal}}exports.EnhancedCancelManager=t,exports.createEnhancedCancelManager=function(){return new t};
//# sourceMappingURL=cancel-manager-enhanced.cjs.map

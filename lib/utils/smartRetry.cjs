"use strict";var e;exports.RetryStrategy=void 0,(e=exports.RetryStrategy||(exports.RetryStrategy={})).IMMEDIATE="immediate",e.EXPONENTIAL="exponential",e.LINEAR="linear",e.FIXED="fixed",e.NONE="none";class t{constructor(e={}){this.config={maxRetries:e.maxRetries??3,baseDelay:e.baseDelay??1e3,maxDelay:e.maxDelay??3e4,checkNetworkStatus:e.checkNetworkStatus??!0,retryableStatusCodes:e.retryableStatusCodes??t.DEFAULT_RETRYABLE_STATUS_CODES,nonRetryableStatusCodes:e.nonRetryableStatusCodes??t.DEFAULT_NON_RETRYABLE_STATUS_CODES,customDecision:e.customDecision}}shouldRetry(e,t){if(t>=this.config?.maxRetries)return{shouldRetry:!1,delay:0,strategy:exports.RetryStrategy.NONE,reason:`已达到最大重试次数 ${this.config?.maxRetries}`};if(this.config?.customDecision){const r=this.config?.customDecision(e,t);if(r)return r}if(this.config?.checkNetworkStatus&&this.isOffline())return{shouldRetry:!1,delay:0,strategy:exports.RetryStrategy.NONE,reason:"当前网络离线"};const r=e.response?.status;return r?this.config?.nonRetryableStatusCodes.includes(r)?{shouldRetry:!1,delay:0,strategy:exports.RetryStrategy.NONE,reason:`状态码 ${r} 不可重试（客户端错误）`}:this.config?.retryableStatusCodes.includes(r)?this.createRetryDecision(!0,t,this.getStrategyForStatusCode(r),`状态码 ${r} 可重试`):r>=500&&r<600?this.createRetryDecision(!0,t,exports.RetryStrategy.EXPONENTIAL,`服务器错误 ${r}，使用指数退避重试`):{shouldRetry:!1,delay:0,strategy:exports.RetryStrategy.NONE,reason:`状态码 ${r} 不在重试范围内`}:this.createRetryDecision(!0,t,exports.RetryStrategy.EXPONENTIAL,"网络错误，使用指数退避重试")}createRetryDecision(e,t,r,s){return{shouldRetry:e,delay:this.calculateDelay(t,r),strategy:r,reason:s}}getStrategyForStatusCode(e){switch(e){case 429:default:return exports.RetryStrategy.EXPONENTIAL;case 503:return exports.RetryStrategy.LINEAR;case 504:return exports.RetryStrategy.FIXED}}calculateDelay(e,t){let r;switch(t){case exports.RetryStrategy.IMMEDIATE:r=0;break;case exports.RetryStrategy.EXPONENTIAL:r=this.config?.baseDelay*2**e;break;case exports.RetryStrategy.LINEAR:r=this.config?.baseDelay*e;break;case exports.RetryStrategy.FIXED:r=this.config?.baseDelay;break;default:r=0}return r=this.addJitter(r),Math.min(r,this.config?.maxDelay)}addJitter(e){const t=.25*e;return e+(Math.random()*t*2-t)}isOffline(){return typeof navigator<"u"&&"onLine"in navigator&&!navigator.onLine}getRetryAdvice(e){const t=e.response?.status;return t?429===t?"请求过于频繁，请稍后再试":t>=500?"服务器暂时不可用，请稍后重试":t>=400&&t<500?"请求参数有误，请检查后重试":"请求失败，请重试":"网络连接失败，请检查网络设置后重试"}}t.DEFAULT_RETRYABLE_STATUS_CODES=[408,429,500,502,503,504],t.DEFAULT_NON_RETRYABLE_STATUS_CODES=[400,401,403,404,405,422];const r=new t;exports.SmartRetryManager=t,exports.createSmartRetryInterceptor=function(e){const r=new t(e),s=new Map;return{onRejected:async e=>{const t=`${e.config?.method}:${e.config?.url}`,a=s.get(t)??0,o=r.shouldRetry(e,a);throw o.shouldRetry?(s.set(t,a+1),await new Promise(e=>setTimeout(e,o.delay)),e):(s.delete(t),e)}}},exports.createSmartRetryManager=function(e){return new t(e)},exports.globalSmartRetryManager=r;
//# sourceMappingURL=smartRetry.cjs.map

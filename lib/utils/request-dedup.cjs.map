{"version":3,"file":"request-dedup.cjs","sources":["../../src/utils/request-dedup.ts"],"sourcesContent":["/**\r\n * 请求去重键生成器模块\r\n */\r\n\r\nimport type { RequestConfig } from '../types'\r\n\r\n/**\r\n * 去重键生成器配置\r\n */\r\nexport interface DeduplicationKeyConfig {\r\n  /** 是否包含请求方法 */\r\n  includeMethod?: boolean\r\n  /** 是否包含URL */\r\n  includeUrl?: boolean\r\n  /** 是否包含查询参数 */\r\n  includeParams?: boolean\r\n  /** 是否包含请求体 */\r\n  includeData?: boolean\r\n  /** 是否包含请求头 */\r\n  includeHeaders?: boolean\r\n  /** 要包含的特定请求头 */\r\n  specificHeaders?: string[]\r\n  /** 自定义键生成函数 */\r\n  customGenerator?: (config: RequestConfig) => string\r\n}\r\n\r\n/**\r\n * 智能去重键生成器（优化版）\r\n *\r\n * 优化点：\r\n * 1. 添加键缓存，避免重复计算\r\n * 2. 使用 WeakMap 自动管理缓存生命周期\r\n * 3. 优化序列化性能\r\n */\r\nexport class DeduplicationKeyGenerator {\r\n  private config: Required<Omit<DeduplicationKeyConfig, 'customGenerator'>> & Pick<DeduplicationKeyConfig, 'customGenerator'>\r\n  // 使用 WeakMap 缓存键，自动垃圾回收\r\n  private keyCache = new WeakMap<RequestConfig, string>()\r\n  // 对于非对象配置，使用普通 Map（带 LRU）\r\n  private stringKeyCache = new Map<string, string>()\r\n  private maxCacheSize = 1000\r\n\r\n  constructor(config: DeduplicationKeyConfig = {}) {\r\n    this.config = {\r\n      includeMethod: true,\r\n      includeUrl: true,\r\n      includeParams: true,\r\n      includeData: false,\r\n      includeHeaders: false,\r\n      specificHeaders: [],\r\n      customGenerator: config.customGenerator,\r\n      ...config,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 生成去重键（优化版 - 带缓存）\r\n   */\r\n  generate(requestConfig: RequestConfig): string {\r\n    // 尝试从缓存获取\r\n    const cached = this.keyCache.get(requestConfig)\r\n    if (cached) {\r\n      return cached\r\n    }\r\n\r\n    // 生成新键\r\n    const key = this.generateKey(requestConfig)\r\n\r\n    // 缓存结果\r\n    this.keyCache.set(requestConfig, key)\r\n\r\n    // 同时缓存到字符串 Map（用于相同配置的不同对象实例）\r\n    this.cacheStringKey(key)\r\n\r\n    return key\r\n  }\r\n\r\n  /**\r\n   * 实际生成键的逻辑\r\n   */\r\n  private generateKey(requestConfig: RequestConfig): string {\r\n    if (this.config?.customGenerator) {\r\n      return this.config?.customGenerator(requestConfig)\r\n    }\r\n\r\n    const parts: string[] = []\r\n\r\n    if (this.config?.includeMethod && requestConfig.method) {\r\n      parts.push(`method:${requestConfig.method.toUpperCase()}`)\r\n    }\r\n\r\n    if (this.config?.includeUrl && requestConfig.url) {\r\n      parts.push(`url:${requestConfig.url}`)\r\n    }\r\n\r\n    if (this.config?.includeParams && requestConfig.params) {\r\n      const paramsStr = this.serializeParams(requestConfig.params)\r\n      if (paramsStr) {\r\n        parts.push(`params:${paramsStr}`)\r\n      }\r\n    }\r\n\r\n    if (this.config?.includeData && requestConfig.data) {\r\n      const dataStr = this.serializeData(requestConfig.data)\r\n      if (dataStr) {\r\n        parts.push(`data:${dataStr}`)\r\n      }\r\n    }\r\n\r\n    if (this.config?.includeHeaders && requestConfig.headers) {\r\n      const headersStr = this.serializeHeaders(requestConfig.headers)\r\n      if (headersStr) {\r\n        parts.push(`headers:${headersStr}`)\r\n      }\r\n    }\r\n\r\n    if (this.config?.specificHeaders.length > 0 && requestConfig.headers) {\r\n      const specificHeadersStr = this.serializeSpecificHeaders(\r\n        requestConfig.headers,\r\n        this.config?.specificHeaders,\r\n      )\r\n      if (specificHeadersStr) {\r\n        parts.push(`specific-headers:${specificHeadersStr}`)\r\n      }\r\n    }\r\n\r\n    return parts.join('|')\r\n  }\r\n\r\n  /**\r\n   * 缓存字符串键（LRU优化版）\r\n   */\r\n  private cacheStringKey(key: string): void {\r\n    // 如果缓存已满，删除最旧的项（优化：只在需要时删除）\r\n    if (this.stringKeyCache.size >= this.maxCacheSize) {\r\n      // 使用迭代器直接获取第一个键\r\n      const iterator = this.stringKeyCache.keys()\r\n      const firstKey = iterator.next().value\r\n      if (firstKey !== undefined) {\r\n        this.stringKeyCache.delete(firstKey)\r\n      }\r\n    }\r\n    this.stringKeyCache.set(key, key)\r\n  }\r\n\r\n  /**\r\n   * 清除缓存\r\n   */\r\n  clearCache(): void {\r\n    this.stringKeyCache.clear()\r\n  }\r\n\r\n  /**\r\n   * 序列化参数（极致优化版 - 使用数组预分配）\r\n   */\r\n  private serializeParams(params: Record<string, any>): string {\r\n    try {\r\n      const keys = Object.keys(params).sort()\r\n      const len = keys.length\r\n      \r\n      if (len === 0) return ''\r\n      \r\n      // 预分配数组大小\r\n      const parts: string[] = Array.from({ length: len }, () => '')\r\n      \r\n      for (let i = 0; i < len; i++) {\r\n        const key = keys[i]!\r\n        parts[i] = `${key}:${JSON.stringify(params[key])}`\r\n      }\r\n      \r\n      return parts.join(',')\r\n    }\r\n    catch {\r\n      return String(params)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 序列化数据（优化版）\r\n   */\r\n  private serializeData(data: any): string {\r\n    try {\r\n      if (data instanceof FormData) {\r\n        // FormData 特殊处理\r\n        const entries: string[] = []\r\n        for (const [key, value] of data.entries()) {\r\n          entries.push(`${key}:${typeof value === 'string' ? value : '[File]'}`)\r\n        }\r\n        return entries.sort().join(',')\r\n      }\r\n\r\n      if (typeof data === 'object' && data !== null) {\r\n        // 直接构建字符串，避免创建排序后的对象\r\n        const keys = Object.keys(data).sort()\r\n        const parts: string[] = []\r\n        for (const key of keys) {\r\n          parts.push(`${key}:${JSON.stringify(data[key])}`)\r\n        }\r\n        return parts.join(',')\r\n      }\r\n\r\n      return String(data)\r\n    }\r\n    catch {\r\n      return String(data)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 序列化请求头（优化版）\r\n   */\r\n  private serializeHeaders(headers: Record<string, string>): string {\r\n    try {\r\n      // 排除一些动态的请求头\r\n      const excludeHeaders = new Set(['authorization', 'x-request-id', 'x-timestamp'])\r\n      const parts: string[] = []\r\n\r\n      const keys = Object.keys(headers).sort()\r\n      for (const key of keys) {\r\n        if (!excludeHeaders.has(key.toLowerCase())) {\r\n          parts.push(`${key}:${headers[key]}`)\r\n        }\r\n      }\r\n\r\n      return parts.join(',')\r\n    }\r\n    catch {\r\n      return String(headers)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 序列化特定请求头（优化版）\r\n   */\r\n  private serializeSpecificHeaders(\r\n    headers: Record<string, string>,\r\n    specificHeaders: string[],\r\n  ): string {\r\n    try {\r\n      const parts: string[] = []\r\n      const sortedHeaders = [...specificHeaders].sort()\r\n\r\n      for (const header of sortedHeaders) {\r\n        if (headers[header] !== undefined) {\r\n          parts.push(`${header}:${headers[header]}`)\r\n        }\r\n      }\r\n\r\n      return parts.join(',')\r\n    }\r\n    catch {\r\n      return ''\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 创建去重键生成器\r\n */\r\nexport function createDeduplicationKeyGenerator(\r\n  config?: DeduplicationKeyConfig,\r\n): DeduplicationKeyGenerator {\r\n  return new DeduplicationKeyGenerator(config)\r\n}\r\n\r\n// 导出默认的键生成器\r\nexport const defaultKeyGenerator = new DeduplicationKeyGenerator()\r\n\r\n/**\r\n * 生成请求唯一键（简化版本，向后兼容）\r\n */\r\nexport function generateRequestKey(config: RequestConfig): string {\r\n  return defaultKeyGenerator.generate(config)\r\n}\r\n"],"names":["DeduplicationKeyGenerator","constructor","config","this","keyCache","WeakMap","stringKeyCache","Map","maxCacheSize","includeMethod","includeUrl","includeParams","includeData","includeHeaders","specificHeaders","customGenerator","generate","requestConfig","cached","get","key","generateKey","set","cacheStringKey","parts","method","push","toUpperCase","url","params","paramsStr","serializeParams","data","dataStr","serializeData","headers","headersStr","serializeHeaders","length","specificHeadersStr","serializeSpecificHeaders","join","size","firstKey","keys","next","value","delete","clearCache","clear","Object","sort","len","Array","from","i","JSON","stringify","String","FormData","entries","excludeHeaders","Set","has","toLowerCase","sortedHeaders","header","defaultKeyGenerator"],"mappings":"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"}
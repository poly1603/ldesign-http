{"version":3,"file":"download.cjs","sources":["../../src/utils/download.ts"],"sourcesContent":["/**\r\n * 文件下载工具函数\r\n * 提供文件下载、进度监控、断点续传等功能\r\n */\r\n\r\nimport type { RequestConfig } from '../types'\r\n\r\n/**\r\n * 下载配置\r\n */\r\nexport interface DownloadConfig extends RequestConfig {\r\n  /** 下载文件名 */\r\n  filename?: string\r\n  /** 下载进度回调 */\r\n  onProgress?: (progress: DownloadProgress) => void\r\n  /** 是否启用断点续传 */\r\n  resumable?: boolean\r\n  /** 分片大小（字节），用于大文件分片下载 */\r\n  chunkSize?: number\r\n  /** 是否自动保存文件 */\r\n  autoSave?: boolean\r\n  /** 保存目录（仅 Node.js 环境） */\r\n  saveDir?: string\r\n}\r\n\r\n/**\r\n * 下载进度信息\r\n */\r\nexport interface DownloadProgress {\r\n  /** 已下载字节数 */\r\n  loaded: number\r\n  /** 总字节数 */\r\n  total: number\r\n  /** 下载百分比 (0-100) */\r\n  percentage: number\r\n  /** 下载速度 (字节/秒) */\r\n  speed: number\r\n  /** 预计剩余时间 (秒) */\r\n  timeRemaining: number\r\n  /** 已耗时 (毫秒) */\r\n  elapsed: number\r\n  /** 下载的文件名 */\r\n  filename?: string\r\n  /** 当前分片索引 */\r\n  chunkIndex?: number\r\n  /** 总分片数 */\r\n  totalChunks?: number\r\n}\r\n\r\n/**\r\n * 下载结果\r\n */\r\nexport interface DownloadResult {\r\n  /** 下载的数据 */\r\n  data: Blob | ArrayBuffer | string\r\n  /** 文件名 */\r\n  filename: string\r\n  /** 文件大小 */\r\n  size: number\r\n  /** 文件类型 */\r\n  type: string\r\n  /** 下载耗时 */\r\n  duration: number\r\n  /** 下载URL（如果自动保存） */\r\n  url?: string\r\n}\r\n\r\n/**\r\n * 分片下载信息\r\n */\r\nexport interface DownloadChunk {\r\n  /** 分片索引 */\r\n  index: number\r\n  /** 分片开始位置 */\r\n  start: number\r\n  /** 分片结束位置 */\r\n  end: number\r\n  /** 分片大小 */\r\n  size: number\r\n  /** 分片数据 */\r\n  data?: ArrayBuffer\r\n  /** 是否已完成 */\r\n  completed: boolean\r\n}\r\n\r\n/**\r\n * 下载进度计算器\r\n */\r\nexport class DownloadProgressCalculator {\r\n  private startTime: number = Date.now()\r\n  private lastLoaded: number = 0\r\n  private lastTime: number = Date.now()\r\n  private speeds: number[] = []\r\n\r\n  calculate(loaded: number, total: number, filename?: string): DownloadProgress {\r\n    const now = Date.now()\r\n    const deltaTime = now - this.lastTime\r\n    const deltaLoaded = loaded - this.lastLoaded\r\n\r\n    // 计算瞬时速度\r\n    const instantSpeed = deltaTime > 0 ? (deltaLoaded / deltaTime) * 1000 : 0\r\n    this.speeds.push(instantSpeed)\r\n\r\n    // 保持最近10个速度样本\r\n    if (this.speeds.length > 10) {\r\n      this.speeds.shift()\r\n    }\r\n\r\n    // 计算平均速度\r\n    const avgSpeed = this.speeds.reduce((sum, speed) => sum + speed, 0) / this.speeds.length\r\n\r\n    // 计算剩余时间\r\n    const remaining = total - loaded\r\n    const timeRemaining = avgSpeed > 0 ? remaining / avgSpeed : 0\r\n\r\n    this.lastLoaded = loaded\r\n    this.lastTime = now\r\n\r\n    return {\r\n      loaded,\r\n      total,\r\n      percentage: total > 0 ? Math.round((loaded / total) * 100) : 0,\r\n      speed: avgSpeed,\r\n      timeRemaining,\r\n      elapsed: now - this.startTime,\r\n      filename,\r\n    }\r\n  }\r\n\r\n  reset(): void {\r\n    this.startTime = Date.now()\r\n    this.lastLoaded = 0\r\n    this.lastTime = Date.now()\r\n    this.speeds = []\r\n  }\r\n}\r\n\r\n/**\r\n * 从响应头获取文件名\r\n */\r\nexport function getFilenameFromResponse(headers: Record<string, string>): string | null {\r\n  const contentDisposition = headers['content-disposition'] || headers['Content-Disposition']\r\n\r\n  if (!contentDisposition) {\r\n    return null\r\n  }\r\n\r\n  // 尝试匹配 filename*=UTF-8''filename 格式\r\n  const utf8Match = contentDisposition.match(/filename\\*=UTF-8''(.+)/i)\r\n  if (utf8Match) {\r\n    return decodeURIComponent(utf8Match[1])\r\n  }\r\n\r\n  // 尝试匹配 filename=\"filename\" 格式\r\n  const quotedMatch = contentDisposition.match(/filename=\"(.+)\"/i)\r\n  if (quotedMatch) {\r\n    return quotedMatch[1]\r\n  }\r\n\r\n  // 尝试匹配 filename=filename 格式\r\n  const unquotedMatch = contentDisposition.match(/filename=([^;]+)/i)\r\n  if (unquotedMatch) {\r\n    return unquotedMatch[1].trim()\r\n  }\r\n\r\n  return null\r\n}\r\n\r\n/**\r\n * 从URL获取文件名\r\n */\r\nexport function getFilenameFromURL(url: string): string {\r\n  try {\r\n    const urlObj = new URL(url)\r\n    const pathname = urlObj.pathname\r\n    const filename = pathname.split('/').pop() || 'download'\r\n\r\n    // 移除查询参数\r\n    return filename.split('?')[0]\r\n  }\r\n  catch {\r\n    return 'download'\r\n  }\r\n}\r\n\r\n/**\r\n * 获取文件MIME类型\r\n */\r\nexport function getMimeTypeFromFilename(filename: string): string {\r\n  const ext = filename.split('.').pop()?.toLowerCase()\r\n\r\n  const mimeTypes: Record<string, string> = {\r\n    // 图片\r\n    'jpg': 'image/jpeg',\r\n    'jpeg': 'image/jpeg',\r\n    'png': 'image/png',\r\n    'gif': 'image/gif',\r\n    'webp': 'image/webp',\r\n    'svg': 'image/svg+xml',\r\n\r\n    // 文档\r\n    'pdf': 'application/pdf',\r\n    'doc': 'application/msword',\r\n    'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\r\n    'xls': 'application/vnd.ms-excel',\r\n    'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\r\n    'ppt': 'application/vnd.ms-powerpoint',\r\n    'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',\r\n\r\n    // 文本\r\n    'txt': 'text/plain',\r\n    'csv': 'text/csv',\r\n    'json': 'application/json',\r\n    'xml': 'application/xml',\r\n    'html': 'text/html',\r\n    'css': 'text/css',\r\n    'js': 'application/javascript',\r\n\r\n    // 音频\r\n    'mp3': 'audio/mpeg',\r\n    'wav': 'audio/wav',\r\n    'ogg': 'audio/ogg',\r\n\r\n    // 视频\r\n    'mp4': 'video/mp4',\r\n    'avi': 'video/x-msvideo',\r\n    'mov': 'video/quicktime',\r\n\r\n    // 压缩文件\r\n    'zip': 'application/zip',\r\n    'rar': 'application/x-rar-compressed',\r\n    '7z': 'application/x-7z-compressed',\r\n    'tar': 'application/x-tar',\r\n    'gz': 'application/gzip',\r\n  }\r\n\r\n  return mimeTypes[ext || ''] || 'application/octet-stream'\r\n}\r\n\r\n/**\r\n * 保存文件到本地（浏览器环境）\r\n */\r\nexport function saveFileToLocal(data: Blob, filename: string): void {\r\n  const url = URL.createObjectURL(data)\r\n  const link = document.createElement('a')\r\n\r\n  link.href = url\r\n  link.download = filename\r\n  link.style.display = 'none'\r\n\r\n  document.body.appendChild(link)\r\n  link.click()\r\n  document.body.removeChild(link)\r\n\r\n  // 清理URL\r\n  setTimeout(() => {\r\n    URL.revokeObjectURL(url)\r\n  }, 100)\r\n}\r\n\r\n/**\r\n * 创建下载分片\r\n */\r\nexport function createDownloadChunks(totalSize: number, chunkSize: number): DownloadChunk[] {\r\n  const chunks: DownloadChunk[] = []\r\n  const totalChunks = Math.ceil(totalSize / chunkSize)\r\n\r\n  for (let i = 0; i < totalChunks; i++) {\r\n    const start = i * chunkSize\r\n    const end = Math.min(start + chunkSize - 1, totalSize - 1)\r\n\r\n    chunks.push({\r\n      index: i,\r\n      start,\r\n      end,\r\n      size: end - start + 1,\r\n      completed: false,\r\n    })\r\n  }\r\n\r\n  return chunks\r\n}\r\n\r\n/**\r\n * 合并下载分片\r\n */\r\nexport function mergeDownloadChunks(chunks: DownloadChunk[]): ArrayBuffer {\r\n  // 按索引排序\r\n  chunks.sort((a, b) => a.index - b.index)\r\n\r\n  // 计算总大小\r\n  const totalSize = chunks.reduce((sum, chunk) => sum + chunk.size, 0)\r\n\r\n  // 创建结果数组\r\n  const result = new Uint8Array(totalSize)\r\n  let offset = 0\r\n\r\n  // 合并数据\r\n  for (const chunk of chunks) {\r\n    if (chunk.data) {\r\n      const chunkData = new Uint8Array(chunk.data)\r\n      result.set(chunkData, offset)\r\n      offset += chunkData.length\r\n    }\r\n  }\r\n\r\n  return result.buffer\r\n}\r\n\r\n/**\r\n * 检查是否支持断点续传\r\n */\r\nexport function supportsRangeRequests(headers: Record<string, string>): boolean {\r\n  const acceptRanges = headers['accept-ranges'] || headers['Accept-Ranges']\r\n  return acceptRanges === 'bytes'\r\n}\r\n\r\n/**\r\n * 创建Range请求头\r\n */\r\nexport function createRangeHeader(start: number, end?: number): string {\r\n  if (end !== undefined) {\r\n    return `bytes=${start}-${end}`\r\n  }\r\n  return `bytes=${start}-`\r\n}\r\n\r\n/**\r\n * 解析Content-Range响应头\r\n */\r\nexport function parseContentRange(contentRange: string): {\r\n  start: number\r\n  end: number\r\n  total: number\r\n} | null {\r\n  const match = contentRange.match(/bytes (\\d+)-(\\d+)\\/(\\d+)/)\r\n\r\n  if (!match) {\r\n    return null\r\n  }\r\n\r\n  return {\r\n    start: Number.parseInt(match[1], 10),\r\n    end: Number.parseInt(match[2], 10),\r\n    total: Number.parseInt(match[3], 10),\r\n  }\r\n}\r\n\r\n/**\r\n * 格式化下载速度\r\n */\r\nexport function formatDownloadSpeed(bytesPerSecond: number): string {\r\n  const units = ['B/s', 'KB/s', 'MB/s', 'GB/s']\r\n  let size = bytesPerSecond\r\n  let unitIndex = 0\r\n\r\n  while (size >= 1024 && unitIndex < units.length - 1) {\r\n    size /= 1024\r\n    unitIndex++\r\n  }\r\n\r\n  return `${size.toFixed(1)} ${units[unitIndex]}`\r\n}\r\n\r\n/**\r\n * 格式化剩余时间\r\n */\r\nexport function formatTimeRemaining(seconds: number): string {\r\n  if (!Number.isFinite(seconds) || seconds < 0) {\r\n    return '未知'\r\n  }\r\n\r\n  if (seconds < 60) {\r\n    return `${Math.round(seconds)}秒`\r\n  }\r\n\r\n  if (seconds < 3600) {\r\n    const minutes = Math.floor(seconds / 60)\r\n    const remainingSeconds = Math.round(seconds % 60)\r\n    return `${minutes}分${remainingSeconds}秒`\r\n  }\r\n\r\n  const hours = Math.floor(seconds / 3600)\r\n  const minutes = Math.floor((seconds % 3600) / 60)\r\n  return `${hours}小时${minutes}分钟`\r\n}\r\n\r\n/**\r\n * 检查文件是否可以预览\r\n */\r\nexport function isPreviewableFile(filename: string): boolean {\r\n  const ext = filename.split('.').pop()?.toLowerCase()\r\n  const previewableExts = [\r\n    'jpg',\r\n    'jpeg',\r\n    'png',\r\n    'gif',\r\n    'webp',\r\n    'svg',\r\n    'pdf',\r\n    'txt',\r\n    'json',\r\n    'xml',\r\n    'html',\r\n    'css',\r\n    'js',\r\n    'mp3',\r\n    'wav',\r\n    'ogg',\r\n    'mp4',\r\n    'avi',\r\n    'mov',\r\n  ]\r\n\r\n  return previewableExts.includes(ext || '')\r\n}\r\n"],"names":["constructor","this","startTime","Date","now","lastLoaded","lastTime","speeds","calculate","loaded","total","filename","deltaTime","deltaLoaded","instantSpeed","push","length","shift","avgSpeed","reduce","sum","speed","timeRemaining","percentage","Math","round","elapsed","reset","totalSize","chunkSize","chunks","totalChunks","ceil","i","start","end","min","index","size","completed","bytesPerSecond","units","unitIndex","toFixed","seconds","Number","isFinite","floor","headers","contentDisposition","utf8Match","match","decodeURIComponent","quotedMatch","unquotedMatch","trim","url","URL","pathname","split","pop","ext","toLowerCase","jpg","jpeg","png","gif","webp","svg","pdf","doc","docx","xls","xlsx","ppt","pptx","txt","csv","json","xml","html","css","js","mp3","wav","ogg","mp4","avi","mov","zip","rar","tar","gz","includes","sort","a","b","chunk","result","Uint8Array","offset","data","chunkData","set","buffer","contentRange","parseInt","createObjectURL","link","document","createElement","href","download","style","display","body","appendChild","click","removeChild","setTimeout","revokeObjectURL"],"mappings":"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"}
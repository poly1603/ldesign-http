"use strict";var t,e=require("./index.cjs");exports.SpanType=void 0,(t=exports.SpanType||(exports.SpanType={})).HTTP="http",t.DATABASE="database",t.CACHE="cache",t.CUSTOM="custom",exports.SpanStatus=void 0,function(t){t.PENDING="pending",t.SUCCESS="success",t.ERROR="error",t.CANCELLED="cancelled"}(exports.SpanStatus||(exports.SpanStatus={}));class s{constructor(t={}){this.traces=new Map,this.config={enabled:t.enabled??!0,sampleRate:t.sampleRate??1,propagateTraceId:t.propagateTraceId??!0,traceIdHeader:t.traceIdHeader??"X-Trace-Id",spanIdHeader:t.spanIdHeader??"X-Span-Id",exporter:t.exporter}}startTrace(t,e=exports.SpanType.HTTP){if(!this.shouldSample())return new n;const s=this.generateTraceId(),r={spanId:this.generateSpanId(),traceId:s,name:t,type:e,startTime:Date.now(),status:exports.SpanStatus.PENDING,tags:[],logs:[]},o={traceId:s,currentSpan:r,spans:[r],metadata:{}};return this.traces.set(s,o),new a(this,o,r)}getTrace(t){return this.traces.get(t)}finishTrace(t){const e=this.traces.get(t);if(e){if(this.config?.exporter){const t=this.config?.exporter(e.spans);t instanceof Promise&&t.catch(t=>{})}this.traces.delete(t)}}shouldSample(){return!!this.config?.enabled&&Math.random()<this.config?.sampleRate}generateTraceId(){return`trace-${e.generateId()}-${Date.now()}`}generateSpanId(){return`span-${e.generateId()}`}getConfig(){return this.config}}class a{constructor(t,e,s){this.tracer=t,this.context=e,this.rootSpan=s}get traceId(){return this.context.traceId}get spanId(){return this.rootSpan.spanId}startSpan(t,s=exports.SpanType.CUSTOM){const a={spanId:`span-${e.generateId()}`,parentSpanId:this.context.currentSpan?.spanId,traceId:this.context.traceId,name:t,type:s,startTime:Date.now(),status:exports.SpanStatus.PENDING,tags:[],logs:[]};return this.context.spans.push(a),this.context.currentSpan=a,new r(a)}addTag(t,e){return this.rootSpan.tags.push({key:t,value:e}),this}addLog(t,e){return this.rootSpan.logs.push({timestamp:Date.now(),message:t,data:e}),this}setError(t){return this.rootSpan.status=exports.SpanStatus.ERROR,this.rootSpan.error={message:t.message,stack:t.stack},this}finish(t=exports.SpanStatus.SUCCESS){const e=Date.now();this.rootSpan.endTime=e,this.rootSpan.duration=e-this.rootSpan.startTime,this.rootSpan.status=t,this.tracer.finishTrace(this.context.traceId)}getSpans(){return[...this.context.spans]}getMetadata(){return this.context.metadata}setMetadata(t,e){return this.context.metadata[t]=e,this}}class r{constructor(t){this.span=t}addTag(t,e){return this.span.tags.push({key:t,value:e}),this}addLog(t,e){return this.span.logs.push({timestamp:Date.now(),message:t,data:e}),this}setError(t){return this.span.status=exports.SpanStatus.ERROR,this.span.error={message:t.message,stack:t.stack},this}finish(t=exports.SpanStatus.SUCCESS){const e=Date.now();this.span.endTime=e,this.span.duration=e-this.span.startTime,this.span.status=t}getRawSpan(){return this.span}}class n extends a{constructor(){super(null,null,null)}startSpan(){return new o}addTag(){return this}addLog(){return this}setError(){return this}finish(){}getSpans(){return[]}}class o extends r{constructor(){super(null)}addTag(){return this}addLog(){return this}setError(){return this}finish(){}}const p=new s;exports.RequestTracer=s,exports.Span=r,exports.Trace=a,exports.consoleExporter=function(t){t.forEach(t=>{t.duration&&t.duration,t.status===exports.SpanStatus.SUCCESS||(t.status,exports.SpanStatus.ERROR);t.tags.length,t.logs.length,t.error})},exports.createRequestTracer=function(t){return new s(t)},exports.createTraceInterceptor=function(t){const e=new s(t),a=new Map;return{request:{onFulfilled:t=>{const s=e.startTrace(`${t.method?.toUpperCase()} ${t.url}`,exports.SpanType.HTTP);s.addTag("http.method",t.method||"GET"),s.addTag("http.url",t.url||""),t.baseURL&&s.addTag("http.base_url",t.baseURL),t.__trace__=s;const r=e.getConfig();return r.propagateTraceId&&(t.headers=t.headers||{},r.traceIdHeader&&r.spanIdHeader&&(t.headers[r.traceIdHeader]=s.traceId,t.headers[r.spanIdHeader]=s.spanId)),a.set(s.traceId,s),t}},response:{onFulfilled:t=>{const e=t.config.__trace__;return e&&(e.addTag("http.status",t.status),e.addLog("Response received"),e.finish(exports.SpanStatus.SUCCESS),a.delete(e.traceId)),t},onRejected:t=>{const e=t.config.__trace__;throw e&&(t.response&&e.addTag("http.status",t.response.status),e.setError(t),e.addLog("Request failed",{error:t.message}),e.finish(exports.SpanStatus.ERROR),a.delete(e.traceId)),t}}}},exports.globalTracer=p;
//# sourceMappingURL=trace.cjs.map

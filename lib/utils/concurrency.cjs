"use strict";var e=require("./dedup-manager.cjs"),t=require("./request-dedup.cjs"),i=require("./rate-limit.cjs");class n{constructor(i={}){this.activeRequests=new Set,this.requestQueue=[],this.requestCounter=0,this.processingQueue=!1,this.config={maxConcurrent:i.maxConcurrent??10,maxQueueSize:i.maxQueueSize??100,deduplication:i.deduplication??!0},this.deduplicationManager=new e.DeduplicationManager,this.keyGenerator=new t.DeduplicationKeyGenerator({includeMethod:!0,includeUrl:!0,includeParams:!0,includeData:!1})}async execute(e,t){if(this.config?.deduplication){const i=this.keyGenerator.generate(t);return this.deduplicationManager.execute(i,()=>this.executeWithConcurrencyControl(e,t))}return this.executeWithConcurrencyControl(e,t)}async executeWithConcurrencyControl(e,t){return new Promise((i,n)=>{const r={id:this.generateTaskId(),execute:e,resolve:i,reject:n,config:t};this.requestQueue.length>=this.config?.maxQueueSize?n(new Error("Request queue is full")):this.activeRequests.size<this.config?.maxConcurrent?this.executeTask(r):this.requestQueue.push(r)})}async executeTask(e){this.activeRequests.add(e.id);try{const t=await e.execute();e.resolve(t)}catch(t){e.reject(t)}finally{this.activeRequests.delete(e.id),this.processQueue()}}processQueue(){if(!this.processingQueue){this.processingQueue=!0;try{for(;this.requestQueue.length>0&&this.activeRequests.size<this.config?.maxConcurrent;){const e=this.requestQueue.shift();e&&this.executeTask(e)}}finally{this.processingQueue=!1}}}cancelQueue(e="Queue cancelled"){this.requestQueue.splice(0).forEach(t=>{t.reject(new Error(e))})}getStatus(){return{activeCount:this.activeRequests.size,queuedCount:this.requestQueue.length,maxConcurrent:this.config?.maxConcurrent,maxQueueSize:this.config?.maxQueueSize,deduplication:this.deduplicationManager.getStats()}}updateConfig(e){Object.assign(this.config,e),this.processQueue()}getConfig(){return{...this.config}}getDeduplicationStats(){return this.deduplicationManager.getStats()}resetDeduplicationStats(){this.deduplicationManager.resetStats()}isRequestDeduplicating(e){const t=this.keyGenerator.generate(e);return this.deduplicationManager.isRunning(t)}cancelDeduplicatedRequest(e){const t=this.keyGenerator.generate(e);this.deduplicationManager.cancel(t)}async waitForDeduplicatedRequest(e){const t=this.keyGenerator.generate(e);return this.deduplicationManager.waitFor(t)}getDeduplicationTasksInfo(){return this.deduplicationManager.getAllTaskInfo()}cleanupTimeoutDeduplicationTasks(e=3e4){return this.deduplicationManager.cleanupTimeoutTasks(e)}configureDeduplicationKeyGenerator(e){this.keyGenerator=new t.DeduplicationKeyGenerator(e)}generateTaskId(){return`task_${++this.requestCounter}_${Date.now()}`}}exports.DeduplicationManager=e.DeduplicationManager,exports.createDeduplicationManager=e.createDeduplicationManager,exports.DeduplicationKeyGenerator=t.DeduplicationKeyGenerator,exports.createDeduplicationKeyGenerator=t.createDeduplicationKeyGenerator,exports.RateLimitManager=i.RateLimitManager,exports.createRateLimitManager=i.createRateLimitManager,exports.ConcurrencyManager=n,exports.createConcurrencyManager=function(e){return new n(e)};
//# sourceMappingURL=concurrency.cjs.map

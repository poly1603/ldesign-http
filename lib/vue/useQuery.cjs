"use strict";var e=require("vue"),n=require("../utils/cancel.cjs");const t=new class{constructor(){this.cache=new Map}get(e,n){const t=this.cache.get(e);return t?Date.now()-t.timestamp>n?null:t.data:null}set(e,n,t){this.cache.set(e,{data:n,timestamp:Date.now(),staleTime:t})}invalidate(e){this.cache.delete(e)}clear(){this.cache.clear()}};exports.useQuery=function(a,r,l,u={}){const o=e.ref(u.initialData??null),c=e.ref(!1),i=e.ref(null),s=e.ref(!1),v=e.ref(!1),f=e.ref(!1),d=e.ref(0),w=e.ref(0),m=u.staleTime??3e5,h=u.retry??3,y=u.retryDelay??1e3;let p=n.createCancelTokenSource();const E=e.computed(()=>c.value||f.value),U=e.computed(()=>!1!==e.unref(u.enabled)),g=()=>{const n=e.unref(r);return"function"==typeof n?n():n},D=async r=>{if(!U.value)throw new Error("Query is disabled");const E=g(),D=t.get(E,m);if(D&&!r)return o.value=D,v.value=!1,s.value=!0,{data:D};o.value?(f.value=!0,v.value=!0):c.value=!0,i.value=null,s.value=!1,p=n.createCancelTokenSource();let C=0;const I="number"==typeof h?h:!0===h?3:0;for(;C<=I;)try{const n={...e.unref(l),...r,signal:p.token.promise},c=await a.request(n);let i=c.data;return u.transform&&(i=u.transform(c.data)),o.value=i,v.value=!1,s.value=!0,d.value=Date.now(),w.value=0,t.set(E,i,m),u.onSuccess&&u.onSuccess(i,c),c}catch(e){const t=e;if(n.isCancelError(t))throw t;if(C++,w.value=C,C<=I&&("function"!=typeof h||h(C,t))){const e="function"==typeof y?y(C):y*2**(C-1);await new Promise(n=>setTimeout(n,e));continue}throw i.value=t,s.value=!0,u.onError&&u.onError(t),t}finally{c.value=!1,f.value=!1,u.onFinally&&u.onFinally()}throw i.value||new Error("Unknown error")},C=()=>{E.value&&p.cancel("Query cancelled by user")};if(e.watch([()=>g(),()=>e.unref(l),U],()=>{U.value&&!1!==u.immediate&&D()},{immediate:!1!==u.immediate,deep:!0}),u.refetchOnWindowFocus){const n=()=>{U.value&&o.value&&D()};typeof window<"u"&&(window.addEventListener("focus",n),e.onUnmounted(()=>{window.removeEventListener("focus",n)}))}if(u.refetchOnReconnect){const n=()=>{U.value&&o.value&&D()};typeof window<"u"&&(window.addEventListener("online",n),e.onUnmounted(()=>{window.removeEventListener("online",n)}))}if(u.refetchInterval&&u.refetchInterval>0){const n=setInterval(()=>{U.value&&o.value&&D()},u.refetchInterval);e.onUnmounted(()=>{clearInterval(n)})}return!1!==u.cancelOnUnmount&&e.onUnmounted(()=>{C()}),{data:o,loading:c,error:i,finished:s,isStale:v,isFetching:f,dataUpdatedAt:d,failureCount:w,execute:D,refresh:()=>D(),cancel:C,reset:()=>{o.value=u.initialData??null,c.value=!1,i.value=null,s.value=!1,v.value=!1,f.value=!1,d.value=0,w.value=0},invalidate:()=>{const e=g();t.invalidate(e),v.value=!0},canCancel:E}};
//# sourceMappingURL=useQuery.cjs.map

{"version":3,"file":"useMutation.cjs","sources":["../../src/vue/useMutation.ts"],"sourcesContent":["import type { Ref } from 'vue'\r\nimport type {\r\n  HttpClient,\r\n  HttpError,\r\n  RequestConfig,\r\n  ResponseData,\r\n} from '../types'\r\nimport type { UseMutationOptions, UseMutationReturn } from '../types/vue'\r\nimport { onUnmounted, ref } from 'vue'\r\nimport { createCancelTokenSource, isCancelError } from '../utils/cancel'\r\n\r\n/**\r\n * useMutation Hook\r\n * 用于处理变更操作（POST、PUT、DELETE 等）\r\n */\r\nexport function useMutation<T = any, V = any>(\r\n  _client: HttpClient,\r\n  mutationFn: (\r\n    variables: V,\r\n    config?: RequestConfig\r\n  ) => Promise<ResponseData<T>>,\r\n  options: UseMutationOptions<T, V> = {},\r\n): UseMutationReturn<T, V> {\r\n  // 响应式状态\r\n  const data = ref<T | null>(null)\r\n  const loading = ref<boolean>(false)\r\n  const error = ref<HttpError | null>(null)\r\n  const finished = ref<boolean>(false)\r\n\r\n  // 取消控制\r\n  let cancelTokenSource = createCancelTokenSource()\r\n\r\n  /**\r\n   * 执行变更\r\n   */\r\n  const mutate = async (\r\n    variables: V,\r\n    config?: RequestConfig,\r\n  ): Promise<ResponseData<T>> => {\r\n    // 重置状态\r\n    loading.value = true\r\n    error.value = null\r\n    finished.value = false\r\n\r\n    // 创建新的取消令牌\r\n    cancelTokenSource = createCancelTokenSource()\r\n\r\n    try {\r\n      // 调用开始回调\r\n      if (options.onMutate) {\r\n        options.onMutate(variables)\r\n      }\r\n\r\n      // 执行变更\r\n      const response = await mutationFn(variables, {\r\n        ...config,\r\n        signal: cancelTokenSource.token.promise as any,\r\n      })\r\n\r\n      // 更新状态\r\n      data.value = response.data\r\n      finished.value = true\r\n\r\n      // 调用成功回调\r\n      if (options.onSuccess) {\r\n        options.onSuccess(response.data, variables, response)\r\n      }\r\n\r\n      return response\r\n    }\r\n    catch (err) {\r\n      const httpError = err as HttpError\r\n\r\n      // 如果不是取消错误，更新错误状态\r\n      if (!isCancelError(httpError)) {\r\n        error.value = httpError\r\n        finished.value = true\r\n\r\n        // 调用错误回调\r\n        if (options.onError) {\r\n          options.onError(httpError, variables)\r\n        }\r\n      }\r\n\r\n      throw httpError\r\n    }\r\n    finally {\r\n      loading.value = false\r\n\r\n      // 调用完成回调\r\n      if (options.onSettled) {\r\n        options.onSettled(data.value ?? undefined, error.value, variables)\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 异步执行变更\r\n   */\r\n  const mutateAsync = mutate\r\n\r\n  /**\r\n   * 重置状态\r\n   */\r\n  const reset = (): void => {\r\n    data.value = null\r\n    loading.value = false\r\n    error.value = null\r\n    finished.value = false\r\n  }\r\n\r\n  // 组件卸载时取消请求\r\n  onUnmounted(() => {\r\n    if (loading.value) {\r\n      cancelTokenSource.cancel('Mutation cancelled due to component unmount')\r\n    }\r\n  })\r\n\r\n  return {\r\n    data: data as Ref<T | null>,\r\n    loading,\r\n    error,\r\n    finished,\r\n    mutate,\r\n    mutateAsync,\r\n    reset,\r\n  }\r\n}\r\n\r\n/**\r\n * 简化的变更 Hook，用于特定的 HTTP 方法\r\n */\r\nexport function usePost<T = any, D = any>(\r\n  client: HttpClient,\r\n  url: string,\r\n  options?: UseMutationOptions<T, D>,\r\n): UseMutationReturn<T, D> {\r\n  return useMutation(\r\n    client,\r\n    (data: D, config?: RequestConfig) => client.post<T>(url, data, config),\r\n    options,\r\n  )\r\n}\r\n\r\nexport function usePut<T = any, D = any>(\r\n  client: HttpClient,\r\n  url: string,\r\n  options?: UseMutationOptions<T, D>,\r\n): UseMutationReturn<T, D> {\r\n  return useMutation(\r\n    client,\r\n    (data: D, config?: RequestConfig) => client.put<T>(url, data, config),\r\n    options,\r\n  )\r\n}\r\n\r\nexport function usePatch<T = any, D = any>(\r\n  client: HttpClient,\r\n  url: string,\r\n  options?: UseMutationOptions<T, D>,\r\n): UseMutationReturn<T, D> {\r\n  return useMutation(\r\n    client,\r\n    (data: D, config?: RequestConfig) => client.patch<T>(url, data, config),\r\n    options,\r\n  )\r\n}\r\n\r\nexport function useDelete<T = any>(\r\n  client: HttpClient,\r\n  url: string,\r\n  options?: UseMutationOptions<T, void>,\r\n): UseMutationReturn<T, void> {\r\n  return useMutation(\r\n    client,\r\n    (_, config?: RequestConfig) => client.delete<T>(url, config),\r\n    options,\r\n  )\r\n}\r\n"],"names":["useMutation","_client","mutationFn","options","data","ref","loading","error","finished","cancelTokenSource","createCancelTokenSource","mutate","async","variables","config","value","onMutate","response","signal","token","promise","onSuccess","err","httpError","isCancelError","onError","onSettled","mutateAsync","onUnmounted","cancel","reset","client","url","_","delete","patch","post","put"],"mappings":"mEAeM,SAAUA,EACdC,EACAC,EAIAC,EAAoC,CAAA,GAGpC,MAAMC,EAAOC,EAAAA,IAAc,MACrBC,EAAUD,EAAAA,KAAa,GACvBE,EAAQF,MAAsB,MAC9BG,EAAWH,EAAAA,KAAa,GAG9B,IAAII,EAAoBC,EAAAA,0BAKxB,MAAMC,EAASC,MACbC,EACAC,KAGAR,EAAQS,OAAQ,EAChBR,EAAMQ,MAAQ,KACdP,EAASO,OAAQ,EAGjBN,EAAoBC,EAAAA,0BAEpB,IAEMP,EAAQa,UACVb,EAAQa,SAASH,GAInB,MAAMI,QAAiBf,EAAWW,EAAW,IACxCC,EACHI,OAAQT,EAAkBU,MAAMC,UAIlC,OAAAhB,EAAKW,MAAQE,EAASb,KACtBI,EAASO,OAAQ,EAGbZ,EAAQkB,WACVlB,EAAQkB,UAAUJ,EAASb,KAAMS,EAAWI,GAGvCA,CACT,CAAA,MACOK,GACL,MAAMC,EAAYD,EAGlB,MAAKE,EAAAA,cAAcD,KACjBhB,EAAMQ,MAAQQ,EACdf,EAASO,OAAQ,EAGbZ,EAAQsB,SACVtB,EAAQsB,QAAQF,EAAWV,IAIzBU,CACR,CAAA,QAEEjB,EAAQS,OAAQ,EAGZZ,EAAQuB,WACVvB,EAAQuB,UAAUtB,EAAKW,YAAS,EAAWR,EAAMQ,MAAOF,EAE5D,GAMIc,EAAchB,EAapB,OAAAiB,EAAAA,YAAY,KACNtB,EAAQS,OACVN,EAAkBoB,OAAO,iDAItB,CACLzB,KAAMA,EACNE,QAAAA,EACAC,MAAAA,EACAC,SAAAA,EACAG,OAAAA,EACAgB,YAAAA,EACAG,MArBY,KACZ1B,EAAKW,MAAQ,KACbT,EAAQS,OAAQ,EAChBR,EAAMQ,MAAQ,KACdP,EAASO,OAAQ,GAmBrB,4BA0CEgB,EACAC,EACA7B,GAEA,OAAOH,EACL+B,EACA,CAACE,EAAGnB,IAA2BiB,EAAOG,OAAUF,EAAKlB,GACrDX,EAEJ,kDArBE4B,EACAC,EACA7B,GAEA,OAAOH,EACL+B,EACA,CAAC3B,EAASU,IAA2BiB,EAAOI,MAASH,EAAK5B,EAAMU,GAChEX,EAEJ,2BAjCE4B,EACAC,EACA7B,GAEA,OAAOH,EACL+B,EACA,CAAC3B,EAASU,IAA2BiB,EAAOK,KAAQJ,EAAK5B,EAAMU,GAC/DX,EAEJ,0BAGE4B,EACAC,EACA7B,GAEA,OAAOH,EACL+B,EACA,CAAC3B,EAASU,IAA2BiB,EAAOM,IAAOL,EAAK5B,EAAMU,GAC9DX,EAEJ"}
{"version":3,"file":"useHttp.cjs","sources":["../../src/vue/useHttp.ts"],"sourcesContent":["import type { InjectionKey, Ref } from 'vue'\r\nimport type { HttpClient, RequestConfig } from '../types'\r\nimport { computed, inject, provide, ref } from 'vue'\r\nimport {\r\n  useDelete,\r\n  useMutation,\r\n  usePatch,\r\n  usePost,\r\n  usePut,\r\n} from './useMutation'\r\nimport { useQuery } from './useQuery'\r\nimport { useRequest } from './useRequest'\r\n\r\n/**\r\n * HTTP 客户端注入键\r\n */\r\nexport const HTTP_CLIENT_KEY: InjectionKey<HttpClient> = Symbol('http-client')\r\n\r\n/**\r\n * 全局配置注入键\r\n */\r\nexport const HTTP_CONFIG_KEY: InjectionKey<Ref<RequestConfig>>\r\n  = Symbol('http-config')\r\n\r\n/**\r\n * 提供 HTTP 客户端\r\n */\r\nexport function provideHttpClient(\r\n  client: HttpClient,\r\n  globalConfig?: RequestConfig,\r\n): void {\r\n  provide(HTTP_CLIENT_KEY, client)\r\n  if (globalConfig) {\r\n    provide(HTTP_CONFIG_KEY, ref(globalConfig))\r\n  }\r\n}\r\n\r\n/**\r\n * 注入 HTTP 客户端\r\n */\r\nexport function injectHttpClient(): HttpClient {\r\n  const client = inject(HTTP_CLIENT_KEY)\r\n  if (!client) {\r\n    throw new Error(\r\n      'HTTP client not provided. Please use provideHttpClient() in a parent component.',\r\n    )\r\n  }\r\n  return client as HttpClient\r\n}\r\n\r\n/**\r\n * 注入全局配置\r\n */\r\nexport function injectHttpConfig(): Ref<RequestConfig> {\r\n  return inject(HTTP_CONFIG_KEY, ref({})) as Ref<RequestConfig>\r\n}\r\n\r\n/**\r\n * 主要的 HTTP Hook\r\n * 自动注入客户端和全局配置\r\n */\r\nexport function useHttp() {\r\n  const client = injectHttpClient()\r\n  const globalConfig = injectHttpConfig()\r\n\r\n  /**\r\n   * 合并全局配置\r\n   */\r\n  const mergeConfig = (config: RequestConfig = {}): RequestConfig => {\r\n    return {\r\n      ...globalConfig.value,\r\n      ...config,\r\n      headers: {\r\n        ...globalConfig.value.headers,\r\n        ...config.headers,\r\n      },\r\n    }\r\n  }\r\n\r\n  return {\r\n    client,\r\n    globalConfig,\r\n\r\n    // 基础请求方法\r\n    request: <T = any>(config: RequestConfig) =>\r\n      client.request<T>(mergeConfig(config)),\r\n\r\n    get: <T = any>(url: string, config?: RequestConfig) =>\r\n      client.get<T>(url, mergeConfig(config)),\r\n\r\n    post: <T = any>(url: string, data?: any, config?: RequestConfig) =>\r\n      client.post<T>(url, data, mergeConfig(config)),\r\n\r\n    put: <T = any>(url: string, data?: any, config?: RequestConfig) =>\r\n      client.put<T>(url, data, mergeConfig(config)),\r\n\r\n    delete: <T = any>(url: string, config?: RequestConfig) =>\r\n      client.delete<T>(url, mergeConfig(config)),\r\n\r\n    patch: <T = any>(url: string, data?: any, config?: RequestConfig) =>\r\n      client.patch<T>(url, data, mergeConfig(config)),\r\n\r\n    head: <T = any>(url: string, config?: RequestConfig) =>\r\n      client.head<T>(url, mergeConfig(config)),\r\n\r\n    options: <T = any>(url: string, config?: RequestConfig) =>\r\n      client.options<T>(url, mergeConfig(config)),\r\n\r\n    // Composition API hooks\r\n    useRequest: <T = any>(config: RequestConfig, options?: any) =>\r\n      useRequest<T>(client, ref(mergeConfig(config)), options),\r\n\r\n    useQuery: <T = any>(queryKey: any, config: RequestConfig, options?: any) =>\r\n      useQuery<T>(client, queryKey, ref(mergeConfig(config)), options),\r\n\r\n    useMutation: <T = any, V = any>(mutationFn: any, options?: any) =>\r\n      useMutation<T, V>(client, mutationFn, options),\r\n\r\n    usePost: <T = any, D = any>(url: string, options?: any) =>\r\n      usePost<T, D>(client, url, options),\r\n\r\n    usePut: <T = any, D = any>(url: string, options?: any) =>\r\n      usePut<T, D>(client, url, options),\r\n\r\n    usePatch: <T = any, D = any>(url: string, options?: any) =>\r\n      usePatch<T, D>(client, url, options),\r\n\r\n    useDelete: <T = any>(url: string, options?: any) =>\r\n      useDelete<T>(client, url, options),\r\n\r\n    // 客户端控制方法\r\n    cancelAll: (reason?: string) => client.cancelAll(reason),\r\n    clearCache: () => client.clearCache(),\r\n    getActiveRequestCount: () => client.getActiveRequestCount(),\r\n    getConcurrencyStatus: () => client.getConcurrencyStatus(),\r\n  }\r\n}\r\n\r\n/**\r\n * 创建资源 Hook\r\n * 用于 RESTful API 操作\r\n *\r\n * 注意: 这是一个轻量级的资源hook,用于依赖注入场景\r\n * 如需更完整的功能(loading状态、error处理等),请使用 useResource from './useResource'\r\n */\r\nexport function useResource<T = any>(baseUrl: string) {\r\n  const {\r\n    get,\r\n    post,\r\n    put,\r\n    patch,\r\n    delete: del,\r\n    useQuery,\r\n    useMutation,\r\n  } = useHttp()\r\n\r\n  return {\r\n    // 查询操作\r\n    useList: (params?: Record<string, any>, options?: any) =>\r\n      useQuery(\r\n        ['resource-list', baseUrl, params],\r\n        { url: baseUrl, params },\r\n        options,\r\n      ),\r\n\r\n    useDetail: (id: string | number, options?: any) =>\r\n      useQuery(\r\n        ['resource-detail', baseUrl, id],\r\n        { url: `${baseUrl}/${id}` },\r\n        options,\r\n      ),\r\n\r\n    // 变更操作\r\n    useCreate: (options?: any) =>\r\n      useMutation((data: T) => post<T>(`${baseUrl}`, data), options),\r\n\r\n    useUpdate: (options?: any) =>\r\n      useMutation(\r\n        ({ id, data }: { id: string | number, data: Partial<T> }) =>\r\n          put<T>(`${baseUrl}/${id}`, data),\r\n        options,\r\n      ),\r\n\r\n    usePatch: (options?: any) =>\r\n      useMutation(\r\n        ({ id, data }: { id: string | number, data: Partial<T> }) =>\r\n          patch<T>(`${baseUrl}/${id}`, data),\r\n        options,\r\n      ),\r\n\r\n    useDelete: (options?: any) =>\r\n      useMutation((id: string | number) => del(`${baseUrl}/${id}`), options),\r\n\r\n    // 直接调用方法\r\n    list: (params?: Record<string, any>) => get<T[]>(baseUrl, { params }),\r\n    detail: (id: string | number) => get<T>(`${baseUrl}/${id}`),\r\n    create: (data: T) => post<T>(baseUrl, data),\r\n    update: (id: string | number, data: Partial<T>) =>\r\n      put<T>(`${baseUrl}/${id}`, data),\r\n    patch: (id: string | number, data: Partial<T>) =>\r\n      patch<T>(`${baseUrl}/${id}`, data),\r\n    remove: (id: string | number) => del(`${baseUrl}/${id}`),\r\n  }\r\n}\r\n\r\n/**\r\n * 分页查询 Hook\r\n */\r\nexport function usePagination<T = any>(\r\n  baseUrl: string,\r\n  initialPage = 1,\r\n  initialPageSize = 10,\r\n) {\r\n  const page = ref<number>(initialPage)\r\n  const pageSize = ref<number>(initialPageSize)\r\n  const total = ref<number>(0)\r\n\r\n  const { useQuery } = useHttp()\r\n\r\n  const queryKey = computed(() => [\r\n    'pagination',\r\n    baseUrl,\r\n    page.value,\r\n    pageSize.value,\r\n  ])\r\n  const config = computed(() => ({\r\n    url: baseUrl,\r\n    params: {\r\n      page: page.value,\r\n      pageSize: pageSize.value,\r\n    },\r\n  }))\r\n\r\n  const query = useQuery<{\r\n    data: T[]\r\n    total: number\r\n    page: number\r\n    pageSize: number\r\n  }>(queryKey, config.value, {\r\n    onSuccess: (data: {\r\n      data: T[]\r\n      total: number\r\n      page: number\r\n      pageSize: number\r\n    }) => {\r\n      total.value = data.total\r\n    },\r\n  })\r\n\r\n  const totalPages = computed(() => Math.ceil(total.value / pageSize.value))\r\n  const hasNextPage = computed(() => page.value < totalPages.value)\r\n  const hasPrevPage = computed(() => page.value > 1)\r\n\r\n  const nextPage = () => {\r\n    if (hasNextPage.value) {\r\n      page.value++\r\n    }\r\n  }\r\n\r\n  const prevPage = () => {\r\n    if (hasPrevPage.value) {\r\n      page.value--\r\n    }\r\n  }\r\n\r\n  const goToPage = (targetPage: number) => {\r\n    if (targetPage >= 1 && targetPage <= totalPages.value) {\r\n      page.value = targetPage\r\n    }\r\n  }\r\n\r\n  const setPageSize = (newPageSize: number) => {\r\n    pageSize.value = newPageSize\r\n    page.value = 1 // 重置到第一页\r\n  }\r\n\r\n  return {\r\n    // 查询状态\r\n    ...query,\r\n\r\n    // 分页数据\r\n    page,\r\n    pageSize,\r\n    total,\r\n    totalPages,\r\n    hasNextPage,\r\n    hasPrevPage,\r\n\r\n    // 操作方法\r\n    nextPage,\r\n    prevPage,\r\n    goToPage,\r\n    setPageSize,\r\n  }\r\n}\r\n"],"names":["HTTP_CLIENT_KEY","Symbol","HTTP_CONFIG_KEY","injectHttpClient","client","inject","Error","injectHttpConfig","ref","useHttp","globalConfig","mergeConfig","config","value","headers","request","get","url","post","data","put","delete","patch","head","options","useRequest","useQuery","queryKey","useMutation","mutationFn","usePost","usePut","usePatch","useDelete","cancelAll","reason","clearCache","getActiveRequestCount","getConcurrencyStatus","provide","baseUrl","initialPage","initialPageSize","page","pageSize","total","query","computed","params","onSuccess","totalPages","Math","ceil","hasNextPage","hasPrevPage","nextPage","prevPage","goToPage","targetPage","setPageSize","newPageSize","del","useList","useDetail","id","useCreate","useUpdate","list","detail","create","update","remove"],"mappings":"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"}
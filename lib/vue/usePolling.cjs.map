{"version":3,"file":"usePolling.cjs","sources":["../../src/vue/usePolling.ts"],"sourcesContent":["/**\r\n * Vue 智能轮询 Composable\r\n *\r\n * 自动轮询请求，支持条件停止、错误处理、网络感知等\r\n */\r\n\r\nimport type { Ref } from 'vue'\r\nimport type { HttpClient, RequestConfig } from '../types'\r\nimport { onUnmounted, ref } from 'vue'\r\nimport { createHttpClient } from '../factory'\r\n\r\n/**\r\n * 轮询配置\r\n */\r\nexport interface PollingConfig {\r\n /** 轮询间隔(ms) */\r\n interval: number\r\n /** 是否立即执行第一次请求 */\r\n immediate?: boolean\r\n /** 是否在页面不可见时暂停 */\r\n pauseWhenHidden?: boolean\r\n /** 是否在离线时暂停 */\r\n pauseWhenOffline?: boolean\r\n /** 最大轮询次数 */\r\n maxPolls?: number\r\n /** 停止条件 */\r\n stopWhen?: (data: any) => boolean\r\n /** 错误时是否停止 */\r\n stopOnError?: boolean\r\n /** 成功回调 */\r\n onSuccess?: (data: any) => void\r\n /** 错误回调 */\r\n onError?: (error: Error) => void\r\n /** 使用自定义客户端 */\r\n client?: HttpClient\r\n}\r\n\r\n/**\r\n * 轮询返回值\r\n */\r\nexport interface UsePollingReturn<T> {\r\n /** 数据 */\r\n data: Ref<T | null>\r\n /** 加载状态 */\r\n loading: Ref<boolean>\r\n /** 错误 */\r\n error: Ref<Error | null>\r\n /** 是否正在轮询 */\r\n isPolling: Ref<boolean>\r\n /** 已轮询次数 */\r\n pollCount: Ref<number>\r\n /** 开始轮询 */\r\n start: () => void\r\n /** 停止轮询 */\r\n stop: () => void\r\n /** 重启轮询 */\r\n restart: () => void\r\n /** 手动执行一次 */\r\n execute: () => Promise<T | null>\r\n}\r\n\r\n/**\r\n * 智能轮询 Hook\r\n *\r\n * 自动轮询请求，支持丰富的配置选项\r\n *\r\n * @example\r\n * ```vue\r\n * <script setup>\r\n * import { usePolling } from '@ldesign/http'\r\n *\r\n * // 每5秒轮询任务状态，直到任务完成\r\n * const { data: task, isPolling, stop } = usePolling(\r\n *  { url: '/api/tasks/123' },\r\n *  {\r\n *   interval: 5000,\r\n *   stopWhen: (task) => task.status === 'completed',\r\n *   onSuccess: (task) => {\r\n *    if (task.status === 'completed') {\r\n *     \r\n *    }\r\n *   },\r\n *  }\r\n * )\r\n * </script>\r\n *\r\n * <template>\r\n *  <div>\r\n *   <div v-if=\"task\">状态: {{ task.status }}</div>\r\n *   <button v-if=\"isPolling\" @click=\"stop\">停止轮询</button>\r\n *  </div>\r\n * </template>\r\n * ```\r\n */\r\nexport function usePolling<T = any>(\r\n requestConfig: RequestConfig,\r\n config: PollingConfig,\r\n): UsePollingReturn<T> {\r\n const client = config.client || createHttpClient()\r\n\r\n const data = ref<T | null>(null)\r\n const loading = ref(false)\r\n const error = ref<Error | null>(null)\r\n const isPolling = ref(false)\r\n const pollCount = ref(0)\r\n\r\n let timerId: ReturnType<typeof setTimeout> | null = null\r\n let isPageVisible = true\r\n let isOnline = true\r\n\r\n  /**\r\n   * 安排下一次轮询\r\n   */\r\n  function scheduleNext() {\r\n    if (timerId) {\r\n      clearTimeout(timerId)\r\n    }\r\n    timerId = setTimeout(pollLoop, config.interval)\r\n  }\r\n\r\n  /**\r\n   * 停止轮询\r\n   */\r\n  const stop = () => {\r\n    isPolling.value = false\r\n\r\n    if (timerId) {\r\n      clearTimeout(timerId)\r\n      timerId = null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 执行单次请求\r\n   */\r\n  async function execute(): Promise<T | null> {\r\n  try {\r\n   loading.value = true\r\n   error.value = null\r\n\r\n   const response = await client.request<T>(requestConfig)\r\n   data.value = response.data\r\n   pollCount.value++\r\n\r\n   // 触发成功回调\r\n   config.onSuccess?.(response.data)\r\n\r\n   // 检查停止条件\r\n   if (config.stopWhen?.(response.data)) {\r\n    stop()\r\n   }\r\n\r\n   // 检查最大轮询次数\r\n   if (config.maxPolls && pollCount.value >= config.maxPolls) {\r\n    stop()\r\n   }\r\n\r\n   return response.data\r\n  }\r\n  catch (err) {\r\n   const errorObj = err as Error\r\n   error.value = errorObj\r\n\r\n   // 触发错误回调\r\n   config.onError?.(errorObj)\r\n\r\n   // 错误时是否停止\r\n   if (config.stopOnError) {\r\n    stop()\r\n   }\r\n\r\n   return null\r\n  }\r\n  finally {\r\n   loading.value = false\r\n  }\r\n }\r\n\r\n /**\r\n  * 轮询循环\r\n  */\r\n async function pollLoop() {\r\n  if (!isPolling.value) return\r\n\r\n  // 检查暂停条件\r\n  if (config.pauseWhenHidden && !isPageVisible) {\r\n   // 页面不可见，延迟后继续\r\n   scheduleNext()\r\n   return\r\n  }\r\n\r\n  if (config.pauseWhenOffline && !isOnline) {\r\n   // 离线，延迟后继续\r\n   scheduleNext()\r\n   return\r\n  }\r\n\r\n  // 执行请求\r\n  await execute()\r\n\r\n  // 如果还在轮询，安排下一次\r\n  if (isPolling.value) {\r\n   scheduleNext()\r\n  }\r\n }\r\n\r\n  /**\r\n   * 开始轮询\r\n   */\r\n  function start() {\r\n    if (isPolling.value) return\r\n\r\n    isPolling.value = true\r\n    pollCount.value = 0\r\n\r\n    // 立即执行\r\n    if (config.immediate !== false) {\r\n      pollLoop()\r\n    }\r\n    else {\r\n      scheduleNext()\r\n    }\r\n  }\r\n\r\n /**\r\n  * 重启轮询\r\n  */\r\n function restart() {\r\n  stop()\r\n  start()\r\n }\r\n\r\n // 监听页面可见性\r\n if (config.pauseWhenHidden && typeof document !== 'undefined') {\r\n  const handleVisibilityChange = () => {\r\n   isPageVisible = !document.hidden\r\n  }\r\n\r\n  document.addEventListener('visibilitychange', handleVisibilityChange)\r\n\r\n  onUnmounted(() => {\r\n   document.removeEventListener('visibilitychange', handleVisibilityChange)\r\n  })\r\n }\r\n\r\n // 监听网络状态\r\n if (config.pauseWhenOffline && typeof window !== 'undefined') {\r\n  const handleOnline = () => {\r\n   isOnline = true\r\n  }\r\n  const handleOffline = () => {\r\n   isOnline = false\r\n  }\r\n\r\n  window.addEventListener('online', handleOnline)\r\n  window.addEventListener('offline', handleOffline)\r\n\r\n  onUnmounted(() => {\r\n   window.removeEventListener('online', handleOnline)\r\n   window.removeEventListener('offline', handleOffline)\r\n  })\r\n }\r\n\r\n // 组件卸载时停止轮询\r\n onUnmounted(() => {\r\n  stop()\r\n })\r\n\r\n // 自动开始\r\n if (config.immediate !== false) {\r\n  start()\r\n }\r\n\r\n return {\r\n  data: data as Ref<T | null>,\r\n  loading,\r\n  error,\r\n  isPolling,\r\n  pollCount,\r\n  start,\r\n  stop,\r\n  restart,\r\n  execute,\r\n }\r\n}\r\n\r\n/**\r\n * 轮询直到条件满足\r\n *\r\n * 简化版本，只需要提供停止条件\r\n */\r\nexport function usePollingUntil<T = any>(\r\n requestConfig: RequestConfig,\r\n stopWhen: (data: T) => boolean,\r\n interval = 3000,\r\n): UsePollingReturn<T> {\r\n return usePolling<T>(requestConfig, {\r\n  interval,\r\n  stopWhen,\r\n  immediate: true,\r\n })\r\n}\r\n\r\n/**\r\n * 轮询N次\r\n *\r\n * 简化版本，轮询固定次数后自动停止\r\n */\r\nexport function usePollingTimes<T = any>(\r\n requestConfig: RequestConfig,\r\n maxPolls: number,\r\n interval = 3000,\r\n): UsePollingReturn<T> {\r\n return usePolling<T>(requestConfig, {\r\n  interval,\r\n  maxPolls,\r\n  immediate: true,\r\n })\r\n}\r\n"],"names":["usePolling","requestConfig","config","client","createHttpClient","data","ref","loading","error","isPolling","pollCount","timerId","isPageVisible","isOnline","scheduleNext","clearTimeout","setTimeout","pollLoop","interval","stop","value","async","execute","response","request","onSuccess","stopWhen","maxPolls","err","errorObj","onError","stopOnError","pauseWhenHidden","pauseWhenOffline","start","immediate","document","handleVisibilityChange","hidden","addEventListener","onUnmounted","removeEventListener","window","handleOnline","handleOffline","restart"],"mappings":"8DA8FM,SAAUA,EACfC,EACAC,GAEA,MAAMC,EAASD,EAAOC,QAAUC,EAAAA,mBAE1BC,EAAOC,EAAAA,IAAc,MACrBC,EAAUD,EAAAA,KAAI,GACdE,EAAQF,EAAAA,IAAkB,MAC1BG,EAAYH,EAAAA,KAAI,GAChBI,EAAYJ,EAAAA,IAAI,GAEtB,IAAIK,EAAgD,KAChDC,GAAgB,EAChBC,GAAW,EAKd,SAASC,IACHH,GACFI,aAAaJ,GAEfA,EAAUK,WAAWC,EAAUf,EAAOgB,SACxC,CAKA,MAAMC,EAAO,KACXV,EAAUW,OAAQ,EAEdT,IACFI,aAAaJ,GACbA,EAAU,OAOdU,eAAeC,IACf,IACCf,EAAQa,OAAQ,EAChBZ,EAAMY,MAAQ,KAEd,MAAMG,QAAiBpB,EAAOqB,QAAWvB,GACzC,OAAAI,EAAKe,MAAQG,EAASlB,KACtBK,EAAUU,QAGVlB,EAAOuB,YAAYF,EAASlB,MAGxBH,EAAOwB,WAAWH,EAASlB,OAC9Bc,IAIGjB,EAAOyB,UAAYjB,EAAUU,OAASlB,EAAOyB,UAChDR,IAGMI,EAASlB,IACjB,CAAA,MACOuB,GACN,MAAMC,EAAWD,EACjB,OAAApB,EAAMY,MAAQS,EAGd3B,EAAO4B,UAAUD,GAGb3B,EAAO6B,aACVZ,IAGM,IACR,SAECZ,EAAQa,OAAQ,CACjB,CACD,CAKAC,eAAeJ,IACd,GAAKR,EAAUW,MAGf,CAAA,GAAIlB,EAAO8B,kBAAoBpB,EAG9B,YADAE,IAID,GAAIZ,EAAO+B,mBAAqBpB,EAG/B,YADAC,UAKKQ,IAGFb,EAAUW,OACbN,IAEF,CAKC,SAASoB,IACHzB,EAAUW,QAEdX,EAAUW,OAAQ,EAClBV,EAAUU,MAAQ,GAGO,IAArBlB,EAAOiC,UACTlB,IAGAH,IAEJ,CAWD,GAAIZ,EAAO8B,wBAA0BI,SAAa,IAAa,CAC9D,MAAMC,EAAyB,KAC9BzB,GAAiBwB,SAASE,QAG3BF,SAASG,iBAAiB,mBAAoBF,GAE9CG,EAAAA,YAAY,KACXJ,SAASK,oBAAoB,mBAAoBJ,IAEnD,CAGA,GAAInC,EAAO+B,yBAA2BS,OAAW,IAAa,CAC7D,MAAMC,EAAe,KACpB9B,GAAW,GAEN+B,EAAgB,KACrB/B,GAAW,GAGZ6B,OAAOH,iBAAiB,SAAUI,GAClCD,OAAOH,iBAAiB,UAAWK,GAEnCJ,EAAAA,YAAY,KACXE,OAAOD,oBAAoB,SAAUE,GACrCD,OAAOD,oBAAoB,UAAWG,IAExC,CAGA,OAAAJ,cAAY,KACXrB,OAIwB,IAArBjB,EAAOiC,WACVD,IAGM,CACN7B,KAAMA,EACNE,QAAAA,EACAC,MAAAA,EACAC,UAAAA,EACAC,UAAAA,EACAwB,MAAAA,EACAf,KAAAA,EACA0B,QAtDD,WACC1B,IACAe,GACD,EAoDCZ,QAAAA,EAEF,8CAwBM,SACLrB,EACA0B,EACAT,EAAW,KAEX,OAAOlB,EAAcC,EAAe,CACnCiB,SAAAA,EACAS,SAAAA,EACAQ,WAAW,GAEb,0BA3BM,SACLlC,EACAyB,EACAR,EAAW,KAEX,OAAOlB,EAAcC,EAAe,CACnCiB,SAAAA,EACAQ,SAAAA,EACAS,WAAW,GAEb"}
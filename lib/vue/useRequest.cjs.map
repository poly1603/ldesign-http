{"version":3,"file":"useRequest.cjs","sources":["../../src/vue/useRequest.ts"],"sourcesContent":["import type { MaybeRef, Ref } from 'vue'\r\nimport type {\r\n  HttpClient,\r\n  HttpError,\r\n  RequestConfig,\r\n  ResponseData,\r\n} from '../types'\r\nimport type { UseRequestOptions, UseRequestReturn } from '../types/vue'\r\nimport { computed, onUnmounted, ref, unref, watch } from 'vue'\r\nimport { createCancelTokenSource, isCancelError } from '../utils/cancel'\r\n\r\n/**\r\n * useRequest Hook\r\n * 用于处理 HTTP 请求的 Vue 3 Composition API Hook\r\n */\r\nexport function useRequest<T = any>(\r\n  client: HttpClient,\r\n  config: MaybeRef<RequestConfig>,\r\n  options: UseRequestOptions<T> = {},\r\n): UseRequestReturn<T> {\r\n  // 响应式状态\r\n  const data = ref<T | null>(options.initialData ?? null)\r\n  const loading = ref<boolean>(false)\r\n  const error = ref<HttpError | null>(null)\r\n  const finished = ref<boolean>(false)\r\n\r\n  // 取消控制\r\n  let cancelTokenSource = createCancelTokenSource()\r\n\r\n  // 计算属性\r\n  const canCancel = computed(() => loading.value)\r\n\r\n  /**\r\n   * 执行请求\r\n   */\r\n  const execute = async (\r\n    overrideConfig?: RequestConfig,\r\n  ): Promise<ResponseData<T>> => {\r\n    // 重置状态\r\n    loading.value = true\r\n    error.value = null\r\n    finished.value = false\r\n\r\n    // 创建新的取消令牌\r\n    cancelTokenSource = createCancelTokenSource()\r\n\r\n    try {\r\n      // 合并配置\r\n      const requestConfig: RequestConfig = {\r\n        ...unref(config),\r\n        ...overrideConfig,\r\n        signal: cancelTokenSource.token.promise as any,\r\n      }\r\n\r\n      // 发送请求\r\n      const response = await client.request<T>(requestConfig)\r\n\r\n      // 转换数据\r\n      let responseData = response.data\r\n      if (typeof options.transform === 'function') {\r\n        responseData = options.transform(response.data)\r\n      }\r\n\r\n      // 更新状态\r\n      data.value = responseData\r\n      finished.value = true\r\n\r\n      // 调用成功回调\r\n      if (typeof options.onSuccess === 'function') {\r\n        options.onSuccess(responseData, response)\r\n      }\r\n\r\n      return response\r\n    }\r\n    catch (err) {\r\n      const httpError = err as HttpError\r\n\r\n      // 如果不是取消错误，更新错误状态\r\n      if (!isCancelError(httpError)) {\r\n        error.value = httpError\r\n        finished.value = true\r\n\r\n        // 调用错误回调\r\n      if (typeof options.onError === 'function') {\r\n        options.onError(httpError)\r\n      }\r\n      }\r\n\r\n      throw httpError\r\n    }\r\n    finally {\r\n      loading.value = false\r\n\r\n      // 调用完成回调\r\n      if (typeof options.onFinally === 'function') {\r\n        options.onFinally()\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 刷新请求\r\n   */\r\n  const refresh = (): Promise<ResponseData<T>> => {\r\n    return execute()\r\n  }\r\n\r\n  /**\r\n   * 取消请求\r\n   */\r\n  const cancel = (): void => {\r\n    if (canCancel.value) {\r\n      cancelTokenSource.cancel('Request cancelled by user')\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 重置状态\r\n   */\r\n  const reset = (): void => {\r\n    data.value = (options.initialData as T | null) ?? null\r\n    loading.value = false\r\n    error.value = null\r\n    finished.value = false\r\n  }\r\n\r\n  // 监听配置变化\r\n  if (options.immediate !== false) {\r\n    watch(\r\n      () => unref(config),\r\n      () => {\r\n        execute()\r\n      },\r\n      { immediate: true, deep: true },\r\n    )\r\n  }\r\n\r\n  // 组件卸载时取消请求\r\n  if (options.cancelOnUnmount !== false) {\r\n    onUnmounted(() => {\r\n      cancel()\r\n    })\r\n  }\r\n\r\n  return {\r\n    data: data as Ref<T | null>,\r\n    loading,\r\n    error,\r\n    finished,\r\n    execute,\r\n    refresh,\r\n    cancel,\r\n    reset,\r\n    canCancel,\r\n  }\r\n}\r\n\r\n/**\r\n * 简化的 useRequest Hook，用于单次请求\r\n */\r\nexport function useAsyncRequest<T = any>(\r\n  _client: HttpClient,\r\n  requestFn: () => Promise<ResponseData<T>>,\r\n  options: Omit<UseRequestOptions<T>, 'immediate'> = {},\r\n): UseRequestReturn<T> {\r\n  const data = ref<T | null>((options.initialData as T | null) ?? null)\r\n  const loading = ref<boolean>(false)\r\n  const error = ref<HttpError | null>(null)\r\n  const finished = ref<boolean>(false)\r\n\r\n  let cancelTokenSource = createCancelTokenSource()\r\n\r\n  const canCancel = computed(() => loading.value)\r\n\r\n  const execute = async (): Promise<ResponseData<T>> => {\r\n    loading.value = true\r\n    error.value = null\r\n    finished.value = false\r\n\r\n    cancelTokenSource = createCancelTokenSource()\r\n\r\n    try {\r\n      const response = await requestFn()\r\n\r\n      let responseData = response.data\r\n      if (typeof options.transform === 'function') {\r\n        responseData = options.transform(response.data)\r\n      }\r\n\r\n      data.value = responseData\r\n      finished.value = true\r\n\r\n      if (typeof options.onSuccess === 'function') {\r\n        options.onSuccess(responseData, response)\r\n      }\r\n\r\n      return response\r\n    }\r\n    catch (err) {\r\n      const httpError = err as HttpError\r\n\r\n      if (!isCancelError(httpError)) {\r\n        error.value = httpError\r\n        finished.value = true\r\n\r\n        if (typeof options.onError === 'function') {\r\n          options.onError(httpError)\r\n        }\r\n      }\r\n\r\n      throw httpError\r\n    }\r\n    finally {\r\n      loading.value = false\r\n\r\n      if (typeof options.onFinally === 'function') {\r\n        options.onFinally()\r\n      }\r\n    }\r\n  }\r\n\r\n  const refresh = execute\r\n  const cancel = (): void => {\r\n    if (canCancel.value) {\r\n      cancelTokenSource.cancel('Request cancelled by user')\r\n    }\r\n  }\r\n\r\n  const reset = (): void => {\r\n    data.value = (options.initialData as T | null) ?? null\r\n    loading.value = false\r\n    error.value = null\r\n    finished.value = false\r\n  }\r\n\r\n  if (options.cancelOnUnmount !== false) {\r\n    onUnmounted(() => {\r\n      cancel()\r\n    })\r\n  }\r\n\r\n  return {\r\n    data: data as Ref<T | null>,\r\n    loading,\r\n    error,\r\n    finished,\r\n    execute,\r\n    refresh,\r\n    cancel,\r\n    reset,\r\n    canCancel,\r\n  }\r\n}\r\n"],"names":["_client","requestFn","options","data","ref","initialData","loading","error","finished","cancelTokenSource","createCancelTokenSource","canCancel","computed","value","execute","async","response","responseData","transform","onSuccess","err","httpError","isCancelError","onError","onFinally","refresh","cancel","cancelOnUnmount","onUnmounted","reset","client","config","requestConfig","unref","overrideConfig","signal","token","promise","request","immediate","watch","deep"],"mappings":"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"}
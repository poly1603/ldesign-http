{"version":3,"file":"useOptimisticUpdate.cjs","sources":["../../src/vue/useOptimisticUpdate.ts"],"sourcesContent":["import type { Ref } from 'vue'\r\nimport type { HttpClient, RequestConfig } from '../types'\r\nimport { ref } from 'vue'\r\n\r\n/**\r\n * 乐观更新配置\r\n */\r\nexport interface OptimisticUpdateOptions<T> {\r\n  /** 乐观更新函数 */\r\n  optimisticUpdate: (currentData: T, input: any) => T\r\n  /** 失败回滚函数 */\r\n  onRollback?: (error: Error, previousData: T) => void\r\n  /** 成功回调 */\r\n  onSuccess?: (data: T) => void\r\n}\r\n\r\n/**\r\n * 乐观更新 Hook\r\n *\r\n * 先立即更新 UI,再发送请求,失败时自动回滚\r\n *\r\n * @example\r\n * ```typescript\r\n * const todos = ref([...])\r\n *\r\n * const { execute, loading, rollback } = useOptimisticUpdate(\r\n *   client,\r\n *   todos,\r\n *   {\r\n *     optimisticUpdate: (current, newTodo) => [...current, newTodo],\r\n *     onRollback: (error, previous) => {\r\n *       console.error('创建失败:', error)\r\n *       todos.value = previous\r\n *     }\r\n *   }\r\n * )\r\n *\r\n * // 点击添加按钮\r\n * await execute(\r\n *   { url: '/api/todos', method: 'POST', data: newTodo },\r\n *   newTodo\r\n * )\r\n * // UI立即显示新todo,如果请求失败会自动回滚\r\n * ```\r\n */\r\nexport function useOptimisticUpdate<T = any, Input = any>(\r\n  client: HttpClient,\r\n  dataRef: Ref<T>,\r\n  options: OptimisticUpdateOptions<T>,\r\n) {\r\n  const loading = ref(false)\r\n  const error = ref<Error | null>(null)\r\n\r\n  let previousData: T | null = null\r\n  let isOptimisticUpdate = false\r\n\r\n  /**\r\n   * 执行乐观更新\r\n   */\r\n  const execute = async (config: RequestConfig, input: Input): Promise<T | null> => {\r\n    try {\r\n      loading.value = true\r\n      error.value = null\r\n\r\n      // 保存当前数据\r\n      previousData = JSON.parse(JSON.stringify(dataRef.value)) // 深拷贝\r\n\r\n      // 立即应用乐观更新\r\n      isOptimisticUpdate = true\r\n      dataRef.value = options.optimisticUpdate(dataRef.value, input)\r\n\r\n      // 发送实际请求\r\n      const response = await client.request<T>(config)\r\n\r\n      // 请求成功,使用服务器返回的数据\r\n      isOptimisticUpdate = false\r\n      if (response.data) {\r\n        dataRef.value = response.data\r\n      }\r\n\r\n      options.onSuccess?.(response.data)\r\n      previousData = null\r\n\r\n      return response.data\r\n    }\r\n    catch (err) {\r\n      error.value = err as Error\r\n\r\n      // 失败回滚\r\n      if (previousData !== null) {\r\n        // 直接执行回滚逻辑而不调用函数\r\n        const previous = previousData\r\n        dataRef.value = previous\r\n        options.onRollback?.(error.value || new Error('Rollback'), previous)\r\n        previousData = null\r\n      }\r\n\r\n      return null\r\n    }\r\n    finally {\r\n      loading.value = false\r\n      isOptimisticUpdate = false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 手动回滚到之前的状态\r\n   */\r\n  const rollback = () => {\r\n    if (previousData !== null) {\r\n      const previous = previousData\r\n      dataRef.value = previous\r\n      options.onRollback?.(error.value || new Error('Rollback'), previous)\r\n      previousData = null\r\n    }\r\n  }\r\n\r\n  return {\r\n    execute,\r\n    rollback,\r\n    loading,\r\n    error,\r\n    isOptimistic: ref(isOptimisticUpdate),\r\n  }\r\n}\r\n\r\n/**\r\n * 列表乐观更新 Hook\r\n *\r\n * 专门用于列表的增删改操作\r\n *\r\n * @example\r\n * ```typescript\r\n * const { add, update, remove } = useOptimisticList(client, todos)\r\n *\r\n * // 添加\r\n * await add(\r\n *   { url: '/api/todos', method: 'POST', data: newTodo },\r\n *   newTodo\r\n * )\r\n *\r\n * // 更新\r\n * await update(\r\n *   { url: `/api/todos/${id}`, method: 'PUT', data: updated },\r\n *   id,\r\n *   updated\r\n * )\r\n *\r\n * // 删除\r\n * await remove(\r\n *   { url: `/api/todos/${id}`, method: 'DELETE' },\r\n *   id\r\n * )\r\n * ```\r\n */\r\nexport function useOptimisticList<T extends { id: any }>(\r\n  client: HttpClient,\r\n  listRef: Ref<T[]>,\r\n  options: { idKey?: keyof T } = {},\r\n) {\r\n  const { idKey = 'id' } = options\r\n  const loading = ref(false)\r\n  const error = ref<Error | null>(null)\r\n\r\n  /**\r\n   * 添加项\r\n   */\r\n  const add = async (config: RequestConfig, item: T): Promise<T | null> => {\r\n    const { execute } = useOptimisticUpdate<T[]>(client, listRef, {\r\n      optimisticUpdate: (current) => [...current, item],\r\n    })\r\n    // execute返回整个列表，但我们只返回新添加的项\r\n    await execute(config, item)\r\n    return item\r\n  }\r\n\r\n  /**\r\n   * 更新项\r\n   */\r\n  const update = async (\r\n    config: RequestConfig,\r\n    id: any,\r\n    updates: Partial<T>,\r\n  ): Promise<T | null> => {\r\n    const { execute } = useOptimisticUpdate<T[]>(client, listRef, {\r\n      optimisticUpdate: (current) =>\r\n        current.map(item =>\r\n          item[idKey] === id ? { ...item, ...updates } : item,\r\n        ),\r\n    })\r\n    // execute返回整个列表，但我们返回更新后的项\r\n    const result = await execute(config, updates)\r\n    if (result) {\r\n      return listRef.value.find(item => item[idKey] === id) || null\r\n    }\r\n    return null\r\n  }\r\n\r\n  /**\r\n   * 删除项\r\n   */\r\n  const remove = async (config: RequestConfig, id: any): Promise<boolean> => {\r\n    const { execute } = useOptimisticUpdate(client, listRef, {\r\n      optimisticUpdate: (current) => current.filter(item => item[idKey] !== id),\r\n    })\r\n    const result = await execute(config, id)\r\n    return result !== null\r\n  }\r\n\r\n  return {\r\n    add,\r\n    update,\r\n    remove,\r\n    loading,\r\n    error,\r\n  }\r\n}\r\n"],"names":["useOptimisticUpdate","client","dataRef","options","loading","ref","error","previousData","isOptimisticUpdate","execute","async","config","input","value","JSON","parse","stringify","optimisticUpdate","response","request","data","onSuccess","err","previous","onRollback","Error","rollback","isOptimistic","listRef","idKey","add","item","current","update","id","updates","map","find","remove","filter"],"mappings":"2CA6CgBA,EACdC,EACAC,EACAC,GAEA,MAAMC,EAAUC,EAAAA,KAAI,GACdC,EAAQD,EAAAA,IAAkB,MAEhC,IAAIE,EAAyB,KACzBC,GAAqB,EA+DzB,MAAO,CACLC,QA3DcC,MAAOC,EAAuBC,KAC5C,IACER,EAAQS,OAAQ,EAChBP,EAAMO,MAAQ,KAGdN,EAAeO,KAAKC,MAAMD,KAAKE,UAAUd,EAAQW,QAGjDL,GAAqB,EACrBN,EAAQW,MAAQV,EAAQc,iBAAiBf,EAAQW,MAAOD,GAGxD,MAAMM,QAAiBjB,EAAOkB,QAAWR,GAGzC,OAAAH,GAAqB,EACjBU,EAASE,OACXlB,EAAQW,MAAQK,EAASE,MAG3BjB,EAAQkB,YAAYH,EAASE,MAC7Bb,EAAe,KAERW,EAASE,IAClB,CAAA,MACOE,GAIL,GAHAhB,EAAMO,MAAQS,EAGO,OAAjBf,EAAuB,CAEzB,MAAMgB,EAAWhB,EACjBL,EAAQW,MAAQU,EAChBpB,EAAQqB,aAAalB,EAAMO,OAAS,IAAIY,MAAM,YAAaF,GAC3DhB,EAAe,IACjB,CAEA,OAAO,IACT,CAAA,QAEEH,EAAQS,OAAQ,EAChBL,GAAqB,CACvB,GAiBAkB,SAXe,KACf,GAAqB,OAAjBnB,EAAuB,CACzB,MAAMgB,EAAWhB,EACjBL,EAAQW,MAAQU,EAChBpB,EAAQqB,aAAalB,EAAMO,OAAS,IAAIY,MAAM,YAAaF,GAC3DhB,EAAe,IACjB,GAMAH,QAAAA,EACAE,MAAAA,EACAqB,aAActB,EAAAA,IAAIG,GAEtB,2BA+BM,SACJP,EACA2B,EACAzB,EAA+B,CAAA,GAE/B,MAAQ0B,MAAAA,EAAQ,MAAS1B,EAiDzB,MAAO,CACL2B,IA3CUpB,MAAOC,EAAuBoB,KACxC,MAAQtB,QAAAA,GAAYT,EAAyBC,EAAQ2B,EAAS,CAC5DX,iBAAmBe,GAAY,IAAIA,EAASD,KAG9C,aAAMtB,EAAQE,EAAQoB,GACfA,GAsCPE,OAhCavB,MACbC,EACAuB,EACAC,KAEA,MAAQ1B,QAAAA,GAAYT,EAAyBC,EAAQ2B,EAAS,CAC5DX,iBAAmBe,GACjBA,EAAQI,IAAIL,GACVA,EAAKF,KAAWK,EAAK,IAAKH,KAASI,GAAYJ,KAKrD,aADqBtB,EAAQE,EAAQwB,IAE5BP,EAAQf,MAAMwB,KAAKN,GAAQA,EAAKF,KAAWK,IAAO,MAmB3DI,OAXa5B,MAAOC,EAAuBuB,KAC3C,MAAQzB,QAAAA,GAAYT,EAAoBC,EAAQ2B,EAAS,CACvDX,iBAAmBe,GAAYA,EAAQO,OAAOR,GAAQA,EAAKF,KAAWK,KAGxE,OAAkB,aADGzB,EAAQE,EAAQuB,IAQrC9B,QApDcC,EAAAA,KAAI,GAqDlBC,MApDYD,EAAAA,IAAkB,MAsDlC"}
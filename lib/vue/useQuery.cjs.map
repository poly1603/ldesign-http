{"version":3,"file":"useQuery.cjs","sources":["../../src/vue/useQuery.ts"],"sourcesContent":["import type { MaybeRef, Ref } from 'vue'\r\nimport type {\r\n  HttpClient,\r\n  HttpError,\r\n  RequestConfig,\r\n  ResponseData,\r\n} from '../types'\r\nimport type { UseQueryOptions, UseQueryReturn } from '../types/vue'\r\nimport { computed, onUnmounted, ref, unref, watch } from 'vue'\r\nimport { createCancelTokenSource, isCancelError } from '../utils/cancel'\r\n\r\n/**\r\n * 查询缓存管理器\r\n */\r\nclass QueryCache {\r\n  private cache = new Map<\r\n    string,\r\n    {\r\n      data: any\r\n      timestamp: number\r\n      staleTime: number\r\n    }\r\n  >()\r\n\r\n  get(key: string, staleTime: number): any {\r\n    const item = this.cache.get(key)\r\n    if (!item)\r\n      return null\r\n\r\n    const isStale = Date.now() - item.timestamp > staleTime\r\n    return isStale ? null : item.data\r\n  }\r\n\r\n  set(key: string, data: any, staleTime: number): void {\r\n    this.cache.set(key, {\r\n      data,\r\n      timestamp: Date.now(),\r\n      staleTime,\r\n    })\r\n  }\r\n\r\n  invalidate(key: string): void {\r\n    this.cache.delete(key)\r\n  }\r\n\r\n  clear(): void {\r\n    this.cache.clear()\r\n  }\r\n}\r\n\r\nconst globalQueryCache = new QueryCache()\r\n\r\n/**\r\n * useQuery Hook\r\n * 用于处理带缓存的查询请求\r\n */\r\nexport function useQuery<T = any>(\r\n  client: HttpClient,\r\n  queryKey: MaybeRef<string | (() => string)>,\r\n  config: MaybeRef<RequestConfig>,\r\n  options: UseQueryOptions<T> = {},\r\n): UseQueryReturn<T> {\r\n  // 响应式状态\r\n  const data = ref<T | null>(options.initialData ?? null)\r\n  const loading = ref<boolean>(false)\r\n  const error = ref<HttpError | null>(null)\r\n  const finished = ref<boolean>(false)\r\n  const isStale = ref<boolean>(false)\r\n  const isFetching = ref<boolean>(false)\r\n  const dataUpdatedAt = ref<number>(0)\r\n  const failureCount = ref<number>(0)\r\n\r\n  // 配置选项\r\n  const staleTime = options.staleTime ?? 300000 // 5 分钟\r\n  // const cacheTime = options.cacheTime ?? 600000 // 10 分钟 (暂未使用)\r\n  const retry = options.retry ?? 3\r\n  const retryDelay = options.retryDelay ?? 1000\r\n\r\n  // 取消控制\r\n  let cancelTokenSource = createCancelTokenSource()\r\n\r\n  // 计算属性\r\n  const canCancel = computed(() => loading.value || isFetching.value)\r\n  const enabled = computed(() => {\r\n    const enabledValue = unref(options.enabled)\r\n    return enabledValue !== false\r\n  })\r\n\r\n  /**\r\n   * 获取查询键\r\n   */\r\n  const getQueryKey = (): string => {\r\n    const key = unref(queryKey)\r\n    return typeof key === 'function' ? (key as () => string)() : (key as string)\r\n  }\r\n\r\n  /**\r\n   * 执行查询\r\n   */\r\n  const execute = async (\r\n    overrideConfig?: RequestConfig,\r\n  ): Promise<ResponseData<T>> => {\r\n    if (!enabled.value) {\r\n      throw new Error('Query is disabled')\r\n    }\r\n\r\n    const key = getQueryKey()\r\n\r\n    // 检查缓存\r\n    const cachedData = globalQueryCache.get(key, staleTime)\r\n    if (cachedData && !overrideConfig) {\r\n      data.value = cachedData\r\n      isStale.value = false\r\n      finished.value = true\r\n      return { data: cachedData } as ResponseData<T>\r\n    }\r\n\r\n    // 设置加载状态\r\n    if (!data.value) {\r\n      loading.value = true\r\n    }\r\n    else {\r\n      isFetching.value = true\r\n      isStale.value = true\r\n    }\r\n\r\n    error.value = null\r\n    finished.value = false\r\n\r\n    // 创建新的取消令牌\r\n    cancelTokenSource = createCancelTokenSource()\r\n\r\n    let currentRetry = 0\r\n    const maxRetries\r\n      = typeof retry === 'number' ? retry : retry === true ? 3 : 0\r\n\r\n    while (currentRetry <= maxRetries) {\r\n      try {\r\n        // 合并配置\r\n        const requestConfig: RequestConfig = {\r\n          ...unref(config),\r\n          ...overrideConfig,\r\n          signal: cancelTokenSource.token.promise as any,\r\n        }\r\n\r\n        // 发送请求\r\n        const response = await client.request<T>(requestConfig)\r\n\r\n        // 转换数据\r\n        let responseData = response.data\r\n        if (options.transform) {\r\n          responseData = options.transform(response.data)\r\n        }\r\n\r\n        // 更新状态\r\n        data.value = responseData\r\n        isStale.value = false\r\n        finished.value = true\r\n        dataUpdatedAt.value = Date.now()\r\n        failureCount.value = 0\r\n\r\n        // 缓存数据\r\n        globalQueryCache.set(key, responseData, staleTime)\r\n\r\n        // 调用成功回调\r\n        if (options.onSuccess) {\r\n          options.onSuccess(responseData, response)\r\n        }\r\n\r\n        return response\r\n      }\r\n      catch (err) {\r\n        const httpError = err as HttpError\r\n\r\n        // 如果是取消错误，直接抛出\r\n        if (isCancelError(httpError)) {\r\n          throw httpError\r\n        }\r\n\r\n        currentRetry++\r\n        failureCount.value = currentRetry\r\n\r\n        // 如果还有重试次数，等待后重试\r\n        if (currentRetry <= maxRetries) {\r\n          const shouldRetry\r\n            = typeof retry === 'function' ? retry(currentRetry, httpError) : true\r\n\r\n          if (shouldRetry) {\r\n            const delay\r\n              = typeof retryDelay === 'function'\r\n                ? retryDelay(currentRetry)\r\n                : retryDelay * 2 ** (currentRetry - 1)\r\n\r\n            await new Promise(resolve => setTimeout(resolve, delay))\r\n            continue\r\n          }\r\n        }\r\n\r\n        // 更新错误状态\r\n        error.value = httpError\r\n        finished.value = true\r\n\r\n        // 调用错误回调\r\n        if (options.onError) {\r\n          options.onError(httpError)\r\n        }\r\n\r\n        throw httpError\r\n      }\r\n      finally {\r\n        loading.value = false\r\n        isFetching.value = false\r\n\r\n        // 调用完成回调\r\n        if (options.onFinally) {\r\n          options.onFinally()\r\n        }\r\n      }\r\n    }\r\n\r\n    throw error.value || new Error('Unknown error')\r\n  }\r\n\r\n  /**\r\n   * 刷新查询\r\n   */\r\n  const refresh = (): Promise<ResponseData<T>> => {\r\n    return execute()\r\n  }\r\n\r\n  /**\r\n   * 取消查询\r\n   */\r\n  const cancel = (): void => {\r\n    if (canCancel.value) {\r\n      cancelTokenSource.cancel('Query cancelled by user')\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 重置状态\r\n   */\r\n  const reset = (): void => {\r\n    data.value = options.initialData ?? null\r\n    loading.value = false\r\n    error.value = null\r\n    finished.value = false\r\n    isStale.value = false\r\n    isFetching.value = false\r\n    dataUpdatedAt.value = 0\r\n    failureCount.value = 0\r\n  }\r\n\r\n  /**\r\n   * 使缓存失效\r\n   */\r\n  const invalidate = (): void => {\r\n    const key = getQueryKey()\r\n    globalQueryCache.invalidate(key)\r\n    isStale.value = true\r\n  }\r\n\r\n  // 监听查询键和配置变化\r\n  watch(\r\n    [() => getQueryKey(), () => unref(config), enabled],\r\n    () => {\r\n      if (enabled.value && options.immediate !== false) {\r\n        execute()\r\n      }\r\n    },\r\n    { immediate: options.immediate !== false, deep: true },\r\n  )\r\n\r\n  // 窗口焦点重新获取\r\n  if (options.refetchOnWindowFocus) {\r\n    const handleFocus = () => {\r\n      if (enabled.value && data.value) {\r\n        execute()\r\n      }\r\n    }\r\n\r\n    if (typeof window !== 'undefined') {\r\n      window.addEventListener('focus', handleFocus)\r\n      onUnmounted(() => {\r\n        window.removeEventListener('focus', handleFocus)\r\n      })\r\n    }\r\n  }\r\n\r\n  // 网络重连重新获取\r\n  if (options.refetchOnReconnect) {\r\n    const handleOnline = () => {\r\n      if (enabled.value && data.value) {\r\n        execute()\r\n      }\r\n    }\r\n\r\n    if (typeof window !== 'undefined') {\r\n      window.addEventListener('online', handleOnline)\r\n      onUnmounted(() => {\r\n        window.removeEventListener('online', handleOnline)\r\n      })\r\n    }\r\n  }\r\n\r\n  // 定时重新获取\r\n  if (options.refetchInterval && options.refetchInterval > 0) {\r\n    const interval = setInterval(() => {\r\n      if (enabled.value && data.value) {\r\n        execute()\r\n      }\r\n    }, options.refetchInterval)\r\n\r\n    onUnmounted(() => {\r\n      clearInterval(interval)\r\n    })\r\n  }\r\n\r\n  // 组件卸载时取消请求\r\n  if (options.cancelOnUnmount !== false) {\r\n    onUnmounted(() => {\r\n      cancel()\r\n    })\r\n  }\r\n\r\n  return {\r\n    data: data as Ref<T | null>,\r\n    loading,\r\n    error,\r\n    finished,\r\n    isStale,\r\n    isFetching,\r\n    dataUpdatedAt,\r\n    failureCount,\r\n    execute,\r\n    refresh,\r\n    cancel,\r\n    reset,\r\n    invalidate,\r\n    canCancel,\r\n  }\r\n}\r\n"],"names":["globalQueryCache","constructor","this","cache","Map","get","key","staleTime","item","Date","now","timestamp","data","set","invalidate","delete","clear","client","queryKey","config","options","ref","initialData","loading","error","finished","isStale","isFetching","dataUpdatedAt","failureCount","retry","retryDelay","cancelTokenSource","createCancelTokenSource","canCancel","computed","value","enabled","unref","getQueryKey","execute","async","Error","cachedData","overrideConfig","currentRetry","maxRetries","requestConfig","signal","token","promise","response","request","responseData","transform","onSuccess","err","httpError","isCancelError","delay","Promise","resolve","setTimeout","onError","onFinally","cancel","watch","immediate","deep","refetchOnWindowFocus","handleFocus","window","addEventListener","onUnmounted","removeEventListener","refetchOnReconnect","handleOnline","refetchInterval","interval","setInterval","clearInterval","cancelOnUnmount","refresh","reset"],"mappings":"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"}
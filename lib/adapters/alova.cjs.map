{"version":3,"file":"alova.cjs","sources":["../../src/adapters/alova.ts"],"sourcesContent":["import type { RequestConfig, ResponseData } from '../types'\r\nimport { BaseAdapter } from './base'\r\n\r\n/**\r\n * Alova 适配器\r\n */\r\nexport class AlovaAdapter extends BaseAdapter {\r\n  name = 'alova'\r\n  private alova: any // alova库，保持any避免依赖alova类型\r\n  private alovaInstance: any // alova实例，保持any避免依赖alova类型\r\n\r\n  constructor(alovaInstance?: any) {\r\n    super()\r\n    this.alovaInstance = alovaInstance\r\n\r\n    if (!alovaInstance) {\r\n      try {\r\n        // 动态导入 alova\r\n        // eslint-disable-next-line ts/no-require-imports\r\n        this.alova = require('alova')\r\n      }\r\n      catch {\r\n        // alova 未安装\r\n        this.alova = null\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 检查是否支持 alova\r\n   */\r\n  isSupported(): boolean {\r\n    return this.alovaInstance !== null || this.alova !== null\r\n  }\r\n\r\n  /**\r\n   * 发送请求\r\n   */\r\n  async request<T = unknown>(config: RequestConfig): Promise<ResponseData<T>> {\r\n    if (!this.isSupported()) {\r\n      throw new Error(\r\n        'Alova is not available. Please install alova: npm install alova',\r\n      )\r\n    }\r\n\r\n    const processedConfig = this.processConfig(config)\r\n\r\n    try {\r\n      // 如果没有 alova 实例，创建一个默认的\r\n      const alovaInstance\r\n        = this.alovaInstance || this.createDefaultAlovaInstance()\r\n\r\n      // 创建 alova 方法\r\n      const method = this.createAlovaMethod(alovaInstance, processedConfig)\r\n\r\n      // 发送请求\r\n      const response = await method.send()\r\n\r\n      // 转换响应为标准格式\r\n      return this.convertFromAlovaResponse<T>(response, processedConfig)\r\n    }\r\n    catch (error) {\r\n      throw this.handleAlovaError(error, processedConfig)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 创建默认的 alova 实例\r\n   */\r\n  private createDefaultAlovaInstance(): any {\r\n    if (!this.alova) {\r\n      throw new Error('Alova is not available')\r\n    }\r\n\r\n    try {\r\n      // 使用 fetch 作为默认请求适配器\r\n      const { createAlova } = this.alova\r\n      let adapterFetch: any\r\n\r\n      try {\r\n        // 尝试导入 alova/fetch 适配器（alova 3.x 版本）\r\n        // eslint-disable-next-line ts/no-require-imports\r\n        adapterFetch = require('alova/fetch')\r\n        if (typeof adapterFetch === 'object' && adapterFetch.default) {\r\n          adapterFetch = adapterFetch.default\r\n        }\r\n      }\r\n      catch {\r\n        // 如果不可用，创建一个简单的 fetch 适配器\r\n        adapterFetch = () => (url: string, config: any) => fetch(url, config)\r\n      }\r\n\r\n      return createAlova({\r\n        baseURL: '',\r\n        requestAdapter: adapterFetch(),\r\n        responded: (response: any) => response.json(),\r\n      })\r\n    }\r\n    catch (error) {\r\n      throw new Error(`Failed to create Alova instance: ${error}`)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 创建 alova 方法\r\n   */\r\n  private createAlovaMethod(alovaInstance: any, config: RequestConfig): any {\r\n    const { url, method = 'GET', data, headers, timeout, params } = config\r\n\r\n    // 确保URL是有效的\r\n    if (!url) {\r\n      throw new Error('URL is required')\r\n    }\r\n\r\n    // 分离URL和查询参数（因为BaseAdapter已经将params合并到URL中）\r\n    let cleanUrl = url\r\n    const extractedParams = params || {}\r\n\r\n    // 如果URL包含查询参数，提取它们\r\n    const urlParts = url.split('?')\r\n    if (urlParts.length > 1) {\r\n      cleanUrl = urlParts[0]\r\n      const queryString = urlParts[1]\r\n      const urlParams = new URLSearchParams(queryString)\r\n\r\n      // 将URL中的参数合并到extractedParams中\r\n      urlParams.forEach((value, key) => {\r\n        // 尝试转换数字字符串回数字\r\n        const numValue = Number(value)\r\n        extractedParams[key] = !Number.isNaN(numValue) && value !== '' ? numValue : value\r\n      })\r\n    }\r\n\r\n    // 构建URL（在测试环境中保持原始URL）\r\n    let fullUrl = cleanUrl\r\n    if (!cleanUrl.startsWith('http') && !cleanUrl.startsWith('//') && config.baseURL) {\r\n      // 只有在明确提供baseURL时才构建完整URL\r\n      fullUrl = `${config.baseURL.replace(/\\/$/, '')}/${cleanUrl.replace(/^\\//, '')}`\r\n    }\r\n\r\n    // 构建选项对象\r\n    const options: any = {\r\n      headers,\r\n      timeout,\r\n    }\r\n\r\n    // 添加查询参数\r\n    if (extractedParams && Object.keys(extractedParams).length > 0) {\r\n      options.params = extractedParams\r\n    }\r\n\r\n    // 添加信号\r\n    if (config.signal) {\r\n      options.signal = config.signal\r\n    }\r\n\r\n    // 根据方法类型创建对应的 alova 方法\r\n    let alovaMethod: any\r\n\r\n    try {\r\n      switch (method.toUpperCase()) {\r\n        case 'GET':\r\n          alovaMethod = alovaInstance.Get(fullUrl, options)\r\n          break\r\n        case 'POST':\r\n          alovaMethod = alovaInstance.Post(fullUrl, data, options)\r\n          break\r\n        case 'PUT':\r\n          alovaMethod = alovaInstance.Put(fullUrl, data, options)\r\n          break\r\n        case 'DELETE':\r\n          alovaMethod = alovaInstance.Delete(fullUrl, options)\r\n          break\r\n        case 'PATCH':\r\n          alovaMethod = alovaInstance.Patch(fullUrl, data, options)\r\n          break\r\n        case 'HEAD':\r\n          alovaMethod = alovaInstance.Head(fullUrl, options)\r\n          break\r\n        case 'OPTIONS':\r\n          alovaMethod = alovaInstance.Options(fullUrl, options)\r\n          break\r\n        default:\r\n          throw new Error(`Unsupported HTTP method: ${method}`)\r\n      }\r\n    }\r\n    catch (error: any) {\r\n      throw new Error(`Failed to parse URL from ${url}: ${error.message}`)\r\n    }\r\n\r\n    // 设置取消信号\r\n    if (config.signal) {\r\n      alovaMethod.abort = () => {\r\n        if (config.signal && !config.signal.aborted) {\r\n          ; (config.signal as any).abort()\r\n        }\r\n      }\r\n    }\r\n\r\n    return alovaMethod\r\n  }\r\n\r\n  /**\r\n   * 转换 alova 响应为标准格式\r\n   */\r\n  private convertFromAlovaResponse<T>(\r\n    alovaResponse: any,\r\n    config: RequestConfig,\r\n  ): ResponseData<T> {\r\n    // alova 的响应格式可能因配置而异\r\n    // 这里假设响应已经被 responded 函数处理过\r\n\r\n    return this.processResponse<T>(\r\n      alovaResponse,\r\n      200, // alova 通常只在成功时返回数据\r\n      'OK',\r\n      {}, // alova 可能不直接暴露响应头\r\n      config,\r\n      alovaResponse,\r\n    )\r\n  }\r\n\r\n  /**\r\n   * 处理 alova 错误\r\n   */\r\n  private handleAlovaError(error: any, config: RequestConfig): Error {\r\n    // 如果错误包含状态码信息，创建带状态码的错误\r\n    if (error.status || error.response?.status) {\r\n      const status = error.status || error.response.status\r\n      const message = `Request failed with status code ${status}`\r\n      const httpError = this.processError(new Error(message), config, error.response)\r\n      httpError.status = status\r\n      return httpError\r\n    }\r\n\r\n    // alova 的错误处理\r\n    if (error.name === 'AlovaError') {\r\n      return this.processError(error, config)\r\n    }\r\n\r\n    // 网络错误或其他错误\r\n    const httpError = this.processError(error, config)\r\n\r\n    if (error.message && error.message.includes('fetch')) {\r\n      httpError.isNetworkError = true\r\n    }\r\n\r\n    return httpError\r\n  }\r\n}\r\n"],"names":["AlovaAdapter","BaseAdapter","constructor","alovaInstance","super","this","name","alova","require","isSupported","request","config","Error","processedConfig","processConfig","createDefaultAlovaInstance","response","createAlovaMethod","send","convertFromAlovaResponse","error","handleAlovaError","createAlova","adapterFetch","default","url","fetch","baseURL","requestAdapter","responded","json","method","data","headers","timeout","params","cleanUrl","extractedParams","urlParts","split","length","queryString","URLSearchParams","forEach","value","key","numValue","Number","isNaN","fullUrl","startsWith","replace","options","alovaMethod","Object","keys","signal","toUpperCase","Get","Post","Put","Delete","Patch","Head","Options","message","abort","aborted","alovaResponse","processResponse","status","httpError","processError","includes","isNetworkError"],"mappings":"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"}
{"version":3,"file":"client-operations.cjs","sources":["../src/client-operations.ts"],"sourcesContent":["/**\r\n * HTTP 客户端文件操作模块\r\n * \r\n * 处理文件上传和下载相关功能\r\n */\r\n\r\nimport type {\r\n  HttpClient,\r\n  RequestConfig,\r\n} from './types'\r\nimport type {\r\n  DownloadConfig,\r\n  DownloadResult,\r\n} from './utils/download'\r\nimport type {\r\n  UploadConfig,\r\n  UploadResult,\r\n} from './utils/upload'\r\nimport {\r\n  DownloadProgressCalculator,\r\n  getFilenameFromResponse,\r\n  getFilenameFromURL,\r\n  getMimeTypeFromFilename,\r\n  saveFileToLocal,\r\n} from './utils/download'\r\nimport { ProgressCalculator, validateFile } from './utils/upload'\r\n\r\n/**\r\n * 文件操作功能接口\r\n */\r\nexport interface FileOperations {\r\n  /**\r\n   * 上传文件\r\n   */\r\n  upload: <T = any>(\r\n    url: string,\r\n    file: File | File[] | FormData,\r\n    config?: UploadConfig,\r\n  ) => Promise<UploadResult<T>>\r\n\r\n  /**\r\n   * 下载文件\r\n   */\r\n  download: (\r\n    url: string,\r\n    config?: DownloadConfig,\r\n  ) => Promise<DownloadResult>\r\n}\r\n\r\n/**\r\n * 文件操作处理器\r\n */\r\nexport class FileOperationHandler implements FileOperations {\r\n  constructor(private client: HttpClient) {}\r\n\r\n  /**\r\n   * 上传文件（支持多文件和进度跟踪）\r\n   */\r\n  async upload<T = any>(\r\n    url: string,\r\n    file: File | File[] | FormData,\r\n    config: UploadConfig = {},\r\n  ): Promise<UploadResult<T>> {\r\n    // 处理不同的输入类型\r\n    let formData: FormData\r\n    let files: File[]\r\n\r\n    if (file instanceof FormData) {\r\n      formData = file\r\n      // 从FormData中提取文件（用于验证）\r\n      files = []\r\n      for (const [, value] of formData.entries()) {\r\n        if (value instanceof File) {\r\n          files.push(value)\r\n        }\r\n      }\r\n    }\r\n    else {\r\n      files = Array.isArray(file) ? file : [file]\r\n      \r\n      // 验证文件\r\n      files.forEach(f => validateFile(f, config))\r\n\r\n      // 创建表单数据\r\n      formData = new FormData()\r\n\r\n      // 添加所有文件\r\n      const fileField = config.fileField || 'files'\r\n      files.forEach((f, index) => {\r\n        formData.append(`${fileField}[${index}]`, f)\r\n      })\r\n\r\n      // 添加额外的表单数据\r\n      if (config.formData) {\r\n        Object.entries(config.formData).forEach(([key, value]) => {\r\n          formData.append(key, value)\r\n        })\r\n      }\r\n    }\r\n\r\n    const startTime = Date.now()\r\n    const progressCalculator = new ProgressCalculator()\r\n\r\n    // 配置请求\r\n    const requestConfig: RequestConfig = {\r\n      method: 'POST',\r\n      url,\r\n      data: formData,\r\n      headers: {\r\n        ...(config.headers || {}),\r\n      },\r\n      ...(config || {}),\r\n      onUploadProgress: config.onProgress\r\n        ? (progressEvent: any) => {\r\n            const progress = progressCalculator.calculate(\r\n              progressEvent.loaded,\r\n              progressEvent.total,\r\n            )\r\n            config.onProgress!(progress)\r\n          }\r\n        : undefined,\r\n    }\r\n\r\n    const response = await this.client.request<T>(requestConfig)\r\n\r\n    return {\r\n      ...response,\r\n      file: files[0], // 返回第一个文件作为代表\r\n      duration: Date.now() - startTime,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 下载文件（支持进度跟踪和自动保存）\r\n   */\r\n  async download(\r\n    url: string,\r\n    config: DownloadConfig = {},\r\n  ): Promise<DownloadResult> {\r\n    const startTime = Date.now()\r\n    const progressCalculator = new DownloadProgressCalculator()\r\n\r\n    // 配置请求\r\n    const requestConfig: RequestConfig = {\r\n      method: 'GET',\r\n      url,\r\n      responseType: 'blob',\r\n      ...(config || {}),\r\n      onDownloadProgress: config.onProgress\r\n        ? (progressEvent: any) => {\r\n            const progress = progressCalculator.calculate(\r\n              progressEvent.loaded,\r\n              progressEvent.total,\r\n              config.filename,\r\n            )\r\n            config.onProgress!(progress)\r\n          }\r\n        : undefined,\r\n    }\r\n\r\n    const response = await this.client.request<Blob>(requestConfig)\r\n\r\n    // 确定文件名\r\n    let filename = config.filename\r\n    if (!filename) {\r\n      filename = getFilenameFromResponse(response.headers)\r\n        || getFilenameFromURL(response.config.url || url)\r\n        || 'download'\r\n    }\r\n\r\n    // 确定文件类型\r\n    const type = response.data?.type || getMimeTypeFromFilename(filename)\r\n\r\n    // 自动保存文件（浏览器环境）\r\n    let downloadUrl: string | undefined\r\n    if (config.autoSave !== false && typeof window !== 'undefined') {\r\n      saveFileToLocal(response.data, filename)\r\n      downloadUrl = URL.createObjectURL(response.data)\r\n    }\r\n\r\n    return {\r\n      data: response.data,\r\n      filename,\r\n      size: response.data.size,\r\n      type,\r\n      duration: Date.now() - startTime,\r\n      url: downloadUrl,\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 创建文件操作处理器\r\n */\r\nexport function createFileOperationHandler(client: HttpClient): FileOperationHandler {\r\n  return new FileOperationHandler(client)\r\n}"],"names":["FileOperationHandler","constructor","client","this","upload","url","file","config","formData","files","FormData","value","entries","File","push","Array","isArray","forEach","f","validateFile","fileField","index","append","Object","key","startTime","Date","now","progressCalculator","ProgressCalculator","requestConfig","method","data","headers","onUploadProgress","onProgress","progressEvent","progress","calculate","loaded","total","request","duration","download","DownloadProgressCalculator","responseType","onDownloadProgress","filename","response","getFilenameFromResponse","getFilenameFromURL","type","getMimeTypeFromFilename","downloadUrl","autoSave","window","saveFileToLocal","URL","createObjectURL","size"],"mappings":"yFAoDaA,EACX,WAAAC,CAAoBC,GAAAC,KAAAD,OAAAA,CAAqB,CAKzC,YAAME,CACJC,EACAC,EACAC,EAAuB,CAAA,GAGvB,IAAIC,EACAC,EAEJ,GAAIH,aAAgBI,SAAU,CAC5BF,EAAWF,EAEXG,EAAQ,GACR,IAAA,MAAW,CAAGE,KAAUH,EAASI,UAC3BD,aAAiBE,MACnBJ,EAAMK,KAAKH,EAGjB,KACK,CACHF,EAAQM,MAAMC,QAAQV,GAAQA,EAAO,CAACA,GAGtCG,EAAMQ,QAAQC,GAAKC,EAAAA,aAAaD,EAAGX,IAGnCC,EAAW,IAAIE,SAGf,MAAMU,EAAYb,EAAOa,WAAa,QACtCX,EAAMQ,QAAQ,CAACC,EAAGG,KAChBb,EAASc,OAAO,GAAGF,KAAaC,KAAUH,KAIxCX,EAAOC,UACTe,OAAOX,QAAQL,EAAOC,UAAUS,QAAQ,EAAEO,EAAKb,MAC7CH,EAASc,OAAOE,EAAKb,IAG3B,CAEA,MAAMc,EAAYC,KAAKC,MACjBC,EAAqB,IAAIC,EAAAA,mBAGzBC,EAA+B,CACnCC,OAAQ,OACR1B,IAAAA,EACA2B,KAAMxB,EACNyB,QAAS,IACH1B,EAAO0B,SAAW,CAAA,MAEpB1B,GAAU,CAAA,EACd2B,iBAAkB3B,EAAO4B,WACpBC,IACC,MAAMC,EAAWT,EAAmBU,UAClCF,EAAcG,OACdH,EAAcI,OAEhBjC,EAAO4B,WAAYE,SAErB,GAKN,MAAO,UAFgBlC,KAAKD,OAAOuC,QAAWX,GAI5CxB,KAAMG,EAAM,GACZiC,SAAUhB,KAAKC,MAAQF,EAE3B,CAKA,cAAMkB,CACJtC,EACAE,EAAyB,CAAA,GAEzB,MAAMkB,EAAYC,KAAKC,MACjBC,EAAqB,IAAIgB,EAAAA,2BAGzBd,EAA+B,CACnCC,OAAQ,MACR1B,IAAAA,EACAwC,aAAc,UACVtC,GAAU,CAAA,EACduC,mBAAoBvC,EAAO4B,WACtBC,IACC,MAAMC,EAAWT,EAAmBU,UAClCF,EAAcG,OACdH,EAAcI,MACdjC,EAAOwC,UAETxC,EAAO4B,WAAYE,SAErB,GAGAW,QAAiB7C,KAAKD,OAAOuC,QAAcX,GAGjD,IAAIiB,EAAWxC,EAAOwC,SACjBA,IACHA,EAAWE,EAAAA,wBAAwBD,EAASf,UACvCiB,EAAAA,mBAAmBF,EAASzC,OAAOF,KAAOA,IAC1C,YAIP,MAAM8C,EAAOH,EAAShB,MAAMmB,MAAQC,EAAAA,wBAAwBL,GAG5D,IAAIM,EACJ,OAAwB,IAApB9C,EAAO+C,iBAA6BC,OAAW,MACjDC,EAAAA,gBAAgBR,EAAShB,KAAMe,GAC/BM,EAAcI,IAAIC,gBAAgBV,EAAShB,OAGtC,CACLA,KAAMgB,EAAShB,KACfe,SAAAA,EACAY,KAAMX,EAAShB,KAAK2B,KACpBR,KAAAA,EACAT,SAAUhB,KAAKC,MAAQF,EACvBpB,IAAKgD,EAET,oEAMI,SAAqCnD,GACzC,OAAO,IAAIF,EAAqBE,EAClC"}
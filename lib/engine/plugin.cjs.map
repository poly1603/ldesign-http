{"version":3,"file":"plugin.cjs","sources":["../../src/engine/plugin.ts"],"sourcesContent":["import type { HttpClient, HttpClientConfig } from '../types'\r\nimport type { HttpPluginOptions } from '../types/vue'\r\nimport { createAdapter } from '../adapters'\r\nimport { HttpClientImpl } from '../client'\r\nimport { HttpPlugin } from '../vue/plugin'\r\n\r\n// 临时使用 any 类型，避免循环依赖\r\ninterface Plugin {\r\n  name: string\r\n  version: string\r\n  dependencies?: string[]\r\n  install: (engine: any) => Promise<void>\r\n  uninstall?: (engine: any) => Promise<void>\r\n  [key: string]: any\r\n}\r\n\r\n/**\r\n * HTTP Engine 插件选项\r\n */\r\nexport interface HttpEnginePluginOptions extends HttpPluginOptions {\r\n  /** 插件名称 */\r\n  name?: string\r\n  /** 插件版本 */\r\n  version?: string\r\n  /** HTTP 客户端配置 */\r\n  clientConfig?: HttpClientConfig\r\n  /** 是否启用全局注入 */\r\n  globalInjection?: boolean\r\n  /** 全局属性名称 */\r\n  globalPropertyName?: string\r\n}\r\n\r\n/**\r\n * 创建 HTTP Engine 插件\r\n *\r\n * 将 HTTP Vue 插件包装为标准的 Engine 插件，提供统一的插件管理体验\r\n *\r\n * @param options HTTP 配置选项\r\n * @returns Engine 插件实例\r\n *\r\n * @example\r\n * ```typescript\r\n * import { createHttpEnginePlugin } from '@ldesign/http'\r\n *\r\n * const httpPlugin = createHttpEnginePlugin({\r\n *   clientConfig: {\r\n *     baseURL: 'https://api.example.com',\r\n *     timeout: 10000\r\n *   },\r\n *   globalInjection: true,\r\n *   globalPropertyName: '$http'\r\n * })\r\n *\r\n * await engine.use(httpPlugin)\r\n * ```\r\n */\r\nexport function createHttpEnginePlugin(\r\n  options: HttpEnginePluginOptions = {},\r\n): Plugin {\r\n  const {\r\n    name = 'http',\r\n    version = '1.0.0',\r\n    clientConfig = {},\r\n    // globalInjection is currently unused\r\n    globalPropertyName = '$http',\r\n    client: providedClient,\r\n    globalConfig,\r\n    ...httpOptions\r\n  } = options\r\n\r\n  return {\r\n    name,\r\n    version,\r\n    dependencies: [], // HTTP 插件通常不依赖其他插件\r\n\r\n    async install(context) {\r\n      try {\r\n        // 检查是否直接传入了Vue应用实例（标准Vue插件用法）\r\n        if (context && typeof context.config === 'object' && typeof context.provide === 'function') {\r\n          // 直接使用Vue应用实例\r\n          const vueApp = context\r\n\r\n          // 定义实际的安装逻辑\r\n          const performInstall = async () => {\r\n            // 创建或使用提供的 HTTP 客户端\r\n            const httpClient\r\n              = providedClient\r\n                || (() => {\r\n                  const adapter = createAdapter(clientConfig.adapter)\r\n                  return new HttpClientImpl(\r\n                    {\r\n                      ...clientConfig,\r\n                      ...globalConfig,\r\n                    },\r\n                    adapter,\r\n                  )\r\n                })()\r\n\r\n            // 创建HTTP方法的快捷方式\r\n            const httpMethods = {\r\n              get: (url: string, config?: any) => httpClient.get(url, config),\r\n              post: (url: string, data?: any, config?: any) => httpClient.post(url, data, config),\r\n              put: (url: string, data?: any, config?: any) => httpClient.put(url, data, config),\r\n              delete: (url: string, config?: any) => httpClient.delete(url, config),\r\n              patch: (url: string, data?: any, config?: any) => httpClient.patch(url, data, config),\r\n              head: (url: string, config?: any) => httpClient.head(url, config),\r\n              options: (url: string, config?: any) => httpClient.options(url, config),\r\n              upload: (url: string, data?: any, config?: any) => httpClient.upload ? httpClient.upload(url, data, config) : httpClient.post(url, data, config),\r\n              download: (url: string, config?: any) => httpClient.download ? httpClient.download(url, config) : httpClient.get(url, config),\r\n            }\r\n\r\n            // 注册到全局属性\r\n            try {\r\n              if (vueApp.config && vueApp.config.globalProperties) {\r\n                vueApp.config.globalProperties.$http = httpMethods\r\n                vueApp.config.globalProperties.$httpClient = httpClient\r\n              }\r\n            }\r\n            catch (error) {\r\n              console.warn('Failed to register global properties:', error)\r\n            }\r\n\r\n            // 提供依赖注入\r\n            try {\r\n              if (typeof vueApp.provide === 'function') {\r\n                vueApp.provide('http', httpMethods)\r\n                vueApp.provide('httpClient', httpClient)\r\n              }\r\n            }\r\n            catch (error) {\r\n              console.warn('Failed to provide dependencies:', error)\r\n            }\r\n          }\r\n\r\n          // 直接执行安装\r\n          await performInstall()\r\n        }\r\n        else {\r\n          // 从上下文中获取引擎实例（引擎模式）\r\n          const engine = context.engine || context\r\n\r\n          // 确保engine存在必要的方法\r\n          if (!engine || typeof engine.getApp !== 'function') {\r\n            console.warn('Invalid engine context: missing required methods')\r\n            return\r\n          }\r\n\r\n          // 定义实际的安装逻辑\r\n          const performInstall = async () => {\r\n            // 获取 Vue 应用实例\r\n            const vueApp = engine.getApp()\r\n            if (!vueApp) {\r\n              throw new Error(\r\n                'Vue app not found. Make sure the engine has created a Vue app before installing HTTP plugin.',\r\n              )\r\n            }\r\n\r\n            // 创建或使用提供的 HTTP 客户端\r\n            const httpClient\r\n              = providedClient\r\n                || (() => {\r\n                  const adapter = createAdapter(clientConfig.adapter)\r\n                  return new HttpClientImpl(\r\n                    {\r\n                      ...clientConfig,\r\n                      ...globalConfig,\r\n                    },\r\n                    adapter,\r\n                  )\r\n                })()\r\n\r\n            // 安装 HTTP Vue 插件\r\n            vueApp.use(HttpPlugin, {\r\n              client: httpClient,\r\n              globalConfig: globalConfig || clientConfig,\r\n              globalProperty: globalPropertyName,\r\n              ...httpOptions,\r\n            })\r\n\r\n            // 将 HTTP 客户端注册到引擎中，便于其他插件访问\r\n            if (engine.http) {\r\n              // 如果引擎支持 HTTP 适配器，设置适配器\r\n              engine.http.setInstance(httpClient)\r\n            }\r\n            else {\r\n              // 否则直接挂载到引擎上\r\n              ; (engine as any).httpClient = httpClient\r\n            }\r\n\r\n            // 记录插件安装成功\r\n            if (engine.logger) {\r\n              engine.logger.info(`${name} plugin installed successfully`, {\r\n                version,\r\n                clientType: httpClient.constructor.name,\r\n              })\r\n            }\r\n          }\r\n\r\n          // 检查 Vue 应用是否已经创建\r\n          const vueApp = engine.getApp()\r\n          if (vueApp) {\r\n            if (engine.logger) {\r\n              engine.logger.info(`[HTTP Plugin] Vue app found, installing immediately`)\r\n            }\r\n            await performInstall()\r\n          }\r\n          else {\r\n            if (engine.logger) {\r\n              engine.logger.info(`[HTTP Plugin] Vue app not found, registering event listener`)\r\n            }\r\n            // 如果 Vue 应用还没有创建，等待 app:created 事件\r\n            await new Promise<void>((resolve, reject) => {\r\n              engine.events.once('app:created', async () => {\r\n                try {\r\n                  if (engine.logger) {\r\n                    engine.logger.info(`[HTTP Plugin] app:created event received, installing now`)\r\n                  }\r\n                  await performInstall()\r\n                  resolve()\r\n                }\r\n                catch (error) {\r\n                  if (engine.logger) {\r\n                    engine.logger.error(`[HTTP Plugin] Failed to install after app creation:`, error)\r\n                  }\r\n                  reject(error)\r\n                }\r\n              })\r\n            })\r\n          }\r\n\r\n          if (engine.logger) {\r\n            engine.logger.info(`${name} plugin registered, waiting for Vue app creation...`)\r\n          }\r\n        }\r\n      }\r\n      catch (error) {\r\n        console.error(`Failed to install http plugin:`, error)\r\n        throw error\r\n      }\r\n    },\r\n\r\n    async uninstall(context) {\r\n      try {\r\n        // 从上下文中获取引擎实例\r\n        const engine = context.engine || context\r\n\r\n        // 确保engine存在必要的方法\r\n        if (!engine) {\r\n          throw new Error('Invalid engine context')\r\n        }\r\n\r\n        // 清理 HTTP 客户端\r\n        if ((engine as any).httpClient) {\r\n          const httpClient = (engine as any).httpClient as HttpClient\r\n          // 取消所有进行中的请求\r\n          httpClient.cancelAll()\r\n          // 清理缓存\r\n          httpClient.clearCache()\r\n          // 移除引用\r\n          delete (engine as any).httpClient\r\n        }\r\n\r\n        engine.logger.info(`${name} plugin uninstalled successfully`)\r\n      }\r\n      catch (error) {\r\n        const engine = context.engine || context\r\n        if (engine && engine.logger) {\r\n          engine.logger.error(`Failed to uninstall ${name} plugin:`, error)\r\n        }\r\n        else {\r\n          console.error(`Failed to uninstall ${name} plugin:`, error)\r\n        }\r\n        throw error\r\n      }\r\n    },\r\n  }\r\n}\r\n\r\n/**\r\n * HTTP 插件工厂函数（向后兼容）\r\n *\r\n * @param options HTTP 配置选项\r\n * @returns HTTP Engine 插件实例\r\n *\r\n * @example\r\n * ```typescript\r\n * import { httpPlugin } from '@ldesign/http'\r\n *\r\n * await engine.use(httpPlugin({\r\n *   clientConfig: {\r\n *     baseURL: 'https://api.example.com'\r\n *   }\r\n * }))\r\n * ```\r\n */\r\nexport function httpPlugin(options: HttpEnginePluginOptions): Plugin {\r\n  return createHttpEnginePlugin(options)\r\n}\r\n\r\n/**\r\n * 默认 HTTP Engine 插件实例\r\n *\r\n * 使用默认配置创建的 HTTP 插件，可以直接使用\r\n *\r\n * @example\r\n * ```typescript\r\n * import { defaultHttpEnginePlugin } from '@ldesign/http'\r\n *\r\n * await engine.use(defaultHttpEnginePlugin)\r\n * ```\r\n */\r\nexport const defaultHttpEnginePlugin = createHttpEnginePlugin({\r\n  globalInjection: true,\r\n  globalPropertyName: '$http',\r\n  clientConfig: {\r\n    timeout: 10000,\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n    },\r\n  },\r\n})\r\n\r\n// 导出类型已在接口定义处导出\r\n\r\n/**\r\n * 创建HTTP插件的别名函数（用于测试兼容性）\r\n */\r\nexport function createHttpPlugin(options?: HttpEnginePluginOptions): Plugin {\r\n  return createHttpEnginePlugin(options || {})\r\n}\r\n"],"names":["createHttpEnginePlugin","options","name","version","clientConfig","globalPropertyName","client","providedClient","globalConfig","httpOptions","dependencies","install","context","config","provide","vueApp","httpClient","adapter","createAdapter","HttpClientImpl","httpMethods","get","url","post","data","put","delete","patch","head","upload","download","globalProperties","$http","$httpClient","error","engine","getApp","performInstall","async","Error","use","HttpPlugin","globalProperty","http","setInstance","logger","info","clientType","constructor","Promise","resolve","reject","events","once","uninstall","cancelAll","clearCache","defaultHttpEnginePlugin","globalInjection","timeout","headers"],"mappings":"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"}
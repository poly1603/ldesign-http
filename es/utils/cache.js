class e{constructor(e=1e3){this.cache=new Map,this.accessOrder=new Map,this.maxSize=1e3,this.cleanupInterval=6e4,this.isDestroyed=!1,this.maxSize=e,this.startCleanup()}async get(e){const t=this.cache.get(e);return t?Date.now()-t.timestamp>t.ttl?(this.cache.delete(e),this.accessOrder.delete(e),null):(this.accessOrder.set(e,Date.now()),t.data):null}async set(e,t,s=3e5){this.cache.size>=this.maxSize&&this.evictLRU(),this.cache.set(e,{data:t,timestamp:Date.now(),ttl:s}),this.accessOrder.set(e,Date.now())}async delete(e){this.cache.delete(e),this.accessOrder.delete(e)}async clear(){this.cache.clear(),this.accessOrder.clear()}startCleanup(){this.isDestroyed||(this.cleanupTimer=setInterval(()=>{this.isDestroyed||this.cleanupExpired()},this.cleanupInterval),this.cleanupTimer.unref&&this.cleanupTimer.unref())}cleanupExpired(){if(this.isDestroyed)return;const e=Date.now(),t=[];let s=0;for(const[a,i]of this.cache.entries())if(e-i.timestamp>i.ttl&&(t.push(a),s++,s>=100))break;for(const e of t)this.cache.delete(e),this.accessOrder.delete(e)}evictLRU(){if(0===this.accessOrder.size)return;let e=null,t=1/0;for(const[s,a]of this.accessOrder.entries())a<t&&(t=a,e=s);e&&(this.cache.delete(e),this.accessOrder.delete(e))}size(){return this.cache.size}keys(){return Array.from(this.cache.keys())}destroy(){this.isDestroyed=!0,this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=void 0),this.cache.clear(),this.accessOrder.clear()}}class t{constructor(e="http_cache_"){this.prefix=e}async get(e){if(typeof localStorage>"u")return null;try{const t=localStorage.getItem(this.prefix+e);if(!t)return null;const s=JSON.parse(t);return Date.now()-s.timestamp>s.ttl?(this.delete(e),null):s.data}catch{return null}}async set(e,t,s=3e5){if(!(typeof localStorage>"u"))try{const a={data:t,timestamp:Date.now(),ttl:s};localStorage.setItem(this.prefix+e,JSON.stringify(a))}catch{}}async delete(e){typeof localStorage>"u"||localStorage.removeItem(this.prefix+e)}async clear(){typeof localStorage>"u"||Object.keys(localStorage).forEach(e=>{e.startsWith(this.prefix)&&localStorage.removeItem(e)})}}class s{constructor(t={}){this.keyCache=new Map,this.stats={hits:0,misses:0,hitRate:0,size:0,memoryUsage:0,recentKeys:[],hotKeys:[]},this.config={enabled:t.enabled??!0,ttl:t.ttl??3e5,keyGenerator:t.keyGenerator??this.defaultKeyGenerator,storage:t.storage??new e},this.storage=this.config?.storage}async get(e){if(!this.config?.enabled)return null;const t=this.getCachedKey(e),s=await this.storage.get(t);s?this.stats.hits++:this.stats.misses++;const a=this.stats.hits+this.stats.misses;return this.stats.hitRate=a>0?this.stats.hits/a:0,s}async set(e,t){if(!this.config?.enabled||"GET"!==e.method||t.status<200||t.status>=300)return;const s=this.getCachedKey(e);await this.storage.set(s,t,this.config?.ttl)}async delete(e){const t=this.getCachedKey(e);await this.storage.delete(t)}async clear(){await this.storage.clear()}updateConfig(e){Object.assign(this.config,e),e.storage&&(this.storage=e.storage)}getConfig(){return{...this.config}}getStats(){return{...this.stats}}getCachedKey(e){const t=`${e.method||"GET"}:${e.url||""}:${e.params?this.fastStringify(e.params):""}:${e.data?this.fastStringify(e.data):""}`;if(this.keyCache.has(t))return this.keyCache.get(t);const s=this.config?.keyGenerator(e);if(this.keyCache.size>1e3){const e=this.keyCache.keys().next().value;void 0!==e&&this.keyCache.delete(e)}return this.keyCache.set(t,s),s}fastStringify(e){return null==e?"":"string"==typeof e?e:"number"==typeof e||"boolean"==typeof e?String(e):JSON.stringify(e)}defaultKeyGenerator(e){const{method:t="GET",url:s="",params:a={},data:i}=e;let r=`${t}:${s}`;const n=Object.keys(a).sort();if(n.length>0){r+=`?${n.map(e=>`${e}=${a[e]}`).join("&")}`}if(i&&"GET"!==t){r+=`:${function(e){let t=0;for(let s=0;s<e.length;s++){t=(t<<5)-t+e.charCodeAt(s),t&=t}return Math.abs(t).toString(36)}("string"==typeof i?i:JSON.stringify(i))}`}return r}}class a extends s{constructor(e={}){super(e),this.accessLog=new Map,this.tagIndex=new Map,this.dependencyGraph=new Map,this.enhancedConfig={strategy:"lru",maxSize:52428800,compression:!1,stats:!0,...e}}async get(e){if(!this.enhancedConfig.stats){if(!this.config?.enabled)return null;const t=this.getCachedKey(e);return await this.storage.get(t)}const t=await super.get(e);if(t){const t=this.getCachedKey(e);this.updateAccessLog(t),this.updateRecentKeys(t)}return t}async set(e,t,s){if(await super.set(e,t),this.enhancedConfig.stats){const t=this.getCachedKey(e);s?.tags&&this.updateTagIndex(t,s.tags),s?.dependencies&&this.updateDependencyGraph(t,s.dependencies),this.updateStats()}}async invalidateByTag(e){const t=this.tagIndex.get(e);if(!t)return 0;const s=t.size;return this.storage.deleteBatch?await this.storage.deleteBatch(Array.from(t)):await Promise.all(Array.from(t).map(e=>this.storage.delete(e))),this.tagIndex.delete(e),this.updateStats(),s}async invalidateByDependency(e){const t=this.dependencyGraph.get(e);if(!t)return 0;let s=0;for(const e of t)await this.storage.delete(e),s++;return this.dependencyGraph.delete(e),this.updateStats(),s}async preload(e){if(!this.enhancedConfig.preload?.enabled)return;const t=e.map(async e=>{try{const t={url:e,method:"GET"},s={data:`preloaded-${e}`,status:200,statusText:"OK",headers:{},config:t};await this.set(t,s)}catch(e){}});await Promise.all(t)}getStats(){return{...this.stats}}resetStats(){this.stats={hits:0,misses:0,hitRate:0,size:0,memoryUsage:0,recentKeys:[],hotKeys:[]},this.accessLog.clear()}getHotKeys(e=10){return Array.from(this.accessLog.entries()).map(([e,t])=>({key:e,accessCount:t})).sort((e,t)=>t.accessCount-e.accessCount).slice(0,e)}async cleanup(){return this.updateStats(),0}updateAccessLog(e){const t=this.accessLog.get(e)||0;this.accessLog.set(e,t+1)}updateRecentKeys(e){const t=this.stats.recentKeys.indexOf(e);t>-1&&this.stats.recentKeys.splice(t,1),this.stats.recentKeys.unshift(e),this.stats.recentKeys.length>10&&(this.stats.recentKeys=this.stats.recentKeys.slice(0,10))}updateTagIndex(e,t){for(const s of t)this.tagIndex.has(s)||this.tagIndex.set(s,new Set),this.tagIndex.get(s).add(e)}updateDependencyGraph(e,t){for(const s of t)this.dependencyGraph.has(s)||this.dependencyGraph.set(s,new Set),this.dependencyGraph.get(s).add(e)}updateStats(){this.stats.hotKeys=this.getHotKeys()}}function i(e){return new s(e)}function r(e){return new a(e)}function n(){return new e}function c(e){return new t(e)}export{s as CacheManager,a as EnhancedCacheManager,t as LocalStorageCacheStorage,e as MemoryCacheStorage,i as createCacheManager,r as createEnhancedCacheManager,c as createLocalStorage,n as createMemoryStorage};
//# sourceMappingURL=cache.js.map

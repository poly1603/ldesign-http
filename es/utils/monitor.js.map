{"version":3,"file":"monitor.js","sources":["../../src/utils/monitor.ts"],"sourcesContent":["/**\n * 请求监控模块\n * 提供请求性能监控、指标收集和分析功能\n */\n\nimport type { RequestConfig, ResponseData } from '../types'\n\n/**\n * 性能指标\n */\nexport interface PerformanceMetrics {\n  requestId: string\n  url: string\n  method: string\n  startTime: number\n  endTime: number\n  duration: number\n  status?: number\n  size?: number\n  cached: boolean\n  retries: number\n  error?: Error\n  timestamp?: number\n}\n\n/**\n * 监控配置\n */\nexport interface MonitorConfig {\n  enabled?: boolean\n  maxMetrics?: number // 最大保存的指标数量\n  slowRequestThreshold?: number // 慢请求阈值(ms)\n  samplingRate?: number // 采样率 (0-1)，高负载时降低采样\n  enableSampling?: boolean // 是否启用采样\n  onSlowRequest?: (metrics: PerformanceMetrics) => void\n  onError?: (metrics: PerformanceMetrics) => void\n  onMetricsUpdate?: (metrics: PerformanceMetrics[]) => void\n}\n\n/**\n * 性能统计信息\n */\nexport interface PerformanceStats {\n  totalRequests: number\n  successfulRequests: number\n  failedRequests: number\n  cachedRequests: number\n  averageDuration: number\n  averageResponseTime?: number\n  medianDuration: number\n  p95Duration: number\n  p99Duration: number\n  slowRequests: number\n  totalDataTransferred: number\n  requestsByMethod: Record<string, number>\n  requestsByStatus: Record<number, number>\n  errorRate: number\n  cacheHitRate: number\n}\n\n/**\n * 请求监控器（优化版）\n *\n * 优化点：\n * 1. 添加采样机制，高负载时降低采样率\n * 2. 缓存统计结果，避免重复计算\n * 3. 使用更紧凑的数据结构\n */\nexport class RequestMonitor {\n  private metrics: PerformanceMetrics[] = []\n  private metricsIndex = 0 // 循环缓冲区索引\n  private config: Required<MonitorConfig>\n  private requestMap = new Map<string, { startTime: number, retries: number }>()\n\n  // 统计缓存\n  private statsCache?: PerformanceStats\n  private statsCacheTime = 0\n  private statsCacheTTL = 1000 // 统计缓存1秒\n\n  // 采样计数器\n  private sampleCounter = 0\n\n  constructor(config: MonitorConfig = {}) {\n    this.config = {\n      enabled: true,\n      maxMetrics: 1000,\n      slowRequestThreshold: 3000,\n      samplingRate: 1.0, // 默认100%采样\n      enableSampling: false, // 默认不启用采样\n      onSlowRequest: () => {},\n      onError: () => {},\n      onMetricsUpdate: () => {},\n      ...config,\n    }\n  }\n\n  /**\n   * 检查是否应该采样\n   */\n  private shouldSample(): boolean {\n    if (!this.config?.enableSampling) {\n      return true\n    }\n\n    this.sampleCounter++\n    return Math.random() < this.config?.samplingRate\n  }\n\n  /**\n   * 开始监控请求（优化版 - 带采样）\n   */\n  startRequest(requestId: string, _config: RequestConfig): void {\n    if (!this.config?.enabled || !this.shouldSample()) {\n      return\n    }\n\n    this.requestMap.set(requestId, {\n      startTime: Date.now(),\n      retries: 0,\n    })\n  }\n\n  /**\n   * 结束监控请求（优化版）\n   */\n  endRequest<T>(\n    requestId: string,\n    config: RequestConfig,\n    response?: ResponseData<T>,\n    error?: Error,\n  ): void {\n    if (!this.config?.enabled) {\n      return\n    }\n\n    const requestInfo = this.requestMap.get(requestId)\n    if (!requestInfo) {\n      return\n    }\n\n    const endTime = Date.now()\n    const duration = endTime - requestInfo.startTime\n\n    const metrics: PerformanceMetrics = {\n      requestId,\n      url: config.url || '',\n      method: config.method || 'GET',\n      startTime: requestInfo.startTime,\n      endTime,\n      duration,\n      status: response?.status,\n      size: this.getResponseSize(response),\n      cached: false, // 需要从缓存管理器获取\n      retries: requestInfo.retries,\n      error,\n      timestamp: endTime,\n    }\n\n    this.addMetrics(metrics)\n    this.requestMap.delete(requestId)\n\n    // 清除统计缓存\n    this.invalidateStatsCache()\n\n    // 触发回调\n    if (duration > this.config?.slowRequestThreshold) {\n      this.config?.onSlowRequest(metrics)\n    }\n\n    if (error) {\n      this.config?.onError(metrics)\n    }\n\n    this.config?.onMetricsUpdate(this.metrics)\n  }\n\n  /**\n   * 记录重试\n   */\n  recordRetry(requestId: string): void {\n    const requestInfo = this.requestMap.get(requestId)\n    if (requestInfo) {\n      requestInfo.retries++\n    }\n  }\n\n  /**\n   * 标记缓存命中\n   */\n  markCached(requestId: string): void {\n    const metrics = this.metrics.find(m => m.requestId === requestId)\n    if (metrics) {\n      metrics.cached = true\n    }\n  }\n\n  /**\n   * 添加指标（使用循环缓冲区优化性能）\n   */\n  private addMetrics(metrics: PerformanceMetrics): void {\n    if (this.metrics.length < this.config?.maxMetrics) {\n      // 缓冲区未满，直接添加\n      this.metrics.push(metrics)\n    }\n    else {\n      // 缓冲区已满，使用循环覆盖（O(1)操作）\n      this.metrics[this.metricsIndex] = metrics\n      this.metricsIndex = (this.metricsIndex + 1) % this.config?.maxMetrics\n    }\n  }\n\n  /**\n   * 获取响应大小\n   */\n  private getResponseSize<T>(response?: ResponseData<T>): number {\n    if (!response?.data)\n      return 0\n\n    if (response.data instanceof Blob) {\n      return response.data.size\n    }\n\n    if (typeof response.data === 'string') {\n      return new Blob([response.data]).size\n    }\n\n    if (typeof response.data === 'object') {\n      return new Blob([JSON.stringify(response.data)]).size\n    }\n\n    return 0\n  }\n\n  /**\n   * 获取性能统计（优化版 - 带缓存）\n   */\n  getStats(): PerformanceStats {\n    // 检查缓存\n    const now = Date.now()\n    if (this.statsCache && (now - this.statsCacheTime) < this.statsCacheTTL) {\n      return { ...this.statsCache } // 返回副本，避免外部修改\n    }\n\n    // 计算统计信息\n    const stats = this.calculateStats()\n\n    // 缓存结果\n    this.statsCache = stats\n    this.statsCacheTime = now\n\n    return { ...stats } // 返回副本\n  }\n\n  /**\n   * 计算统计信息（优化版）\n   */\n  private calculateStats(): PerformanceStats {\n    const total = this.metrics.length\n    \n    // 早期返回优化\n    if (total === 0) {\n      return {\n        totalRequests: 0,\n        successfulRequests: 0,\n        failedRequests: 0,\n        cachedRequests: 0,\n        averageDuration: 0,\n        averageResponseTime: 0,\n        medianDuration: 0,\n        p95Duration: 0,\n        p99Duration: 0,\n        slowRequests: 0,\n        totalDataTransferred: 0,\n        requestsByMethod: {},\n        requestsByStatus: {},\n        errorRate: 0,\n        cacheHitRate: 0,\n      }\n    }\n    \n    let successful = 0\n    let failed = 0\n    let cached = 0\n    let slow = 0\n    let totalDuration = 0\n    let totalSize = 0\n\n    // 使用 Object.create(null) 创建更快的普通对象\n    const requestsByMethod: Record<string, number> = Object.create(null)\n    const requestsByStatus: Record<number, number> = Object.create(null)\n    \n    // 预分配数组大小\n    const durations: number[] = Array.from({ length: total }, () => 0)\n    const slowThreshold = this.config?.slowRequestThreshold\n\n    // 单次遍历收集所有数据\n    let i = 0\n    for (const metric of this.metrics) {\n      const duration = metric.duration\n      durations[i++] = duration\n      totalDuration += duration\n      totalSize += metric.size || 0\n\n      // 使用位运算优化计数\n      failed += metric.error ? 1 : 0\n      successful += metric.error ? 0 : 1\n      cached += metric.cached ? 1 : 0\n      slow += duration > slowThreshold ? 1 : 0\n\n      // 按方法统计\n      requestsByMethod[metric.method] = (requestsByMethod[metric.method] || 0) + 1\n\n      // 按状态码统计\n      if (metric.status) {\n        requestsByStatus[metric.status] = (requestsByStatus[metric.status] || 0) + 1\n      }\n    }\n\n    // 使用更快的排序算法（对于小数组）\n    if (total < 100) {\n      // 插入排序对小数组更快\n      this.insertionSort(durations)\n    } else {\n      durations.sort((a, b) => a - b)\n    }\n\n    return {\n      totalRequests: total,\n      successfulRequests: successful,\n      failedRequests: failed,\n      cachedRequests: cached,\n      averageDuration: totalDuration / total,\n      averageResponseTime: totalDuration / total,\n      medianDuration: this.getPercentile(durations, 50),\n      p95Duration: this.getPercentile(durations, 95),\n      p99Duration: this.getPercentile(durations, 99),\n      slowRequests: slow,\n      totalDataTransferred: totalSize,\n      requestsByMethod,\n      requestsByStatus,\n      errorRate: failed / total,\n      cacheHitRate: cached / total,\n    }\n  }\n\n  /**\n   * 插入排序（对小数组更快）\n   */\n  private insertionSort(arr: number[]): void {\n    for (let i = 1; i < arr.length; i++) {\n      const key = arr[i]\n      let j = i - 1\n      while (j >= 0 && arr[j] > key) {\n        arr[j + 1] = arr[j]\n        j--\n      }\n      arr[j + 1] = key\n    }\n  }\n\n  /**\n   * 清除统计缓存\n   */\n  private invalidateStatsCache(): void {\n    this.statsCache = undefined\n  }\n\n  /**\n   * 获取百分位数\n   */\n  private getPercentile(sortedArray: number[], percentile: number): number {\n    if (sortedArray.length === 0)\n      return 0\n    const index = Math.ceil((percentile / 100) * sortedArray.length) - 1\n    return sortedArray[Math.max(0, index)]\n  }\n\n  /**\n   * 获取最近的指标\n   */\n  getRecentMetrics(count: number = 10): PerformanceMetrics[] {\n    return this.metrics.slice(-count)\n  }\n\n  /**\n   * 获取慢请求\n   */\n  getSlowRequests(): PerformanceMetrics[] {\n    return this.metrics.filter(m => m.duration > this.config?.slowRequestThreshold)\n  }\n\n  /**\n   * 获取失败请求\n   */\n  getFailedRequests(): PerformanceMetrics[] {\n    return this.metrics.filter(m => m.error)\n  }\n\n  /**\n   * 清空指标\n   */\n  clear(): void {\n    this.metrics = []\n    this.requestMap.clear()\n  }\n\n  /**\n   * 导出指标\n   */\n  exportMetrics(): PerformanceMetrics[] {\n    return [...this.metrics]\n  }\n\n  /**\n   * 启用监控\n   */\n  enable(): void {\n    if (this.config) {\n      this.config.enabled = true\n    }\n  }\n\n  /**\n   * 禁用监控\n   */\n  disable(): void {\n    if (this.config) {\n      this.config.enabled = false\n    }\n  }\n\n  /**\n   * 设置慢请求阈值\n   */\n  setSlowRequestThreshold(threshold: number): void {\n    if (this.config) {\n      this.config.slowRequestThreshold = threshold\n    }\n  }\n\n  /**\n   * 获取指标\n   */\n  getMetrics(): PerformanceMetrics[] {\n    return [...this.metrics]\n  }\n\n  /**\n   * 是否启用\n   */\n  isEnabled(): boolean {\n    return this.config?.enabled\n  }\n}\n\n/**\n * 创建请求监控器\n */\nexport function createRequestMonitor(config?: MonitorConfig): RequestMonitor {\n  return new RequestMonitor(config)\n}\n\n/**\n * 默认监控器实例\n */\nexport const defaultMonitor = createRequestMonitor()\n"],"names":["RequestMonitor","constructor","config","this","metrics","metricsIndex","requestMap","Map","statsCacheTime","statsCacheTTL","sampleCounter","enabled","maxMetrics","slowRequestThreshold","samplingRate","enableSampling","onSlowRequest","onError","onMetricsUpdate","shouldSample","Math","random","startRequest","requestId","_config","set","startTime","Date","now","retries","endRequest","response","error","requestInfo","get","endTime","duration","url","method","status","size","getResponseSize","cached","timestamp","addMetrics","delete","invalidateStatsCache","recordRetry","markCached","find","m","length","push","data","Blob","JSON","stringify","getStats","statsCache","stats","calculateStats","total","totalRequests","successfulRequests","failedRequests","cachedRequests","averageDuration","averageResponseTime","medianDuration","p95Duration","p99Duration","slowRequests","totalDataTransferred","requestsByMethod","requestsByStatus","errorRate","cacheHitRate","successful","failed","slow","totalDuration","totalSize","Object","create","durations","Array","from","slowThreshold","i","metric","insertionSort","sort","a","b","getPercentile","arr","key","j","sortedArray","percentile","index","ceil","max","getRecentMetrics","count","slice","getSlowRequests","filter","getFailedRequests","clear","exportMetrics","enable","disable","setSlowRequestThreshold","threshold","getMetrics","isEnabled","createRequestMonitor","defaultMonitor","f","R"],"mappings":"MAoEaA,EAcX,WAAAC,CAAYC,EAAwB,CAAA,GAb5BC,KAAAC,QAAgC,GAChCD,KAAAE,aAAe,EAEfF,KAAAG,WAAa,IAAIC,IAIjBJ,KAAAK,eAAiB,EACjBL,KAAAM,cAAgB,IAGhBN,KAAAO,cAAgB,EAGtBP,KAAKD,OAAS,CACZS,SAAS,EACTC,WAAY,IACZC,qBAAsB,IACtBC,aAAc,EACdC,gBAAgB,EAChBC,cAAe,OACfC,QAAS,OACTC,gBAAiB,UACdhB,EAEP,CAKQ,YAAAiB,GACN,OAAKhB,KAAKD,QAAQa,iBAIlBZ,KAAKO,gBACEU,KAAKC,SAAWlB,KAAKD,QAAQY,aACtC,CAKA,YAAAQ,CAAaC,EAAmBC,IACzBrB,KAAKD,QAAQS,UAAYR,KAAKgB,gBAInChB,KAAKG,WAAWmB,IAAIF,EAAW,CAC7BG,UAAWC,KAAKC,MAChBC,QAAS,GAEb,CAKA,UAAAC,CACEP,EACArB,EACA6B,EACAC,GAEA,IAAK7B,KAAKD,QAAQS,QAChB,OAGF,MAAMsB,EAAc9B,KAAKG,WAAW4B,IAAIX,GACxC,IAAKU,EACH,OAGF,MAAME,EAAUR,KAAKC,MACfQ,EAAWD,EAAUF,EAAYP,UAEjCtB,EAA8B,CAClCmB,UAAAA,EACAc,IAAKnC,EAAOmC,KAAO,GACnBC,OAAQpC,EAAOoC,QAAU,MACzBZ,UAAWO,EAAYP,UACvBS,QAAAA,EACAC,SAAAA,EACAG,OAAQR,GAAUQ,OAClBC,KAAMrC,KAAKsC,gBAAgBV,GAC3BW,QAAQ,EACRb,QAASI,EAAYJ,QACrBG,MAAAA,EACAW,UAAWR,GAGbhC,KAAKyC,WAAWxC,GAChBD,KAAKG,WAAWuC,OAAOtB,GAGvBpB,KAAK2C,uBAGDV,EAAWjC,KAAKD,QAAQW,sBAC1BV,KAAKD,QAAQc,cAAcZ,GAGzB4B,GACF7B,KAAKD,QAAQe,QAAQb,GAGvBD,KAAKD,QAAQgB,gBAAgBf,KAAKC,QACpC,CAKA,WAAA2C,CAAYxB,GACV,MAAMU,EAAc9B,KAAKG,WAAW4B,IAAIX,GACpCU,GACFA,EAAYJ,SAEhB,CAKA,UAAAmB,CAAWzB,GACT,MAAMnB,EAAUD,KAAKC,QAAQ6C,KAAKC,GAAKA,EAAE3B,YAAcA,GACnDnB,IACFA,EAAQsC,QAAS,EAErB,CAKQ,UAAAE,CAAWxC,GACbD,KAAKC,QAAQ+C,OAAShD,KAAKD,QAAQU,WAErCT,KAAKC,QAAQgD,KAAKhD,IAIlBD,KAAKC,QAAQD,KAAKE,cAAgBD,EAClCD,KAAKE,cAAgBF,KAAKE,aAAe,GAAKF,KAAKD,QAAQU,WAE/D,CAKQ,eAAA6B,CAAmBV,GACzB,OAAKA,GAAUsB,KAGXtB,EAASsB,gBAAgBC,KACpBvB,EAASsB,KAAKb,KAGM,iBAAlBT,EAASsB,KACX,IAAIC,KAAK,CAACvB,EAASsB,OAAOb,KAGN,iBAAlBT,EAASsB,KACX,IAAIC,KAAK,CAACC,KAAKC,UAAUzB,EAASsB,QAAQb,KAG5C,EAdE,CAeX,CAKA,QAAAiB,GAEE,MAAM7B,EAAMD,KAAKC,MACjB,GAAIzB,KAAKuD,YAAe9B,EAAMzB,KAAKK,eAAkBL,KAAKM,cACxD,MAAO,IAAKN,KAAKuD,YAInB,MAAMC,EAAQxD,KAAKyD,iBAGnB,YAAKF,WAAaC,EAClBxD,KAAKK,eAAiBoB,EAEf,IAAK+B,EACd,CAKQ,cAAAC,GACN,MAAMC,EAAQ1D,KAAKC,QAAQ+C,OAG3B,GAAc,IAAVU,EACF,MAAO,CACLC,cAAe,EACfC,mBAAoB,EACpBC,eAAgB,EAChBC,eAAgB,EAChBC,gBAAiB,EACjBC,oBAAqB,EACrBC,eAAgB,EAChBC,YAAa,EACbC,YAAa,EACbC,aAAc,EACdC,qBAAsB,EACtBC,iBAAkB,CAAA,EAClBC,iBAAkB,GAClBC,UAAW,EACXC,aAAc,GAIlB,IAAIC,EAAa,EACbC,EAAS,EACTpC,EAAS,EACTqC,EAAO,EACPC,EAAgB,EAChBC,EAAY,EAGhB,MAAMR,EAA2CS,OAAOC,OAAO,MACzDT,EAA2CQ,OAAOC,OAAO,MAGzDC,EAAsBC,MAAMC,KAAK,CAAEnC,OAAQU,GAAS,IAAM,GAC1D0B,EAAgBpF,KAAKD,QAAQW,qBAGnC,IAAI2E,EAAI,EACR,IAAA,MAAWC,KAAUtF,KAAKC,QAAS,CACjC,MAAMgC,EAAWqD,EAAOrD,SACxBgD,EAAUI,KAAOpD,EACjB4C,GAAiB5C,EACjB6C,GAAaQ,EAAOjD,MAAQ,EAG5BsC,GAAUW,EAAOzD,MAAQ,EAAI,EAC7B6C,GAAcY,EAAOzD,MAAQ,EAAI,EACjCU,GAAU+C,EAAO/C,OAAS,EAAI,EAC9BqC,GAAQ3C,EAAWmD,EAAgB,EAAI,EAGvCd,EAAiBgB,EAAOnD,SAAWmC,EAAiBgB,EAAOnD,SAAW,GAAK,EAGvEmD,EAAOlD,SACTmC,EAAiBe,EAAOlD,SAAWmC,EAAiBe,EAAOlD,SAAW,GAAK,EAE/E,CAGA,OAAIsB,EAAQ,IAEV1D,KAAKuF,cAAcN,GAEnBA,EAAUO,KAAK,CAACC,EAAGC,IAAMD,EAAIC,GAGxB,CACL/B,cAAeD,EACfE,mBAAoBc,EACpBb,eAAgBc,EAChBb,eAAgBvB,EAChBwB,gBAAiBc,EAAgBnB,EACjCM,oBAAqBa,EAAgBnB,EACrCO,eAAgBjE,KAAK2F,cAAcV,EAAW,IAC9Cf,YAAalE,KAAK2F,cAAcV,EAAW,IAC3Cd,YAAanE,KAAK2F,cAAcV,EAAW,IAC3Cb,aAAcQ,EACdP,qBAAsBS,EACtBR,iBAAAA,EACAC,iBAAAA,EACAC,UAAWG,EAASjB,EACpBe,aAAclC,EAASmB,EAE3B,CAKQ,aAAA6B,CAAcK,GACpB,IAAA,IAASP,EAAI,EAAGA,EAAIO,EAAI5C,OAAQqC,IAAK,CACnC,MAAMQ,EAAMD,EAAIP,GAChB,IAAIS,EAAIT,EAAI,EACZ,KAAOS,GAAK,GAAKF,EAAIE,GAAKD,GACxBD,EAAIE,EAAI,GAAKF,EAAIE,GACjBA,IAEFF,EAAIE,EAAI,GAAKD,CACf,CACF,CAKQ,oBAAAlD,GACN3C,KAAKuD,gBAAa,CACpB,CAKQ,aAAAoC,CAAcI,EAAuBC,GAC3C,GAA2B,IAAvBD,EAAY/C,OACd,SACF,MAAMiD,EAAQhF,KAAKiF,KAAMF,EAAa,IAAOD,EAAY/C,QAAU,EACnE,OAAO+C,EAAY9E,KAAKkF,IAAI,EAAGF,GACjC,CAKA,gBAAAG,CAAiBC,EAAgB,IAC/B,OAAOrG,KAAKC,QAAQqG,OAAOD,EAC7B,CAKA,eAAAE,GACE,OAAOvG,KAAKC,QAAQuG,OAAOzD,GAAKA,EAAEd,SAAWjC,KAAKD,QAAQW,qBAC5D,CAKA,iBAAA+F,GACE,OAAOzG,KAAKC,QAAQuG,OAAOzD,GAAKA,EAAElB,MACpC,CAKA,KAAA6E,GACE1G,KAAKC,QAAU,GACfD,KAAKG,WAAWuG,OAClB,CAKA,aAAAC,GACE,MAAO,IAAI3G,KAAKC,QAClB,CAKA,MAAA2G,GACM5G,KAAKD,SACPC,KAAKD,OAAOS,SAAU,EAE1B,CAKA,OAAAqG,GACM7G,KAAKD,SACPC,KAAKD,OAAOS,SAAU,EAE1B,CAKA,uBAAAsG,CAAwBC,GAClB/G,KAAKD,SACPC,KAAKD,OAAOW,qBAAuBqG,EAEvC,CAKA,UAAAC,GACE,MAAO,IAAIhH,KAAKC,QAClB,CAKA,SAAAgH,GACE,OAAOjH,KAAKD,QAAQS,OACtB,EAMI,SAAU0G,EAAqBnH,GACnC,OAAO,IAAIF,EAAeE,EAC5B,CAKO,MAAMoH,EAAiBD,WAAAnE,oBAAAqE,0BAAAC"}
import{generateId as t}from"./index.js";var e,a,s;(a=e||(e={})).HTTP="http",a.DATABASE="database",a.CACHE="cache",a.CUSTOM="custom",function(t){t.PENDING="pending",t.SUCCESS="success",t.ERROR="error",t.CANCELLED="cancelled"}(s||(s={}));class r{constructor(t={}){this.traces=new Map,this.config={enabled:t.enabled??!0,sampleRate:t.sampleRate??1,propagateTraceId:t.propagateTraceId??!0,traceIdHeader:t.traceIdHeader??"X-Trace-Id",spanIdHeader:t.spanIdHeader??"X-Span-Id",exporter:t.exporter}}startTrace(t,a=e.HTTP){if(!this.shouldSample())return new c;const r=this.generateTraceId(),o={spanId:this.generateSpanId(),traceId:r,name:t,type:a,startTime:Date.now(),status:s.PENDING,tags:[],logs:[]},d={traceId:r,currentSpan:o,spans:[o],metadata:{}};return this.traces.set(r,d),new n(this,d,o)}getTrace(t){return this.traces.get(t)}finishTrace(t){const e=this.traces.get(t);if(e){if(this.config?.exporter){const t=this.config?.exporter(e.spans);t instanceof Promise&&t.catch(t=>{})}this.traces.delete(t)}}shouldSample(){return!!this.config?.enabled&&Math.random()<this.config?.sampleRate}generateTraceId(){return`trace-${t()}-${Date.now()}`}generateSpanId(){return`span-${t()}`}getConfig(){return this.config}}class n{constructor(t,e,a){this.tracer=t,this.context=e,this.rootSpan=a}get traceId(){return this.context.traceId}get spanId(){return this.rootSpan.spanId}startSpan(a,r=e.CUSTOM){const n={spanId:`span-${t()}`,parentSpanId:this.context.currentSpan?.spanId,traceId:this.context.traceId,name:a,type:r,startTime:Date.now(),status:s.PENDING,tags:[],logs:[]};return this.context.spans.push(n),this.context.currentSpan=n,new o(n)}addTag(t,e){return this.rootSpan.tags.push({key:t,value:e}),this}addLog(t,e){return this.rootSpan.logs.push({timestamp:Date.now(),message:t,data:e}),this}setError(t){return this.rootSpan.status=s.ERROR,this.rootSpan.error={message:t.message,stack:t.stack},this}finish(t=s.SUCCESS){const e=Date.now();this.rootSpan.endTime=e,this.rootSpan.duration=e-this.rootSpan.startTime,this.rootSpan.status=t,this.tracer.finishTrace(this.context.traceId)}getSpans(){return[...this.context.spans]}getMetadata(){return this.context.metadata}setMetadata(t,e){return this.context.metadata[t]=e,this}}class o{constructor(t){this.span=t}addTag(t,e){return this.span.tags.push({key:t,value:e}),this}addLog(t,e){return this.span.logs.push({timestamp:Date.now(),message:t,data:e}),this}setError(t){return this.span.status=s.ERROR,this.span.error={message:t.message,stack:t.stack},this}finish(t=s.SUCCESS){const e=Date.now();this.span.endTime=e,this.span.duration=e-this.span.startTime,this.span.status=t}getRawSpan(){return this.span}}class c extends n{constructor(){super(null,null,null)}startSpan(){return new d}addTag(){return this}addLog(){return this}setError(){return this}finish(){}getSpans(){return[]}}class d extends o{constructor(){super(null)}addTag(){return this}addLog(){return this}setError(){return this}finish(){}}function i(t){return new r(t)}const p=new r;function h(t){const a=new r(t),n=new Map;return{request:{onFulfilled:t=>{const s=a.startTrace(`${t.method?.toUpperCase()} ${t.url}`,e.HTTP);s.addTag("http.method",t.method||"GET"),s.addTag("http.url",t.url||""),t.baseURL&&s.addTag("http.base_url",t.baseURL),t.__trace__=s;const r=a.getConfig();return r.propagateTraceId&&(t.headers=t.headers||{},r.traceIdHeader&&r.spanIdHeader&&(t.headers[r.traceIdHeader]=s.traceId,t.headers[r.spanIdHeader]=s.spanId)),n.set(s.traceId,s),t}},response:{onFulfilled:t=>{const e=t.config.__trace__;return e&&(e.addTag("http.status",t.status),e.addLog("Response received"),e.finish(s.SUCCESS),n.delete(e.traceId)),t},onRejected:t=>{const e=t.config.__trace__;throw e&&(t.response&&e.addTag("http.status",t.response.status),e.setError(t),e.addLog("Request failed",{error:t.message}),e.finish(s.ERROR),n.delete(e.traceId)),t}}}}function u(t){t.forEach(t=>{t.duration&&t.duration,t.status===s.SUCCESS||(t.status,s.ERROR);t.tags.length,t.logs.length,t.error})}export{r as RequestTracer,o as Span,s as SpanStatus,e as SpanType,n as Trace,u as consoleExporter,i as createRequestTracer,h as createTraceInterceptor,p as globalTracer};
//# sourceMappingURL=trace.js.map

class e{constructor(e){this.preconnectedDomains=new Set,this.client=e}async warmup(e){const{urls:t,method:n="HEAD",concurrency:c=5,timeout:s=5e3,dnsPrefetch:o=!0,preconnect:a=!0,silent:r=!0}=e,i=Date.now(),l=[],u=[],d=[];if(o&&typeof document<"u"&&this.dnsPrefetch(t),a&&typeof document<"u"){const e=[...new Set(t.map(e=>new URL(e).origin))];this.preconnect(e)}const h=this.createBatches(t,c);for(const e of h)await Promise.all(e.map(async e=>{const t=Date.now();try{await this.client.request({url:e,method:n,timeout:s,metadata:{isWarmup:!0}});const c=Date.now()-t;d.push(c),l.push(e)}catch(t){u.push({url:e,error:t})}}));const m=Date.now()-i,p=d.length>0?d.reduce((e,t)=>e+t,0)/d.length:0;return{succeeded:l,failed:u,duration:m,stats:{total:t.length,success:l.length,failed:u.length,averageTime:p}}}dnsPrefetch(e){typeof document>"u"||[...new Set(e.map(e=>{try{return new URL(e).origin}catch{return null}}).filter(Boolean))].forEach(e=>{if(!this.hasLinkTag(e,"dns-prefetch")){const t=document.createElement("link");t.rel="dns-prefetch",t.href=e,document.head.appendChild(t)}})}preconnect(e){typeof document>"u"||e.forEach(e=>{if(!this.preconnectedDomains.has(e)&&!this.hasLinkTag(e,"preconnect")){const t=document.createElement("link");t.rel="preconnect",t.href=e,t.crossOrigin="anonymous",document.head.appendChild(t),this.preconnectedDomains.add(e)}})}preload(e,t="fetch"){if(!(typeof document>"u"||this.hasLinkTag(e,"preload"))){const n=document.createElement("link");n.rel="preload",n.href=e,n.as=t,document.head.appendChild(n)}}async warmupWithRetry(e,t=2){let n=await this.warmup(e);for(let c=0;c<t&&n.failed.length>0;c++){const t=n.failed.map(e=>e.url),c=await this.warmup({...e,urls:t});n={succeeded:[...n.succeeded,...c.succeeded],failed:c.failed,duration:n.duration+c.duration,stats:{total:e.urls.length,success:n.succeeded.length+c.succeeded.length,failed:c.failed.length,averageTime:(n.stats.averageTime+c.stats.averageTime)/2}}}return n}async smartWarmup(e,t=5){const n=this.getAccessCounts(),c=e.filter(e=>(n.get(e)||0)>=t);return 0===c.length?{succeeded:[],failed:[],duration:0,stats:{total:0,success:0,failed:0,averageTime:0}}:this.warmup({urls:c,silent:!0})}cleanup(){typeof document>"u"||(document.querySelectorAll('link[rel="dns-prefetch"], link[rel="preconnect"], link[rel="preload"]').forEach(e=>e.remove()),this.preconnectedDomains.clear())}createBatches(e,t){const n=[];for(let c=0;c<e.length;c+=t)n.push(e.slice(c,c+t));return n}hasLinkTag(e,t){return!(typeof document>"u")&&!!document.querySelector(`link[rel="${t}"][href="${e}"]`)}getAccessCounts(){return new Map}}function t(t){return new e(t)}class n{constructor(e={}){this.connections=new Map,this.config={enabled:!0,maxIdleTime:6e4,maxConnections:100,maxConnectionsPerHost:6,...e}}acquire(e){if(!this.config?.enabled)return;let t=this.connections.get(e);t||(t={count:0,lastUsed:Date.now()},this.connections.set(e,t)),t.count++,t.lastUsed=Date.now(),t.timer&&clearTimeout(t.timer),t.timer=setTimeout(()=>{this.release(e)},this.config?.maxIdleTime)}release(e){const t=this.connections.get(e);t&&(t.count--,t.count<=0&&(t.timer&&clearTimeout(t.timer),this.connections.delete(e)))}getStats(){const e={totalConnections:this.connections.size,activeConnections:0,idleConnections:0,connectionsByHost:{}},t=Date.now();return this.connections.forEach((n,c)=>{t-n.lastUsed>(this.config?.maxIdleTime??0)/2?e.idleConnections++:e.activeConnections++,e.connectionsByHost[c]=n.count}),e}cleanup(){this.connections.forEach(e=>{e.timer&&clearTimeout(e.timer)}),this.connections.clear()}updateConfig(e){this.config={...this.config,...e}}}function c(e){return new n(e)}async function s(t,n,c){return new e(t).warmup({urls:n,...c})}export{n as KeepAliveManager,e as WarmupManager,c as createKeepAliveManager,t as createWarmupManager,s as warmupConnections};
//# sourceMappingURL=warmup.js.map

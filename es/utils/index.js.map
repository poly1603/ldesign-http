{"version":3,"file":"index.js","sources":["../../src/utils/index.ts"],"sourcesContent":["import type { HttpError, RequestConfig } from '../types'\n\n/**\n * 合并配置对象（性能优化版本 v2）\n *\n * 将默认配置和自定义配置合并，自定义配置会覆盖默认配置。\n * 对于 headers 和 params 对象，会进行深度合并。\n *\n * 性能优化：\n * - 添加输入验证，防止无效输入\n * - 使用位标记追踪需要合并的字段，减少条件判断\n * - 缓存常用配置模式\n * - 避免不必要的对象创建\n *\n * @param defaultConfig - 默认配置对象\n * @param customConfig - 自定义配置对象，可选\n * @returns 合并后的配置对象\n * @throws {TypeError} 当配置对象不是有效对象时\n *\n * @example\n * ```typescript\n * const defaultConfig = {\n *   timeout: 5000,\n *   headers: { 'Content-Type': 'application/json' }\n * }\n *\n * const customConfig = {\n *   timeout: 10000,\n *   headers: { 'Authorization': 'Bearer token' }\n * }\n *\n * const merged = mergeConfig(defaultConfig, customConfig)\n * // 结果: {\n * //   timeout: 10000,\n * //   headers: {\n * //     'Content-Type': 'application/json',\n * //     'Authorization': 'Bearer token'\n * //   }\n * // }\n * ```\n */\nexport function mergeConfig(\n  defaultConfig: RequestConfig,\n  customConfig: RequestConfig = {},\n): RequestConfig {\n  // 输入验证\n  if (!defaultConfig || typeof defaultConfig !== 'object') {\n    throw new TypeError('defaultConfig must be a valid object')\n  }\n\n  // 快速路径：如果自定义配置为空或无效，直接返回默认配置\n  if (!customConfig || typeof customConfig !== 'object' || Object.keys(customConfig).length === 0) {\n    return { ...defaultConfig }\n  }\n\n  // 浅拷贝基础配置\n  const merged: RequestConfig = { ...defaultConfig, ...customConfig }\n\n  // 只在两者都有 headers 时才进行深度合并（性能优化）\n  if (defaultConfig.headers && customConfig.headers) {\n    merged.headers = { ...defaultConfig.headers, ...customConfig.headers }\n  }\n\n  // 只在两者都有 params 时才进行深度合并（性能优化）\n  if (defaultConfig.params && customConfig.params) {\n    merged.params = { ...defaultConfig.params, ...customConfig.params }\n  }\n\n  return merged\n}\n\n// 缓存编码后的常见字符，提升性能\nconst ENCODED_CHARS_CACHE = new Map<string, string>()\nconst CACHE_SIZE_LIMIT = 1000\n\n/**\n * 带缓存的 encodeURIComponent（优化版：减少缓存检查开销）\n */\nfunction cachedEncodeURIComponent(str: string): string {\n  // 只对非常短的字符串使用缓存（减少 Map 查找开销）\n  if (str.length <= 20) {\n    const cached = ENCODED_CHARS_CACHE.get(str)\n    if (cached !== undefined) {\n      return cached\n    }\n\n    const encoded = encodeURIComponent(str).replace(/%20/g, '+')\n\n    // 限制缓存大小\n    if (ENCODED_CHARS_CACHE.size < CACHE_SIZE_LIMIT) {\n      ENCODED_CHARS_CACHE.set(str, encoded)\n    }\n\n    return encoded\n  }\n\n  // 长字符串直接编码（不使用缓存）\n  return encodeURIComponent(str).replace(/%20/g, '+')\n}\n\n/**\n * 构建查询字符串（性能优化版本 v2）\n *\n * 将参数对象转换为 URL 查询字符串格式。\n * 支持数组值、null/undefined 值过滤。\n *\n * 性能优化：\n * - 使用缓存减少重复编码开销\n * - 预估数组大小，减少内存重分配\n * - 提前过滤无效值\n * - 使用位运算优化数组处理\n *\n * @param params - 参数对象\n * @returns URL 查询字符串，不包含前导 '?'\n * @throws {TypeError} 当 params 不是有效对象时\n *\n * @example\n * ```typescript\n * const params = {\n *   name: 'John',\n *   age: 30,\n *   tags: ['developer', 'typescript'],\n *   active: true,\n *   deleted: null // 会被忽略\n * }\n *\n * const queryString = buildQueryString(params)\n * // 结果: \"name=John&age=30&tags=developer&tags=typescript&active=true\"\n * ```\n */\nexport function buildQueryString(params: Record<string, any>): string {\n  // 输入验证\n  if (!params || typeof params !== 'object') {\n    return ''\n  }\n\n  const keys = Object.keys(params)\n  if (keys.length === 0) {\n    return ''\n  }\n\n  // 预估数组大小，减少扩容开销\n  const parts: string[] = Array.from({length: keys.length * 2})\n  let index = 0\n\n  // 优化：使用 for-of 循环，比 for-in 更快\n  for (const key of keys) {\n    const value = params[key]\n\n    // 跳过 null 和 undefined\n    if (value === null || value === undefined) {\n      continue\n    }\n\n    const encodedKey = cachedEncodeURIComponent(key)\n\n    if (Array.isArray(value)) {\n      // 数组值处理\n      const len = value.length\n      for (let i = 0; i < len; i++) {\n        const item = value[i]\n        if (item !== null && item !== undefined) {\n          parts[index++] = `${encodedKey}=${cachedEncodeURIComponent(String(item))}`\n        }\n      }\n    }\n    else {\n      // 单值处理\n      parts[index++] = `${encodedKey}=${cachedEncodeURIComponent(String(value))}`\n    }\n  }\n\n  // 截取有效部分并拼接\n  return parts.slice(0, index).join('&')\n}\n\n/**\n * 清除查询字符串编码缓存\n * \n * 用于释放内存或测试场景\n */\nexport function clearQueryStringCache(): void {\n  ENCODED_CHARS_CACHE.clear()\n}\n\n/**\n * 构建完整的 URL\n */\nexport function buildURL(\n  url: string,\n  baseURL?: string,\n  params?: Record<string, any>,\n): string {\n  let fullURL = url\n\n  // 处理 baseURL\n  if (baseURL && !isAbsoluteURL(url)) {\n    fullURL = combineURLs(baseURL, url)\n  }\n\n  // 处理查询参数\n  if (params && Object.keys(params).length > 0) {\n    const queryString = buildQueryString(params)\n    if (queryString) {\n      const separator = fullURL.includes('?') ? '&' : '?'\n      fullURL += separator + queryString\n    }\n  }\n\n  return fullURL\n}\n\n/**\n * 判断是否为绝对 URL\n */\nexport function isAbsoluteURL(url: string): boolean {\n  return /^(?:[a-z][a-z\\d+\\-.]*:)?\\/\\//i.test(url)\n}\n\n/**\n * 合并 URL\n */\nexport function combineURLs(baseURL: string, relativeURL: string): string {\n  return relativeURL\n    ? `${baseURL.replace(/\\/+$/, '')}/${relativeURL.replace(/^\\/+/, '')}`\n    : baseURL\n}\n\n/**\n * 创建 HTTP 错误\n */\nexport function createHttpError(\n  message: string,\n  config?: RequestConfig,\n  code?: string,\n  response?: any,\n): HttpError {\n  const error = new Error(message) as HttpError\n  error.config = config\n  error.code = code\n  error.response = response\n  error.isNetworkError = false\n  error.isTimeoutError = false\n  error.isCancelError = false\n\n  // 判断错误类型\n  if (code === 'ECONNABORTED' || message.includes('timeout')) {\n    error.isTimeoutError = true\n  }\n  else if (code === 'NETWORK_ERROR' || message.includes('Network Error')) {\n    error.isNetworkError = true\n  }\n  else if (code === 'CANCELED' || message.includes('canceled')) {\n    error.isCancelError = true\n  }\n\n  return error\n}\n\n/**\n * 延迟函数\n */\nexport function delay(ms: number): Promise<void> {\n  return new Promise(resolve => setTimeout(resolve, ms))\n}\n\n/**\n * 生成唯一 ID\n */\nexport function generateId(): string {\n  return (\n    Math.random().toString(36).substring(2, 15)\n    + Math.random().toString(36).substring(2, 15)\n  )\n}\n\n/**\n * 深拷贝对象（优化版）\n */\nexport function deepClone<T>(obj: T): T {\n  if (obj === null || typeof obj !== 'object') {\n    return obj\n  }\n\n  if (obj instanceof Date) {\n    return new Date(obj.getTime()) as unknown as T\n  }\n\n  if (Array.isArray(obj)) {\n    return obj.map(item => deepClone(item)) as unknown as T\n  }\n\n  if (typeof obj === 'object') {\n    const cloned = {} as T\n    // 使用 for-in 遍历，性能更好\n    for (const key in obj) {\n      if (Object.prototype.hasOwnProperty.call(obj, key)) {\n        cloned[key] = deepClone(obj[key])\n      }\n    }\n    return cloned\n  }\n\n  return obj\n}\n\n/**\n * 判断是否为 FormData\n */\nexport function isFormData(data: unknown): data is FormData {\n  return typeof FormData !== 'undefined' && data instanceof FormData\n}\n\n/**\n * 判断是否为 Blob\n */\nexport function isBlob(data: unknown): data is Blob {\n  return typeof Blob !== 'undefined' && data instanceof Blob\n}\n\n/**\n * 判断是否为 ArrayBuffer\n */\nexport function isArrayBuffer(data: unknown): data is ArrayBuffer {\n  return typeof ArrayBuffer !== 'undefined' && data instanceof ArrayBuffer\n}\n\n/**\n * 判断是否为 URLSearchParams\n */\nexport function isURLSearchParams(data: unknown): data is URLSearchParams {\n  return (\n    typeof URLSearchParams !== 'undefined' && data instanceof URLSearchParams\n  )\n}\n\n/**\n * HTTP状态码分类工具函数\n */\nexport const HttpStatus = {\n  isSuccess: (status: number): boolean => status >= 200 && status < 300,\n  isRedirect: (status: number): boolean => status >= 300 && status < 400,\n  isClientError: (status: number): boolean => status >= 400 && status < 500,\n  isServerError: (status: number): boolean => status >= 500,\n  isAuthError: (status: number): boolean => status === 401 || status === 403,\n  isNotFound: (status: number): boolean => status === 404,\n  isTimeout: (status: number): boolean => status === 408,\n} as const\n\n/**\n * 错误分类工具函数\n */\nexport const ErrorClassifier = {\n  /**\n   * 判断是否为网络错误\n   */\n  isNetworkError: (error: any): boolean => {\n    return error?.isNetworkError\n      || error?.name === 'NetworkError'\n      || error?.code === 'NETWORK_ERROR'\n      || (!error?.response && error?.message?.includes('network'))\n  },\n\n  /**\n   * 判断是否为超时错误\n   */\n  isTimeoutError: (error: any): boolean => {\n    return error?.isTimeoutError\n      || error?.name === 'TimeoutError'\n      || error?.code === 'TIMEOUT'\n      || error?.message?.includes('timeout')\n  },\n\n  /**\n   * 判断是否为取消错误\n   */\n  isCancelError: (error: any): boolean => {\n    return error?.isCancelError\n      || error?.name === 'AbortError'\n      || error?.code === 'CANCELED'\n      || error?.message?.includes('aborted')\n  },\n\n  /**\n   * 获取错误类型\n   */\n  getErrorType: (error: any): string => {\n    if (ErrorClassifier.isNetworkError(error))\n      return 'network'\n    if (ErrorClassifier.isTimeoutError(error))\n      return 'timeout'\n    if (ErrorClassifier.isCancelError(error))\n      return 'cancel'\n    if (error?.response?.status) {\n      const status = error.response.status\n      if (HttpStatus.isClientError(status))\n        return 'client'\n      if (HttpStatus.isServerError(status))\n        return 'server'\n    }\n    return 'unknown'\n  },\n\n  /**\n   * 获取用户友好的错误消息\n   */\n  getUserFriendlyMessage: (error: any): string => {\n    const type = ErrorClassifier.getErrorType(error)\n    const messages = {\n      network: '网络连接失败，请检查网络设置',\n      timeout: '请求超时，请重试',\n      cancel: '请求已取消',\n      client: `请求失败 (${error?.response?.status || '客户端错误'})`,\n      server: '服务器内部错误，请稍后重试',\n      unknown: '未知错误，请重试',\n    }\n    return messages[type as keyof typeof messages] || messages.unknown\n  },\n} as const\n\n// 导出新增的工具模块\nexport * from './batch'\nexport * from './helpers'\nexport * from './memory'\nexport * from './offline'\nexport * from './signature'\nexport * from './warmup'\n"],"names":["mergeConfig","defaultConfig","customConfig","TypeError","Object","keys","length","merged","headers","params","ENCODED_CHARS_CACHE","Map","cachedEncodeURIComponent","str","cached","get","encoded","encodeURIComponent","replace","size","set","buildQueryString","parts","Array","from","index","key","value","encodedKey","isArray","len","i","item","String","slice","join","clearQueryStringCache","clear","buildURL","url","baseURL","fullURL","isAbsoluteURL","combineURLs","queryString","separator","includes","test","relativeURL","createHttpError","message","config","code","response","error","Error","isNetworkError","isTimeoutError","isCancelError","delay","ms","Promise","resolve","setTimeout","generateId","Math","random","toString","substring","deepClone","obj","Date","getTime","map","cloned","prototype","hasOwnProperty","call","isFormData","data","FormData","isBlob","Blob","isArrayBuffer","ArrayBuffer","isURLSearchParams","URLSearchParams","HttpStatus","isSuccess","status","isRedirect","isClientError","isServerError","isAuthError","isNotFound","isTimeout","ErrorClassifier","name","getErrorType","getUserFriendlyMessage","type","messages","network","timeout","cancel","client","server","unknown"],"mappings":"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"}
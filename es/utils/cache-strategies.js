class t{constructor(t=100){this.name="lru",this.accessOrder=new Map,this.counter=0,this.maxSize=t}shouldCache(t,e){return"GET"===t.method&&e.status>=200&&e.status<300}getTTL(t,e){const s=e.headers?.["cache-control"];if(s){const t=this.parseMaxAge(s);if(t)return 1e3*t}return 3e5}generateKey(t){const{method:e="GET",url:s="",params:r={}}=t,a=Object.keys(r).sort().map(t=>`${t}=${r[t]}`).join("&");return`${e}:${s}${a?`?${a}`:""}`}recordAccess(t){this.accessOrder.set(t,this.counter++),this.accessOrder.size>this.maxSize&&this.evict()}getLRUKey(){if(0===this.accessOrder.size)return null;let t="",e=Number.MAX_SAFE_INTEGER;for(const[s,r]of this.accessOrder)r<e&&(e=r,t=s);return t}evict(){const t=this.getLRUKey();return t&&this.accessOrder.delete(t),t}parseMaxAge(t){const e=t.match(/max-age=(\d+)/);return e?Number.parseInt(e[1],10):null}}class e{constructor(t=100){this.name="lfu",this.frequency=new Map,this.maxSize=t}shouldCache(t,e){return"GET"===t.method&&e.status>=200&&e.status<300}getTTL(t,e){return 6e5}generateKey(t){const{method:e="GET",url:s="",params:r={}}=t;return`${e}:${s}:${JSON.stringify(r)}`}recordAccess(t){const e=this.frequency.get(t)||0;this.frequency.set(t,e+1),this.frequency.size>this.maxSize&&this.evict()}getLFUKey(){if(0===this.frequency.size)return null;let t="",e=Number.MAX_SAFE_INTEGER;for(const[s,r]of this.frequency)r<e&&(e=r,t=s);return t}evict(){const t=this.getLFUKey();return t&&this.frequency.delete(t),t}}class s{constructor(t=3e5){this.name="ttl",this.defaultTTL=t}shouldCache(t,e){return e.status>=200&&e.status<400}getTTL(t,e){const s=t?.cache?.ttl;if(s)return s;const r=e.headers?.["cache-control"];if(r){if(r.includes("no-cache")||r.includes("no-store"))return 0;const t=this.parseMaxAge(r);if(t)return 1e3*t}return this.defaultTTL}generateKey(t){return`${t.method}:${t.url}:${Date.now()}`}parseMaxAge(t){const e=t.match(/max-age=(\d+)/);return e?Number.parseInt(e[1],10):null}}class r{constructor(){this.name="smart",this.accessHistory=new Map,this.hitRates=new Map}shouldCache(t,e){const s=this.generateKey(t);return(this.hitRates.get(s)||0)>.3||"GET"===t.method&&200===e.status}getTTL(t,e){const s=this.generateKey(t),r=this.accessHistory.get(s)||[];if(r.length>=2){const t=[];for(let e=1;e<r.length;e++)t.push(r[e]-r[e-1]);const e=t.reduce((t,e)=>t+e,0)/t.length;return Math.min(2*e,18e5)}return 3e5}generateKey(t){const{method:e="GET",url:s=""}=t;return`${e}:${s.split("?")[0]}`}recordAccess(t,e){const s=this.accessHistory.get(t)||[];s.push(Date.now()),s.length>10&&s.shift(),this.accessHistory.set(t,s);const r=this.hitRates.get(t)||0,a=e?.9*r+.1:.9*r;this.hitRates.set(t,a)}}class a{constructor(){this.stats={hits:0,misses:0,hitRate:0,size:0,memoryUsage:0,recentKeys:[],hotKeys:[]},this.accessLog=new Map,this.maxRecentKeys=10,this.maxHotKeys=10}recordHit(t){this.stats.hits++,this.updateHitRate(),this.recordAccess(t)}recordMiss(t){this.stats.misses++,this.updateHitRate(),this.updateRecentKeys(t)}recordAccess(t){const e=this.accessLog.get(t)||0;this.accessLog.set(t,e+1),this.updateRecentKeys(t),this.updateHotKeys()}updateHitRate(){const t=this.stats.hits+this.stats.misses;this.stats.hitRate=t>0?this.stats.hits/t:0}updateRecentKeys(t){const e=this.stats.recentKeys.indexOf(t);e>-1&&this.stats.recentKeys.splice(e,1),this.stats.recentKeys.unshift(t),this.stats.recentKeys.length>this.maxRecentKeys&&(this.stats.recentKeys=this.stats.recentKeys.slice(0,this.maxRecentKeys))}updateHotKeys(){this.stats.hotKeys=Array.from(this.accessLog.entries()).map(([t,e])=>({key:t,accessCount:e})).sort((t,e)=>e.accessCount-t.accessCount).slice(0,this.maxHotKeys)}updateSize(t){this.stats.size=t}updateMemoryUsage(t){this.stats.memoryUsage=t}getStats(){return{...this.stats}}reset(){this.stats={hits:0,misses:0,hitRate:0,size:0,memoryUsage:0,recentKeys:[],hotKeys:[]},this.accessLog.clear()}}function c(a="lru",c){switch(a){case"lfu":return new e(c?.maxSize);case"ttl":return new s(c?.defaultTTL);case"smart":return new r;default:return new t(c?.maxSize)}}export{a as CacheStatsCollector,e as LFUCacheStrategy,t as LRUCacheStrategy,r as SmartCacheStrategy,s as TTLCacheStrategy,c as createCacheStrategy};
//# sourceMappingURL=cache-strategies.js.map

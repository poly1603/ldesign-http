{"version":3,"file":"upload.js","sources":["../../src/utils/upload.ts"],"sourcesContent":["/**\r\n * 文件上传工具函数\r\n * 提供文件上传、进度监控、断点续传等功能\r\n */\r\n\r\nimport type { RequestConfig, ResponseData } from '../types'\r\n\r\n/**\r\n * 文件上传配置\r\n */\r\nexport interface UploadConfig extends Omit<RequestConfig, 'data'> {\r\n  /** 文件字段名 */\r\n  fileField?: string\r\n  /** 额外的表单数据 */\r\n  formData?: Record<string, string | Blob>\r\n  /** 上传进度回调 */\r\n  onProgress?: (progress: UploadProgress) => void\r\n  /** 分片大小（字节），用于大文件分片上传 */\r\n  chunkSize?: number\r\n  /** 是否启用断点续传 */\r\n  resumable?: boolean\r\n  /** 文件类型限制 */\r\n  accept?: string[]\r\n  /** 文件大小限制（字节） */\r\n  maxSize?: number\r\n  /** 并发上传数量 */\r\n  concurrent?: number\r\n}\r\n\r\n/**\r\n * 上传进度信息\r\n */\r\nexport interface UploadProgress {\r\n  /** 已上传字节数 */\r\n  loaded: number\r\n  /** 总字节数 */\r\n  total: number\r\n  /** 上传百分比 (0-100) */\r\n  percentage: number\r\n  /** 上传速度 (字节/秒) */\r\n  speed: number\r\n  /** 预计剩余时间 (秒) */\r\n  timeRemaining: number\r\n  /** 已耗时 (毫秒) */\r\n  elapsed: number\r\n  /** 当前上传的文件 */\r\n  file?: File\r\n  /** 当前分片索引 */\r\n  chunkIndex?: number\r\n  /** 总分片数 */\r\n  totalChunks?: number\r\n}\r\n\r\n/**\r\n * 上传结果\r\n */\r\nexport interface UploadResult<T = any> extends ResponseData<T> {\r\n  /** 上传的文件信息 */\r\n  file: File\r\n  /** 上传耗时 */\r\n  duration: number\r\n}\r\n\r\n/**\r\n * 分片信息\r\n */\r\nexport interface ChunkInfo {\r\n  /** 分片索引 */\r\n  index: number\r\n  /** 分片数据 */\r\n  chunk: Blob\r\n  /** 分片大小 */\r\n  size: number\r\n  /** 分片开始位置 */\r\n  start: number\r\n  /** 分片结束位置 */\r\n  end: number\r\n  /** 文件哈希 */\r\n  fileHash: string\r\n}\r\n\r\n/**\r\n * 文件验证错误\r\n */\r\nexport class FileValidationError extends Error {\r\n  constructor(\r\n    message: string,\r\n    public file: File,\r\n    public code: 'TYPE_NOT_ALLOWED' | 'SIZE_TOO_LARGE' | 'INVALID_FILE',\r\n  ) {\r\n    super(message)\r\n    this.name = 'FileValidationError'\r\n  }\r\n}\r\n\r\n/**\r\n * 验证文件\r\n */\r\nexport function validateFile(file: File, config: UploadConfig): void {\r\n  // 检查文件类型\r\n  if (config.accept && config.accept.length > 0) {\r\n    const fileType = file.type\r\n    const fileName = file.name.toLowerCase()\r\n\r\n    const isTypeAllowed = config.accept.some((accept) => {\r\n      if (accept.startsWith('.')) {\r\n        // 扩展名匹配\r\n        return fileName.endsWith(accept.toLowerCase())\r\n      }\r\n      else if (accept.includes('/')) {\r\n        // MIME 类型匹配\r\n        return fileType === accept || fileType.startsWith(accept.replace('*', ''))\r\n      }\r\n      return false\r\n    })\r\n\r\n    if (!isTypeAllowed) {\r\n      throw new FileValidationError(\r\n        `文件类型不被允许: ${fileType}`,\r\n        file,\r\n        'TYPE_NOT_ALLOWED',\r\n      )\r\n    }\r\n  }\r\n\r\n  // 检查文件大小\r\n  if (config.maxSize && file.size > config.maxSize) {\r\n    throw new FileValidationError(\r\n      `文件大小超出限制: ${formatFileSize(file.size)} > ${formatFileSize(config.maxSize)}`,\r\n      file,\r\n      'SIZE_TOO_LARGE',\r\n    )\r\n  }\r\n\r\n  // 检查文件是否有效\r\n  if (file.size === 0) {\r\n    throw new FileValidationError(\r\n      '文件为空',\r\n      file,\r\n      'INVALID_FILE',\r\n    )\r\n  }\r\n}\r\n\r\n/**\r\n * 格式化文件大小\r\n */\r\nexport function formatFileSize(bytes: number): string {\r\n  if (bytes === 0)\r\n    return '0 B'\r\n\r\n  const k = 1024\r\n  const sizes = ['B', 'KB', 'MB', 'GB', 'TB']\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k))\r\n\r\n  return `${Number.parseFloat((bytes / k ** i).toFixed(2))} ${sizes[i]}`\r\n}\r\n\r\n/**\r\n * 获取文件扩展名\r\n */\r\nexport function getFileExtension(filename: string): string {\r\n  return filename.slice(((filename.lastIndexOf('.') - 1) >>> 0) + 2)\r\n}\r\n\r\n/**\r\n * 生成文件哈希\r\n */\r\nexport async function generateFileHash(file: File): Promise<string> {\r\n  const buffer = await file.arrayBuffer()\r\n  const hashBuffer = await crypto.subtle.digest('SHA-256', buffer)\r\n  const hashArray = Array.from(new Uint8Array(hashBuffer))\r\n  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('')\r\n}\r\n\r\n/**\r\n * 将文件分片\r\n */\r\nexport function createFileChunks(file: File, chunkSize: number): ChunkInfo[] {\r\n  const chunks: ChunkInfo[] = []\r\n  const totalChunks = Math.ceil(file.size / chunkSize)\r\n\r\n  for (let i = 0; i < totalChunks; i++) {\r\n    const start = i * chunkSize\r\n    const end = Math.min(start + chunkSize, file.size)\r\n    const chunk = file.slice(start, end)\r\n\r\n    chunks.push({\r\n      index: i,\r\n      chunk,\r\n      size: chunk.size,\r\n      start,\r\n      end,\r\n      fileHash: '', // 将在上传时生成\r\n    })\r\n  }\r\n\r\n  return chunks\r\n}\r\n\r\n/**\r\n * 创建上传表单数据\r\n */\r\nexport function createUploadFormData(\r\n  file: File,\r\n  config: UploadConfig,\r\n  chunkInfo?: ChunkInfo,\r\n): FormData {\r\n  const formData = new FormData()\r\n\r\n  // 添加文件\r\n  const fileField = config.fileField || 'file'\r\n  if (chunkInfo) {\r\n    formData.append(fileField, chunkInfo.chunk, file.name)\r\n    formData.append('chunkIndex', chunkInfo.index.toString())\r\n    formData.append('totalChunks', Math.ceil(file.size / (config.chunkSize || file.size)).toString())\r\n    formData.append('fileHash', chunkInfo.fileHash)\r\n  }\r\n  else {\r\n    formData.append(fileField, file)\r\n  }\r\n\r\n  // 添加额外的表单数据\r\n  if (config.formData) {\r\n    Object.entries(config.formData).forEach(([key, value]) => {\r\n      formData.append(key, value)\r\n    })\r\n  }\r\n\r\n  // 添加文件信息\r\n  formData.append('fileName', file.name)\r\n  formData.append('fileSize', file.size.toString())\r\n  formData.append('fileType', file.type)\r\n\r\n  return formData\r\n}\r\n\r\n/**\r\n * 计算上传进度\r\n */\r\nexport class ProgressCalculator {\r\n  private startTime: number = Date.now()\r\n  private lastLoaded: number = 0\r\n  private lastTime: number = Date.now()\r\n  private speeds: number[] = []\r\n\r\n  calculate(loaded: number, total: number, file?: File): UploadProgress {\r\n    const now = Date.now()\r\n    const deltaTime = now - this.lastTime\r\n    const deltaLoaded = loaded - this.lastLoaded\r\n\r\n    // 计算瞬时速度\r\n    const instantSpeed = deltaTime > 0 ? (deltaLoaded / deltaTime) * 1000 : 0\r\n    this.speeds.push(instantSpeed)\r\n\r\n    // 保持最近10个速度样本\r\n    if (this.speeds.length > 10) {\r\n      this.speeds.shift()\r\n    }\r\n\r\n    // 计算平均速度\r\n    const avgSpeed = this.speeds.reduce((sum, speed) => sum + speed, 0) / this.speeds.length\r\n\r\n    // 计算剩余时间\r\n    const remaining = total - loaded\r\n    const timeRemaining = avgSpeed > 0 ? remaining / avgSpeed : 0\r\n\r\n    this.lastLoaded = loaded\r\n    this.lastTime = now\r\n\r\n    return {\r\n      loaded,\r\n      total,\r\n      percentage: total > 0 ? Math.round((loaded / total) * 100) : 0,\r\n      speed: avgSpeed,\r\n      timeRemaining,\r\n      elapsed: now - this.startTime,\r\n      file,\r\n    }\r\n  }\r\n\r\n  reset(): void {\r\n    this.startTime = Date.now()\r\n    this.lastLoaded = 0\r\n    this.lastTime = Date.now()\r\n    this.speeds = []\r\n  }\r\n}\r\n\r\n/**\r\n * 检查文件是否为图片\r\n */\r\nexport function isImageFile(file: File): boolean {\r\n  return file.type.startsWith('image/')\r\n}\r\n\r\n/**\r\n * 检查文件是否为视频\r\n */\r\nexport function isVideoFile(file: File): boolean {\r\n  return file.type.startsWith('video/')\r\n}\r\n\r\n/**\r\n * 检查文件是否为音频\r\n */\r\nexport function isAudioFile(file: File): boolean {\r\n  return file.type.startsWith('audio/')\r\n}\r\n\r\n/**\r\n * 检查文件是否为文档\r\n */\r\nexport function isDocumentFile(file: File): boolean {\r\n  const documentTypes = [\r\n    'application/pdf',\r\n    'application/msword',\r\n    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\r\n    'application/vnd.ms-excel',\r\n    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\r\n    'application/vnd.ms-powerpoint',\r\n    'application/vnd.openxmlformats-officedocument.presentationml.presentation',\r\n    'text/plain',\r\n    'text/csv',\r\n  ]\r\n\r\n  return documentTypes.includes(file.type)\r\n}\r\n\r\n/**\r\n * 生成文件预览URL\r\n */\r\nexport function createFilePreviewURL(file: File): string {\r\n  return URL.createObjectURL(file)\r\n}\r\n\r\n/**\r\n * 释放文件预览URL\r\n */\r\nexport function revokeFilePreviewURL(url: string): void {\r\n  URL.revokeObjectURL(url)\r\n}\r\n"],"names":["FileValidationError","Error","constructor","message","file","code","super","this","name","validateFile","config","accept","length","fileType","type","fileName","toLowerCase","some","startsWith","endsWith","includes","replace","maxSize","size","formatFileSize","bytes","i","Math","floor","log","Number","parseFloat","toFixed","getFileExtension","filename","slice","lastIndexOf","async","generateFileHash","buffer","arrayBuffer","hashBuffer","crypto","subtle","digest","Array","from","Uint8Array","map","b","toString","padStart","join","createFileChunks","chunkSize","chunks","totalChunks","ceil","start","end","min","chunk","push","index","fileHash","createUploadFormData","chunkInfo","formData","FormData","fileField","append","Object","entries","forEach","key","value","ProgressCalculator","startTime","Date","now","lastLoaded","lastTime","speeds","calculate","loaded","total","deltaTime","deltaLoaded","instantSpeed","shift","avgSpeed","reduce","sum","speed","timeRemaining","percentage","round","elapsed","reset","isImageFile","isVideoFile","isAudioFile","isDocumentFile","createFilePreviewURL","URL","createObjectURL","revokeFilePreviewURL","url","revokeObjectURL","l","L","g","v","x","p","w","F","D","S","z","E","y","m"],"mappings":"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"}
class t{constructor(t={}){this.metrics=[],this.metricsIndex=0,this.requestMap=new Map,this.statsCacheTime=0,this.statsCacheTTL=1e3,this.sampleCounter=0,this.config={enabled:!0,maxMetrics:1e3,slowRequestThreshold:3e3,samplingRate:1,enableSampling:!1,onSlowRequest:()=>{},onError:()=>{},onMetricsUpdate:()=>{},...t}}shouldSample(){return!this.config?.enableSampling||(this.sampleCounter++,Math.random()<this.config?.samplingRate)}startRequest(t,e){!this.config?.enabled||!this.shouldSample()||this.requestMap.set(t,{startTime:Date.now(),retries:0})}endRequest(t,e,s,i){if(!this.config?.enabled)return;const r=this.requestMap.get(t);if(!r)return;const a=Date.now(),n=a-r.startTime,o={requestId:t,url:e.url||"",method:e.method||"GET",startTime:r.startTime,endTime:a,duration:n,status:s?.status,size:this.getResponseSize(s),cached:!1,retries:r.retries,error:i,timestamp:a};this.addMetrics(o),this.requestMap.delete(t),this.invalidateStatsCache(),n>this.config?.slowRequestThreshold&&this.config?.onSlowRequest(o),i&&this.config?.onError(o),this.config?.onMetricsUpdate(this.metrics)}recordRetry(t){const e=this.requestMap.get(t);e&&e.retries++}markCached(t){const e=this.metrics.find(e=>e.requestId===t);e&&(e.cached=!0)}addMetrics(t){this.metrics.length<this.config?.maxMetrics?this.metrics.push(t):(this.metrics[this.metricsIndex]=t,this.metricsIndex=(this.metricsIndex+1)%this.config?.maxMetrics)}getResponseSize(t){return t?.data?t.data instanceof Blob?t.data.size:"string"==typeof t.data?new Blob([t.data]).size:"object"==typeof t.data?new Blob([JSON.stringify(t.data)]).size:0:0}getStats(){const t=Date.now();if(this.statsCache&&t-this.statsCacheTime<this.statsCacheTTL)return{...this.statsCache};const e=this.calculateStats();return this.statsCache=e,this.statsCacheTime=t,{...e}}calculateStats(){const t=this.metrics.length;if(0===t)return{totalRequests:0,successfulRequests:0,failedRequests:0,cachedRequests:0,averageDuration:0,averageResponseTime:0,medianDuration:0,p95Duration:0,p99Duration:0,slowRequests:0,totalDataTransferred:0,requestsByMethod:{},requestsByStatus:{},errorRate:0,cacheHitRate:0};let e=0,s=0,i=0,r=0,a=0,n=0;const o=Object.create(null),c=Object.create(null),h=Array.from({length:t},()=>0),u=this.config?.slowRequestThreshold;let l=0;for(const t of this.metrics){const d=t.duration;h[l++]=d,a+=d,n+=t.size||0,s+=t.error?1:0,e+=t.error?0:1,i+=t.cached?1:0,r+=d>u?1:0,o[t.method]=(o[t.method]||0)+1,t.status&&(c[t.status]=(c[t.status]||0)+1)}return t<100?this.insertionSort(h):h.sort((t,e)=>t-e),{totalRequests:t,successfulRequests:e,failedRequests:s,cachedRequests:i,averageDuration:a/t,averageResponseTime:a/t,medianDuration:this.getPercentile(h,50),p95Duration:this.getPercentile(h,95),p99Duration:this.getPercentile(h,99),slowRequests:r,totalDataTransferred:n,requestsByMethod:o,requestsByStatus:c,errorRate:s/t,cacheHitRate:i/t}}insertionSort(t){for(let e=1;e<t.length;e++){const s=t[e];let i=e-1;for(;i>=0&&t[i]>s;)t[i+1]=t[i],i--;t[i+1]=s}}invalidateStatsCache(){this.statsCache=void 0}getPercentile(t,e){if(0===t.length)return 0;const s=Math.ceil(e/100*t.length)-1;return t[Math.max(0,s)]}getRecentMetrics(t=10){return this.metrics.slice(-t)}getSlowRequests(){return this.metrics.filter(t=>t.duration>this.config?.slowRequestThreshold)}getFailedRequests(){return this.metrics.filter(t=>t.error)}clear(){this.metrics=[],this.requestMap.clear()}exportMetrics(){return[...this.metrics]}enable(){this.config&&(this.config.enabled=!0)}disable(){this.config&&(this.config.enabled=!1)}setSlowRequestThreshold(t){this.config&&(this.config.slowRequestThreshold=t)}getMetrics(){return[...this.metrics]}isEnabled(){return this.config?.enabled}}function e(e){return new t(e)}const s=e();export{t as RequestMonitor,e as createRequestMonitor,s as defaultMonitor};
//# sourceMappingURL=monitor.js.map

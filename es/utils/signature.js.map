{"version":3,"file":"signature.js","sources":["../../src/utils/signature.ts"],"sourcesContent":["/**\r\n * 请求签名功能\r\n * 提供请求签名和验证，提高 API 安全性\r\n */\r\n\r\nimport type { RequestConfig } from '../types'\r\n\r\n/**\r\n * 签名配置\r\n */\r\nexport interface SignatureConfig {\r\n  /** 签名密钥 */\r\n  secret: string\r\n  /** 签名算法 */\r\n  algorithm?: 'sha256' | 'sha1' | 'md5'\r\n  /** 签名头名称 */\r\n  headerName?: string\r\n  /** 时间戳头名称 */\r\n  timestampHeaderName?: string\r\n  /** 随机数头名称 */\r\n  nonceHeaderName?: string\r\n  /** 签名有效期（秒） */\r\n  expiresIn?: number\r\n  /** 是否包含请求体 */\r\n  includeBody?: boolean\r\n  /** 是否包含查询参数 */\r\n  includeParams?: boolean\r\n  /** 自定义签名生成器 */\r\n  customGenerator?: (data: string, secret: string) => string | Promise<string>\r\n}\r\n\r\n/**\r\n * 签名结果\r\n */\r\nexport interface SignatureResult {\r\n  /** 签名值 */\r\n  signature: string\r\n  /** 时间戳 */\r\n  timestamp: number\r\n  /** 随机数 */\r\n  nonce: string\r\n}\r\n\r\n/**\r\n * 请求签名管理器\r\n * \r\n * 功能：\r\n * 1. 生成请求签名\r\n * 2. 验证请求签名\r\n * 3. 防重放攻击\r\n * 4. 支持多种签名算法\r\n */\r\nexport class SignatureManager {\r\n  private config: Required<Omit<SignatureConfig, 'customGenerator'>> & Pick<SignatureConfig, 'customGenerator'>\r\n  private usedNonces = new Set<string>()\r\n  private nonceCleanupTimer?: ReturnType<typeof setTimeout>\r\n\r\n  constructor(config: SignatureConfig) {\r\n    this.config = {\r\n      secret: config.secret,\r\n      algorithm: config.algorithm ?? 'sha256',\r\n      headerName: config.headerName ?? 'X-Signature',\r\n      timestampHeaderName: config.timestampHeaderName ?? 'X-Timestamp',\r\n      nonceHeaderName: config.nonceHeaderName ?? 'X-Nonce',\r\n      expiresIn: config.expiresIn ?? 300, // 5分钟\r\n      includeBody: config.includeBody ?? true,\r\n      includeParams: config.includeParams ?? true,\r\n      customGenerator: config.customGenerator,\r\n    }\r\n\r\n    // 启动随机数清理定时器\r\n    this.startNonceCleanup()\r\n  }\r\n\r\n  /**\r\n   * 为请求生成签名\r\n   */\r\n  async sign(config: RequestConfig): Promise<RequestConfig> {\r\n    const timestamp = Date.now()\r\n    const nonce = this.generateNonce()\r\n\r\n    // 构建签名数据\r\n    const signData = this.buildSignData(config, timestamp, nonce)\r\n\r\n    // 生成签名\r\n    const signature = await this.generateSignature(signData)\r\n\r\n    // 添加签名头\r\n    const headers = {\r\n      ...config.headers,\r\n      [this.config?.headerName]: signature,\r\n      [this.config?.timestampHeaderName]: timestamp.toString(),\r\n      [this.config?.nonceHeaderName]: nonce,\r\n    }\r\n\r\n    return {\r\n      ...config,\r\n      headers,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 验证请求签名\r\n   */\r\n  async verify(config: RequestConfig): Promise<boolean> {\r\n    const signature = config.headers?.[this.config?.headerName]\r\n    const timestamp = config.headers?.[this.config?.timestampHeaderName]\r\n    const nonce = config.headers?.[this.config?.nonceHeaderName]\r\n\r\n    if (!signature || !timestamp || !nonce) {\r\n      return false\r\n    }\r\n\r\n    // 检查时间戳是否过期\r\n    const now = Date.now()\r\n    const requestTime = Number.parseInt(timestamp, 10)\r\n    if (now - requestTime > this.config?.expiresIn * 1000) {\r\n      return false\r\n    }\r\n\r\n    // 检查随机数是否已使用（防重放攻击）\r\n    if (this.usedNonces.has(nonce)) {\r\n      return false\r\n    }\r\n\r\n    // 构建签名数据\r\n    const signData = this.buildSignData(config, requestTime, nonce)\r\n\r\n    // 生成期望的签名\r\n    const expectedSignature = await this.generateSignature(signData)\r\n\r\n    // 比较签名\r\n    const isValid = signature === expectedSignature\r\n\r\n    // 如果签名有效，记录随机数\r\n    if (isValid) {\r\n      this.usedNonces.add(nonce)\r\n    }\r\n\r\n    return isValid\r\n  }\r\n\r\n  /**\r\n   * 构建签名数据\r\n   */\r\n  private buildSignData(config: RequestConfig, timestamp: number, nonce: string): string {\r\n    const parts: string[] = [\r\n      config.method || 'GET',\r\n      config.url || '',\r\n      timestamp.toString(),\r\n      nonce,\r\n    ]\r\n\r\n    // 包含查询参数\r\n    if (this.config?.includeParams && config.params) {\r\n      const sortedParams = this.sortObject(config.params)\r\n      parts.push(JSON.stringify(sortedParams))\r\n    }\r\n\r\n    // 包含请求体\r\n    if (this.config?.includeBody && config.data) {\r\n      if (typeof config.data === 'string') {\r\n        parts.push(config.data)\r\n      }\r\n      else {\r\n        parts.push(JSON.stringify(config.data))\r\n      }\r\n    }\r\n\r\n    return parts.join('&')\r\n  }\r\n\r\n  /**\r\n   * 生成签名\r\n   */\r\n  private async generateSignature(data: string): Promise<string> {\r\n    // 如果有自定义生成器，使用自定义生成器\r\n    if (this.config?.customGenerator) {\r\n      return this.config?.customGenerator(data, this.config?.secret)\r\n    }\r\n\r\n    // 使用内置算法\r\n    return this.hash(data + this.config?.secret, this.config?.algorithm)\r\n  }\r\n\r\n  /**\r\n   * 哈希函数\r\n   */\r\n  private async hash(data: string, algorithm: string): Promise<string> {\r\n    // 浏览器环境使用 SubtleCrypto\r\n    if (typeof crypto !== 'undefined' && crypto.subtle) {\r\n      const encoder = new TextEncoder()\r\n      const dataBuffer = encoder.encode(data)\r\n      \r\n      let algoName: string\r\n      switch (algorithm) {\r\n        case 'sha256':\r\n          algoName = 'SHA-256'\r\n          break\r\n        case 'sha1':\r\n          algoName = 'SHA-1'\r\n          break\r\n        default:\r\n          throw new Error(`Unsupported algorithm: ${algorithm}`)\r\n      }\r\n\r\n      const hashBuffer = await crypto.subtle.digest(algoName, dataBuffer)\r\n      const hashArray = Array.from(new Uint8Array(hashBuffer))\r\n      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('')\r\n    }\r\n\r\n    // Node.js 环境使用 crypto 模块（ESM 动态导入）\r\n    try {\r\n      const { createHash } = await import('node:crypto')\r\n      return createHash(algorithm).update(data).digest('hex')\r\n    }\r\n    catch {\r\n      // 如果 crypto 模块不可用，降级到简单哈希\r\n    }\r\n\r\n    // 降级方案：使用简单的哈希（不安全，仅用于开发）\r\n    return this.simpleHash(data)\r\n  }\r\n\r\n  /**\r\n   * 简单哈希（不安全，仅用于开发）\r\n   */\r\n  private simpleHash(str: string): string {\r\n    let hash = 0\r\n    for (let i = 0; i < str.length; i++) {\r\n      const char = str.charCodeAt(i)\r\n      hash = ((hash << 5) - hash) + char\r\n      hash = hash & hash // Convert to 32bit integer\r\n    }\r\n    return Math.abs(hash).toString(16)\r\n  }\r\n\r\n  /**\r\n   * 生成随机数\r\n   */\r\n  private generateNonce(): string {\r\n    const timestamp = Date.now().toString(36)\r\n    const random = Math.random().toString(36).substring(2, 15)\r\n    return `${timestamp}${random}`\r\n  }\r\n\r\n  /**\r\n   * 对象排序（用于生成一致的签名）\r\n   */\r\n  private sortObject(obj: Record<string, any>): Record<string, any> {\r\n    const sorted: Record<string, any> = {}\r\n    Object.keys(obj).sort().forEach((key) => {\r\n      sorted[key] = obj[key]\r\n    })\r\n    return sorted\r\n  }\r\n\r\n  /**\r\n   * 启动随机数清理定时器\r\n   */\r\n  private startNonceCleanup(): void {\r\n    // 每分钟清理一次过期的随机数\r\n    this.nonceCleanupTimer = setInterval(() => {\r\n      // 简单实现：清空所有随机数\r\n      // 更好的实现应该记录随机数的时间戳，只清理过期的\r\n      this.usedNonces.clear()\r\n    }, 60000)\r\n  }\r\n\r\n  /**\r\n   * 清空已使用的随机数\r\n   */\r\n  clearNonces(): void {\r\n    this.usedNonces.clear()\r\n  }\r\n\r\n  /**\r\n   * 销毁签名管理器\r\n   */\r\n  destroy(): void {\r\n    if (this.nonceCleanupTimer) {\r\n      clearInterval(this.nonceCleanupTimer)\r\n      this.nonceCleanupTimer = undefined\r\n    }\r\n    this.usedNonces.clear()\r\n  }\r\n}\r\n\r\n/**\r\n * 创建签名管理器\r\n */\r\nexport function createSignatureManager(config: SignatureConfig): SignatureManager {\r\n  return new SignatureManager(config)\r\n}\r\n\r\n/**\r\n * 创建签名拦截器\r\n */\r\nexport function createSignatureInterceptor(config: SignatureConfig) {\r\n  const manager = new SignatureManager(config)\r\n\r\n  return async (requestConfig: RequestConfig): Promise<RequestConfig> => {\r\n    return manager.sign(requestConfig)\r\n  }\r\n}\r\n\r\n"],"names":["SignatureManager","constructor","config","this","usedNonces","Set","secret","algorithm","headerName","timestampHeaderName","nonceHeaderName","expiresIn","includeBody","includeParams","customGenerator","startNonceCleanup","sign","timestamp","Date","now","nonce","generateNonce","signData","buildSignData","signature","generateSignature","headers","toString","verify","requestTime","Number","parseInt","has","isValid","add","parts","method","url","params","sortedParams","sortObject","push","JSON","stringify","data","join","hash","crypto","subtle","dataBuffer","TextEncoder","encode","algoName","Error","hashBuffer","digest","Array","from","Uint8Array","map","b","padStart","createHash","import","update","simpleHash","str","i","length","charCodeAt","Math","abs","random","substring","obj","sorted","Object","keys","sort","forEach","key","nonceCleanupTimer","setInterval","clear","clearNonces","destroy","clearInterval","createSignatureManager","createSignatureInterceptor","manager","async","requestConfig","o","g","d"],"mappings":"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"}
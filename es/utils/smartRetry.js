var e,t;(t=e||(e={})).IMMEDIATE="immediate",t.EXPONENTIAL="exponential",t.LINEAR="linear",t.FIXED="fixed",t.NONE="none";class a{constructor(e={}){this.config={maxRetries:e.maxRetries??3,baseDelay:e.baseDelay??1e3,maxDelay:e.maxDelay??3e4,checkNetworkStatus:e.checkNetworkStatus??!0,retryableStatusCodes:e.retryableStatusCodes??a.DEFAULT_RETRYABLE_STATUS_CODES,nonRetryableStatusCodes:e.nonRetryableStatusCodes??a.DEFAULT_NON_RETRYABLE_STATUS_CODES,customDecision:e.customDecision}}shouldRetry(t,a){if(a>=this.config?.maxRetries)return{shouldRetry:!1,delay:0,strategy:e.NONE,reason:`已达到最大重试次数 ${this.config?.maxRetries}`};if(this.config?.customDecision){const e=this.config?.customDecision(t,a);if(e)return e}if(this.config?.checkNetworkStatus&&this.isOffline())return{shouldRetry:!1,delay:0,strategy:e.NONE,reason:"当前网络离线"};const s=t.response?.status;return s?this.config?.nonRetryableStatusCodes.includes(s)?{shouldRetry:!1,delay:0,strategy:e.NONE,reason:`状态码 ${s} 不可重试（客户端错误）`}:this.config?.retryableStatusCodes.includes(s)?this.createRetryDecision(!0,a,this.getStrategyForStatusCode(s),`状态码 ${s} 可重试`):s>=500&&s<600?this.createRetryDecision(!0,a,e.EXPONENTIAL,`服务器错误 ${s}，使用指数退避重试`):{shouldRetry:!1,delay:0,strategy:e.NONE,reason:`状态码 ${s} 不在重试范围内`}:this.createRetryDecision(!0,a,e.EXPONENTIAL,"网络错误，使用指数退避重试")}createRetryDecision(e,t,a,s){return{shouldRetry:e,delay:this.calculateDelay(t,a),strategy:a,reason:s}}getStrategyForStatusCode(t){switch(t){case 429:default:return e.EXPONENTIAL;case 503:return e.LINEAR;case 504:return e.FIXED}}calculateDelay(t,a){let s;switch(a){case e.IMMEDIATE:s=0;break;case e.EXPONENTIAL:s=this.config?.baseDelay*2**t;break;case e.LINEAR:s=this.config?.baseDelay*t;break;case e.FIXED:s=this.config?.baseDelay;break;default:s=0}return s=this.addJitter(s),Math.min(s,this.config?.maxDelay)}addJitter(e){const t=.25*e;return e+(Math.random()*t*2-t)}isOffline(){return typeof navigator<"u"&&"onLine"in navigator&&!navigator.onLine}getRetryAdvice(e){const t=e.response?.status;return t?429===t?"请求过于频繁，请稍后再试":t>=500?"服务器暂时不可用，请稍后重试":t>=400&&t<500?"请求参数有误，请检查后重试":"请求失败，请重试":"网络连接失败，请检查网络设置后重试"}}function s(e){return new a(e)}a.DEFAULT_RETRYABLE_STATUS_CODES=[408,429,500,502,503,504],a.DEFAULT_NON_RETRYABLE_STATUS_CODES=[400,401,403,404,405,422];const r=new a;function n(e){const t=new a(e),s=new Map;return{onRejected:async e=>{const a=`${e.config?.method}:${e.config?.url}`,r=s.get(a)??0,n=t.shouldRetry(e,r);throw n.shouldRetry?(s.set(a,r+1),await new Promise(e=>setTimeout(e,n.delay)),e):(s.delete(a),e)}}}export{e as RetryStrategy,a as SmartRetryManager,n as createSmartRetryInterceptor,s as createSmartRetryManager,r as globalSmartRetryManager};
//# sourceMappingURL=smartRetry.js.map

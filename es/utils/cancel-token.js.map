{"version":3,"file":"cancel-token.js","sources":["../../src/utils/cancel-token.ts"],"sourcesContent":["/**\r\n * 取消令牌模块\r\n * \r\n * 提供请求取消令牌的实现\r\n */\r\n\r\nimport type { RequestConfig } from '../types'\r\nimport { ErrorHandler } from './error'\r\n\r\n/**\r\n * 取消令牌接口\r\n */\r\nexport interface CancelToken {\r\n  /** 取消原因 */\r\n  reason?: string\r\n  /** 是否已取消 */\r\n  isCancelled: boolean\r\n  /** 取消回调 */\r\n  promise: Promise<string>\r\n  /** 抛出取消错误 */\r\n  throwIfRequested: () => void\r\n}\r\n\r\n/**\r\n * 取消令牌实现\r\n */\r\nexport class CancelTokenImpl implements CancelToken {\r\n  public isCancelled = false\r\n  public reason?: string\r\n  public promise: Promise<string>\r\n\r\n  private resolvePromise!: (reason: string) => void\r\n\r\n  constructor() {\r\n    this.promise = new Promise<string>((resolve) => {\r\n      this.resolvePromise = resolve\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 取消请求\r\n   */\r\n  cancel(reason = 'Request cancelled'): void {\r\n    if (this.isCancelled) {\r\n      return\r\n    }\r\n\r\n    this.isCancelled = true\r\n    this.reason = reason\r\n    this.resolvePromise(reason)\r\n  }\r\n\r\n  /**\r\n   * 如果已取消则抛出错误\r\n   */\r\n  throwIfRequested(): void {\r\n    if (this.isCancelled) {\r\n      throw ErrorHandler.createCancelError({} as RequestConfig)\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 取消令牌源\r\n */\r\nexport class CancelTokenSource {\r\n  public token: CancelToken\r\n\r\n  constructor() {\r\n    this.token = new CancelTokenImpl()\r\n  }\r\n\r\n  /**\r\n   * 取消请求\r\n   */\r\n  cancel(reason?: string): void {\r\n    ;(this.token as CancelTokenImpl).cancel(reason)\r\n  }\r\n\r\n  /**\r\n   * 创建新的取消令牌源\r\n   */\r\n  static create(): CancelTokenSource {\r\n    return new CancelTokenSource()\r\n  }\r\n}\r\n\r\n/**\r\n * 超时取消令牌\r\n */\r\nexport class TimeoutCancelToken extends CancelTokenImpl {\r\n  private timeoutId?: NodeJS.Timeout\r\n\r\n  constructor(timeout: number, reason = `Timeout exceeded: ${timeout}ms`) {\r\n    super()\r\n    \r\n    this.timeoutId = setTimeout(() => {\r\n      this.cancel(reason)\r\n    }, timeout)\r\n  }\r\n\r\n  /**\r\n   * 取消请求\r\n   */\r\n  cancel(reason = 'Request cancelled'): void {\r\n    if (this.timeoutId) {\r\n      clearTimeout(this.timeoutId)\r\n      this.timeoutId = undefined\r\n    }\r\n    super.cancel(reason)\r\n  }\r\n\r\n  /**\r\n   * 重置超时\r\n   */\r\n  reset(timeout: number): void {\r\n    if (this.timeoutId) {\r\n      clearTimeout(this.timeoutId)\r\n    }\r\n    \r\n    if (!this.isCancelled) {\r\n      this.timeoutId = setTimeout(() => {\r\n        this.cancel(`Timeout exceeded: ${timeout}ms`)\r\n      }, timeout)\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 组合取消令牌\r\n */\r\nexport class CombinedCancelToken implements CancelToken {\r\n  public isCancelled = false\r\n  public reason?: string\r\n  public promise: Promise<string>\r\n\r\n  private resolvePromise!: (reason: string) => void\r\n  private tokens: CancelToken[]\r\n\r\n  constructor(...tokens: CancelToken[]) {\r\n    this.tokens = tokens\r\n    \r\n    this.promise = new Promise<string>((resolve) => {\r\n      this.resolvePromise = resolve\r\n    })\r\n\r\n    // 监听所有令牌\r\n    this.setupListeners()\r\n  }\r\n\r\n  private setupListeners(): void {\r\n    this.tokens.forEach(token => {\r\n      if (token.isCancelled) {\r\n        this.handleTokenCancel(token.reason || 'Request cancelled')\r\n        return\r\n      }\r\n\r\n      token.promise.then(reason => {\r\n        this.handleTokenCancel(reason)\r\n      }).catch(() => {\r\n        // 忽略错误\r\n      })\r\n    })\r\n  }\r\n\r\n  private handleTokenCancel(reason: string): void {\r\n    if (this.isCancelled) {\r\n      return\r\n    }\r\n\r\n    this.isCancelled = true\r\n    this.reason = reason\r\n    this.resolvePromise(reason)\r\n  }\r\n\r\n  throwIfRequested(): void {\r\n    if (this.isCancelled) {\r\n      throw ErrorHandler.createCancelError({} as RequestConfig)\r\n    }\r\n    \r\n    // 检查所有子令牌\r\n    this.tokens.forEach(token => {\r\n      if (token.isCancelled) {\r\n        this.handleTokenCancel(token.reason || 'Request cancelled')\r\n        this.throwIfRequested()\r\n      }\r\n    })\r\n  }\r\n}\r\n\r\n/**\r\n * 取消令牌工厂\r\n */\r\nexport class CancelTokenFactory {\r\n  /**\r\n   * 创建基础取消令牌\r\n   */\r\n  static create(): CancelTokenSource {\r\n    return new CancelTokenSource()\r\n  }\r\n\r\n  /**\r\n   * 创建超时取消令牌\r\n   */\r\n  static createWithTimeout(timeout: number, reason?: string): TimeoutCancelToken {\r\n    return new TimeoutCancelToken(timeout, reason)\r\n  }\r\n\r\n  /**\r\n   * 组合多个取消令牌\r\n   */\r\n  static combine(...tokens: CancelToken[]): CombinedCancelToken {\r\n    return new CombinedCancelToken(...tokens)\r\n  }\r\n\r\n  /**\r\n   * 从 AbortSignal 创建取消令牌\r\n   */\r\n  static fromAbortSignal(signal: AbortSignal): CancelToken {\r\n    const token = new CancelTokenImpl()\r\n\r\n    if (signal.aborted) {\r\n      token.cancel(signal.reason as string || 'Aborted')\r\n    } else {\r\n      signal.addEventListener('abort', () => {\r\n        token.cancel(signal.reason as string || 'Aborted')\r\n      }, { once: true })\r\n    }\r\n\r\n    return token\r\n  }\r\n\r\n  /**\r\n   * 创建永不取消的令牌\r\n   */\r\n  static never(): CancelToken {\r\n    return {\r\n      isCancelled: false,\r\n      reason: undefined,\r\n      promise: new Promise(() => {}), // 永不resolve\r\n      throwIfRequested: () => {},\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 创建取消令牌源\r\n */\r\nexport function createCancelTokenSource(): CancelTokenSource {\r\n  return CancelTokenSource.create()\r\n}\r\n\r\n/**\r\n * 创建超时取消令牌\r\n */\r\nexport function createTimeoutToken(timeout: number, reason?: string): TimeoutCancelToken {\r\n  return new TimeoutCancelToken(timeout, reason)\r\n}\r\n\r\n/**\r\n * 组合多个取消令牌\r\n */\r\nexport function combineCancelTokens(...tokens: CancelToken[]): CombinedCancelToken {\r\n  return new CombinedCancelToken(...tokens)\r\n}"],"names":["CancelTokenImpl","constructor","this","isCancelled","promise","Promise","resolve","resolvePromise","cancel","reason","throwIfRequested","ErrorHandler","createCancelError","CancelTokenSource","token","create","TimeoutCancelToken","timeout","super","timeoutId","setTimeout","clearTimeout","reset","CombinedCancelToken","tokens","setupListeners","forEach","handleTokenCancel","then","catch","CancelTokenFactory","createWithTimeout","combine","fromAbortSignal","signal","aborted","addEventListener","once","never","createCancelTokenSource","createTimeoutToken","combineCancelTokens","a","r","n","c","i","u","l","h"],"mappings":"gDA0BaA,EAOX,WAAAC,GANOC,KAAAC,aAAc,EAOnBD,KAAKE,QAAU,IAAIC,QAAiBC,IAClCJ,KAAKK,eAAiBD,GAE1B,CAKA,MAAAE,CAAOC,EAAS,qBACVP,KAAKC,cAITD,KAAKC,aAAc,EACnBD,KAAKO,OAASA,EACdP,KAAKK,eAAeE,GACtB,CAKA,gBAAAC,GACE,GAAIR,KAAKC,YACP,MAAMQ,EAAaC,kBAAkB,CAAA,EAEzC,QAMWC,EAGX,WAAAZ,GACEC,KAAKY,MAAQ,IAAId,CACnB,CAKA,MAAAQ,CAAOC,GACHP,KAAKY,MAA0BN,OAAOC,EAC1C,CAKA,aAAOM,GACL,OAAO,IAAIF,CACb,EAMI,MAAOG,UAA2BhB,EAGtC,WAAAC,CAAYgB,EAAiBR,EAAS,qBAAqBQ,OACzDC,QAEAhB,KAAKiB,UAAYC,WAAW,KAC1BlB,KAAKM,OAAOC,IACXQ,EACL,CAKA,MAAAT,CAAOC,EAAS,qBACVP,KAAKiB,YACPE,aAAanB,KAAKiB,WAClBjB,KAAKiB,eAAY,GAEnBD,MAAMV,OAAOC,EACf,CAKA,KAAAa,CAAML,GACAf,KAAKiB,WACPE,aAAanB,KAAKiB,WAGfjB,KAAKC,cACRD,KAAKiB,UAAYC,WAAW,KAC1BlB,KAAKM,OAAO,qBAAqBS,QAChCA,GAEP,QAMWM,EAQX,WAAAtB,IAAeuB,GAPRtB,KAAAC,aAAc,EAQnBD,KAAKsB,OAASA,EAEdtB,KAAKE,QAAU,IAAIC,QAAiBC,IAClCJ,KAAKK,eAAiBD,IAIxBJ,KAAKuB,gBACP,CAEQ,cAAAA,GACNvB,KAAKsB,OAAOE,QAAQZ,IACdA,EAAMX,YACRD,KAAKyB,kBAAkBb,EAAML,QAAU,qBAIzCK,EAAMV,QAAQwB,KAAKnB,IACjBP,KAAKyB,kBAAkBlB,KACtBoB,MAAM,SAIb,CAEQ,iBAAAF,CAAkBlB,GACpBP,KAAKC,cAITD,KAAKC,aAAc,EACnBD,KAAKO,OAASA,EACdP,KAAKK,eAAeE,GACtB,CAEA,gBAAAC,GACE,GAAIR,KAAKC,YACP,MAAMQ,EAAaC,kBAAkB,CAAA,GAIvCV,KAAKsB,OAAOE,QAAQZ,IACdA,EAAMX,cACRD,KAAKyB,kBAAkBb,EAAML,QAAU,qBACvCP,KAAKQ,qBAGX,QAMWoB,EAIX,aAAOf,GACL,OAAO,IAAIF,CACb,CAKA,wBAAOkB,CAAkBd,EAAiBR,GACxC,OAAO,IAAIO,EAAmBC,EAASR,EACzC,CAKA,cAAOuB,IAAWR,GAChB,OAAO,IAAID,KAAuBC,EACpC,CAKA,sBAAOS,CAAgBC,GACrB,MAAMpB,EAAQ,IAAId,EAElB,OAAIkC,EAAOC,QACTrB,EAAMN,OAAO0B,EAAOzB,QAAoB,WAExCyB,EAAOE,iBAAiB,QAAS,KAC/BtB,EAAMN,OAAO0B,EAAOzB,QAAoB,YACvC,CAAE4B,MAAM,IAGNvB,CACT,CAKA,YAAOwB,GACL,MAAO,CACLnC,aAAa,EACbM,YAAQ,EACRL,QAAS,IAAIC,QAAQ,QACrBK,iBAAkB,OAEtB,WAMc6B,IACd,OAAO1B,EAAkBE,QAC3B,CAKM,SAAUyB,EAAmBvB,EAAiBR,GAClD,OAAO,IAAIO,EAAmBC,EAASR,EACzC,CAKM,SAAUgC,KAAuBjB,GACrC,OAAO,IAAID,KAAuBC,EACpC,QAAAkB,wBAAAC,qBAAAC,uBAAAC,yBAAAC,wBAAAC,yBAAAC,6BAAAC"}
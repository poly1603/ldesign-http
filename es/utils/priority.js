var t,e;(e=t||(t={}))[e.CRITICAL=0]="CRITICAL",e[e.HIGH=1]="HIGH",e[e.NORMAL=2]="NORMAL",e[e.LOW=3]="LOW",e[e.IDLE=4]="IDLE";class s{constructor(e={}){this.queue=new Map,this.active=new Set,this.stats={totalQueued:0,totalProcessed:0,totalFailed:0,waitTimes:[],processTimes:[]},this.processing=!1,this.lastBoostCheck=0,this.cachedQueueSize=0,this.queueSizeDirty=!0,this.config={maxConcurrent:6,maxQueueSize:100,queueTimeout:3e4,priorityBoost:!0,boostInterval:5e3,...e};for(const e of Object.values(t))"number"==typeof e&&this.queue.set(e,[]);this.config?.priorityBoost&&this.startPriorityBoost()}async enqueue(e,s,i=t.NORMAL){return new Promise((t,o)=>{if(this.getTotalQueueSize()>=this.config?.maxQueueSize)return void o(new Error("Queue is full"));const r={id:this.generateId(),priority:i,config:e,executor:s,resolve:t,reject:o,timestamp:Date.now(),abortController:new AbortController},n=this.queue.get(i);n&&(n.push(r),this.stats.totalQueued++,this.queueSizeDirty=!0),this.config?.queueTimeout>0&&setTimeout(()=>{this.removeItem(r)&&(r.reject(new Error("Request timeout in queue")),this.stats.totalFailed++)},this.config?.queueTimeout),this.processQueue()})}async processQueue(){if(!this.processing){for(this.processing=!0;this.active.size<this.config?.maxConcurrent;){const t=this.getNextItem();if(!t)break;this.active.add(t.id),this.executeItem(t)}this.processing=!1}}async executeItem(t){const e=Date.now()-t.timestamp;this.stats.waitTimes.push(e);const s=Date.now();try{const e=await t.executor();t.resolve(e),this.stats.totalProcessed++;const i=Date.now()-s;this.stats.processTimes.push(i)}catch(e){t.reject(e),this.stats.totalFailed++}finally{this.active.delete(t.id),this.processQueue()}}getNextItem(){for(const e of[t.CRITICAL,t.HIGH,t.NORMAL,t.LOW,t.IDLE]){const t=this.queue.get(e);if(t&&t.length>0)return t.shift()}}removeItem(t){const e=this.queue.get(t.priority);if(!e)return!1;const s=e.findIndex(e=>e.id===t.id);return-1!==s&&(e.splice(s,1),!0)}startPriorityBoost(){this.boostTimer=setInterval(()=>{if(0===this.getTotalQueueSize())return;const t=Date.now();t-this.lastBoostCheck<this.config?.boostInterval/2||(this.lastBoostCheck=t,this.performPriorityBoost(t))},2e3)}performPriorityBoost(e){const s=[];for(const[i,o]of this.queue.entries()){if(i===t.CRITICAL||0===o.length)continue;const r=this.config?.boostInterval;for(let n=0;n<o.length;n++){const u=o[n];if(e-u.timestamp>r){const e=Math.max(t.CRITICAL,i-1);s.push({item:u,from:i,to:e})}}}for(const t of s){const e=this.queue.get(t.from);if(e){const s=e.indexOf(t.item);-1!==s&&(e.splice(s,1),this.queueSizeDirty=!0)}t.item.priority=t.to;const s=this.queue.get(t.to);s&&s.push(t.item)}}cancel(t){for(const[,e]of this.queue.entries()){const s=e.findIndex(e=>e.id===t);if(-1!==s){const t=e[s];return e.splice(s,1),t.reject(new Error("Request cancelled")),t.abortController?.abort(),!0}}return this.active.has(t),!1}cancelAll(t="All requests cancelled"){for(const[,e]of this.queue.entries()){for(const s of e)s.reject(new Error(t)),s.abortController?.abort();e.length=0}}getStats(){const t={};for(const[e,s]of this.queue.entries())t[e]=s.length;const e=this.stats.waitTimes.length>0?this.stats.waitTimes.reduce((t,e)=>t+e,0)/this.stats.waitTimes.length:0,s=this.stats.processTimes.length>0?this.stats.processTimes.reduce((t,e)=>t+e,0)/this.stats.processTimes.length:0;return{totalQueued:this.stats.totalQueued,totalProcessed:this.stats.totalProcessed,totalFailed:this.stats.totalFailed,currentActive:this.active.size,queuedByPriority:t,averageWaitTime:e,averageProcessTime:s}}getTotalQueueSize(){if(!this.queueSizeDirty)return this.cachedQueueSize;let t=0;for(const[,e]of this.queue.entries())t+=e.length;return this.cachedQueueSize=t,this.queueSizeDirty=!1,t}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}destroy(){this.boostTimer&&clearInterval(this.boostTimer),this.cancelAll("Queue destroyed"),this.queue.clear(),this.active.clear()}}function i(t){return new s(t)}function o(e){if(void 0!==e.priority)return e.priority;const s=e.url||"";return s.includes("/auth")||s.includes("/login")||s.includes("/token")?t.CRITICAL:s.includes("/api")?t.HIGH:s.match(/\.(jpg|jpeg|png|gif|css|js)$/i)?t.LOW:s.includes("/analytics")||s.includes("/log")?t.IDLE:t.NORMAL}export{t as Priority,s as PriorityQueue,i as createPriorityQueue,o as determinePriority};
//# sourceMappingURL=priority.js.map

{"version":3,"file":"transformer.js","sources":["../../src/utils/transformer.ts"],"sourcesContent":["/**\r\n * 自动数据转换器\r\n *\r\n * 自动转换响应数据中的特殊类型（日期、大数字、枚举等）\r\n */\r\n\r\n/**\r\n * 转换器配置\r\n */\r\nexport interface TransformerConfig {\r\n /** 是否转换日期字符串为Date对象 */\r\n transformDates?: boolean\r\n /** 是否转换大数字字符串为BigInt */\r\n transformBigInt?: boolean\r\n /** 是否转换null为undefined */\r\n nullToUndefined?: boolean\r\n /** 是否转换空字符串为null */\r\n emptyStringToNull?: boolean\r\n /** 日期字段的正则匹配 */\r\n datePattern?: RegExp\r\n /** 自定义转换函数 */\r\n customTransformers?: Array<(key: string, value: any) => any>\r\n}\r\n\r\n/**\r\n * 数据转换器\r\n *\r\n * @example\r\n * ```typescript\r\n * const transformer = new DataTransformer({\r\n *  transformDates: true,\r\n *  transformBigInt: true,\r\n * })\r\n *\r\n * const data = {\r\n *  createdAt: '2024-01-01T00:00:00Z',\r\n *  count: '9007199254740991',\r\n * }\r\n *\r\n * const transformed = transformer.transform(data)\r\n * // {\r\n * //  createdAt: Date 对象,\r\n * //  count: BigInt\r\n * // }\r\n * ```\r\n */\r\nexport class DataTransformer {\r\n private config: Required<Omit<TransformerConfig, 'customTransformers'>> & { customTransformers: TransformerConfig['customTransformers'] }\r\n\r\n // ISO 8601日期格式正则\r\n private static readonly ISO_DATE_REGEX = /^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{3})?Z?$/\r\n\r\n // 常见日期字段名\r\n private static readonly DATE_FIELD_NAMES = [\r\n  'date',\r\n  'time',\r\n  'createdAt',\r\n  'updatedAt',\r\n  'deletedAt',\r\n  'publishedAt',\r\n  'timestamp',\r\n  'startTime',\r\n  'endTime',\r\n ]\r\n\r\n constructor(config: TransformerConfig = {}) {\r\n  this.config = {\r\n   transformDates: config.transformDates ?? true,\r\n   transformBigInt: config.transformBigInt ?? false,\r\n   nullToUndefined: config.nullToUndefined ?? false,\r\n   emptyStringToNull: config.emptyStringToNull ?? false,\r\n   datePattern: config.datePattern ?? DataTransformer.ISO_DATE_REGEX,\r\n   customTransformers: config.customTransformers ?? [],\r\n  }\r\n }\r\n\r\n /**\r\n  * 转换数据\r\n  */\r\n transform<T = any>(data: any): T {\r\n  return this.transformValue('root', data) as T\r\n }\r\n\r\n /**\r\n  * 转换单个值\r\n  */\r\n private transformValue(key: string, value: any): any {\r\n  // 应用自定义转换器\r\n  for (const customTransformer of this.config?.customTransformers || []) {\r\n   const result = customTransformer(key, value)\r\n   if (result !== undefined) {\r\n    return result\r\n   }\r\n  }\r\n\r\n  // null处理\r\n  if (value === null) {\r\n   return this.config?.nullToUndefined ? undefined : null\r\n  }\r\n\r\n  // undefined直接返回\r\n  if (value === undefined) {\r\n   return undefined\r\n  }\r\n\r\n  // 字符串处理\r\n  if (typeof value === 'string') {\r\n   return this.transformString(key, value)\r\n  }\r\n\r\n  // 数组处理\r\n  if (Array.isArray(value)) {\r\n   return value.map((item, index) => this.transformValue(`${key}[${index}]`, item))\r\n  }\r\n\r\n  // 对象处理\r\n  if (typeof value === 'object' && value !== null) {\r\n   return this.transformObject(value)\r\n  }\r\n\r\n  // 其他类型直接返回\r\n  return value\r\n }\r\n\r\n /**\r\n  * 转换字符串\r\n  */\r\n private transformString(key: string, value: string): any {\r\n  // 空字符串处理\r\n  if (value === '' && this.config?.emptyStringToNull) {\r\n   return null\r\n  }\r\n\r\n  // 日期转换\r\n  if (this.config?.transformDates && this.isDateField(key, value)) {\r\n   const date = new Date(value)\r\n   if (!Number.isNaN(date.getTime())) {\r\n    return date\r\n   }\r\n  }\r\n\r\n  // 大数字转换\r\n  if (this.config?.transformBigInt && this.isBigIntString(value)) {\r\n   try {\r\n    return BigInt(value)\r\n   }\r\n   catch {\r\n    // 转换失败，返回原值\r\n   }\r\n  }\r\n\r\n  return value\r\n }\r\n\r\n /**\r\n  * 转换对象\r\n  */\r\n private transformObject(obj: Record<string, any>): Record<string, any> {\r\n  const result: Record<string, any> = {}\r\n\r\n  for (const [key, value] of Object.entries(obj)) {\r\n   result[key] = this.transformValue(key, value)\r\n  }\r\n\r\n  return result\r\n }\r\n\r\n /**\r\n  * 判断是否为日期字段\r\n  */\r\n private isDateField(key: string, value: string): boolean {\r\n  // 检查字段名是否包含日期相关关键词\r\n  const lowerKey = key.toLowerCase()\r\n  const isDateFieldName = DataTransformer.DATE_FIELD_NAMES.some(name =>\r\n   lowerKey.includes(name.toLowerCase()),\r\n  )\r\n\r\n  // 检查值是否匹配日期格式\r\n  const matchesDatePattern = this.config?.datePattern.test(value)\r\n\r\n  return isDateFieldName || matchesDatePattern\r\n }\r\n\r\n /**\r\n  * 判断是否为大数字字符串\r\n  */\r\n private isBigIntString(value: string): boolean {\r\n  // 只包含数字\r\n  if (!/^\\d+$/.test(value)) {\r\n   return false\r\n  }\r\n\r\n  // 超过JavaScript安全整数范围\r\n  const num = Number(value)\r\n  return num > Number.MAX_SAFE_INTEGER || num < Number.MIN_SAFE_INTEGER\r\n }\r\n\r\n /**\r\n  * 反向转换（用于请求数据）\r\n  */\r\n serialize<T = any>(data: any): T {\r\n  return this.serializeValue(data) as T\r\n }\r\n\r\n /**\r\n  * 序列化值\r\n  */\r\n private serializeValue(value: any): any {\r\n  // Date转ISO字符串\r\n  if (value instanceof Date) {\r\n   return value.toISOString()\r\n  }\r\n\r\n  // BigInt转字符串\r\n  if (typeof value === 'bigint') {\r\n   return value.toString()\r\n  }\r\n\r\n  // 数组\r\n  if (Array.isArray(value)) {\r\n   return value.map(item => this.serializeValue(item))\r\n  }\r\n\r\n  // 对象\r\n  if (typeof value === 'object' && value !== null) {\r\n   const result: Record<string, any> = {}\r\n   for (const [key, val] of Object.entries(value)) {\r\n    result[key] = this.serializeValue(val)\r\n   }\r\n   return result\r\n  }\r\n\r\n  return value\r\n }\r\n}\r\n\r\n/**\r\n * 创建数据转换器\r\n */\r\nexport function createDataTransformer(config?: TransformerConfig): DataTransformer {\r\n return new DataTransformer(config)\r\n}\r\n\r\n/**\r\n * 全局数据转换器\r\n */\r\nexport const globalDataTransformer = new DataTransformer()\r\n\r\n/**\r\n * 数据转换拦截器\r\n *\r\n * 自动转换响应数据和请求数据\r\n */\r\nexport function createDataTransformInterceptor(config?: TransformerConfig) {\r\n const transformer = new DataTransformer(config)\r\n\r\n return {\r\n  // 请求拦截器 - 序列化数据\r\n  request: {\r\n   onFulfilled: (requestConfig: any) => {\r\n    if (requestConfig.data) {\r\n     requestConfig.data = transformer.serialize(requestConfig.data)\r\n    }\r\n    return requestConfig\r\n   },\r\n  },\r\n\r\n  // 响应拦截器 - 转换数据\r\n  response: {\r\n   onFulfilled: (response: any) => {\r\n    if (response.data) {\r\n     response.data = transformer.transform(response.data)\r\n    }\r\n    return response\r\n   },\r\n  },\r\n }\r\n}\r\n\r\n/**\r\n * 便捷转换函数\r\n */\r\n\r\n/**\r\n * 将日期字符串转换为Date对象\r\n */\r\nexport function transformDates<T = any>(data: any): T {\r\n const transformer = new DataTransformer({\r\n  transformDates: true,\r\n  transformBigInt: false,\r\n })\r\n return transformer.transform(data)\r\n}\r\n\r\n/**\r\n * 将大数字字符串转换为BigInt\r\n */\r\nexport function transformBigInts<T = any>(data: any): T {\r\n const transformer = new DataTransformer({\r\n  transformDates: false,\r\n  transformBigInt: true,\r\n })\r\n return transformer.transform(data)\r\n}\r\n\r\n/**\r\n * 将null转换为undefined\r\n */\r\nexport function nullToUndefined<T = any>(data: any): T {\r\n const transformer = new DataTransformer({\r\n  transformDates: false,\r\n  nullToUndefined: true,\r\n })\r\n return transformer.transform(data)\r\n}\r\n"],"names":["DataTransformer","constructor","config","this","transformDates","transformBigInt","nullToUndefined","emptyStringToNull","datePattern","ISO_DATE_REGEX","customTransformers","transform","data","transformValue","key","value","customTransformer","result","transformString","Array","isArray","map","item","index","transformObject","isDateField","date","Date","Number","isNaN","getTime","isBigIntString","BigInt","obj","Object","entries","lowerKey","toLowerCase","isDateFieldName","DATE_FIELD_NAMES","some","name","includes","matchesDatePattern","test","num","MAX_SAFE_INTEGER","MIN_SAFE_INTEGER","serialize","serializeValue","toISOString","toString","val","createDataTransformer","globalDataTransformer","createDataTransformInterceptor","transformer","request","onFulfilled","requestConfig","response","transformBigInts","n","l","f","u","d","c","m"],"mappings":"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"}
import{ErrorHandler as e}from"./error.js";class t{constructor(){this.isCancelled=!1,this.promise=new Promise(e=>{this.resolvePromise=e})}cancel(e="Request cancelled"){this.isCancelled||(this.isCancelled=!0,this.reason=e,this.resolvePromise(e))}throwIfRequested(){if(this.isCancelled)throw e.createCancelError({})}}class a{constructor(){this.token=new t}cancel(e){this.token.cancel(e)}}class s{constructor(){this.requests=new Map,this.cancelTokens=new Map}static source(){return new a}register(e,t,a){this.requests.set(e,t),a&&(this.cancelTokens.set(e,a),a.promise.then(()=>{this.cancel(e)}).catch(()=>{}))}cancel(e,t="Request cancelled"){const a=this.requests.get(e);a&&(a.abort(),this.requests.delete(e));const s=this.cancelTokens.get(e);s&&!s.isCancelled&&(s.cancel(t),this.cancelTokens.delete(e))}cancelAll(e="All requests cancelled"){this.requests.forEach((e,t)=>{e.abort()}),this.requests.clear(),this.cancelTokens.forEach((t,a)=>{t.isCancelled||t.cancel(e)}),this.cancelTokens.clear()}cleanup(e){this.requests.delete(e),this.cancelTokens.delete(e)}getActiveRequestCount(){return this.requests.size}isCancelled(e){const t=this.cancelTokens.get(e);return!!t&&t.isCancelled}createMergedSignal(e){const t=e.filter(e=>void 0!==e);if(0===t.length)return(new AbortController).signal;if(1===t.length)return t[0];const a=new AbortController,s=()=>{a.abort()};return t.forEach(e=>{e.aborted?a.abort():e.addEventListener("abort",s,{once:!0})}),a.signal}}class n extends s{constructor(e={}){super(),this.metadata=new Map,this.config={defaultTimeout:e.defaultTimeout||3e4,autoCleanup:!1!==e.autoCleanup,cleanupInterval:e.cleanupInterval||6e4},this.config?.autoCleanup&&this.startAutoCleanup()}createWithTags(e,t=[],a){const s=r();this.metadata.set(e,{source:s,tags:new Set(t),createdAt:Date.now(),config:a});const n=new AbortController;return this.register(e,n,s.token),s}cancelBatch(e,t){let a=0;for(const s of e)this.metadata.has(s)&&(this.cancel(s,t||"Batch cancelled"),a++);return a}cancelByTag(e,t){const a=this.getRequestIdsByTag(e);return this.cancelBatch(a,t||`Cancelled by tag: ${e}`)}cancelByTags(e,t){const a=new Set;return e.forEach(e=>{this.getRequestIdsByTag(e).forEach(e=>a.add(e))}),this.cancelBatch(Array.from(a),t)}cancelTimeout(e,t){const a=Date.now(),s=[];return this.metadata.forEach((t,n)=>{a-t.createdAt>e&&s.push(n)}),this.cancelBatch(s,t||`Timeout exceeded: ${e}ms`)}cancelWhere(e,t){const a=[];return this.metadata.forEach((t,s)=>{e(t,s)&&a.push(s)}),this.cancelBatch(a,t)}getRequestIdsByTag(e){const t=[];return this.metadata.forEach((a,s)=>{a.tags.has(e)&&t.push(s)}),t}getRequestCountByTag(){const e=new Map;return this.metadata.forEach(t=>{t.tags.forEach(t=>{e.set(t,(e.get(t)||0)+1)})}),e}getActiveRequests(){const e=Date.now(),t=[];return this.metadata.forEach((a,s)=>{t.push({id:s,tags:Array.from(a.tags),age:e-a.createdAt,url:a.config?.url})}),t}getStats(){const e=Date.now();let t=0,a=0;const s=this.getRequestCountByTag();return this.metadata.forEach(s=>{const n=e-s.createdAt;t+=n,a=Math.max(a,n)}),{active:this.metadata.size,byTag:Object.fromEntries(s),averageAge:this.metadata.size>0?t/this.metadata.size:0,oldestAge:a,oldestRequest:this.getOldestRequest()}}getOldestRequest(){if(0===this.metadata.size)return null;const e=Date.now();let t,a="",s=0;return this.metadata.forEach((n,c)=>{const r=e-n.createdAt;r>s&&(s=r,a=c,t=n.config?.url)}),{id:a,age:s,url:t}}has(e){return this.metadata.has(e)}getTags(e){const t=this.metadata.get(e);return t?Array.from(t.tags):[]}addTags(e,...t){const a=this.metadata.get(e);return!!a&&(t.forEach(e=>a.tags.add(e)),!0)}removeTags(e,...t){const a=this.metadata.get(e);return!!a&&(t.forEach(e=>a.tags.delete(e)),!0)}cleanup(e){super.cleanup(e),this.metadata.delete(e)}cleanupAll(){const e=[];this.metadata.forEach((t,a)=>{this.isCancelled(a)&&e.push(a)}),e.forEach(e=>this.cleanup(e))}startAutoCleanup(){this.cleanupTimer=setInterval(()=>{this.cleanupAll()},this.config?.cleanupInterval)}stopAutoCleanup(){this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=void 0)}updateConfig(e){const t=this.config?.autoCleanup;this.config={...this.config,...e},t&&!this.config?.autoCleanup?this.stopAutoCleanup():!t&&this.config?.autoCleanup&&this.startAutoCleanup()}destroy(){this.stopAutoCleanup(),this.cancelAll("Manager destroyed"),this.metadata.clear()}}const c=new n;function r(){return s.source()}function o(e){return new n(e)}function l(e){return e&&(e.isCancelError||"AbortError"===e.name||"CANCELED"===e.code||e.message?.includes("cancelled")||e.message?.includes("aborted"))}function i(e){const t=r();return setTimeout(()=>{t.cancel(`Request timeout after ${e}ms`)},e),t}export{s as CancelManager,t as CancelTokenImpl,a as CancelTokenSource,n as EnhancedCancelManager,r as createCancelTokenSource,o as createEnhancedCancelManager,i as createTimeoutCancelToken,c as globalCancelManager,l as isCancelError};
//# sourceMappingURL=cancel.js.map

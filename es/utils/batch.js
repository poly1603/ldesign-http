class t{constructor(t={}){this.pendingBatch=[],this.stats={totalRequests:0,batchCount:0,savedRequests:0,averageBatchSize:0,efficiency:0},this.config={windowMs:t.windowMs??50,maxBatchSize:t.maxBatchSize??10,enabled:t.enabled??!0,endpoint:t.endpoint??"/batch",requestBuilder:t.requestBuilder??this.defaultRequestBuilder.bind(this),responseParser:t.responseParser??this.defaultResponseParser.bind(this)}}async add(t){if(!this.config?.enabled)throw new Error("Batch processing is disabled");return new Promise((e,s)=>{const a={config:t,resolve:e,reject:s,timestamp:Date.now()};this.pendingBatch.push(a),this.stats.totalRequests++,this.pendingBatch.length>=this.config?.maxBatchSize?this.flush():this.scheduleBatch()})}scheduleBatch(){this.batchTimer||(this.batchTimer=setTimeout(()=>{this.flush()},this.config?.windowMs))}async flush(){if(this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=void 0),0===this.pendingBatch.length)return;const t=this.pendingBatch.splice(0,this.config?.maxBatchSize);this.stats.batchCount++,this.stats.savedRequests+=t.length-1,this.updateStats();try{const e=this.config?.requestBuilder(t.map(t=>t.config)),s=await this.executeBatchRequest(e),a=this.config?.responseParser(s);t.forEach((t,e)=>{a[e]?t.resolve(a[e]):t.reject(new Error("No response for request"))})}catch(e){t.forEach(t=>{t.reject(e)})}this.pendingBatch.length>0&&this.scheduleBatch()}async executeBatchRequest(t){throw new Error("Batch request executor not configured. Please set a custom requestBuilder.")}defaultRequestBuilder(t){return{method:"POST",url:this.config?.endpoint,data:{requests:t.map(t=>({method:t.method,url:t.url,headers:t.headers,params:t.params,data:t.data}))}}}defaultResponseParser(t){const e=t.data;if(!e||!Array.isArray(e.responses))throw new Error("Invalid batch response format");return e.responses.map(t=>({data:t.data,status:t.status||200,statusText:t.statusText||"OK",headers:t.headers||{},config:{}}))}updateStats(){this.stats.batchCount>0&&(this.stats.averageBatchSize=this.stats.totalRequests/this.stats.batchCount,this.stats.efficiency=this.stats.totalRequests>0?this.stats.savedRequests/this.stats.totalRequests:0)}getStats(){return{...this.stats}}resetStats(){this.stats={totalRequests:0,batchCount:0,savedRequests:0,averageBatchSize:0,efficiency:0}}getPendingCount(){return this.pendingBatch.length}clear(){this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=void 0),this.pendingBatch.forEach(t=>{t.reject(new Error("Batch cleared"))}),this.pendingBatch=[]}updateConfig(t){Object.assign(this.config,t)}destroy(){this.clear()}}function e(e){return new t(e)}export{t as BatchManager,e as createBatchManager};
//# sourceMappingURL=batch.js.map

import{generateId as e}from"../utils/index.js";import{determinePriority as t}from"../utils/priority.js";class r{constructor(e){this.config=e}async execute(r,i){const c=i?.requestId||e();this.config.monitor.startRequest(c,r);try{const e=t(r);if(void 0!==e&&this.config.priorityQueue)return await this.executeWithPriority(r,c,e,i);const s=await this.executeWithRetry(r,c,i);return this.config.monitor.endRequest(c,r,s),s}catch(e){throw this.config.monitor.endRequest(c,r,void 0,e),e}}async executeWithPriority(e,t,r,i){return this.config.priorityQueue.enqueue(e,async()=>{const r=await this.executeWithRetry(e,t,i);return this.config.monitor.endRequest(t,e,r),r},r)}async executeWithRetry(e,t,r){const i=e.retry;return!r?.skipRetry&&i?.retries&&i.retries>0?this.config.retryManager.executeWithRetry(()=>(this.config.monitor.recordRetry(t),this.executeSingle(e,r)),e):this.executeSingle(e,r)}async executeSingle(e,t){if(!t?.skipCache){const t=await this.config.cacheManager.get(e);if(t)return t}return this.config.concurrencyManager.execute(()=>this.performRequest(e),e)}async performRequest(e){const t=await this.config.adapter.request(e);return await this.config.cacheManager.set(e,t),t}async executeBatch(e,t){const r=[];if(t?.parallel){const t=e.map(e=>this.execute(e).then(e=>({success:!0,data:e})).catch(e=>({success:!1,error:e}))),i=await Promise.all(t);r.push(...i)}else for(const i of e)try{const e=await this.execute(i);r.push({success:!0,data:e})}catch(e){if(r.push({success:!1,error:e}),!t?.continueOnError)break}return r}async executeWithTimeout(e,t){const r=new Promise((e,r)=>{setTimeout(()=>{r(new Error(`Request timeout after ${t}ms`))},t)});return Promise.race([this.execute(e),r])}async executeWithCancellation(e,t){return new Promise((r,i)=>{const c=()=>{i(new Error("Request cancelled"))};t.aborted?c():(t.addEventListener("abort",c,{once:!0}),this.execute({...e,signal:t}).then(r).catch(i).finally(()=>{t.removeEventListener("abort",c)}))})}getStatus(){return{concurrency:this.config.concurrencyManager.getStatus(),cache:{size:this.config.cacheManager.getSize?.()||0,hits:this.config.cacheManager.getStats?.()?.hits||0,misses:this.config.cacheManager.getStats?.()?.misses||0},monitor:this.config.monitor.getMetrics?.()||[]}}cleanup(){this.config.cacheManager.clear(),this.config.concurrencyManager.cancelQueue(),this.config.priorityQueue&&this.config.priorityQueue.clear?.()}}function i(e){return new r(e)}export{r as RequestExecutor,i as createRequestExecutor};
//# sourceMappingURL=request-executor.js.map

{"version":3,"file":"client-monitoring.js","sources":["../src/client-monitoring.ts"],"sourcesContent":["/**\r\n * HTTP 客户端监控模块\r\n * \r\n * 提供性能监控、指标统计和分析功能\r\n */\r\n\r\nimport type { CacheManager } from './utils/cache'\r\nimport type { ConcurrencyManager } from './utils/concurrency'\r\nimport type { RequestMonitor } from './utils/monitor'\r\nimport type { RequestPool } from './utils/pool'\r\nimport type { PriorityQueue } from './utils/priority'\r\n\r\n/**\r\n * 监控指标接口\r\n */\r\nexport interface MonitoringMetrics {\r\n  /** 性能统计 */\r\n  performance: any\r\n  /** 优先级队列统计 */\r\n  priorityQueue?: any\r\n  /** 连接池统计 */\r\n  connectionPool?: any\r\n  /** 并发控制统计 */\r\n  concurrency?: any\r\n  /** 缓存统计 */\r\n  cache?: any\r\n}\r\n\r\n/**\r\n * 监控功能接口\r\n */\r\nexport interface MonitoringOperations {\r\n  /**\r\n   * 获取性能监控统计\r\n   */\r\n  getPerformanceStats: () => any\r\n\r\n  /**\r\n   * 获取最近的请求指标\r\n   */\r\n  getRecentMetrics: (count?: number) => any\r\n\r\n  /**\r\n   * 获取慢请求列表\r\n   */\r\n  getSlowRequests: () => any\r\n\r\n  /**\r\n   * 获取失败请求列表\r\n   */\r\n  getFailedRequests: () => any\r\n\r\n  /**\r\n   * 启用性能监控\r\n   */\r\n  enableMonitoring: () => void\r\n\r\n  /**\r\n   * 禁用性能监控\r\n   */\r\n  disableMonitoring: () => void\r\n\r\n  /**\r\n   * 获取优先级队列统计\r\n   */\r\n  getPriorityQueueStats: () => any\r\n\r\n  /**\r\n   * 获取连接池统计\r\n   */\r\n  getConnectionPoolStats: () => any\r\n\r\n  /**\r\n   * 获取连接池详情\r\n   */\r\n  getConnectionDetails: () => any\r\n\r\n  /**\r\n   * 导出性能指标\r\n   */\r\n  exportMetrics: () => MonitoringMetrics\r\n}\r\n\r\n/**\r\n * 监控处理器\r\n */\r\nexport class MonitoringHandler implements MonitoringOperations {\r\n  constructor(\r\n    private monitor: RequestMonitor,\r\n    private priorityQueue?: PriorityQueue,\r\n    private requestPool?: RequestPool,\r\n    private concurrencyManager?: ConcurrencyManager,\r\n    private cacheManager?: CacheManager,\r\n  ) {}\r\n\r\n  /**\r\n   * 获取性能监控统计\r\n   */\r\n  getPerformanceStats() {\r\n    return this.monitor.getStats()\r\n  }\r\n\r\n  /**\r\n   * 获取最近的请求指标\r\n   */\r\n  getRecentMetrics(count?: number) {\r\n    return this.monitor.getRecentMetrics(count)\r\n  }\r\n\r\n  /**\r\n   * 获取慢请求列表\r\n   */\r\n  getSlowRequests() {\r\n    return this.monitor.getSlowRequests()\r\n  }\r\n\r\n  /**\r\n   * 获取失败请求列表\r\n   */\r\n  getFailedRequests() {\r\n    return this.monitor.getFailedRequests()\r\n  }\r\n\r\n  /**\r\n   * 启用性能监控\r\n   */\r\n  enableMonitoring() {\r\n    this.monitor.enable()\r\n  }\r\n\r\n  /**\r\n   * 禁用性能监控\r\n   */\r\n  disableMonitoring() {\r\n    this.monitor.disable()\r\n  }\r\n\r\n  /**\r\n   * 获取优先级队列统计\r\n   */\r\n  getPriorityQueueStats() {\r\n    return this.priorityQueue?.getStats()\r\n  }\r\n\r\n  /**\r\n   * 获取连接池统计\r\n   */\r\n  getConnectionPoolStats() {\r\n    return this.requestPool?.getStats()\r\n  }\r\n\r\n  /**\r\n   * 获取连接池详情\r\n   */\r\n  getConnectionDetails() {\r\n    return this.requestPool?.getConnectionDetails()\r\n  }\r\n\r\n  /**\r\n   * 导出性能指标\r\n   */\r\n  exportMetrics(): MonitoringMetrics {\r\n    return {\r\n      performance: this.monitor.exportMetrics(),\r\n      priorityQueue: this.priorityQueue?.getStats(),\r\n      connectionPool: this.requestPool?.getStats(),\r\n      concurrency: this.concurrencyManager?.getStatus(),\r\n      cache: this.cacheManager?.getStats ? this.cacheManager.getStats() : null,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 清理监控数据\r\n   */\r\n  clearMetrics(): void {\r\n    this.monitor.clear()\r\n  }\r\n\r\n  /**\r\n   * 设置监控阈值\r\n   */\r\n  setThresholds(thresholds: {\r\n    slowRequestThreshold?: number\r\n    errorRateThreshold?: number\r\n  }): void {\r\n    if (thresholds.slowRequestThreshold !== undefined) {\r\n      this.monitor.setSlowRequestThreshold(thresholds.slowRequestThreshold)\r\n    }\r\n    if (thresholds.errorRateThreshold !== undefined) {\r\n      // 实现错误率阈值设置\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取实时性能指标\r\n   */\r\n  getRealtimeMetrics(): {\r\n    requestsPerSecond: number\r\n    averageResponseTime: number\r\n    errorRate: number\r\n    activeRequests: number\r\n  } {\r\n    const stats = this.monitor.getStats()\r\n    const concurrencyStatus = this.concurrencyManager?.getStatus()\r\n\r\n    return {\r\n      requestsPerSecond: this.calculateRequestsPerSecond(),\r\n      averageResponseTime: stats.averageResponseTime || 0,\r\n      errorRate: stats.errorRate || 0,\r\n      activeRequests: concurrencyStatus?.activeCount || 0,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 计算每秒请求数\r\n   */\r\n  private calculateRequestsPerSecond(): number {\r\n    const recentMetrics = this.monitor.getRecentMetrics(60) // 最近60个请求\r\n    if (!recentMetrics || recentMetrics.length === 0) {\r\n      return 0\r\n    }\r\n\r\n    const now = Date.now()\r\n    const oneMinuteAgo = now - 60000\r\n    const recentRequests = recentMetrics.filter(\r\n      (m: any) => m.timestamp && m.timestamp > oneMinuteAgo\r\n    )\r\n\r\n    if (recentRequests.length === 0) {\r\n      return 0\r\n    }\r\n\r\n    const firstRequest = recentRequests[0]\r\n    if (!firstRequest?.timestamp) {\r\n      return 0\r\n    }\r\n    const timeSpan = (now - firstRequest.timestamp) / 1000\r\n    return recentRequests.length / timeSpan\r\n  }\r\n\r\n  /**\r\n   * 生成性能报告\r\n   */\r\n  generateReport(): {\r\n    summary: any\r\n    details: any\r\n    recommendations: string[]\r\n  } {\r\n    const metrics = this.exportMetrics()\r\n    const stats = this.getPerformanceStats()\r\n\r\n    const recommendations: string[] = []\r\n\r\n    // 分析并生成建议\r\n    const avgResponseTime = stats.averageResponseTime ?? 0\r\n    if (avgResponseTime > 3000) {\r\n      recommendations.push('Average response time is high. Consider implementing caching or optimizing server endpoints.')\r\n    }\r\n\r\n    if (stats.errorRate > 0.05) {\r\n      recommendations.push('Error rate is above 5%. Review error logs and implement retry strategies.')\r\n    }\r\n\r\n    if (metrics.cache?.hitRate && metrics.cache.hitRate < 0.3) {\r\n      recommendations.push('Cache hit rate is low. Consider adjusting cache TTL or preloading frequently accessed data.')\r\n    }\r\n\r\n    if (metrics.concurrency?.queuedCount && metrics.concurrency.queuedCount > 10) {\r\n      recommendations.push('Many requests are queued. Consider increasing the concurrent request limit.')\r\n    }\r\n\r\n    return {\r\n      summary: {\r\n        totalRequests: stats.totalRequests,\r\n        successRate: 1 - stats.errorRate,\r\n        averageResponseTime: stats.averageResponseTime,\r\n        cacheHitRate: metrics.cache?.hitRate || 0,\r\n      },\r\n      details: metrics,\r\n      recommendations,\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 创建监控处理器\r\n */\r\nexport function createMonitoringHandler(\r\n  monitor: RequestMonitor,\r\n  priorityQueue?: PriorityQueue,\r\n  requestPool?: RequestPool,\r\n  concurrencyManager?: ConcurrencyManager,\r\n  cacheManager?: CacheManager,\r\n): MonitoringHandler {\r\n  return new MonitoringHandler(\r\n    monitor,\r\n    priorityQueue,\r\n    requestPool,\r\n    concurrencyManager,\r\n    cacheManager,\r\n  )\r\n}"],"names":["MonitoringHandler","constructor","monitor","priorityQueue","requestPool","concurrencyManager","cacheManager","this","getPerformanceStats","getStats","getRecentMetrics","count","getSlowRequests","getFailedRequests","enableMonitoring","enable","disableMonitoring","disable","getPriorityQueueStats","getConnectionPoolStats","getConnectionDetails","exportMetrics","performance","connectionPool","concurrency","getStatus","cache","clearMetrics","clear","setThresholds","thresholds","slowRequestThreshold","setSlowRequestThreshold","errorRateThreshold","getRealtimeMetrics","stats","concurrencyStatus","requestsPerSecond","calculateRequestsPerSecond","averageResponseTime","errorRate","activeRequests","activeCount","recentMetrics","length","now","Date","oneMinuteAgo","recentRequests","filter","m","timestamp","firstRequest","timeSpan","generateReport","metrics","recommendations","push","hitRate","queuedCount","summary","totalRequests","successRate","cacheHitRate","details","createMonitoringHandler","a","u"],"mappings":"MAsFaA,EACX,WAAAC,CACUC,EACAC,EACAC,EACAC,EACAC,GAJAC,KAAAL,QAAAA,EACAK,KAAAJ,cAAAA,EACAI,KAAAH,YAAAA,EACAG,KAAAF,mBAAAA,EACAE,KAAAD,aAAAA,CACP,CAKH,mBAAAE,GACE,OAAOD,KAAKL,QAAQO,UACtB,CAKA,gBAAAC,CAAiBC,GACf,OAAOJ,KAAKL,QAAQQ,iBAAiBC,EACvC,CAKA,eAAAC,GACE,OAAOL,KAAKL,QAAQU,iBACtB,CAKA,iBAAAC,GACE,OAAON,KAAKL,QAAQW,mBACtB,CAKA,gBAAAC,GACEP,KAAKL,QAAQa,QACf,CAKA,iBAAAC,GACET,KAAKL,QAAQe,SACf,CAKA,qBAAAC,GACE,OAAOX,KAAKJ,eAAeM,UAC7B,CAKA,sBAAAU,GACE,OAAOZ,KAAKH,aAAaK,UAC3B,CAKA,oBAAAW,GACE,OAAOb,KAAKH,aAAagB,sBAC3B,CAKA,aAAAC,GACE,MAAO,CACLC,YAAaf,KAAKL,QAAQmB,gBAC1BlB,cAAeI,KAAKJ,eAAeM,WACnCc,eAAgBhB,KAAKH,aAAaK,WAClCe,YAAajB,KAAKF,oBAAoBoB,YACtCC,MAAOnB,KAAKD,cAAcG,SAAWF,KAAKD,aAAaG,WAAa,KAExE,CAKA,YAAAkB,GACEpB,KAAKL,QAAQ0B,OACf,CAKA,aAAAC,CAAcC,QAI4B,IAApCA,EAAWC,sBACbxB,KAAKL,QAAQ8B,wBAAwBF,EAAWC,sBAE9CD,EAAWG,kBAGjB,CAKA,kBAAAC,GAME,MAAMC,EAAQ5B,KAAKL,QAAQO,WACrB2B,EAAoB7B,KAAKF,oBAAoBoB,YAEnD,MAAO,CACLY,kBAAmB9B,KAAK+B,6BACxBC,oBAAqBJ,EAAMI,qBAAuB,EAClDC,UAAWL,EAAMK,WAAa,EAC9BC,eAAgBL,GAAmBM,aAAe,EAEtD,CAKQ,0BAAAJ,GACN,MAAMK,EAAgBpC,KAAKL,QAAQQ,iBAAiB,IACpD,IAAKiC,GAA0C,IAAzBA,EAAcC,OAClC,OAAO,EAGT,MAAMC,EAAMC,KAAKD,MACXE,EAAeF,EAAM,IACrBG,EAAiBL,EAAcM,OAClCC,GAAWA,EAAEC,WAAaD,EAAEC,UAAYJ,GAG3C,GAA8B,IAA1BC,EAAeJ,OACjB,SAGF,MAAMQ,EAAeJ,EAAe,GACpC,IAAKI,GAAcD,UACjB,SAEF,MAAME,GAAYR,EAAMO,EAAaD,WAAa,IAClD,OAAOH,EAAeJ,OAASS,CACjC,CAKA,cAAAC,GAKE,MAAMC,EAAUhD,KAAKc,gBACfc,EAAQ5B,KAAKC,sBAEbgD,EAA4B,GAIlC,OADwBrB,EAAMI,qBAAuB,GAC/B,KACpBiB,EAAgBC,KAAK,gGAGnBtB,EAAMK,UAAY,KACpBgB,EAAgBC,KAAK,6EAGnBF,EAAQ7B,OAAOgC,SAAWH,EAAQ7B,MAAMgC,QAAU,IACpDF,EAAgBC,KAAK,+FAGnBF,EAAQ/B,aAAamC,aAAeJ,EAAQ/B,YAAYmC,YAAc,IACxEH,EAAgBC,KAAK,+EAGhB,CACLG,QAAS,CACPC,cAAe1B,EAAM0B,cACrBC,YAAa,EAAI3B,EAAMK,UACvBD,oBAAqBJ,EAAMI,oBAC3BwB,aAAcR,EAAQ7B,OAAOgC,SAAW,GAE1CM,QAAST,EACTC,gBAAAA,EAEJ,EAMI,SAAUS,EACd/D,EACAC,EACAC,EACAC,EACAC,GAEA,OAAO,IAAIN,EACTE,EACAC,EACAC,EACAC,EACAC,EAEJ,QAAA4D,uBAAAC"}
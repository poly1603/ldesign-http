{"version":3,"file":"common.js","sources":["../../src/interceptors/common.ts"],"sourcesContent":["import type {\r\n  ErrorInterceptor,\r\n  HttpError,\r\n  RequestInterceptor,\r\n  ResponseInterceptor,\r\n} from '../types'\r\n\r\n/**\r\n * 请求日志拦截器\r\n */\r\nexport const requestLoggerInterceptor: RequestInterceptor = (config) => {\r\n  // eslint-disable-next-line no-console\r\n  console.log(`[HTTP Request] ${config.method} ${config.url}`, {\r\n    headers: config.headers,\r\n    data: config.data,\r\n    params: config.params,\r\n  })\r\n  return config\r\n}\r\n\r\n/**\r\n * 响应日志拦截器\r\n */\r\nexport const responseLoggerInterceptor: ResponseInterceptor = (response) => {\r\n  // eslint-disable-next-line no-console\r\n  console.log(`[HTTP Response] ${response.config.method} ${response.config.url}`, {\r\n    status: response.status,\r\n    data: response.data\r\n  })\r\n  return response\r\n}\r\n\r\n/**\r\n * 错误日志拦截器\r\n */\r\nexport const errorLoggerInterceptor: ErrorInterceptor = (error) => {\r\n  console.error(`[HTTP Error] ${error.config?.url}`, {\r\n    message: error.message,\r\n    code: error.code,\r\n    status: error.response?.status,\r\n    response: error.response?.data,\r\n  })\r\n  return error\r\n}\r\n\r\n/**\r\n * 认证拦截器工厂\r\n */\r\nexport function createAuthInterceptor(\r\n  getToken: () => string | null,\r\n): RequestInterceptor {\r\n  return (config) => {\r\n    const token = getToken()\r\n    if (token) {\r\n      config.headers = {\r\n        ...config.headers,\r\n        Authorization: `Bearer ${token}`,\r\n      }\r\n    }\r\n    return config\r\n  }\r\n}\r\n\r\n/**\r\n * 基础 URL 拦截器工厂\r\n */\r\nexport function createBaseURLInterceptor(baseURL: string): RequestInterceptor {\r\n  return (config) => {\r\n    if (!config.baseURL && !config.url?.startsWith('http')) {\r\n      config.baseURL = baseURL\r\n    }\r\n    return config\r\n  }\r\n}\r\n\r\n/**\r\n * 请求 ID 拦截器\r\n */\r\nexport const requestIdInterceptor: RequestInterceptor = (config) => {\r\n  const requestId = Math.random().toString(36).substring(2, 15)\r\n  config.headers = {\r\n    ...config.headers,\r\n    'X-Request-ID': requestId,\r\n  }\r\n  return config\r\n}\r\n\r\n/**\r\n * 时间戳拦截器\r\n */\r\nexport const timestampInterceptor: RequestInterceptor = (config) => {\r\n  const timestamp = Date.now()\r\n\r\n  // 为 GET 请求添加时间戳参数防止缓存\r\n  if (config.method === 'GET') {\r\n    config.params = {\r\n      ...config.params,\r\n      _t: timestamp,\r\n    }\r\n  }\r\n\r\n  // 添加时间戳头部\r\n  config.headers = {\r\n    ...config.headers,\r\n    'X-Timestamp': timestamp.toString(),\r\n  }\r\n\r\n  return config\r\n}\r\n\r\n/**\r\n * 内容类型拦截器\r\n */\r\nexport const contentTypeInterceptor: RequestInterceptor = (config) => {\r\n  if (\r\n    config.data\r\n    && !config.headers?.['Content-Type']\r\n    && !config.headers?.['content-type']\r\n  ) {\r\n    if (typeof config.data === 'object' && !(config.data instanceof FormData)) {\r\n      config.headers = {\r\n        ...config.headers,\r\n        'Content-Type': 'application/json',\r\n      }\r\n    }\r\n  }\r\n  return config\r\n}\r\n\r\n/**\r\n * 响应时间拦截器\r\n */\r\nexport function createResponseTimeInterceptor(): {\r\n  request: RequestInterceptor\r\n  response: ResponseInterceptor\r\n} {\r\n  const startTimes = new Map<string, number>()\r\n\r\n  return {\r\n    request: (config) => {\r\n      const requestId\r\n        = config.headers?.['X-Request-ID'] || Math.random().toString(36)\r\n      startTimes.set(requestId, Date.now())\r\n      config.headers = {\r\n        ...config.headers,\r\n        'X-Request-ID': requestId,\r\n      }\r\n      return config\r\n    },\r\n    response: (response) => {\r\n      const requestId = response.config.headers?.['X-Request-ID']\r\n      if (requestId && startTimes.has(requestId)) {\r\n        const startTime = startTimes.get(requestId)!\r\n        const duration = Date.now() - startTime\r\n        // eslint-disable-next-line no-console\r\n        console.log(`[Response Time] ${response.config.url}: ${duration}ms`)\r\n        startTimes.delete(requestId)\r\n      }\r\n      return response\r\n    },\r\n  }\r\n}\r\n\r\n/**\r\n * 状态码处理拦截器\r\n */\r\nexport const statusCodeInterceptor: ResponseInterceptor = (response) => {\r\n  // 可以在这里处理特定的状态码\r\n  if (response.status >= 400) {\r\n    throw new Error(`HTTP Error: ${response.status} ${response.statusText}`)\r\n  }\r\n  return response\r\n}\r\n\r\n/**\r\n * 数据转换拦截器工厂\r\n */\r\nexport function createDataTransformInterceptor<T, R>(\r\n  transform: (data: T) => R,\r\n): ResponseInterceptor<R> {\r\n  return (response) => {\r\n    return {\r\n      ...response,\r\n      data: transform(response.data as unknown as T),\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 重试拦截器工厂\r\n */\r\nexport function createRetryInterceptor(\r\n  maxRetries: number = 3,\r\n  retryDelay: number = 1000,\r\n  retryCondition?: (error: HttpError) => boolean,\r\n): ErrorInterceptor {\r\n  return async (error) => {\r\n    const config = error.config\r\n    if (!config) {\r\n      return error\r\n    }\r\n\r\n    // 检查是否应该重试\r\n    const shouldRetry = retryCondition\r\n      ? retryCondition(error)\r\n      : error.isNetworkError || error.isTimeoutError\r\n\r\n    if (!shouldRetry) {\r\n      return error\r\n    }\r\n\r\n    // 获取当前重试次数\r\n    const retryCount = (config as any).__retryCount || 0\r\n\r\n    if (retryCount >= maxRetries) {\r\n      return error\r\n    }\r\n\r\n    // 增加重试次数\r\n    ;(config as any).__retryCount = retryCount + 1\r\n\r\n    // 延迟重试\r\n    await new Promise(resolve =>\r\n      setTimeout(resolve, retryDelay * 2 ** retryCount),\r\n    )\r\n\r\n    // 这里需要重新发送请求，但由于拦截器的限制，我们只能返回错误\r\n    // 实际的重试逻辑应该在 HttpClient 中实现\r\n    return error\r\n  }\r\n}\r\n\r\n// 简化的拦截器函数，用于测试\r\nexport function authInterceptor(options: any = {}) {\r\n  const {\r\n    tokenKey = 'accessToken',\r\n    headerName = 'Authorization',\r\n    tokenPrefix = 'Bearer',\r\n  } = options\r\n\r\n  return {\r\n    request: (config: any) => {\r\n      const token = localStorage.getItem(tokenKey)\r\n      if (token) {\r\n        config.headers = config.headers || {}\r\n        config.headers[headerName] = `${tokenPrefix} ${token}`\r\n      }\r\n      return config\r\n    },\r\n    responseError: (error: any) => {\r\n      if (error.response?.status === 401) {\r\n        localStorage.removeItem(tokenKey)\r\n      }\r\n      return error\r\n    },\r\n  }\r\n}\r\n\r\nexport function loggingInterceptor(options: any = {}) {\r\n  const { level = 'info', logger = console } = options\r\n\r\n  return {\r\n    request: (config: any) => {\r\n      if (level === 'info' || level === 'debug') {\r\n        logger.log('Request:', {\r\n          method: config.method,\r\n          url: config.url,\r\n          headers: config.headers,\r\n          data: config.data,\r\n        })\r\n      }\r\n      return config\r\n    },\r\n    response: (response: any) => {\r\n      if (level === 'info' || level === 'debug') {\r\n        logger.log('Response:', {\r\n          status: response.status,\r\n          data: response.data,\r\n          headers: response.headers,\r\n        })\r\n      }\r\n      return response\r\n    },\r\n    responseError: (error: any) => {\r\n      logger.error('Error:', {\r\n        message: error.message,\r\n        config: error.config,\r\n        response: error.response,\r\n      })\r\n      return error\r\n    },\r\n  }\r\n}\r\n\r\nexport function errorHandlingInterceptor(options: any = {}) {\r\n  const { customHandler } = options\r\n\r\n  return {\r\n    responseError: (error: any) => {\r\n      if (customHandler) {\r\n        return customHandler(error)\r\n      }\r\n\r\n      // 默认错误处理\r\n      if (error.isNetworkError) {\r\n        error.userMessage = '网络连接失败，请检查网络设置'\r\n      }\r\n      else if (error.isTimeoutError) {\r\n        error.userMessage = '请求超时，请重试'\r\n      }\r\n      else if (error.response?.status >= 500) {\r\n        error.userMessage = '服务器内部错误'\r\n      }\r\n      else if (error.response?.status >= 400) {\r\n        error.userMessage = `请求失败 (${error.response.status})`\r\n      }\r\n\r\n      return error\r\n    },\r\n  }\r\n}\r\n\r\nexport function timeoutInterceptor(options: any = {}) {\r\n  const { timeout = 5000 } = options\r\n\r\n  return {\r\n    request: (config: any) => {\r\n      if (!config.timeout) {\r\n        config.timeout = timeout\r\n      }\r\n      return config\r\n    },\r\n    responseError: (error: any) => {\r\n      if (error.code === 'ECONNABORTED' || error.message?.includes('timeout')) {\r\n        error.isTimeoutError = true\r\n        error.message = 'Request timeout'\r\n      }\r\n      return error\r\n    },\r\n  }\r\n}\r\n\r\nexport function retryInterceptor(options: any = {}) {\r\n  const { maxAttempts = 3, delay = 1000 } = options\r\n\r\n  return {\r\n    request: (config: any) => {\r\n      if (!config.retry) {\r\n        config.retry = { maxAttempts, delay }\r\n      }\r\n      return config\r\n    },\r\n  }\r\n}\r\n\r\nexport function cacheInterceptor(options: any = {}) {\r\n  const { enabled = true, ttl = 300000, methods = ['GET'] } = options\r\n\r\n  return {\r\n    request: (config: any) => {\r\n      // 不覆盖现有的缓存配置\r\n      if (!config.cache) {\r\n        const method = config.method?.toUpperCase() || 'GET'\r\n        const shouldCache = enabled && methods.includes(method)\r\n        config.cache = { enabled: shouldCache, ttl }\r\n      }\r\n      return config\r\n    },\r\n  }\r\n}\r\n"],"names":["requestLoggerInterceptor","config","responseLoggerInterceptor","response","errorLoggerInterceptor","error","createAuthInterceptor","getToken","token","headers","Authorization","createBaseURLInterceptor","baseURL","url","startsWith","requestIdInterceptor","requestId","Math","random","toString","substring","timestampInterceptor","timestamp","Date","now","method","params","_t","contentTypeInterceptor","data","FormData","createResponseTimeInterceptor","startTimes","Map","request","set","has","startTime","get","delete","statusCodeInterceptor","status","Error","statusText","createDataTransformInterceptor","transform","createRetryInterceptor","maxRetries","retryDelay","retryCondition","async","isNetworkError","isTimeoutError","retryCount","__retryCount","Promise","resolve","setTimeout","authInterceptor","options","tokenKey","headerName","tokenPrefix","localStorage","getItem","responseError","removeItem","loggingInterceptor","level","logger","console","log","message","errorHandlingInterceptor","customHandler","userMessage","timeoutInterceptor","timeout","code","includes","retryInterceptor","maxAttempts","delay","retry","cacheInterceptor","enabled","ttl","methods","cache","toUpperCase","shouldCache","T","C","h","d","p","E","l","I","R","i","D","m","u","c","y","f","q","g"],"mappings":"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"}
{"version":3,"file":"graphql.js","sources":["../../src/features/graphql.ts"],"sourcesContent":["import type { HttpClient, RequestConfig } from '../types'\n\n/**\n * GraphQL 查询变量类型\n */\nexport type GraphQLVariables = Record<string, any>\n\n/**\n * GraphQL 请求配置\n */\nexport interface GraphQLRequestConfig extends Omit<RequestConfig, 'method' | 'data'> {\n  /** GraphQL 端点 URL（如果不同于 baseURL） */\n  endpoint?: string\n  /** 自定义请求头 */\n  headers?: Record<string, string>\n  /** 启用批量查询 */\n  batching?: boolean\n  /** 批量查询延迟（毫秒） */\n  batchDelay?: number\n}\n\n/**\n * GraphQL 响应类型\n */\nexport interface GraphQLResponse<T = any> {\n  data?: T\n  errors?: GraphQLError[]\n  extensions?: Record<string, any>\n}\n\n/**\n * GraphQL 错误类��\n */\nexport interface GraphQLError {\n  message: string\n  locations?: Array<{ line: number, column: number }>\n  path?: Array<string | number>\n  extensions?: Record<string, any>\n}\n\n/**\n * GraphQL 批量请求项\n */\ninterface BatchItem<T = any> {\n  query: string\n  variables?: GraphQLVariables\n  operationName?: string\n  resolve: (value: GraphQLResponse<T>) => void\n  reject: (error: Error) => void\n}\n\n/**\n * GraphQL 客户端配置\n */\nexport interface GraphQLClientConfig {\n  /** 默认端点 URL */\n  endpoint: string\n  /** 默认请求头 */\n  headers?: Record<string, string>\n  /** 启用批量查询 */\n  batching?: boolean\n  /** 批量查询延迟（毫秒） */\n  batchDelay?: number\n  /** 是否在控制台打印查询 */\n  debug?: boolean\n}\n\n/**\n * GraphQL 客户端\n *\n * 提供 GraphQL 查询、变更和订阅功能，支持批量查询优化\n *\n * @example\n * ```typescript\n * const graphqlClient = new GraphQLClient(httpClient, {\n *   endpoint: '/graphql',\n *   batching: true,\n *   batchDelay: 10\n * })\n *\n * // 执行查询\n * const { data, errors } = await graphqlClient.query<User[]>(`\n *   query GetUsers {\n *     users {\n *       id\n *       name\n *       email\n *     }\n *   }\n * `)\n *\n * // 执行变更\n * const result = await graphqlClient.mutate<User>(`\n *   mutation CreateUser($input: CreateUserInput!) {\n *     createUser(input: $input) {\n *       id\n *       name\n *     }\n *   }\n * `, {\n *   input: { name: 'John', email: 'john@example.com' }\n * })\n * ```\n */\nexport class GraphQLClient {\n  private httpClient: HttpClient\n  private config: Required<GraphQLClientConfig>\n  private batchQueue: BatchItem[] = []\n  private batchTimer: ReturnType<typeof setTimeout> | null = null\n\n  constructor(httpClient: HttpClient, config: GraphQLClientConfig) {\n    this.httpClient = httpClient\n    this.config = {\n      endpoint: config.endpoint,\n      headers: config.headers || {},\n      batching: config.batching ?? false,\n      batchDelay: config.batchDelay ?? 10,\n      debug: config.debug ?? false,\n    }\n  }\n\n  /**\n   * 执行 GraphQL 查询\n   */\n  async query<T = any>(\n    query: string,\n    variables?: GraphQLVariables,\n    config?: GraphQLRequestConfig,\n  ): Promise<GraphQLResponse<T>> {\n    return this.request<T>(query, variables, undefined, config)\n  }\n\n  /**\n   * 执行 GraphQL 变更\n   */\n  async mutate<T = any>(\n    mutation: string,\n    variables?: GraphQLVariables,\n    config?: GraphQLRequestConfig,\n  ): Promise<GraphQLResponse<T>> {\n    // 变更不支持批量处理\n    return this.request<T>(mutation, variables, undefined, {\n      ...config,\n      batching: false,\n    })\n  }\n\n  /**\n   * 执行 GraphQL 请求\n   */\n  private async request<T = any>(\n    query: string,\n    variables?: GraphQLVariables,\n    operationName?: string,\n    config?: GraphQLRequestConfig,\n  ): Promise<GraphQLResponse<T>> {\n    const shouldBatch = config?.batching ?? this.config?.batching\n\n    if (shouldBatch) {\n      return this.batchRequest<T>(query, variables, operationName, config)\n    }\n\n    return this.singleRequest<T>(query, variables, operationName, config)\n  }\n\n  /**\n   * 执行单个 GraphQL 请求\n   */\n  private async singleRequest<T = any>(\n    query: string,\n    variables?: GraphQLVariables,\n    operationName?: string,\n    config?: GraphQLRequestConfig,\n  ): Promise<GraphQLResponse<T>> {\n    const endpoint = config?.endpoint || this.config?.endpoint\n\n    if (this.config?.debug) {\n      console.debug('[GraphQL Query]', query)\n      if (variables) {\n        console.debug('[GraphQL Variables]', variables)\n      }\n    }\n\n    try {\n      const response = await this.httpClient.post<GraphQLResponse<T>>(\n        endpoint,\n        {\n          query,\n          variables,\n          operationName,\n        },\n        {\n          ...config,\n          headers: {\n            'Content-Type': 'application/json',\n            ...this.config?.headers,\n            ...config?.headers,\n          },\n        },\n      )\n\n      const result = response.data\n\n      if (this.config?.debug && result.errors) {\n        console.error('[GraphQL Errors]', result.errors)\n      }\n\n      if (result.errors && result.errors.length > 0) {\n        throw new GraphQLClientError(result.errors, result.data)\n      }\n\n      return result\n    }\n    catch (error: any) {\n      if (error instanceof GraphQLClientError) {\n        throw error\n      }\n      throw new GraphQLClientError([{\n        message: error.message || 'GraphQL request failed',\n        extensions: { originalError: error },\n      }])\n    }\n  }\n\n  /**\n   * 批量请求\n   */\n  private async batchRequest<T = any>(\n    query: string,\n    variables?: GraphQLVariables,\n    operationName?: string,\n    config?: GraphQLRequestConfig,\n  ): Promise<GraphQLResponse<T>> {\n    return new Promise<GraphQLResponse<T>>((resolve, reject) => {\n      // 添加到批量队列\n      this.batchQueue.push({\n        query,\n        variables,\n        operationName,\n        resolve: resolve as any,\n        reject,\n      })\n\n      // 如果已经有定时器，不需要创建新的\n      if (this.batchTimer) {\n        return\n      }\n\n      // 设置批量执行定时器\n      const delay = config?.batchDelay ?? this.config?.batchDelay\n      this.batchTimer = setTimeout(() => {\n        this.executeBatch(config)\n      }, delay)\n    })\n  }\n\n  /**\n   * 执行批量请求\n   */\n  private async executeBatch(config?: GraphQLRequestConfig): Promise<void> {\n    // 获取并清空队列\n    const batch = [...this.batchQueue]\n    this.batchQueue = []\n    this.batchTimer = null\n\n    if (batch.length === 0) {\n      return\n    }\n\n    const endpoint = config?.endpoint || this.config?.endpoint\n\n    if (this.config?.debug) {\n      console.debug('[GraphQL Batch]', `Processing ${batch.length} requests`)\n    }\n\n    try {\n      // 构建批量请求\n      const batchRequest = batch.map(item => ({\n        query: item.query,\n        variables: item.variables,\n        operationName: item.operationName,\n      }))\n\n      // 发送批量请求\n      const response = await this.httpClient.post<GraphQLResponse[]>(\n        endpoint,\n        batchRequest,\n        {\n          ...config,\n          headers: {\n            'Content-Type': 'application/json',\n            ...this.config?.headers,\n            ...config?.headers,\n          },\n        },\n      )\n\n      // 分发响应到各个 Promise\n      response.data.forEach((result, index) => {\n        const item = batch[index]\n        if (result.errors && result.errors.length > 0) {\n          item.reject(new GraphQLClientError(result.errors, result.data))\n        }\n        else {\n          item.resolve(result)\n        }\n      })\n    }\n    catch (error: any) {\n      // 批量请求失败，所有 Promise 都 reject\n      batch.forEach((item) => {\n        item.reject(error)\n      })\n    }\n  }\n\n  /**\n   * 清除批量队列\n   */\n  clearBatch(): void {\n    if (this.batchTimer) {\n      clearTimeout(this.batchTimer)\n      this.batchTimer = null\n    }\n    this.batchQueue = []\n  }\n\n  /**\n   * 获取批量队列大小\n   */\n  getBatchQueueSize(): number {\n    return this.batchQueue.length\n  }\n\n  /**\n   * 更新配置\n   */\n  updateConfig(config: Partial<GraphQLClientConfig>): void {\n    Object.assign(this.config, config)\n  }\n\n  /**\n   * 获取当前配置\n   */\n  getConfig(): GraphQLClientConfig {\n    return { ...this.config }\n  }\n}\n\n/**\n * GraphQL 客户端错误\n */\nexport class GraphQLClientError extends Error {\n  public graphQLErrors: GraphQLError[]\n  public data?: any\n\n  constructor(errors: GraphQLError[], data?: any) {\n    const message = errors.map(e => e.message).join('\\n')\n    super(message)\n    this.name = 'GraphQLClientError'\n    this.graphQLErrors = errors\n    this.data = data\n\n    // 设置原型链，确保 instanceof 正常工作\n    Object.setPrototypeOf(this, GraphQLClientError.prototype)\n  }\n\n  /**\n   * 判断是否有指定类型的错误\n   */\n  hasErrorCode(code: string): boolean {\n    return this.graphQLErrors.some(\n      error => error.extensions?.code === code,\n    )\n  }\n\n  /**\n   * 获取第一个错误\n   */\n  getFirstError(): GraphQLError | undefined {\n    return this.graphQLErrors[0]\n  }\n}\n\n/**\n * 创建 GraphQL 客户端\n */\nexport function createGraphQLClient(\n  httpClient: HttpClient,\n  config: GraphQLClientConfig,\n): GraphQLClient {\n  return new GraphQLClient(httpClient, config)\n}\n\n/**\n * 类型守卫：检查是否为 GraphQL 错误\n */\nexport function isGraphQLError(error: any): error is GraphQLClientError {\n  return error instanceof GraphQLClientError\n}\n"],"names":["GraphQLClient","constructor","httpClient","config","this","batchQueue","batchTimer","endpoint","headers","batching","batchDelay","debug","query","variables","request","mutate","mutation","operationName","batchRequest","singleRequest","result","post","data","errors","length","GraphQLClientError","error","message","extensions","originalError","Promise","resolve","reject","push","delay","setTimeout","executeBatch","batch","map","item","forEach","index","clearBatch","clearTimeout","getBatchQueueSize","updateConfig","Object","assign","getConfig","Error","super","e","join","name","graphQLErrors","setPrototypeOf","prototype","hasErrorCode","code","some","getFirstError","createGraphQLClient","isGraphQLError","c","n","u","g"],"mappings":"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"}
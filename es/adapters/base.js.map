{"version":3,"file":"base.js","sources":["../../src/adapters/base.ts"],"sourcesContent":["import type {\n  HttpAdapter,\n  HttpError,\n  RequestConfig,\n  ResponseData,\n} from '../types'\nimport { buildURL, createHttpError } from '../utils'\n\n/**\n * 适配器基类\n */\nexport abstract class BaseAdapter implements HttpAdapter {\n  abstract name: string\n\n  /**\n   * 发送请求的抽象方法\n   */\n  abstract request<T = unknown>(config: RequestConfig): Promise<ResponseData<T>>\n\n  /**\n   * 检查是否支持当前环境\n   */\n  abstract isSupported(): boolean\n\n  /**\n   * 处理请求配置\n   */\n  protected processConfig(config: RequestConfig): RequestConfig {\n    const processedConfig = { ...config }\n\n    // 构建完整 URL\n    if (processedConfig.url) {\n      processedConfig.url = buildURL(\n        processedConfig.url,\n        processedConfig.baseURL,\n        processedConfig.params,\n      )\n    }\n\n    // 设置默认方法\n    if (!processedConfig.method) {\n      processedConfig.method = 'GET'\n    }\n\n    // 设置默认头部\n    if (!processedConfig.headers) {\n      processedConfig.headers = {}\n    }\n\n    return processedConfig\n  }\n\n  /**\n   * 处理响应数据\n   */\n  protected processResponse<T>(\n    data: T,\n    status: number,\n    statusText: string,\n    headers: Record<string, string>,\n    config: RequestConfig,\n    raw?: any,\n  ): ResponseData<T> {\n    return {\n      data,\n      status,\n      statusText,\n      headers,\n      config,\n      raw,\n    }\n  }\n\n  /**\n   * 处理错误\n   */\n  protected processError(\n    error: any,\n    config: RequestConfig,\n    response?: ResponseData,\n  ): HttpError {\n    let message = 'Request failed'\n    let code: string | undefined\n\n    if (error instanceof Error) {\n      message = error.message\n      code = (error as any).code\n    }\n    else if (typeof error === 'string') {\n      message = error\n    }\n\n    // 根据错误类型设置相应的标志\n    const httpError = createHttpError(message, config, code, response)\n\n    // 处理特定错误类型\n    if (error.name === 'AbortError' || message.includes('aborted')) {\n      httpError.isCancelError = true\n      httpError.code = 'CANCELED'\n    }\n    else if (error.name === 'TimeoutError' || message.includes('timeout')) {\n      httpError.isTimeoutError = true\n      httpError.code = 'TIMEOUT'\n    }\n    else if (message.includes('Network') || message.includes('fetch')) {\n      httpError.isNetworkError = true\n      httpError.code = 'NETWORK_ERROR'\n    }\n\n    return httpError\n  }\n\n  /**\n   * 创建超时控制器\n   */\n  protected createTimeoutController(timeout?: number): {\n    signal: AbortSignal\n    cleanup: () => void\n  } {\n    const controller = new AbortController()\n    let timeoutId: NodeJS.Timeout | undefined\n\n    if (timeout && timeout > 0) {\n      timeoutId = setTimeout(() => {\n        if (controller && typeof controller.abort === 'function') {\n          controller.abort()\n        }\n      }, timeout)\n    }\n\n    return {\n      signal: controller.signal,\n      cleanup: () => {\n        if (timeoutId) {\n          clearTimeout(timeoutId)\n        }\n      },\n    }\n  }\n\n  /**\n   * 合并 AbortSignal\n   */\n  protected mergeAbortSignals(\n    signals: (AbortSignal | undefined)[],\n  ): AbortSignal {\n    const validSignals = signals.filter(\n      (signal): signal is AbortSignal => signal !== undefined,\n    )\n\n    if (validSignals.length === 0) {\n      return new AbortController().signal\n    }\n\n    if (validSignals.length === 1) {\n      // 已检查数组长度，安全断言\n      return validSignals[0]!\n    }\n\n    // 创建一个新的控制器来合并多个信号\n    const controller = new AbortController()\n\n    const abortHandler = () => {\n      controller.abort()\n    }\n\n    validSignals.forEach((signal) => {\n      if (signal.aborted) {\n        controller.abort()\n        return\n      }\n      signal.addEventListener('abort', abortHandler, { once: true })\n    })\n\n    return controller.signal\n  }\n\n  /**\n   * 解析响应头\n   */\n  protected parseHeaders(\n    headers: Headers | Record<string, string>,\n  ): Record<string, string> {\n    const result: Record<string, string> = {}\n\n    if (headers instanceof Headers) {\n      headers.forEach((value, key) => {\n        result[key.toLowerCase()] = value\n      })\n    }\n    else {\n      Object.keys(headers).forEach((key) => {\n        const value = headers[key]\n        if (value !== undefined) {\n          result[key.toLowerCase()] = value\n        }\n      })\n    }\n\n    return result\n  }\n}\n"],"names":["BaseAdapter","processConfig","config","processedConfig","url","buildURL","baseURL","params","method","headers","processResponse","data","status","statusText","raw","processError","error","response","code","message","Error","httpError","createHttpError","name","includes","isCancelError","isTimeoutError","isNetworkError","createTimeoutController","timeout","controller","AbortController","timeoutId","setTimeout","abort","signal","cleanup","clearTimeout","mergeAbortSignals","signals","validSignals","filter","length","abortHandler","forEach","aborted","addEventListener","once","parseHeaders","result","Headers","value","key","toLowerCase","Object","keys","i"],"mappings":"wEAWsBA,EAgBV,aAAAC,CAAcC,GACtB,MAAMC,EAAkB,IAAKD,GAG7B,OAAIC,EAAgBC,MAClBD,EAAgBC,IAAMC,EACpBF,EAAgBC,IAChBD,EAAgBG,QAChBH,EAAgBI,SAKfJ,EAAgBK,SACnBL,EAAgBK,OAAS,OAItBL,EAAgBM,UACnBN,EAAgBM,QAAU,IAGrBN,CACT,CAKU,eAAAO,CACRC,EACAC,EACAC,EACAJ,EACAP,EACAY,GAEA,MAAO,CACLH,KAAAA,EACAC,OAAAA,EACAC,WAAAA,EACAJ,QAAAA,EACAP,OAAAA,EACAY,IAAAA,EAEJ,CAKU,YAAAC,CACRC,EACAd,EACAe,GAEA,IACIC,EADAC,EAAU,iBAGVH,aAAiBI,OACnBD,EAAUH,EAAMG,QAChBD,EAAQF,EAAcE,MAEE,iBAAVF,IACdG,EAAUH,GAIZ,MAAMK,EAAYC,EAAgBH,EAASjB,EAAQgB,EAAMD,GAGzD,MAAmB,eAAfD,EAAMO,MAAyBJ,EAAQK,SAAS,YAClDH,EAAUI,eAAgB,EAC1BJ,EAAUH,KAAO,YAEK,iBAAfF,EAAMO,MAA2BJ,EAAQK,SAAS,YACzDH,EAAUK,gBAAiB,EAC3BL,EAAUH,KAAO,YAEVC,EAAQK,SAAS,YAAcL,EAAQK,SAAS,YACvDH,EAAUM,gBAAiB,EAC3BN,EAAUH,KAAO,iBAGZG,CACT,CAKU,uBAAAO,CAAwBC,GAIhC,MAAMC,EAAa,IAAIC,gBACvB,IAAIC,EAEJ,OAAIH,GAAWA,EAAU,IACvBG,EAAYC,WAAW,KACjBH,GAA0C,mBAArBA,EAAWI,OAClCJ,EAAWI,SAEZL,IAGE,CACLM,OAAQL,EAAWK,OACnBC,QAAS,KACHJ,GACFK,aAAaL,IAIrB,CAKU,iBAAAM,CACRC,GAEA,MAAMC,EAAeD,EAAQE,OAC1BN,QAA6C,IAAXA,GAGrC,GAA4B,IAAxBK,EAAaE,OACf,OAAO,IAAIX,iBAAkBI,OAG/B,GAA4B,IAAxBK,EAAaE,OAEf,OAAOF,EAAa,GAItB,MAAMV,EAAa,IAAIC,gBAEjBY,EAAe,KACnBb,EAAWI,SAGb,OAAAM,EAAaI,QAAST,IAChBA,EAAOU,QACTf,EAAWI,QAGbC,EAAOW,iBAAiB,QAASH,EAAc,CAAEI,MAAM,MAGlDjB,EAAWK,MACpB,CAKU,YAAAa,CACRvC,GAEA,MAAMwC,EAAiC,CAAA,EAEvC,OAAIxC,aAAmByC,QACrBzC,EAAQmC,QAAQ,CAACO,EAAOC,KACtBH,EAAOG,EAAIC,eAAiBF,IAI9BG,OAAOC,KAAK9C,GAASmC,QAASQ,IAC5B,MAAMD,EAAQ1C,EAAQ2C,QACR,IAAVD,IACFF,EAAOG,EAAIC,eAAiBF,KAK3BF,CACT,SACDO"}
{"version":3,"file":"axios.js","sources":["../../src/adapters/axios.ts"],"sourcesContent":["import type { RequestConfig, ResponseData } from '../types'\r\nimport { BaseAdapter } from './base'\r\n\r\n/**\r\n * Axios 适配器\r\n */\r\nexport class AxiosAdapter extends BaseAdapter {\r\n  name = 'axios'\r\n  private axios: any // axios实例，保持any避免依赖axios类型\r\n\r\n  constructor(axiosInstance?: any) {\r\n    super()\r\n\r\n    if (axiosInstance) {\r\n      this.axios = axiosInstance\r\n    }\r\n    else {\r\n      try {\r\n        // 动态导入 axios\r\n        // eslint-disable-next-line ts/no-require-imports\r\n        this.axios = require('axios')\r\n      }\r\n      catch {\r\n        // axios 未安装\r\n        this.axios = null\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 检查是否支持 axios\r\n   */\r\n  isSupported(): boolean {\r\n    return this.axios !== null\r\n  }\r\n\r\n  /**\r\n   * 发送请求\r\n   */\r\n  async request<T = unknown>(config: RequestConfig): Promise<ResponseData<T>> {\r\n    if (!this.isSupported()) {\r\n      throw new Error(\r\n        'Axios is not available. Please install axios: npm install axios',\r\n      )\r\n    }\r\n\r\n    const processedConfig = this.processConfig(config)\r\n\r\n    try {\r\n      // 转换配置为 axios 格式\r\n      const axiosConfig = this.convertToAxiosConfig(processedConfig)\r\n\r\n      // 发送请求\r\n      const response = await this.axios.request(axiosConfig)\r\n\r\n      // 转换响应为标准格式\r\n      return this.convertFromAxiosResponse<T>(response, processedConfig)\r\n    }\r\n    catch (error) {\r\n      throw this.handleAxiosError(error, processedConfig)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 转换配置为 axios 格式\r\n   */\r\n  private convertToAxiosConfig(config: RequestConfig): any {\r\n    // 分离URL和查询参数（因为BaseAdapter已经将params合并到URL中）\r\n    let cleanUrl = config.url || ''\r\n    const extractedParams = config.params || {}\r\n    const baseURL = config.baseURL\r\n\r\n    // 如果URL包含查询参数，提取它们\r\n    const urlParts = cleanUrl.split('?')\r\n    if (urlParts.length > 1) {\r\n      cleanUrl = urlParts[0]\r\n      const queryString = urlParts[1]\r\n      const urlParams = new URLSearchParams(queryString)\r\n\r\n      // 将URL中的参数合并到extractedParams中\r\n      urlParams.forEach((value, key) => {\r\n        // 尝试转换数字字符串回数字\r\n        const numValue = Number(value)\r\n        extractedParams[key] = !Number.isNaN(numValue) && value !== '' ? numValue : value\r\n      })\r\n    }\r\n\r\n    // 如果URL已经包含了baseURL，需要分离它们\r\n    if (baseURL && cleanUrl.startsWith(baseURL)) {\r\n      cleanUrl = cleanUrl.substring(baseURL.length)\r\n      // 确保URL以/开头\r\n      if (!cleanUrl.startsWith('/')) {\r\n        cleanUrl = `/${cleanUrl}`\r\n      }\r\n    }\r\n\r\n    const axiosConfig: any = {\r\n      url: cleanUrl,\r\n      method: config.method,\r\n    }\r\n\r\n    // 只在有值时添加字段\r\n    if (config.headers && Object.keys(config.headers).length > 0) {\r\n      axiosConfig.headers = config.headers\r\n    }\r\n    if (config.data !== undefined) {\r\n      axiosConfig.data = config.data\r\n    }\r\n    if (config.timeout !== undefined) {\r\n      axiosConfig.timeout = config.timeout\r\n    }\r\n    if (baseURL) {\r\n      axiosConfig.baseURL = baseURL\r\n    }\r\n    if (config.withCredentials !== undefined) {\r\n      axiosConfig.withCredentials = config.withCredentials\r\n    }\r\n    if (config.signal) {\r\n      axiosConfig.signal = config.signal\r\n    }\r\n\r\n    // 处理查询参数\r\n    if (extractedParams && Object.keys(extractedParams).length > 0) {\r\n      axiosConfig.params = extractedParams\r\n    }\r\n\r\n    // 处理响应类型\r\n    if (config.responseType) {\r\n      switch (config.responseType) {\r\n        case 'json':\r\n          axiosConfig.responseType = 'json'\r\n          break\r\n        case 'text':\r\n          axiosConfig.responseType = 'text'\r\n          break\r\n        case 'blob':\r\n          axiosConfig.responseType = 'blob'\r\n          break\r\n        case 'arrayBuffer':\r\n          axiosConfig.responseType = 'arraybuffer'\r\n          break\r\n        case 'stream':\r\n          axiosConfig.responseType = 'stream'\r\n          break\r\n        default:\r\n          axiosConfig.responseType = 'json'\r\n      }\r\n    }\r\n\r\n    // 移除 undefined 值\r\n    Object.keys(axiosConfig).forEach((key) => {\r\n      if (axiosConfig[key] === undefined) {\r\n        delete axiosConfig[key]\r\n      }\r\n    })\r\n\r\n    return axiosConfig\r\n  }\r\n\r\n  /**\r\n   * 转换 axios 响应为标准格式\r\n   */\r\n  private convertFromAxiosResponse<T>(\r\n    axiosResponse: any,\r\n    config: RequestConfig,\r\n  ): ResponseData<T> {\r\n    // 创建简化的config对象，只包含必要的字段\r\n    const simplifiedConfig = {\r\n      url: config.url,\r\n    }\r\n\r\n    return this.processResponse<T>(\r\n      axiosResponse.data,\r\n      axiosResponse.status,\r\n      axiosResponse.statusText,\r\n      axiosResponse.headers || {},\r\n      simplifiedConfig,\r\n    )\r\n  }\r\n\r\n  /**\r\n   * 处理 axios 错误\r\n   */\r\n  private handleAxiosError(error: any, config: RequestConfig): Error {\r\n    if (error.response) {\r\n      // 服务器响应了错误状态码\r\n      const response = this.convertFromAxiosResponse(error.response, config)\r\n      const status = error.response.status\r\n      const message = `Request failed with status code ${status}`\r\n      const httpError = this.processError(new Error(message), config, response)\r\n      httpError.status = status\r\n      httpError.response = response\r\n      return httpError\r\n    }\r\n    else if (error.request) {\r\n      // 请求已发送但没有收到响应\r\n      const httpError = this.processError(error, config)\r\n      httpError.isNetworkError = true\r\n      return httpError\r\n    }\r\n    else {\r\n      // 其他错误\r\n      return this.processError(error, config)\r\n    }\r\n  }\r\n}\r\n"],"names":["AxiosAdapter","BaseAdapter","constructor","axiosInstance","super","this","name","axios","require","isSupported","request","config","Error","processedConfig","processConfig","axiosConfig","convertToAxiosConfig","response","convertFromAxiosResponse","error","handleAxiosError","cleanUrl","url","extractedParams","params","baseURL","urlParts","split","length","queryString","URLSearchParams","forEach","value","key","numValue","Number","isNaN","startsWith","substring","method","headers","Object","keys","data","timeout","withCredentials","signal","responseType","axiosResponse","simplifiedConfig","processResponse","status","statusText","message","httpError","processError","isNetworkError","l"],"mappings":"wCAMM,MAAOA,UAAqBC,EAIhC,WAAAC,CAAYC,GAGV,GAFAC,QAJFC,KAAAC,KAAO,QAMDH,EACFE,KAAKE,MAAQJ,OAGb,IAGEE,KAAKE,MAAQC,QAAQ,QACvB,OAGEH,KAAKE,MAAQ,IACf,CAEJ,CAKA,WAAAE,GACE,OAAsB,OAAfJ,KAAKE,KACd,CAKA,aAAMG,CAAqBC,GACzB,IAAKN,KAAKI,cACR,MAAM,IAAIG,MACR,mEAIJ,MAAMC,EAAkBR,KAAKS,cAAcH,GAE3C,IAEE,MAAMI,EAAcV,KAAKW,qBAAqBH,GAGxCI,QAAiBZ,KAAKE,MAAMG,QAAQK,GAG1C,OAAOV,KAAKa,yBAA4BD,EAAUJ,EACpD,CAAA,MACOM,GACL,MAAMd,KAAKe,iBAAiBD,EAAON,EACrC,CACF,CAKQ,oBAAAG,CAAqBL,GAE3B,IAAIU,EAAWV,EAAOW,KAAO,GAC7B,MAAMC,EAAkBZ,EAAOa,QAAU,CAAA,EACnCC,EAAUd,EAAOc,QAGjBC,EAAWL,EAASM,MAAM,KAChC,GAAID,EAASE,OAAS,EAAG,CACvBP,EAAWK,EAAS,GACpB,MAAMG,EAAcH,EAAS,GACX,IAAII,gBAAgBD,GAG5BE,QAAQ,CAACC,EAAOC,KAExB,MAAMC,EAAWC,OAAOH,GACxBT,EAAgBU,GAAQE,OAAOC,MAAMF,IAAuB,KAAVF,EAA0BA,EAAXE,GAErE,CAGIT,GAAWJ,EAASgB,WAAWZ,KACjCJ,EAAWA,EAASiB,UAAUb,EAAQG,QAEjCP,EAASgB,WAAW,OACvBhB,EAAW,IAAIA,MAInB,MAAMN,EAAmB,CACvBO,IAAKD,EACLkB,OAAQ5B,EAAO4B,QA6BjB,GAzBI5B,EAAO6B,SAAWC,OAAOC,KAAK/B,EAAO6B,SAASZ,OAAS,IACzDb,EAAYyB,QAAU7B,EAAO6B,cAEX,IAAhB7B,EAAOgC,OACT5B,EAAY4B,KAAOhC,EAAOgC,WAEL,IAAnBhC,EAAOiC,UACT7B,EAAY6B,QAAUjC,EAAOiC,SAE3BnB,IACFV,EAAYU,QAAUA,QAEO,IAA3Bd,EAAOkC,kBACT9B,EAAY8B,gBAAkBlC,EAAOkC,iBAEnClC,EAAOmC,SACT/B,EAAY+B,OAASnC,EAAOmC,QAI1BvB,GAAmBkB,OAAOC,KAAKnB,GAAiBK,OAAS,IAC3Db,EAAYS,OAASD,GAInBZ,EAAOoC,aACT,OAAQpC,EAAOoC,cACb,IAAK,OAeL,QACEhC,EAAYgC,aAAe,aAb7B,IAAK,OACHhC,EAAYgC,aAAe,OAC3B,MACF,IAAK,OACHhC,EAAYgC,aAAe,OAC3B,MACF,IAAK,cACHhC,EAAYgC,aAAe,cAC3B,MACF,IAAK,SACHhC,EAAYgC,aAAe,SAQjC,cAAOL,KAAK3B,GAAagB,QAASE,SACP,IAArBlB,EAAYkB,WACPlB,EAAYkB,KAIhBlB,CACT,CAKQ,wBAAAG,CACN8B,EACArC,GAGA,MAAMsC,EAAmB,CACvB3B,IAAKX,EAAOW,KAGd,OAAOjB,KAAK6C,gBACVF,EAAcL,KACdK,EAAcG,OACdH,EAAcI,WACdJ,EAAcR,SAAW,CAAA,EACzBS,EAEJ,CAKQ,gBAAA7B,CAAiBD,EAAYR,GACnC,GAAIQ,EAAMF,SAAU,CAElB,MAAMA,EAAWZ,KAAKa,yBAAyBC,EAAMF,SAAUN,GACzDwC,EAAShC,EAAMF,SAASkC,OACxBE,EAAU,mCAAmCF,IAC7CG,EAAYjD,KAAKkD,aAAa,IAAI3C,MAAMyC,GAAU1C,EAAQM,GAChE,OAAAqC,EAAUH,OAASA,EACnBG,EAAUrC,SAAWA,EACdqC,CACT,IACSnC,EAAMT,QAAS,CAEtB,MAAM4C,EAAYjD,KAAKkD,aAAapC,EAAOR,GAC3C,OAAA2C,EAAUE,gBAAiB,EACpBF,CACT,CAGE,OAAOjD,KAAKkD,aAAapC,EAAOR,EAEpC,SACD8C"}
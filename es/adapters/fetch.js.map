{"version":3,"file":"fetch.js","sources":["../../src/adapters/fetch.ts"],"sourcesContent":["import type { RequestConfig, ResponseData } from '../types'\r\nimport { isArrayBuffer, isBlob, isFormData, isURLSearchParams } from '../utils'\r\nimport { BaseAdapter } from './base'\r\n\r\n/**\r\n * Fetch 适配器\r\n */\r\nexport class FetchAdapter extends BaseAdapter {\r\n  name = 'fetch'\r\n\r\n  /**\r\n   * 检查是否支持 fetch API\r\n   */\r\n  isSupported(): boolean {\r\n    return (\r\n      typeof fetch !== 'undefined' && typeof AbortController !== 'undefined'\r\n    )\r\n  }\r\n\r\n  /**\r\n   * 发送请求\r\n   */\r\n  async request<T = unknown>(config: RequestConfig): Promise<ResponseData<T>> {\r\n    const processedConfig = this.processConfig(config)\r\n\r\n    try {\r\n      // 创建超时控制器\r\n      const timeoutController = this.createTimeoutController(\r\n        processedConfig.timeout,\r\n      )\r\n\r\n      // 合并 AbortSignal\r\n      const signal = this.mergeAbortSignals([\r\n        processedConfig.signal,\r\n        timeoutController.signal,\r\n      ])\r\n\r\n      // 构建 fetch 选项\r\n      const fetchOptions: RequestInit = {\r\n        method: processedConfig.method,\r\n        headers: this.buildHeaders(processedConfig),\r\n        signal,\r\n        credentials: processedConfig.withCredentials\r\n          ? 'include'\r\n          : 'same-origin',\r\n      }\r\n\r\n      // 处理请求体\r\n      if (\r\n        processedConfig.data\r\n        && processedConfig.method !== 'GET'\r\n        && processedConfig.method !== 'HEAD'\r\n      ) {\r\n        fetchOptions.body = this.buildBody(\r\n          processedConfig.data,\r\n          processedConfig.headers,\r\n        )\r\n      }\r\n\r\n      // 发送请求\r\n      const response = await fetch(processedConfig.url!, fetchOptions)\r\n\r\n      // 清理超时定时器\r\n      timeoutController.cleanup()\r\n\r\n      // 处理响应\r\n      return await this.handleResponse<T>(response, processedConfig)\r\n    }\r\n    catch (error) {\r\n      throw this.processError(error, processedConfig)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 构建请求头\r\n   */\r\n  private buildHeaders(config: RequestConfig): HeadersInit {\r\n    const headers: Record<string, string> = { ...config.headers }\r\n\r\n    // 如果没有设置 Content-Type 且有数据，自动设置\r\n    if (config.data && !headers['content-type'] && !headers['Content-Type']) {\r\n      if (typeof config.data === 'string') {\r\n        headers['Content-Type'] = 'text/plain'\r\n      }\r\n      else if (isFormData(config.data)) {\r\n        // FormData 会自动设置 Content-Type，包括 boundary\r\n        delete headers['Content-Type']\r\n      }\r\n      else if (isURLSearchParams(config.data)) {\r\n        headers['Content-Type'] = 'application/x-www-form-urlencoded'\r\n      }\r\n      else if (typeof config.data === 'object') {\r\n        headers['Content-Type'] = 'application/json'\r\n      }\r\n    }\r\n\r\n    return headers\r\n  }\r\n\r\n  /**\r\n   * 构建请求体\r\n   */\r\n  private buildBody(data: any, headers?: Record<string, string>): BodyInit {\r\n    if (data === null || data === undefined) {\r\n      return undefined as any\r\n    }\r\n\r\n    // 直接支持的类型\r\n    if (\r\n      typeof data === 'string'\r\n      || isFormData(data)\r\n      || isBlob(data)\r\n      || isArrayBuffer(data)\r\n      || isURLSearchParams(data)\r\n      || data instanceof ReadableStream\r\n    ) {\r\n      return data\r\n    }\r\n\r\n    // 对象类型，根据 Content-Type 处理\r\n    const contentType\r\n      = headers?.['content-type'] || headers?.['Content-Type'] || ''\r\n\r\n    if (contentType.includes('application/x-www-form-urlencoded')) {\r\n      const params = new URLSearchParams()\r\n      Object.keys(data).forEach((key) => {\r\n        const value = data[key]\r\n        if (value !== null && value !== undefined) {\r\n          params.append(key, String(value))\r\n        }\r\n      })\r\n      return params\r\n    }\r\n\r\n    // 默认 JSON 序列化\r\n    return JSON.stringify(data)\r\n  }\r\n\r\n  /**\r\n   * 处理响应\r\n   */\r\n  private async handleResponse<T>(\r\n    response: Response,\r\n    config: RequestConfig,\r\n  ): Promise<ResponseData<T>> {\r\n    const headers = this.parseHeaders(response.headers)\r\n\r\n    // 解析响应数据\r\n    const data = await this.parseResponseData<T>(response, config.responseType)\r\n\r\n    // 检查状态码\r\n    if (!response.ok) {\r\n      const error = this.processError(\r\n        new Error(`Request failed with status ${response.status}`),\r\n        config,\r\n        this.processResponse(\r\n          data,\r\n          response.status,\r\n          response.statusText,\r\n          headers,\r\n          config,\r\n          response,\r\n        ),\r\n      )\r\n      throw error\r\n    }\r\n\r\n    return this.processResponse(\r\n      data,\r\n      response.status,\r\n      response.statusText,\r\n      headers,\r\n      config,\r\n      response,\r\n    )\r\n  }\r\n\r\n  /**\r\n   * 解析响应数据\r\n   */\r\n  private async parseResponseData<T>(\r\n    response: Response,\r\n    responseType?: string,\r\n  ): Promise<T> {\r\n    if (!response.body) {\r\n      return null as T\r\n    }\r\n\r\n    try {\r\n      switch (responseType) {\r\n        case 'text':\r\n          return (await response.text()) as T\r\n        case 'blob':\r\n          return (await response.blob()) as T\r\n        case 'arrayBuffer':\r\n          return (await response.arrayBuffer()) as T\r\n        case 'stream':\r\n          return response.body as T\r\n        case 'json':\r\n        default: {\r\n          // 检查 Content-Type\r\n          const contentType = response.headers.get('content-type') || ''\r\n          if (contentType.includes('application/json')) {\r\n            return await response.json()\r\n          }\r\n          else if (contentType.includes('text/')) {\r\n            return (await response.text()) as T\r\n          }\r\n          else {\r\n            // 尝试解析为 JSON，失败则返回文本\r\n            const text = await response.text()\r\n            try {\r\n              return JSON.parse(text)\r\n            }\r\n            catch {\r\n              return text as T\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    catch {\r\n      // 解析失败，返回空值\r\n      return null as T\r\n    }\r\n  }\r\n}\r\n"],"names":["FetchAdapter","BaseAdapter","constructor","this","name","isSupported","fetch","AbortController","request","config","processedConfig","processConfig","timeoutController","createTimeoutController","timeout","signal","mergeAbortSignals","fetchOptions","method","headers","buildHeaders","credentials","withCredentials","data","body","buildBody","response","url","cleanup","handleResponse","error","processError","isFormData","isURLSearchParams","isBlob","isArrayBuffer","ReadableStream","includes","params","URLSearchParams","keys","forEach","key","value","append","String","JSON","stringify","parseHeaders","parseResponseData","responseType","ok","Error","status","processResponse","statusText","text","blob","arrayBuffer","contentType","get","json","parse","d"],"mappings":"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"}
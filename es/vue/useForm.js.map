{"version":3,"file":"useForm.js","sources":["../../src/vue/useForm.ts"],"sourcesContent":["import type { Ref } from 'vue'\nimport type { HttpClientConfig, RequestConfig } from '../types'\nimport { computed, onUnmounted, reactive, ref } from 'vue'\nimport { createHttpClient } from '../factory'\n\n/**\n * 表单验证规则\n */\nexport interface ValidationRule<T = any> {\n  required?: boolean\n  min?: number\n  max?: number\n  pattern?: RegExp\n  validator?: (value: T) => boolean | string\n  message?: string\n}\n\n/**\n * 表单字段配置\n */\nexport interface FormField<T = any> {\n  value: T\n  rules?: ValidationRule<T>[]\n  error?: string\n}\n\n/**\n * 表单选项\n */\nexport interface FormOptions<T> {\n  /** 初始数据 */\n  initialData?: Partial<T>\n  /** 是否在组件卸载时取消请求 */\n  cancelOnUnmount?: boolean\n  /** 提交成功回调 */\n  onSuccess?: (data: any, response: any) => void\n  /** 提交失败回调 */\n  onError?: (error: Error) => void\n  /** 验证失败回调 */\n  onValidationError?: (errors: Record<string, string>) => void\n  /** HTTP客户端配置 */\n  clientConfig?: HttpClientConfig\n}\n\n/**\n * 表单返回值\n */\nexport interface FormReturn<T> {\n  /** 表单数据 */\n  data: T\n  /** 提交状态 */\n  submitting: Ref<boolean>\n  /** 错误信息 */\n  error: Ref<Error | null>\n  /** 验证错误 */\n  errors: Ref<Record<string, string>>\n  /** 是否有错误 */\n  hasError: Ref<boolean>\n  /** 是否有验证错误 */\n  hasValidationErrors: Ref<boolean>\n  /** 是否有任何错误 */\n  hasAnyError: Ref<boolean>\n  /** 表单是否有效 */\n  isValid: Ref<boolean>\n  /** 提交表单 */\n  submit: (url: string, config?: RequestConfig) => Promise<any>\n  /** 验证表单 */\n  validate: () => boolean\n  /** 验证单个字段 */\n  validateField: (field: keyof T) => boolean\n  /** 重置表单 */\n  reset: () => void\n  /** 清除错误 */\n  clearErrors: () => void\n  /** 清除验证错误 */\n  clearValidationErrors: () => void\n  /** 设置字段值 */\n  setField: (field: keyof T, value: any) => void\n  /** 设置字段错误 */\n  setFieldError: (field: keyof T, error: string) => void\n}\n\n/**\n * 表单管理hook\n * 提供表单数据管理、验证和提交功能\n *\n * @example\n * ```ts\n * const { data, submitting, errors, submit, validate } = useForm<User>({\n *   initialData: { name: '', email: '' }\n * })\n *\n * // 设置验证规则\n * const rules = {\n *   name: [{ required: true, message: '姓名不能为空' }],\n *   email: [\n *     { required: true, message: '邮箱不能为空' },\n *     { pattern: /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/, message: '邮箱格式不正确' }\n *   ]\n * }\n *\n * // 提交表单\n * const handleSubmit = async () => {\n *   if (validate()) {\n *     await submit('/api/users')\n *   }\n * }\n * ```\n */\nexport function useForm<T extends Record<string, any>>(\n  options: FormOptions<T> = {},\n): FormReturn<T> {\n  const client = createHttpClient(options.clientConfig)\n\n  // 响应式状态\n  const data = reactive({ ...options.initialData } as T)\n  const submitting = ref(false)\n  const error = ref<Error | null>(null)\n  const errors = ref<Record<string, string>>({})\n\n  // 验证规则存储\n  const validationRules = ref<Record<string, ValidationRule[]>>({})\n\n  const hasError = computed(() => error.value !== null)\n  const hasValidationErrors = computed(() => Object.keys(errors.value).length > 0)\n  const hasAnyError = computed(() => hasError.value || hasValidationErrors.value)\n  const isValid = computed(() => !hasValidationErrors.value)\n\n  let abortController: AbortController | null = null\n\n  /**\n   * 验证单个字段\n   */\n  const validateField = (field: keyof T): boolean => {\n    const rules = validationRules.value[field as string]\n    if (!rules || rules.length === 0)\n      return true\n\n    const value = (data as any)[field]\n\n    for (const rule of rules) {\n      // 必填验证\n      if (rule.required && (value === undefined || value === null || value === '')) {\n        errors.value[field as string] = rule.message || `${String(field)} is required`\n        return false\n      }\n\n      // 跳过空值的其他验证\n      if (value === undefined || value === null || value === '') {\n        continue\n      }\n\n      // 最小长度验证\n      if (rule.min !== undefined && String(value).length < rule.min) {\n        errors.value[field as string] = rule.message || `${String(field)} must be at least ${rule.min} characters`\n        return false\n      }\n\n      // 最大长度验证\n      if (rule.max !== undefined && String(value).length > rule.max) {\n        errors.value[field as string] = rule.message || `${String(field)} must be at most ${rule.max} characters`\n        return false\n      }\n\n      // 正则验证\n      if (rule.pattern && !rule.pattern.test(String(value))) {\n        errors.value[field as string] = rule.message || `${String(field)} format is invalid`\n        return false\n      }\n\n      // 自定义验证\n      if (rule.validator) {\n        const result = rule.validator(value)\n        if (result !== true) {\n          errors.value[field as string] = typeof result === 'string' ? result : (rule.message || `${String(field)} is invalid`)\n          return false\n        }\n      }\n    }\n\n    // 验证通过，清除错误\n    delete errors.value[field as string]\n    return true\n  }\n\n  /**\n   * 验证整个表单\n   */\n  const validate = (): boolean => {\n    let isFormValid = true\n\n    for (const field in validationRules.value) {\n      if (!validateField(field)) {\n        isFormValid = false\n      }\n    }\n\n    if (!isFormValid && options.onValidationError) {\n      options.onValidationError(errors.value)\n    }\n\n    return isFormValid\n  }\n\n  /**\n   * 提交表单\n   */\n  const submit = async (url: string, config?: RequestConfig): Promise<any> => {\n    try {\n      submitting.value = true\n      error.value = null\n\n      // 验证表单\n      if (!validate()) {\n        return null\n      }\n\n      // 取消之前的请求\n      if (abortController) {\n        abortController.abort()\n      }\n      abortController = new AbortController()\n\n      const requestConfig = {\n        ...config,\n        signal: abortController.signal,\n      }\n\n      const response = await client.post(url, data, requestConfig)\n\n      options.onSuccess?.(response.data, response)\n      return response.data\n    }\n    catch (err) {\n      const errorObj = err as Error\n      if (errorObj.name !== 'AbortError') {\n        error.value = errorObj\n        options.onError?.(errorObj)\n      }\n      throw errorObj\n    }\n    finally {\n      submitting.value = false\n    }\n  }\n\n  /**\n   * 重置表单\n   */\n  const reset = () => {\n    Object.assign(data, options.initialData || {})\n    submitting.value = false\n    error.value = null\n    errors.value = {}\n  }\n\n  /**\n   * 清除错误\n   */\n  const clearErrors = () => {\n    error.value = null\n  }\n\n  /**\n   * 清除验证错误\n   */\n  const clearValidationErrors = () => {\n    errors.value = {}\n  }\n\n  /**\n   * 设置字段值\n   */\n  const setField = (field: keyof T, value: any) => {\n    ;(data as any)[field] = value\n    // 设置值后自动验证该字段\n    if (validationRules.value[field as string]) {\n      validateField(field)\n    }\n  }\n\n  /**\n   * 设置字段错误\n   */\n  const setFieldError = (field: keyof T, errorMessage: string) => {\n    errors.value[field as string] = errorMessage\n  }\n\n  /**\n   * 设置验证规则\n   */\n  const setValidationRules = (rules: Record<keyof T, ValidationRule[]>) => {\n    validationRules.value = rules as Record<string, ValidationRule[]>\n  }\n\n  // 组件卸载时取消请求\n  if (options.cancelOnUnmount !== false) {\n    onUnmounted(() => {\n      if (abortController) {\n        abortController.abort()\n      }\n    })\n  }\n\n  return {\n    data,\n    submitting,\n    error,\n    errors,\n    hasError,\n    hasValidationErrors,\n    hasAnyError,\n    isValid,\n    submit,\n    validate,\n    validateField,\n    reset,\n    clearErrors,\n    clearValidationErrors,\n    setField,\n    setFieldError,\n    // 额外的方法\n    setValidationRules,\n  } as FormReturn<T> & { setValidationRules: (rules: Record<keyof T, ValidationRule[]>) => void }\n}\n"],"names":["useForm","options","client","createHttpClient","clientConfig","data","reactive","initialData","submitting","ref","error","errors","validationRules","hasError","computed","value","hasValidationErrors","Object","keys","length","hasAnyError","isValid","abortController","validateField","field","rules","rule","required","message","String","min","max","pattern","test","validator","result","validate","isFormValid","onValidationError","cancelOnUnmount","onUnmounted","abort","submit","async","url","config","AbortController","requestConfig","signal","response","post","onSuccess","err","errorObj","name","onError","reset","assign","clearErrors","clearValidationErrors","setField","setFieldError","errorMessage","setValidationRules","q"],"mappings":"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"}
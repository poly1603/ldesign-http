{"version":3,"file":"useRequest.js","sources":["../../src/vue/useRequest.ts"],"sourcesContent":["import type { MaybeRef, Ref } from 'vue'\r\nimport type {\r\n  HttpClient,\r\n  HttpError,\r\n  RequestConfig,\r\n  ResponseData,\r\n} from '../types'\r\nimport type { UseRequestOptions, UseRequestReturn } from '../types/vue'\r\nimport { computed, onUnmounted, ref, unref, watch } from 'vue'\r\nimport { createCancelTokenSource, isCancelError } from '../utils/cancel'\r\n\r\n/**\r\n * useRequest Hook\r\n * 用于处理 HTTP 请求的 Vue 3 Composition API Hook\r\n */\r\nexport function useRequest<T = any>(\r\n  client: HttpClient,\r\n  config: MaybeRef<RequestConfig>,\r\n  options: UseRequestOptions<T> = {},\r\n): UseRequestReturn<T> {\r\n  // 响应式状态\r\n  const data = ref<T | null>(options.initialData ?? null)\r\n  const loading = ref<boolean>(false)\r\n  const error = ref<HttpError | null>(null)\r\n  const finished = ref<boolean>(false)\r\n\r\n  // 取消控制\r\n  let cancelTokenSource = createCancelTokenSource()\r\n\r\n  // 计算属性\r\n  const canCancel = computed(() => loading.value)\r\n\r\n  /**\r\n   * 执行请求\r\n   */\r\n  const execute = async (\r\n    overrideConfig?: RequestConfig,\r\n  ): Promise<ResponseData<T>> => {\r\n    // 重置状态\r\n    loading.value = true\r\n    error.value = null\r\n    finished.value = false\r\n\r\n    // 创建新的取消令牌\r\n    cancelTokenSource = createCancelTokenSource()\r\n\r\n    try {\r\n      // 合并配置\r\n      const requestConfig: RequestConfig = {\r\n        ...unref(config),\r\n        ...overrideConfig,\r\n        signal: cancelTokenSource.token.promise as any,\r\n      }\r\n\r\n      // 发送请求\r\n      const response = await client.request<T>(requestConfig)\r\n\r\n      // 转换数据\r\n      let responseData = response.data\r\n      if (typeof options.transform === 'function') {\r\n        responseData = options.transform(response.data)\r\n      }\r\n\r\n      // 更新状态\r\n      data.value = responseData\r\n      finished.value = true\r\n\r\n      // 调用成功回调\r\n      if (typeof options.onSuccess === 'function') {\r\n        options.onSuccess(responseData, response)\r\n      }\r\n\r\n      return response\r\n    }\r\n    catch (err) {\r\n      const httpError = err as HttpError\r\n\r\n      // 如果不是取消错误，更新错误状态\r\n      if (!isCancelError(httpError)) {\r\n        error.value = httpError\r\n        finished.value = true\r\n\r\n        // 调用错误回调\r\n      if (typeof options.onError === 'function') {\r\n        options.onError(httpError)\r\n      }\r\n      }\r\n\r\n      throw httpError\r\n    }\r\n    finally {\r\n      loading.value = false\r\n\r\n      // 调用完成回调\r\n      if (typeof options.onFinally === 'function') {\r\n        options.onFinally()\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 刷新请求\r\n   */\r\n  const refresh = (): Promise<ResponseData<T>> => {\r\n    return execute()\r\n  }\r\n\r\n  /**\r\n   * 取消请求\r\n   */\r\n  const cancel = (): void => {\r\n    if (canCancel.value) {\r\n      cancelTokenSource.cancel('Request cancelled by user')\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 重置状态\r\n   */\r\n  const reset = (): void => {\r\n    data.value = (options.initialData as T | null) ?? null\r\n    loading.value = false\r\n    error.value = null\r\n    finished.value = false\r\n  }\r\n\r\n  // 监听配置变化\r\n  if (options.immediate !== false) {\r\n    watch(\r\n      () => unref(config),\r\n      () => {\r\n        execute()\r\n      },\r\n      { immediate: true, deep: true },\r\n    )\r\n  }\r\n\r\n  // 组件卸载时取消请求\r\n  if (options.cancelOnUnmount !== false) {\r\n    onUnmounted(() => {\r\n      cancel()\r\n    })\r\n  }\r\n\r\n  return {\r\n    data: data as Ref<T | null>,\r\n    loading,\r\n    error,\r\n    finished,\r\n    execute,\r\n    refresh,\r\n    cancel,\r\n    reset,\r\n    canCancel,\r\n  }\r\n}\r\n\r\n/**\r\n * 简化的 useRequest Hook，用于单次请求\r\n */\r\nexport function useAsyncRequest<T = any>(\r\n  _client: HttpClient,\r\n  requestFn: () => Promise<ResponseData<T>>,\r\n  options: Omit<UseRequestOptions<T>, 'immediate'> = {},\r\n): UseRequestReturn<T> {\r\n  const data = ref<T | null>((options.initialData as T | null) ?? null)\r\n  const loading = ref<boolean>(false)\r\n  const error = ref<HttpError | null>(null)\r\n  const finished = ref<boolean>(false)\r\n\r\n  let cancelTokenSource = createCancelTokenSource()\r\n\r\n  const canCancel = computed(() => loading.value)\r\n\r\n  const execute = async (): Promise<ResponseData<T>> => {\r\n    loading.value = true\r\n    error.value = null\r\n    finished.value = false\r\n\r\n    cancelTokenSource = createCancelTokenSource()\r\n\r\n    try {\r\n      const response = await requestFn()\r\n\r\n      let responseData = response.data\r\n      if (typeof options.transform === 'function') {\r\n        responseData = options.transform(response.data)\r\n      }\r\n\r\n      data.value = responseData\r\n      finished.value = true\r\n\r\n      if (typeof options.onSuccess === 'function') {\r\n        options.onSuccess(responseData, response)\r\n      }\r\n\r\n      return response\r\n    }\r\n    catch (err) {\r\n      const httpError = err as HttpError\r\n\r\n      if (!isCancelError(httpError)) {\r\n        error.value = httpError\r\n        finished.value = true\r\n\r\n        if (typeof options.onError === 'function') {\r\n          options.onError(httpError)\r\n        }\r\n      }\r\n\r\n      throw httpError\r\n    }\r\n    finally {\r\n      loading.value = false\r\n\r\n      if (typeof options.onFinally === 'function') {\r\n        options.onFinally()\r\n      }\r\n    }\r\n  }\r\n\r\n  const refresh = execute\r\n  const cancel = (): void => {\r\n    if (canCancel.value) {\r\n      cancelTokenSource.cancel('Request cancelled by user')\r\n    }\r\n  }\r\n\r\n  const reset = (): void => {\r\n    data.value = (options.initialData as T | null) ?? null\r\n    loading.value = false\r\n    error.value = null\r\n    finished.value = false\r\n  }\r\n\r\n  if (options.cancelOnUnmount !== false) {\r\n    onUnmounted(() => {\r\n      cancel()\r\n    })\r\n  }\r\n\r\n  return {\r\n    data: data as Ref<T | null>,\r\n    loading,\r\n    error,\r\n    finished,\r\n    execute,\r\n    refresh,\r\n    cancel,\r\n    reset,\r\n    canCancel,\r\n  }\r\n}\r\n"],"names":["useRequest","client","config","options","data","ref","initialData","loading","error","finished","cancelTokenSource","createCancelTokenSource","canCancel","computed","value","execute","async","requestConfig","unref","overrideConfig","signal","token","promise","response","request","responseData","transform","onSuccess","err","httpError","isCancelError","onError","onFinally","cancel","immediate","watch","deep","cancelOnUnmount","onUnmounted","refresh","reset","useAsyncRequest","_client","requestFn","R","F"],"mappings":"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"}
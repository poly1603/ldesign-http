{"version":3,"file":"useThrottledRequest.js","sources":["../../src/vue/useThrottledRequest.ts"],"sourcesContent":["import type { MaybeRef, Ref } from 'vue'\r\nimport type { HttpClient, RequestConfig } from '../types'\r\nimport { ref, unref } from 'vue'\r\n\r\n/**\r\n * 防抖/节流请求选项\r\n */\r\nexport interface ThrottleOptions {\r\n  /** 延迟时间（毫秒） */\r\n  delay?: number\r\n  /** 是否使用防抖（false为节流） */\r\n  debounce?: boolean\r\n  /** 是否在前沿触发 */\r\n  leading?: boolean\r\n  /** 是否在后沿触发 */\r\n  trailing?: boolean\r\n}\r\n\r\n/**\r\n * 防抖请求 Hook\r\n *\r\n * 防止用户快速点击导致的重复请求\r\n *\r\n * @example\r\n * ```typescript\r\n * const { execute, loading, data } = useDebouncedRequest(\r\n *   client,\r\n *   { url: '/api/search' },\r\n *   { delay: 300 }\r\n * )\r\n *\r\n * // 用户输入时调用,300ms内只发送最后一次请求\r\n * watch(searchQuery, (query) => {\r\n *   execute({ params: { q: query } })\r\n * })\r\n * ```\r\n */\r\nexport function useDebouncedRequest<T = any>(\r\n  client: HttpClient,\r\n  baseConfig: MaybeRef<RequestConfig>,\r\n  options: ThrottleOptions = {},\r\n) {\r\n  const { delay = 300 } = options\r\n  const loading = ref(false)\r\n  const data = ref<T | null>(null)\r\n  const error = ref<Error | null>(null)\r\n\r\n  let timeoutId: ReturnType<typeof setTimeout> | null = null\r\n\r\n  const execute = async (config?: RequestConfig): Promise<T | null> => {\r\n    // 取消之前的定时器\r\n    if (timeoutId) {\r\n      clearTimeout(timeoutId)\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n      timeoutId = setTimeout(async () => {\r\n        try {\r\n          loading.value = true\r\n          error.value = null\r\n\r\n          const mergedConfig = {\r\n            ...unref(baseConfig),\r\n            ...config,\r\n          }\r\n\r\n          const response = await client.request<T>(mergedConfig)\r\n          data.value = response.data\r\n\r\n          resolve(response.data)\r\n        }\r\n        catch (err) {\r\n          error.value = err as Error\r\n          reject(err)\r\n        }\r\n        finally {\r\n          loading.value = false\r\n          timeoutId = null\r\n        }\r\n      }, delay)\r\n    })\r\n  }\r\n\r\n  const cancel = () => {\r\n    if (timeoutId) {\r\n      clearTimeout(timeoutId)\r\n      timeoutId = null\r\n    }\r\n  }\r\n\r\n  return {\r\n    execute,\r\n    cancel,\r\n    loading,\r\n    data: data as Ref<T | null>,\r\n    error,\r\n  }\r\n}\r\n\r\n/**\r\n * 节流请求 Hook\r\n *\r\n * 限制请求频率,在指定时间内最多执行一次\r\n *\r\n * @example\r\n * ```typescript\r\n * const { execute, loading } = useThrottledRequest(\r\n *   client,\r\n *   { url: '/api/save' },\r\n *   { delay: 1000 }\r\n * )\r\n *\r\n * // 1秒内多次调用只执行第一次\r\n * button.addEventListener('click', () => execute())\r\n * ```\r\n */\r\nexport function useThrottledRequest<T = any>(\r\n  client: HttpClient,\r\n  baseConfig: MaybeRef<RequestConfig>,\r\n  options: ThrottleOptions = {},\r\n) {\r\n  const { delay = 1000, leading = true, trailing = false } = options\r\n  const loading = ref(false)\r\n  const data = ref<T | null>(null)\r\n  const error = ref<Error | null>(null)\r\n\r\n  let lastExecuteTime = 0\r\n  let timeoutId: ReturnType<typeof setTimeout> | null = null\r\n  let lastArgs: RequestConfig | undefined\r\n\r\n  const execute = async (config?: RequestConfig): Promise<T | null> => {\r\n    const now = Date.now()\r\n    const elapsed = now - lastExecuteTime\r\n\r\n    lastArgs = config\r\n\r\n    const doExecute = async () => {\r\n      try {\r\n        loading.value = true\r\n        error.value = null\r\n\r\n        const mergedConfig = {\r\n          ...unref(baseConfig),\r\n          ...lastArgs,\r\n        }\r\n\r\n        const response = await client.request<T>(mergedConfig)\r\n        data.value = response.data\r\n\r\n        lastExecuteTime = Date.now()\r\n        return response.data\r\n      }\r\n      catch (err) {\r\n        error.value = err as Error\r\n        throw err\r\n      }\r\n      finally {\r\n        loading.value = false\r\n      }\r\n    }\r\n\r\n    // Leading edge\r\n    if (leading && elapsed > delay) {\r\n      if (timeoutId) {\r\n        clearTimeout(timeoutId)\r\n        timeoutId = null\r\n      }\r\n      return doExecute()\r\n    }\r\n\r\n    // Trailing edge\r\n    if (trailing) {\r\n      if (timeoutId) {\r\n        clearTimeout(timeoutId)\r\n      }\r\n\r\n      return new Promise((resolve, reject) => {\r\n        timeoutId = setTimeout(async () => {\r\n          try {\r\n            const result = await doExecute()\r\n            resolve(result)\r\n          }\r\n          catch (err) {\r\n            reject(err)\r\n          }\r\n          finally {\r\n            timeoutId = null\r\n          }\r\n        }, delay - elapsed)\r\n      })\r\n    }\r\n\r\n    return null\r\n  }\r\n\r\n  return {\r\n    execute,\r\n    loading,\r\n    data: data as Ref<T | null>,\r\n    error,\r\n  }\r\n}\r\n"],"names":["useDebouncedRequest","client","baseConfig","options","delay","loading","ref","data","error","timeoutId","execute","async","clearTimeout","Promise","resolve","reject","setTimeout","value","mergedConfig","unref","config","response","request","err","cancel","useThrottledRequest","leading","trailing","lastArgs","lastExecuteTime","elapsed","Date","now","doExecute","result","q","p"],"mappings":"qCAqCM,SAAUA,EACdC,EACAC,EACAC,EAA2B,CAAA,GAE3B,MAAQC,MAAAA,EAAQ,KAAQD,EAClBE,EAAUC,GAAI,GACdC,EAAOD,EAAc,MACrBE,EAAQF,EAAkB,MAEhC,IAAIG,EAAkD,KA2CtD,MAAO,CACLC,QA1CcC,UAEVF,GACFG,aAAaH,GAGR,IAAII,QAAQ,CAACC,EAASC,KAC3BN,EAAYO,WAAWL,UACrB,IACEN,EAAQY,OAAQ,EAChBT,EAAMS,MAAQ,KAEd,MAAMC,EAAe,IAChBC,EAAMjB,MACNkB,GAGCC,QAAiBpB,EAAOqB,QAAWJ,GACzCX,EAAKU,MAAQI,EAASd,KAEtBO,EAAQO,EAASd,KACnB,CAAA,MACOgB,GACLf,EAAMS,MAAQM,EACdR,EAAOQ,EACT,CAAA,QAEElB,EAAQY,OAAQ,EAChBR,EAAY,IACd,GACCL,MAaLoB,OATa,KACTf,IACFG,aAAaH,GACbA,EAAY,OAOdJ,QAAAA,EACAE,KAAMA,EACNC,MAAAA,EAEJ,CAmBM,SAAUiB,EACdxB,EACAC,EACAC,EAA2B,IAE3B,MAAQC,MAAAA,EAAQ,IAAMsB,QAAAA,GAAU,EAAMC,SAAAA,GAAW,GAAUxB,EACrDE,EAAUC,GAAI,GACdC,EAAOD,EAAc,MACrBE,EAAQF,EAAkB,MAEhC,IAEIsB,EAFAC,EAAkB,EAClBpB,EAAkD,KAoEtD,MAAO,CACLC,QAlEcC,UAEd,MAAMmB,EADMC,KAAKC,MACKH,EAEtBD,EAAWR,EAEX,MAAMa,EAAYtB,UAChB,IACEN,EAAQY,OAAQ,EAChBT,EAAMS,MAAQ,KAEd,MAAMC,EAAe,IAChBC,EAAMjB,MACN0B,GAGCP,QAAiBpB,EAAOqB,QAAWJ,GACzC,OAAAX,EAAKU,MAAQI,EAASd,KAEtBsB,EAAkBE,KAAKC,MAChBX,EAASd,IAClB,CAAA,MACOgB,GACL,MAAAf,EAAMS,MAAQM,EACRA,CACR,CAAA,QAEElB,EAAQY,OAAQ,CAClB,GAIF,OAAIS,GAAWI,EAAU1B,GACnBK,IACFG,aAAaH,GACbA,EAAY,MAEPwB,KAILN,GACElB,GACFG,aAAaH,GAGR,IAAII,QAAQ,CAACC,EAASC,KAC3BN,EAAYO,WAAWL,UACrB,IACE,MAAMuB,QAAeD,IACrBnB,EAAQoB,EACV,OACOX,GACLR,EAAOQ,EACT,CAAA,QAEEd,EAAY,IACd,GACCL,EAAQ0B,MAIR,MAKPzB,QAAAA,EACAE,KAAMA,EACNC,MAAAA,EAEJ,QAAA2B,yBAAAC"}
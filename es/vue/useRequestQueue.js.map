{"version":3,"file":"useRequestQueue.js","sources":["../../src/vue/useRequestQueue.ts"],"sourcesContent":["import type { Ref } from 'vue'\r\nimport type { HttpClient, RequestConfig } from '../types'\r\nimport { computed, ref } from 'vue'\r\n\r\n/**\r\n * 请求队列项\r\n */\r\ninterface QueueItem<T> {\r\n  id: string\r\n  config: RequestConfig\r\n  priority: number\r\n  resolve: (value: T) => void\r\n  reject: (error: any) => void\r\n  createdAt: number\r\n}\r\n\r\n/**\r\n * 请求队列配置\r\n */\r\nexport interface RequestQueueConfig {\r\n  /** 最大并发数 */\r\n  concurrency?: number\r\n  /** 是否自动开始 */\r\n  autoStart?: boolean\r\n  /** 超时时间（毫秒） */\r\n  timeout?: number\r\n}\r\n\r\n/**\r\n * 请求队列 Hook\r\n *\r\n * 管理请求队列,控制并发,支持优先级\r\n *\r\n * @example\r\n * ```typescript\r\n * const queue = useRequestQueue(client, { concurrency: 3 })\r\n *\r\n * // 添加请求到队列\r\n * const result1 = await queue.enqueue({ url: '/api/data1' }, 1)\r\n * const result2 = await queue.enqueue({ url: '/api/data2' }, 2) // 高优先级\r\n *\r\n * // 查看队列状态\r\n *  // 2\r\n *  // 3\r\n * ```\r\n */\r\nexport function useRequestQueue<T = any>(\r\n  client: HttpClient,\r\n  config: RequestQueueConfig = {},\r\n) {\r\n  const { concurrency = 6, autoStart = true, timeout = 30000 } = config\r\n\r\n  const queue = ref<QueueItem<T>[]>([])\r\n  const activeRequests = ref<Set<string>>(new Set())\r\n  const completedCount = ref(0)\r\n  const failedCount = ref(0)\r\n  const isPaused = ref(!autoStart)\r\n\r\n  // 计算属性\r\n  const pending = computed(() => queue.value.length)\r\n  const active = computed(() => activeRequests.value.size)\r\n  const total = computed(() => completedCount.value + failedCount.value + pending.value + active.value)\r\n\r\n  /**\r\n   * 添加请求到队列\r\n   */\r\n  const enqueue = (requestConfig: RequestConfig, priority = 0): Promise<T> => {\r\n    return new Promise((resolve, reject) => {\r\n      const id = `${Date.now()}-${Math.random()}`\r\n      const item: QueueItem<T> = {\r\n        id,\r\n        config: requestConfig,\r\n        priority,\r\n        resolve,\r\n        reject,\r\n        createdAt: Date.now(),\r\n      }\r\n\r\n      // 按优先级插入队列\r\n      const insertIndex = queue.value.findIndex(q => q.priority < priority)\r\n      if (insertIndex === -1) {\r\n        queue.value.push(item)\r\n      }\r\n      else {\r\n        queue.value.splice(insertIndex, 0, item)\r\n      }\r\n\r\n      if (!isPaused.value) {\r\n        setTimeout(() => processQueue(), 0)\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 执行单个请求\r\n   */\r\n  const executeRequest = async (item: QueueItem<T>) => {\r\n    try {\r\n      // 检查超时\r\n      const elapsed = Date.now() - item.createdAt\r\n      if (elapsed > timeout) {\r\n        throw new Error('Request timeout in queue')\r\n      }\r\n\r\n      const response = await client.request<T>(item.config)\r\n      item.resolve(response.data)\r\n      completedCount.value++\r\n    }\r\n    catch (error) {\r\n      item.reject(error)\r\n      failedCount.value++\r\n    }\r\n    finally {\r\n      activeRequests.value.delete(item.id)\r\n      if (!isPaused.value) {\r\n        processQueue()\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 处理队列\r\n   */\r\n  async function processQueue() {\r\n    while (\r\n      !isPaused.value\r\n      && queue.value.length > 0\r\n      && activeRequests.value.size < concurrency\r\n    ) {\r\n      const item = queue.value.shift()\r\n      if (!item)\r\n        break\r\n\r\n      activeRequests.value.add(item.id)\r\n\r\n      // 执行请求\r\n      executeRequest(item).catch(() => {\r\n        // 错误已在executeRequest内部处理\r\n      })\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * 暂停队列处理\r\n   */\r\n  const pause = () => {\r\n    isPaused.value = true\r\n  }\r\n\r\n  /**\r\n   * 恢复队列处理\r\n   */\r\n  const resume = () => {\r\n    isPaused.value = false\r\n    processQueue()\r\n  }\r\n\r\n  /**\r\n   * 清空队列\r\n   */\r\n  const clear = () => {\r\n    queue.value.forEach((item) => {\r\n      item.reject(new Error('Queue cleared'))\r\n    })\r\n    queue.value = []\r\n  }\r\n\r\n  /**\r\n   * 取消所有活动请求\r\n   */\r\n  const cancelAll = () => {\r\n    client.cancelAll('Queue cancelled')\r\n    activeRequests.value.clear()\r\n  }\r\n\r\n  /**\r\n   * 重置统计\r\n   */\r\n  const reset = () => {\r\n    completedCount.value = 0\r\n    failedCount.value = 0\r\n  }\r\n\r\n  return {\r\n    // 队列操作\r\n    enqueue,\r\n    pause,\r\n    resume,\r\n    clear,\r\n    cancelAll,\r\n    reset,\r\n\r\n    // 状态\r\n    pending,\r\n    active,\r\n    total,\r\n    completed: completedCount,\r\n    failed: failedCount,\r\n    isPaused,\r\n\r\n    // 原始数据\r\n    queue: queue as Ref<QueueItem<T>[]>,\r\n    activeRequests,\r\n  }\r\n}\r\n"],"names":["useRequestQueue","client","config","concurrency","autoStart","timeout","queue","ref","activeRequests","Set","completedCount","failedCount","isPaused","pending","computed","value","length","active","size","total","executeRequest","async","Date","now","item","createdAt","Error","response","request","resolve","data","error","reject","delete","id","processQueue","shift","add","catch","enqueue","requestConfig","priority","Promise","Math","random","insertIndex","findIndex","q","push","splice","setTimeout","pause","resume","clear","forEach","cancelAll","reset","completed","failed","E"],"mappings":"iDA8CgBA,EACdC,EACAC,EAA6B,CAAA,GAE7B,MAAQC,YAAAA,EAAc,EAAGC,UAAAA,GAAY,EAAMC,QAAAA,EAAU,KAAUH,EAEzDI,EAAQC,EAAoB,IAC5BC,EAAiBD,EAAiB,IAAIE,KACtCC,EAAiBH,EAAI,GACrBI,EAAcJ,EAAI,GAClBK,EAAWL,GAAKH,GAGhBS,EAAUC,EAAS,IAAMR,EAAMS,MAAMC,QACrCC,EAASH,EAAS,IAAMN,EAAeO,MAAMG,MAC7CC,EAAQL,EAAS,IAAMJ,EAAeK,MAAQJ,EAAYI,MAAQF,EAAQE,MAAQE,EAAOF,OAmCzFK,EAAiBC,UACrB,IAGE,GADgBC,KAAKC,MAAQC,EAAKC,UACpBpB,EACZ,MAAM,IAAIqB,MAAM,4BAGlB,MAAMC,QAAiB1B,EAAO2B,QAAWJ,EAAKtB,QAC9CsB,EAAKK,QAAQF,EAASG,MACtBpB,EAAeK,OACjB,OACOgB,GACLP,EAAKQ,OAAOD,GACZpB,EAAYI,OACd,CAAA,QAEEP,EAAeO,MAAMkB,OAAOT,EAAKU,IAC5BtB,EAASG,OACZoB,GAEJ,GAMFd,eAAec,IACb,MACGvB,EAASG,OACPT,EAAMS,MAAMC,OAAS,GACrBR,EAAeO,MAAMG,KAAOf,GAC/B,CACA,MAAMqB,EAAOlB,EAAMS,MAAMqB,QACzB,IAAKZ,EACH,MAEFhB,EAAeO,MAAMsB,IAAIb,EAAKU,IAG9Bd,EAAeI,GAAMc,MAAM,OAG7B,CACF,CA4CA,MAAO,CAELC,QAxHc,CAACC,EAA8BC,EAAW,IACjD,IAAIC,QAAQ,CAACb,EAASG,KAE3B,MAAMR,EAAqB,CACzBU,GAFS,GAAGZ,KAAKC,SAASoB,KAAKC,WAG/B1C,OAAQsC,EACRC,SAAAA,EACAZ,QAAAA,EACAG,OAAAA,EACAP,UAAWH,KAAKC,OAIZsB,EAAcvC,EAAMS,MAAM+B,UAAUC,GAAKA,EAAEN,SAAWA,QACxDI,EACFvC,EAAMS,MAAMiC,KAAKxB,GAGjBlB,EAAMS,MAAMkC,OAAOJ,EAAa,EAAGrB,GAGhCZ,EAASG,OACZmC,WAAW,IAAMf,IAAgB,KAmGrCgB,MAzCY,KACZvC,EAASG,OAAQ,GAyCjBqC,OAnCa,KACbxC,EAASG,OAAQ,EACjBoB,KAkCAkB,MA5BY,KACZ/C,EAAMS,MAAMuC,QAAS9B,IACnBA,EAAKQ,OAAO,IAAIN,MAAM,oBAExBpB,EAAMS,MAAQ,IAyBdwC,UAnBgB,KAChBtD,EAAOsD,UAAU,mBACjB/C,EAAeO,MAAMsC,SAkBrBG,MAZY,KACZ9C,EAAeK,MAAQ,EACvBJ,EAAYI,MAAQ,GAapBF,QAAAA,EACAI,OAAAA,EACAE,MAAAA,EACAsC,UAAW/C,EACXgD,OAAQ/C,EACRC,SAAAA,EAGAN,MAAOA,EACPE,eAAAA,EAEJ,QAAAmD"}
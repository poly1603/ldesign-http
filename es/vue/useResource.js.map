{"version":3,"file":"useResource.js","sources":["../../src/vue/useResource.ts"],"sourcesContent":["import type { MaybeRef, Ref } from 'vue'\nimport type { HttpClientConfig, RequestConfig } from '../types'\nimport { computed, onUnmounted, ref, unref, watch } from 'vue'\nimport { createHttpClient } from '../factory'\n\n/**\n * 资源操作选项\n */\nexport interface ResourceOptions<T> {\n  /** 是否立即加载数据 */\n  immediate?: boolean\n  /** 是否在组件卸载时取消请求 */\n  cancelOnUnmount?: boolean\n  /** 数据转换函数 */\n  transform?: (data: any) => T\n  /** 成功回调 */\n  onSuccess?: (data: T, operation: 'list' | 'get' | 'create' | 'update' | 'delete') => void\n  /** 错误回调 */\n  onError?: (error: Error, operation: 'list' | 'get' | 'create' | 'update' | 'delete') => void\n  /** HTTP客户端配置 */\n  clientConfig?: HttpClientConfig\n}\n\n/**\n * 资源操作返回值\n */\nexport interface ResourceReturn<T> {\n  /** 数据列表 */\n  items: Ref<T[]>\n  /** 当前项 */\n  current: Ref<T | null>\n  /** 加载状态 */\n  loading: Ref<boolean>\n  /** 错误信息 */\n  error: Ref<Error | null>\n  /** 是否有错误 */\n  hasError: Ref<boolean>\n  /** 获取列表 */\n  list: (config?: RequestConfig) => Promise<T[]>\n  /** 获取单个项 */\n  get: (id: string | number, config?: RequestConfig) => Promise<T | null>\n  /** 创建项 */\n  create: (data: Partial<T>, config?: RequestConfig) => Promise<T | null>\n  /** 更新项 */\n  update: (id: string | number, data: Partial<T>, config?: RequestConfig) => Promise<T | null>\n  /** 删除项 */\n  remove: (id: string | number, config?: RequestConfig) => Promise<boolean>\n  /** 重置状态 */\n  reset: () => void\n  /** 清除错误 */\n  clearError: () => void\n  /** 刷新列表 */\n  refresh: () => Promise<T[]>\n}\n\n/**\n * 资源管理hook\n * 提供完整的CRUD操作\n *\n * @example\n * ```ts\n * const { items, current, loading, list, get, create, update, remove } = useResource<User>('/api/users')\n *\n * // 获取列表\n * await list()\n *\n * // 获取单个用户\n * await get(1)\n *\n * // 创建用户\n * await create({ name: 'John', email: 'john@example.com' })\n *\n * // 更新用户\n * await update(1, { name: 'Jane' })\n *\n * // 删除用户\n * await remove(1)\n * ```\n */\nexport function useResource<T = any>(\n  baseUrl: MaybeRef<string>,\n  options: ResourceOptions<T> = {},\n): ResourceReturn<T> {\n  const client = createHttpClient(options.clientConfig)\n\n  // 响应式状态\n  const items = ref<T[]>([])\n  const current = ref<T | null>(null)\n  const loading = ref(false)\n  const error = ref<Error | null>(null)\n\n  const hasError = computed(() => error.value !== null)\n\n  let abortController: AbortController | null = null\n\n  /**\n   * 处理请求\n   */\n  const handleRequest = async <R>(\n    operation: 'list' | 'get' | 'create' | 'update' | 'delete',\n    requestFn: () => Promise<R>,\n  ): Promise<R | null> => {\n    try {\n      loading.value = true\n      error.value = null\n\n      // 取消之前的请求\n      if (abortController) {\n        abortController.abort()\n      }\n      abortController = new AbortController()\n\n      const result = await requestFn()\n\n      if (operation === 'list' || operation === 'get') {\n        options.onSuccess?.(result as any, operation)\n      }\n\n      return result\n    }\n    catch (err) {\n      const errorObj = err as Error\n      if (errorObj.name !== 'AbortError') {\n        error.value = errorObj\n        options.onError?.(errorObj, operation)\n      }\n      return null\n    }\n    finally {\n      loading.value = false\n    }\n  }\n\n  /**\n   * 获取列表\n   */\n  const list = async (config?: RequestConfig): Promise<T[]> => {\n    const result = await handleRequest('list', async () => {\n      const requestConfig = {\n        ...config,\n        signal: abortController?.signal,\n      }\n\n      const response = await client.get<T[]>(unref(baseUrl), requestConfig)\n      let data = response.data\n\n      if (options.transform) {\n        data = Array.isArray(data) ? data.map(options.transform) : data\n      }\n\n      items.value = data\n      return data\n    })\n\n    return result || []\n  }\n\n  /**\n   * 获取单个项\n   */\n  const get = async (id: string | number, config?: RequestConfig): Promise<T | null> => {\n    const result = await handleRequest('get', async () => {\n      const url = `${unref(baseUrl)}/${id}`\n      const requestConfig = {\n        ...config,\n        signal: abortController?.signal,\n      }\n\n      const response = await client.get<T>(url, requestConfig)\n      let data = response.data\n\n      if (options.transform) {\n        data = options.transform(data)\n      }\n\n      current.value = data\n      return data\n    })\n\n    return result\n  }\n\n  /**\n   * 创建项\n   */\n  const create = async (data: Partial<T>, config?: RequestConfig): Promise<T | null> => {\n    const result = await handleRequest('create', async () => {\n      const requestConfig = {\n        ...config,\n        signal: abortController?.signal,\n      }\n\n      const response = await client.post<T>(unref(baseUrl), data, requestConfig)\n      let responseData = response.data\n\n      if (options.transform) {\n        responseData = options.transform(responseData)\n      }\n\n      // 添加到列表中\n      ;(items.value as any).push(responseData)\n      current.value = responseData\n\n      options.onSuccess?.(responseData, 'create')\n      return responseData\n    })\n\n    return result\n  }\n\n  /**\n   * 更新项\n   */\n  const update = async (id: string | number, data: Partial<T>, config?: RequestConfig): Promise<T | null> => {\n    const result = await handleRequest('update', async () => {\n      const url = `${unref(baseUrl)}/${id}`\n      const requestConfig = {\n        ...config,\n        signal: abortController?.signal,\n      }\n\n      const response = await client.put<T>(url, data, requestConfig)\n      let responseData = response.data\n\n      if (options.transform) {\n        responseData = options.transform(responseData)\n      }\n\n      // 更新列表中的项\n      const index = items.value.findIndex((item: any) => item.id === id)\n      if (index !== -1) {\n        ;(items.value as any)[index] = responseData\n      }\n\n      current.value = responseData\n      options.onSuccess?.(responseData, 'update')\n      return responseData\n    })\n\n    return result\n  }\n\n  /**\n   * 删除项\n   */\n  const remove = async (id: string | number, config?: RequestConfig): Promise<boolean> => {\n    const result = await handleRequest('delete', async () => {\n      const url = `${unref(baseUrl)}/${id}`\n      const requestConfig = {\n        ...config,\n        signal: abortController?.signal,\n      }\n\n      await client.delete(url, requestConfig)\n\n      // 从列表中移除\n      const index = items.value.findIndex((item: any) => item.id === id)\n      if (index !== -1) {\n        items.value.splice(index, 1)\n      }\n\n      // 如果当前项被删除，清空当前项\n      if (current.value && (current.value as any).id === id) {\n        current.value = null\n      }\n\n      options.onSuccess?.(null as any, 'delete')\n      return true\n    })\n\n    return result !== null\n  }\n\n  /**\n   * 重置状态\n   */\n  const reset = () => {\n    items.value = []\n    current.value = null\n    loading.value = false\n    error.value = null\n  }\n\n  /**\n   * 清除错误\n   */\n  const clearError = () => {\n    error.value = null\n  }\n\n  /**\n   * 刷新列表\n   */\n  const refresh = (): Promise<T[]> => {\n    return list()\n  }\n\n  // 立即加载数据\n  if (options.immediate !== false) {\n    watch(() => unref(baseUrl), () => {\n      list()\n    }, { immediate: true })\n  }\n\n  // 组件卸载时取消请求\n  if (options.cancelOnUnmount !== false) {\n    onUnmounted(() => {\n      if (abortController) {\n        abortController.abort()\n      }\n    })\n  }\n\n  return {\n    items: items as Ref<T[]>,\n    current: current as Ref<T | null>,\n    loading,\n    error,\n    hasError,\n    list,\n    get,\n    create,\n    update,\n    remove,\n    reset,\n    clearError,\n    refresh,\n  }\n}\n"],"names":["useResource","baseUrl","options","client","createHttpClient","clientConfig","items","ref","current","loading","error","hasError","computed","value","abortController","handleRequest","async","operation","requestFn","abort","AbortController","result","onSuccess","err","errorObj","name","onError","list","requestConfig","config","signal","data","get","unref","transform","Array","isArray","map","immediate","watch","cancelOnUnmount","onUnmounted","id","url","create","responseData","post","push","update","put","index","findIndex","item","remove","delete","splice","reset","clearError","refresh","O"],"mappings":"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"}
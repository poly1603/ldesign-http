import{ref as e,computed as a,unref as t,watch as n,onUnmounted as l}from"vue";import{createCancelTokenSource as r,isCancelError as o}from"../utils/cancel.js";const u=new class{constructor(){this.cache=new Map}get(e,a){const t=this.cache.get(e);return t?Date.now()-t.timestamp>a?null:t.data:null}set(e,a,t){this.cache.set(e,{data:a,timestamp:Date.now(),staleTime:t})}invalidate(e){this.cache.delete(e)}clear(){this.cache.clear()}};function i(i,c,s,v={}){const d=e(v.initialData??null),f=e(!1),w=e(null),m=e(!1),h=e(!1),y=e(!1),p=e(0),E=e(0),g=v.staleTime??3e5,D=v.retry??3,I=v.retryDelay??1e3;let b=r();const C=a(()=>f.value||y.value),F=a(()=>!1!==t(v.enabled)),L=()=>{const e=t(c);return"function"==typeof e?e():e},S=async e=>{if(!F.value)throw new Error("Query is disabled");const a=L(),n=u.get(a,g);if(n&&!e)return d.value=n,h.value=!1,m.value=!0,{data:n};d.value?(y.value=!0,h.value=!0):f.value=!0,w.value=null,m.value=!1,b=r();let l=0;const c="number"==typeof D?D:!0===D?3:0;for(;l<=c;)try{const n={...t(s),...e,signal:b.token.promise},l=await i.request(n);let r=l.data;return v.transform&&(r=v.transform(l.data)),d.value=r,h.value=!1,m.value=!0,p.value=Date.now(),E.value=0,u.set(a,r,g),v.onSuccess&&v.onSuccess(r,l),l}catch(e){const a=e;if(o(a))throw a;if(l++,E.value=l,l<=c&&("function"!=typeof D||D(l,a))){const e="function"==typeof I?I(l):I*2**(l-1);await new Promise(a=>setTimeout(a,e));continue}throw w.value=a,m.value=!0,v.onError&&v.onError(a),a}finally{f.value=!1,y.value=!1,v.onFinally&&v.onFinally()}throw w.value||new Error("Unknown error")},T=()=>{C.value&&b.cancel("Query cancelled by user")};if(n([()=>L(),()=>t(s),F],()=>{F.value&&!1!==v.immediate&&S()},{immediate:!1!==v.immediate,deep:!0}),v.refetchOnWindowFocus){const e=()=>{F.value&&d.value&&S()};typeof window<"u"&&(window.addEventListener("focus",e),l(()=>{window.removeEventListener("focus",e)}))}if(v.refetchOnReconnect){const e=()=>{F.value&&d.value&&S()};typeof window<"u"&&(window.addEventListener("online",e),l(()=>{window.removeEventListener("online",e)}))}if(v.refetchInterval&&v.refetchInterval>0){const e=setInterval(()=>{F.value&&d.value&&S()},v.refetchInterval);l(()=>{clearInterval(e)})}return!1!==v.cancelOnUnmount&&l(()=>{T()}),{data:d,loading:f,error:w,finished:m,isStale:h,isFetching:y,dataUpdatedAt:p,failureCount:E,execute:S,refresh:()=>S(),cancel:T,reset:()=>{d.value=v.initialData??null,f.value=!1,w.value=null,m.value=!1,h.value=!1,y.value=!1,p.value=0,E.value=0},invalidate:()=>{const e=L();u.invalidate(e),h.value=!0},canCancel:C}}export{i as useQuery};
//# sourceMappingURL=useQuery.js.map

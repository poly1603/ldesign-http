{"version":3,"file":"useHttp.js","sources":["../../src/vue/useHttp.ts"],"sourcesContent":["import type { InjectionKey, Ref } from 'vue'\r\nimport type { HttpClient, RequestConfig } from '../types'\r\nimport { computed, inject, provide, ref } from 'vue'\r\nimport {\r\n  useDelete,\r\n  useMutation,\r\n  usePatch,\r\n  usePost,\r\n  usePut,\r\n} from './useMutation'\r\nimport { useQuery } from './useQuery'\r\nimport { useRequest } from './useRequest'\r\n\r\n/**\r\n * HTTP 客户端注入键\r\n */\r\nexport const HTTP_CLIENT_KEY: InjectionKey<HttpClient> = Symbol('http-client')\r\n\r\n/**\r\n * 全局配置注入键\r\n */\r\nexport const HTTP_CONFIG_KEY: InjectionKey<Ref<RequestConfig>>\r\n  = Symbol('http-config')\r\n\r\n/**\r\n * 提供 HTTP 客户端\r\n */\r\nexport function provideHttpClient(\r\n  client: HttpClient,\r\n  globalConfig?: RequestConfig,\r\n): void {\r\n  provide(HTTP_CLIENT_KEY, client)\r\n  if (globalConfig) {\r\n    provide(HTTP_CONFIG_KEY, ref(globalConfig))\r\n  }\r\n}\r\n\r\n/**\r\n * 注入 HTTP 客户端\r\n */\r\nexport function injectHttpClient(): HttpClient {\r\n  const client = inject(HTTP_CLIENT_KEY)\r\n  if (!client) {\r\n    throw new Error(\r\n      'HTTP client not provided. Please use provideHttpClient() in a parent component.',\r\n    )\r\n  }\r\n  return client as HttpClient\r\n}\r\n\r\n/**\r\n * 注入全局配置\r\n */\r\nexport function injectHttpConfig(): Ref<RequestConfig> {\r\n  return inject(HTTP_CONFIG_KEY, ref({})) as Ref<RequestConfig>\r\n}\r\n\r\n/**\r\n * 主要的 HTTP Hook\r\n * 自动注入客户端和全局配置\r\n */\r\nexport function useHttp() {\r\n  const client = injectHttpClient()\r\n  const globalConfig = injectHttpConfig()\r\n\r\n  /**\r\n   * 合并全局配置\r\n   */\r\n  const mergeConfig = (config: RequestConfig = {}): RequestConfig => {\r\n    return {\r\n      ...globalConfig.value,\r\n      ...config,\r\n      headers: {\r\n        ...globalConfig.value.headers,\r\n        ...config.headers,\r\n      },\r\n    }\r\n  }\r\n\r\n  return {\r\n    client,\r\n    globalConfig,\r\n\r\n    // 基础请求方法\r\n    request: <T = any>(config: RequestConfig) =>\r\n      client.request<T>(mergeConfig(config)),\r\n\r\n    get: <T = any>(url: string, config?: RequestConfig) =>\r\n      client.get<T>(url, mergeConfig(config)),\r\n\r\n    post: <T = any>(url: string, data?: any, config?: RequestConfig) =>\r\n      client.post<T>(url, data, mergeConfig(config)),\r\n\r\n    put: <T = any>(url: string, data?: any, config?: RequestConfig) =>\r\n      client.put<T>(url, data, mergeConfig(config)),\r\n\r\n    delete: <T = any>(url: string, config?: RequestConfig) =>\r\n      client.delete<T>(url, mergeConfig(config)),\r\n\r\n    patch: <T = any>(url: string, data?: any, config?: RequestConfig) =>\r\n      client.patch<T>(url, data, mergeConfig(config)),\r\n\r\n    head: <T = any>(url: string, config?: RequestConfig) =>\r\n      client.head<T>(url, mergeConfig(config)),\r\n\r\n    options: <T = any>(url: string, config?: RequestConfig) =>\r\n      client.options<T>(url, mergeConfig(config)),\r\n\r\n    // Composition API hooks\r\n    useRequest: <T = any>(config: RequestConfig, options?: any) =>\r\n      useRequest<T>(client, ref(mergeConfig(config)), options),\r\n\r\n    useQuery: <T = any>(queryKey: any, config: RequestConfig, options?: any) =>\r\n      useQuery<T>(client, queryKey, ref(mergeConfig(config)), options),\r\n\r\n    useMutation: <T = any, V = any>(mutationFn: any, options?: any) =>\r\n      useMutation<T, V>(client, mutationFn, options),\r\n\r\n    usePost: <T = any, D = any>(url: string, options?: any) =>\r\n      usePost<T, D>(client, url, options),\r\n\r\n    usePut: <T = any, D = any>(url: string, options?: any) =>\r\n      usePut<T, D>(client, url, options),\r\n\r\n    usePatch: <T = any, D = any>(url: string, options?: any) =>\r\n      usePatch<T, D>(client, url, options),\r\n\r\n    useDelete: <T = any>(url: string, options?: any) =>\r\n      useDelete<T>(client, url, options),\r\n\r\n    // 客户端控制方法\r\n    cancelAll: (reason?: string) => client.cancelAll(reason),\r\n    clearCache: () => client.clearCache(),\r\n    getActiveRequestCount: () => client.getActiveRequestCount(),\r\n    getConcurrencyStatus: () => client.getConcurrencyStatus(),\r\n  }\r\n}\r\n\r\n/**\r\n * 创建资源 Hook\r\n * 用于 RESTful API 操作\r\n *\r\n * 注意: 这是一个轻量级的资源hook,用于依赖注入场景\r\n * 如需更完整的功能(loading状态、error处理等),请使用 useResource from './useResource'\r\n */\r\nexport function useResource<T = any>(baseUrl: string) {\r\n  const {\r\n    get,\r\n    post,\r\n    put,\r\n    patch,\r\n    delete: del,\r\n    useQuery,\r\n    useMutation,\r\n  } = useHttp()\r\n\r\n  return {\r\n    // 查询操作\r\n    useList: (params?: Record<string, any>, options?: any) =>\r\n      useQuery(\r\n        ['resource-list', baseUrl, params],\r\n        { url: baseUrl, params },\r\n        options,\r\n      ),\r\n\r\n    useDetail: (id: string | number, options?: any) =>\r\n      useQuery(\r\n        ['resource-detail', baseUrl, id],\r\n        { url: `${baseUrl}/${id}` },\r\n        options,\r\n      ),\r\n\r\n    // 变更操作\r\n    useCreate: (options?: any) =>\r\n      useMutation((data: T) => post<T>(`${baseUrl}`, data), options),\r\n\r\n    useUpdate: (options?: any) =>\r\n      useMutation(\r\n        ({ id, data }: { id: string | number, data: Partial<T> }) =>\r\n          put<T>(`${baseUrl}/${id}`, data),\r\n        options,\r\n      ),\r\n\r\n    usePatch: (options?: any) =>\r\n      useMutation(\r\n        ({ id, data }: { id: string | number, data: Partial<T> }) =>\r\n          patch<T>(`${baseUrl}/${id}`, data),\r\n        options,\r\n      ),\r\n\r\n    useDelete: (options?: any) =>\r\n      useMutation((id: string | number) => del(`${baseUrl}/${id}`), options),\r\n\r\n    // 直接调用方法\r\n    list: (params?: Record<string, any>) => get<T[]>(baseUrl, { params }),\r\n    detail: (id: string | number) => get<T>(`${baseUrl}/${id}`),\r\n    create: (data: T) => post<T>(baseUrl, data),\r\n    update: (id: string | number, data: Partial<T>) =>\r\n      put<T>(`${baseUrl}/${id}`, data),\r\n    patch: (id: string | number, data: Partial<T>) =>\r\n      patch<T>(`${baseUrl}/${id}`, data),\r\n    remove: (id: string | number) => del(`${baseUrl}/${id}`),\r\n  }\r\n}\r\n\r\n/**\r\n * 分页查询 Hook\r\n */\r\nexport function usePagination<T = any>(\r\n  baseUrl: string,\r\n  initialPage = 1,\r\n  initialPageSize = 10,\r\n) {\r\n  const page = ref<number>(initialPage)\r\n  const pageSize = ref<number>(initialPageSize)\r\n  const total = ref<number>(0)\r\n\r\n  const { useQuery } = useHttp()\r\n\r\n  const queryKey = computed(() => [\r\n    'pagination',\r\n    baseUrl,\r\n    page.value,\r\n    pageSize.value,\r\n  ])\r\n  const config = computed(() => ({\r\n    url: baseUrl,\r\n    params: {\r\n      page: page.value,\r\n      pageSize: pageSize.value,\r\n    },\r\n  }))\r\n\r\n  const query = useQuery<{\r\n    data: T[]\r\n    total: number\r\n    page: number\r\n    pageSize: number\r\n  }>(queryKey, config.value, {\r\n    onSuccess: (data: {\r\n      data: T[]\r\n      total: number\r\n      page: number\r\n      pageSize: number\r\n    }) => {\r\n      total.value = data.total\r\n    },\r\n  })\r\n\r\n  const totalPages = computed(() => Math.ceil(total.value / pageSize.value))\r\n  const hasNextPage = computed(() => page.value < totalPages.value)\r\n  const hasPrevPage = computed(() => page.value > 1)\r\n\r\n  const nextPage = () => {\r\n    if (hasNextPage.value) {\r\n      page.value++\r\n    }\r\n  }\r\n\r\n  const prevPage = () => {\r\n    if (hasPrevPage.value) {\r\n      page.value--\r\n    }\r\n  }\r\n\r\n  const goToPage = (targetPage: number) => {\r\n    if (targetPage >= 1 && targetPage <= totalPages.value) {\r\n      page.value = targetPage\r\n    }\r\n  }\r\n\r\n  const setPageSize = (newPageSize: number) => {\r\n    pageSize.value = newPageSize\r\n    page.value = 1 // 重置到第一页\r\n  }\r\n\r\n  return {\r\n    // 查询状态\r\n    ...query,\r\n\r\n    // 分页数据\r\n    page,\r\n    pageSize,\r\n    total,\r\n    totalPages,\r\n    hasNextPage,\r\n    hasPrevPage,\r\n\r\n    // 操作方法\r\n    nextPage,\r\n    prevPage,\r\n    goToPage,\r\n    setPageSize,\r\n  }\r\n}\r\n"],"names":["HTTP_CLIENT_KEY","Symbol","HTTP_CONFIG_KEY","provideHttpClient","client","globalConfig","provide","ref","injectHttpClient","inject","Error","injectHttpConfig","useHttp","mergeConfig","config","value","headers","request","get","url","post","data","put","delete","patch","head","options","useRequest","useQuery","queryKey","useMutation","mutationFn","usePost","usePut","usePatch","useDelete","cancelAll","reason","clearCache","getActiveRequestCount","getConcurrencyStatus","useResource","baseUrl","del","useList","params","useDetail","id","useCreate","useUpdate","list","detail","create","update","remove","usePagination","initialPage","initialPageSize","page","pageSize","total","query","computed","onSuccess","totalPages","Math","ceil","hasNextPage","hasPrevPage","nextPage","prevPage","goToPage","targetPage","setPageSize","newPageSize","d","h","y","H","M","P","_","Q"],"mappings":"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"}
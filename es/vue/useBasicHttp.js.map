{"version":3,"file":"useBasicHttp.js","sources":["../../src/vue/useBasicHttp.ts"],"sourcesContent":["import type { MaybeRef, Ref } from 'vue'\nimport type { HttpClientConfig, RequestConfig } from '../types'\nimport { computed, getCurrentInstance, onUnmounted, ref, unref, watch } from 'vue'\nimport { createHttpClient } from '../factory'\n\n/**\n * 基础HTTP请求选项\n */\nexport interface BasicHttpOptions<T = unknown> {\n  /** 是否立即执行请求 */\n  immediate?: boolean\n  /** 是否在组件卸载时取消请求 */\n  cancelOnUnmount?: boolean\n  /** 请求成功回调 */\n  onSuccess?: (data: T) => void\n  /** 请求失败回调 */\n  onError?: (error: Error) => void\n  /** 请求完成回调 */\n  onFinally?: () => void\n}\n\n/**\n * 基础HTTP请求返回值\n */\nexport interface BasicHttpReturn<T, D = unknown> {\n  /** 响应数据 */\n  data: Ref<T | null>\n  /** 加载状态 */\n  loading: Ref<boolean>\n  /** 错误信息 */\n  error: Ref<Error | null>\n  /** 是否完成 */\n  finished: Ref<boolean>\n  /** 是否有错误 */\n  hasError: Ref<boolean>\n  /** 执行请求 */\n  execute: (data?: D) => Promise<T | null>\n  /** 重置状态 */\n  reset: () => void\n  /** 清除错误 */\n  clearError: () => void\n}\n\n/**\n * 创建基础HTTP客户端\n */\nfunction createBasicClient(config?: HttpClientConfig) {\n  // 为相对URL提供默认的baseURL\n  const defaultConfig: HttpClientConfig = {\n    baseURL: typeof window !== 'undefined' ? window.location.origin : 'http://localhost',\n    ...config,\n  }\n  return createHttpClient(defaultConfig)\n}\n\n/**\n * 通用HTTP请求hook工厂\n *\n * 这个内部函数用于创建所有HTTP方法的hooks,消除重复代码\n */\nfunction createHttpHook<T = unknown, D = unknown>(\n  method: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH',\n  url: MaybeRef<string>,\n  config?: MaybeRef<RequestConfig>,\n  options: BasicHttpOptions<T> = {},\n): BasicHttpReturn<T, D> {\n  const client = createBasicClient()\n  const responseData = ref<T | null>(null)\n  const loading = ref(false)\n  const error = ref<Error | null>(null)\n  const finished = ref(false)\n\n  const hasError = computed(() => error.value !== null)\n\n  let abortController: AbortController | null = null\n\n  const execute = async (requestData?: D): Promise<T | null> => {\n    try {\n      loading.value = true\n      error.value = null\n      finished.value = false\n\n      // 取消之前的请求\n      if (abortController) {\n        abortController.abort()\n      }\n      abortController = new AbortController()\n\n      const requestConfig = {\n        ...unref(config),\n        signal: abortController.signal,\n      }\n\n      let response\n      switch (method) {\n        case 'GET':\n          response = await client.get<T>(unref(url), requestConfig)\n          break\n        case 'POST':\n          response = await client.post<T>(unref(url), requestData, requestConfig)\n          break\n        case 'PUT':\n          response = await client.put<T>(unref(url), requestData, requestConfig)\n          break\n        case 'PATCH':\n          response = await client.patch<T>(unref(url), requestData, requestConfig)\n          break\n        case 'DELETE':\n          response = await client.delete<T>(unref(url), requestConfig)\n          break\n      }\n\n      responseData.value = response.data\n\n      options.onSuccess?.(response.data)\n      return response.data\n    }\n    catch (err) {\n      const errorObj = err as Error\n      if (errorObj.name !== 'AbortError') {\n        error.value = errorObj\n        options.onError?.(errorObj)\n      }\n      return null\n    }\n    finally {\n      loading.value = false\n      finished.value = true\n      options.onFinally?.()\n    }\n  }\n\n  const reset = () => {\n    responseData.value = null\n    loading.value = false\n    error.value = null\n    finished.value = false\n  }\n\n  const clearError = () => {\n    error.value = null\n  }\n\n  // GET请求支持监听URL变化自动执行\n  if (method === 'GET' && options.immediate !== false) {\n    watch(() => unref(url), () => execute(), { immediate: true })\n  }\n\n  // 组件卸载时取消请求\n  if (options.cancelOnUnmount !== false && getCurrentInstance()) {\n    onUnmounted(() => {\n      if (abortController) {\n        abortController.abort()\n      }\n    })\n  }\n\n  return {\n    data: responseData as Ref<T | null>,\n    loading,\n    error,\n    finished,\n    hasError,\n    execute,\n    reset,\n    clearError,\n  }\n}\n\n/**\n * 基础HTTP GET请求hook\n *\n * @example\n * ```ts\n * const { data, loading, error, execute } = useGet('/api/users')\n * ```\n */\nexport function useGet<T = any>(\n  url: MaybeRef<string>,\n  config?: MaybeRef<RequestConfig>,\n  options: BasicHttpOptions = {},\n): BasicHttpReturn<T> {\n  return createHttpHook<T>('GET', url, config, options)\n}\n\n/**\n * 基础HTTP POST请求hook\n *\n * @example\n * ```ts\n * const { data, loading, error, execute } = usePost('/api/users')\n * await execute({ name: 'John' })\n * ```\n */\nexport function usePost<T = unknown, D = unknown>(\n  url: MaybeRef<string>,\n  config?: MaybeRef<RequestConfig>,\n  options: BasicHttpOptions<T> = {},\n): BasicHttpReturn<T, D> {\n  return createHttpHook<T, D>('POST', url, config, options) as BasicHttpReturn<T, D>\n}\n\n/**\n * 基础HTTP PUT请求hook\n */\nexport function usePut<T = unknown, D = unknown>(\n  url: MaybeRef<string>,\n  config?: MaybeRef<RequestConfig>,\n  options: BasicHttpOptions<T> = {},\n): BasicHttpReturn<T, D> {\n  return createHttpHook<T, D>('PUT', url, config, options) as BasicHttpReturn<T, D>\n}\n\n/**\n * 基础HTTP DELETE请求hook\n */\nexport function useDelete<T = unknown>(\n  url: MaybeRef<string>,\n  config?: MaybeRef<RequestConfig>,\n  options: BasicHttpOptions<T> = {},\n): BasicHttpReturn<T> {\n  return createHttpHook<T>('DELETE', url, config, options)\n}\n\n/**\n * 基础HTTP PATCH请求hook\n */\nexport function usePatch<T = unknown, D = unknown>(\n  url: MaybeRef<string>,\n  config?: MaybeRef<RequestConfig>,\n  options: BasicHttpOptions<T> = {},\n): BasicHttpReturn<T, D> {\n  return createHttpHook<T, D>('PATCH', url, config, options) as BasicHttpReturn<T, D>\n}\n"],"names":["createHttpHook","method","url","config","options","client","defaultConfig","baseURL","window","location","origin","createHttpClient","createBasicClient","responseData","ref","loading","error","finished","hasError","computed","value","abortController","execute","async","abort","AbortController","requestConfig","unref","signal","response","get","post","requestData","put","patch","delete","data","onSuccess","err","errorObj","name","onError","onFinally","immediate","watch","cancelOnUnmount","getCurrentInstance","onUnmounted","reset","clearError","useGet","usePost","usePut","useDelete","usePatch","x","U","D","A","G"],"mappings":"wJA4DA,SAASA,EACPC,EACAC,EACAC,EACAC,EAA+B,CAAA,GAE/B,MAAMC,EApBR,SAA2BF,GAEzB,MAAMG,EAAkC,CACtCC,eAAgBC,OAAW,IAAcA,OAAOC,SAASC,OAAS,sBAC/DP,GAEL,OAAOQ,EAAiBL,EAC1B,CAaiBM,GACTC,EAAeC,EAAc,MAC7BC,EAAUD,GAAI,GACdE,EAAQF,EAAkB,MAC1BG,EAAWH,GAAI,GAEfI,EAAWC,EAAS,IAAsB,OAAhBH,EAAMI,OAEtC,IAAIC,EAA0C,KAE9C,MAAMC,EAAUC,UACd,IACER,EAAQK,OAAQ,EAChBJ,EAAMI,MAAQ,KACdH,EAASG,OAAQ,EAGbC,GACFA,EAAgBG,QAElBH,EAAkB,IAAII,gBAEtB,MAAMC,EAAgB,IACjBC,EAAMxB,GACTyB,OAAQP,EAAgBO,QAG1B,IAAIC,EACJ,OAAQ5B,GACN,IAAK,MACH4B,QAAiBxB,EAAOyB,IAAOH,EAAMzB,GAAMwB,GAC3C,MACF,IAAK,OACHG,QAAiBxB,EAAO0B,KAAQJ,EAAMzB,GAAM8B,EAAaN,GACzD,MACF,IAAK,MACHG,QAAiBxB,EAAO4B,IAAON,EAAMzB,GAAM8B,EAAaN,GACxD,MACF,IAAK,QACHG,QAAiBxB,EAAO6B,MAASP,EAAMzB,GAAM8B,EAAaN,GAC1D,MACF,IAAK,SACHG,QAAiBxB,EAAO8B,OAAUR,EAAMzB,GAAMwB,GAIlD,OAAAb,EAAaO,MAAQS,EAASO,KAE9BhC,EAAQiC,YAAYR,EAASO,MACtBP,EAASO,IAClB,OACOE,GACL,MAAMC,EAAWD,EACjB,MAAsB,eAAlBC,EAASC,OACXxB,EAAMI,MAAQmB,EACdnC,EAAQqC,UAAUF,IAEb,IACT,SAEExB,EAAQK,OAAQ,EAChBH,EAASG,OAAQ,EACjBhB,EAAQsC,aACV,GAeF,MAAe,QAAXzC,IAA0C,IAAtBG,EAAQuC,WAC9BC,EAAM,IAAMjB,EAAMzB,GAAM,IAAMoB,IAAW,CAAEqB,WAAW,KAIxB,IAA5BvC,EAAQyC,iBAA6BC,KACvCC,EAAY,KACN1B,GACFA,EAAgBG,UAKf,CACLY,KAAMvB,EACNE,QAAAA,EACAC,MAAAA,EACAC,SAAAA,EACAC,SAAAA,EACAI,QAAAA,EACA0B,MAhCY,KACZnC,EAAaO,MAAQ,KACrBL,EAAQK,OAAQ,EAChBJ,EAAMI,MAAQ,KACdH,EAASG,OAAQ,GA6BjB6B,WA1BiB,KACjBjC,EAAMI,MAAQ,MA2BlB,CAUM,SAAU8B,EACdhD,EACAC,EACAC,EAA4B,CAAA,GAE5B,OAAOJ,EAAkB,MAAOE,EAAKC,EAAQC,EAC/C,CAWM,SAAU+C,EACdjD,EACAC,EACAC,EAA+B,IAE/B,OAAOJ,EAAqB,OAAQE,EAAKC,EAAQC,EACnD,UAKgBgD,EACdlD,EACAC,EACAC,EAA+B,CAAA,GAE/B,OAAOJ,EAAqB,MAAOE,EAAKC,EAAQC,EAClD,CAKM,SAAUiD,EACdnD,EACAC,EACAC,EAA+B,CAAA,GAE/B,OAAOJ,EAAkB,SAAUE,EAAKC,EAAQC,EAClD,CAKM,SAAUkD,EACdpD,EACAC,EACAC,EAA+B,CAAA,GAE/B,OAAOJ,EAAqB,QAASE,EAAKC,EAAQC,EACpD,QAAAmD,eAAAC,YAAAC,cAAAC,aAAAC"}